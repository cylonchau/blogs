<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>详解haproxy | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="haproxy"><meta name=description content="haproxy 介绍 haproxy是一个开源的、高性能的基于TCP和HTTP应用代理的高可用的、负载均衡服务软件，它支持双机热备、高可用、负载均衡、虚拟主机、基于TCP和HTTP的应用代理、图形界面查看信息等功能。其配置简单、维护方便，而且拥有很好的对服务器节点的健康检查功能(相当于keepalived健康检查)，当其代理的后端服务器出现故障时，haproxy会自动的将该故障服务器摘除，当故障的服务器恢复后，haproxy还会自动将该服务器自动加入进来提供服务。
LVS/NGINX对比 haproxy 特别适用于那些高负载、访问量很大，但又需要会话保持及七层应用代理的业务应用。haproxy运行在今天的普通的服务器硬件上，几乎不需要进行任何的优化就可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单、轻松、安全的整合到各种己有的网站架构中，同时，haproxy的代理模式，可以使得所有应用服务器不会暴露到公共网络上，即后面的节点服务器不需要公网IP地址。
从1.3版本起，haproxy软件引入了frontend,backend的功能，frontend (ad规则匹配)可以让运维管理人员根据任意HTTP请求头内容做规则匹配，然后把请求定向到相关的backend(这个是事先定义好的多个server pools，等待前端把请求转过来的服务器组)。通过frontend和backend，我们可以很容易的买现haproxy的各种7层应用代理功能。
haproxy代理模式 haproxy支持两种主要代理模式：
1、基于4层的tcp应用代理(例如:可用于邮件服务、内部协议通信服务器、MySQL、HTTPS服务等)。
2、基于7层的http代理。在4层tcp代理模式下，haproxy仅在客户端和服务器之间进行流量转发。但是在7层http代理模式下，haproxy会分析应用层协议，并且能通过允许、拒绝、交换、增加、修改或者删除请求(request)或者回应(response)里指定内容来控制协议。
官方网站:www.haproxy.org
haproxy 解决方案拓扑图 haproxy L4负载均衡应用架构拓扑 haproxy软件的四层tcp应用代理非常优秀，且配置非常简单、方便，比LVS和Nginx的配置要简单很多，首先，配置haproxy不需要在RS端做任何特殊配置 (只要对应服务开启就OK)就可以实现应用代理，其次，haproxy的配置语法和增加虚拟主机功能等也比lvs/nginx简单。并且和商业版的NS (Netscaler)、F5, A10等负载均衡硬件的使用方法和在架构中的位置一模一样。下面是haproxy的Layer4层应用代理的拓扑结构图:
说明:由于haproxy软件采用的是类NAT模式(本质不同)的应用代理，数据包来去都会经过haproxy，因此，在流量特别大的情况下(门户级别的流量)，其效率和性能不如LVS的DR模式负载均衡。
在一般的中小型公司，建议采用haproxy做负载均衡，而不要使用LVS或Nginx。为什么强调中小型公司呢?换句话说，千万PV级别以下直接使用haproxy做负载均衡，会让我们负责维护的运维管理人员配置简单、快速、维护方便，出问题好排查。
haproxy L7负载均衡应用架构拓扑 haproxy软件的最大优势在于其7层的根据URL请求头应用过滤的功能以及sesson会话功能，在门户网站的高并发生产架构中，haproxy软件一般用在4层LVS负载均衡软件的下一层，或者像haproxy官方推荐的也可以挂在硬件负载均衡althon, NS, F5, A10下使用，其表现非常好。从2009年起taobao，京东商城的业务也大面积使用了haproxy作为7层CACHE应用代理。
安装haproxy 模拟真实环境
搭建合适的模拟环境是一个人学习能力的重要体现。例如：人类第一次上太空也没有真正的环境，但是想去太空就是要自己动手去搭建逼真的模拟环境。实验多了就是经验，自然就有解除生产环境的机会了。
名称 接口 IP 用途 MASTER eth0 10.0.0.7 外网管理IP用于WAN数据转发 eth1 172.16.1.7 内网管理IP，用于LAN数据转发 eth2 10.0.10.7 用于服务器间心跳连接（直连） VIP 10.0.0.17 用于提供应用程序A挂载服务 BACKUP eth0 10.0.0.8 外网管理IP，用于WAN数据转发 eth1 172.16.1.8 内网管理IP，用于LAN数据转发 eth2 10.0.10.8 用于服务器间心跳连接（直连） VIP 10.0.0.8 用于提供应用程序B挂载服务 下载安装haproxy 下载地址：http://www.haproxy.org/download/
文档地址：http://www.haproxy.org/download/1.7/doc/configuration.txt
编译haproxy bash 1 2 3 4 make TARGET=linux2628 ARCH=x86_64 # <==64位编译配置 make TARGET=linux2628 ARCH=i386 # <==32位编译配置 make PREFIX=/app/haproxy-1."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2017/11/haproxy/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2017/11/haproxy/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-H94HZ5S19Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H94HZ5S19Y")</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="详解haproxy"><meta property="og:description" content="haproxy 介绍 haproxy是一个开源的、高性能的基于TCP和HTTP应用代理的高可用的、负载均衡服务软件，它支持双机热备、高可用、负载均衡、虚拟主机、基于TCP和HTTP的应用代理、图形界面查看信息等功能。其配置简单、维护方便，而且拥有很好的对服务器节点的健康检查功能(相当于keepalived健康检查)，当其代理的后端服务器出现故障时，haproxy会自动的将该故障服务器摘除，当故障的服务器恢复后，haproxy还会自动将该服务器自动加入进来提供服务。
LVS/NGINX对比 haproxy 特别适用于那些高负载、访问量很大，但又需要会话保持及七层应用代理的业务应用。haproxy运行在今天的普通的服务器硬件上，几乎不需要进行任何的优化就可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单、轻松、安全的整合到各种己有的网站架构中，同时，haproxy的代理模式，可以使得所有应用服务器不会暴露到公共网络上，即后面的节点服务器不需要公网IP地址。
从1.3版本起，haproxy软件引入了frontend,backend的功能，frontend (ad规则匹配)可以让运维管理人员根据任意HTTP请求头内容做规则匹配，然后把请求定向到相关的backend(这个是事先定义好的多个server pools，等待前端把请求转过来的服务器组)。通过frontend和backend，我们可以很容易的买现haproxy的各种7层应用代理功能。
haproxy代理模式 haproxy支持两种主要代理模式：
1、基于4层的tcp应用代理(例如:可用于邮件服务、内部协议通信服务器、MySQL、HTTPS服务等)。
2、基于7层的http代理。在4层tcp代理模式下，haproxy仅在客户端和服务器之间进行流量转发。但是在7层http代理模式下，haproxy会分析应用层协议，并且能通过允许、拒绝、交换、增加、修改或者删除请求(request)或者回应(response)里指定内容来控制协议。
官方网站:www.haproxy.org
haproxy 解决方案拓扑图 haproxy L4负载均衡应用架构拓扑 haproxy软件的四层tcp应用代理非常优秀，且配置非常简单、方便，比LVS和Nginx的配置要简单很多，首先，配置haproxy不需要在RS端做任何特殊配置 (只要对应服务开启就OK)就可以实现应用代理，其次，haproxy的配置语法和增加虚拟主机功能等也比lvs/nginx简单。并且和商业版的NS (Netscaler)、F5, A10等负载均衡硬件的使用方法和在架构中的位置一模一样。下面是haproxy的Layer4层应用代理的拓扑结构图:
说明:由于haproxy软件采用的是类NAT模式(本质不同)的应用代理，数据包来去都会经过haproxy，因此，在流量特别大的情况下(门户级别的流量)，其效率和性能不如LVS的DR模式负载均衡。
在一般的中小型公司，建议采用haproxy做负载均衡，而不要使用LVS或Nginx。为什么强调中小型公司呢?换句话说，千万PV级别以下直接使用haproxy做负载均衡，会让我们负责维护的运维管理人员配置简单、快速、维护方便，出问题好排查。
haproxy L7负载均衡应用架构拓扑 haproxy软件的最大优势在于其7层的根据URL请求头应用过滤的功能以及sesson会话功能，在门户网站的高并发生产架构中，haproxy软件一般用在4层LVS负载均衡软件的下一层，或者像haproxy官方推荐的也可以挂在硬件负载均衡althon, NS, F5, A10下使用，其表现非常好。从2009年起taobao，京东商城的业务也大面积使用了haproxy作为7层CACHE应用代理。
安装haproxy 模拟真实环境
搭建合适的模拟环境是一个人学习能力的重要体现。例如：人类第一次上太空也没有真正的环境，但是想去太空就是要自己动手去搭建逼真的模拟环境。实验多了就是经验，自然就有解除生产环境的机会了。
名称 接口 IP 用途 MASTER eth0 10.0.0.7 外网管理IP用于WAN数据转发 eth1 172.16.1.7 内网管理IP，用于LAN数据转发 eth2 10.0.10.7 用于服务器间心跳连接（直连） VIP 10.0.0.17 用于提供应用程序A挂载服务 BACKUP eth0 10.0.0.8 外网管理IP，用于WAN数据转发 eth1 172.16.1.8 内网管理IP，用于LAN数据转发 eth2 10.0.10.8 用于服务器间心跳连接（直连） VIP 10.0.0.8 用于提供应用程序B挂载服务 下载安装haproxy 下载地址：http://www.haproxy.org/download/
文档地址：http://www.haproxy.org/download/1.7/doc/configuration.txt
编译haproxy bash 1 2 3 4 make TARGET=linux2628 ARCH=x86_64 # <==64位编译配置 make TARGET=linux2628 ARCH=i386 # <==32位编译配置 make PREFIX=/app/haproxy-1."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2017/11/haproxy/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-11-16T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-28T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="详解haproxy"><meta name=twitter:description content="haproxy 介绍 haproxy是一个开源的、高性能的基于TCP和HTTP应用代理的高可用的、负载均衡服务软件，它支持双机热备、高可用、负载均衡、虚拟主机、基于TCP和HTTP的应用代理、图形界面查看信息等功能。其配置简单、维护方便，而且拥有很好的对服务器节点的健康检查功能(相当于keepalived健康检查)，当其代理的后端服务器出现故障时，haproxy会自动的将该故障服务器摘除，当故障的服务器恢复后，haproxy还会自动将该服务器自动加入进来提供服务。
LVS/NGINX对比 haproxy 特别适用于那些高负载、访问量很大，但又需要会话保持及七层应用代理的业务应用。haproxy运行在今天的普通的服务器硬件上，几乎不需要进行任何的优化就可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单、轻松、安全的整合到各种己有的网站架构中，同时，haproxy的代理模式，可以使得所有应用服务器不会暴露到公共网络上，即后面的节点服务器不需要公网IP地址。
从1.3版本起，haproxy软件引入了frontend,backend的功能，frontend (ad规则匹配)可以让运维管理人员根据任意HTTP请求头内容做规则匹配，然后把请求定向到相关的backend(这个是事先定义好的多个server pools，等待前端把请求转过来的服务器组)。通过frontend和backend，我们可以很容易的买现haproxy的各种7层应用代理功能。
haproxy代理模式 haproxy支持两种主要代理模式：
1、基于4层的tcp应用代理(例如:可用于邮件服务、内部协议通信服务器、MySQL、HTTPS服务等)。
2、基于7层的http代理。在4层tcp代理模式下，haproxy仅在客户端和服务器之间进行流量转发。但是在7层http代理模式下，haproxy会分析应用层协议，并且能通过允许、拒绝、交换、增加、修改或者删除请求(request)或者回应(response)里指定内容来控制协议。
官方网站:www.haproxy.org
haproxy 解决方案拓扑图 haproxy L4负载均衡应用架构拓扑 haproxy软件的四层tcp应用代理非常优秀，且配置非常简单、方便，比LVS和Nginx的配置要简单很多，首先，配置haproxy不需要在RS端做任何特殊配置 (只要对应服务开启就OK)就可以实现应用代理，其次，haproxy的配置语法和增加虚拟主机功能等也比lvs/nginx简单。并且和商业版的NS (Netscaler)、F5, A10等负载均衡硬件的使用方法和在架构中的位置一模一样。下面是haproxy的Layer4层应用代理的拓扑结构图:
说明:由于haproxy软件采用的是类NAT模式(本质不同)的应用代理，数据包来去都会经过haproxy，因此，在流量特别大的情况下(门户级别的流量)，其效率和性能不如LVS的DR模式负载均衡。
在一般的中小型公司，建议采用haproxy做负载均衡，而不要使用LVS或Nginx。为什么强调中小型公司呢?换句话说，千万PV级别以下直接使用haproxy做负载均衡，会让我们负责维护的运维管理人员配置简单、快速、维护方便，出问题好排查。
haproxy L7负载均衡应用架构拓扑 haproxy软件的最大优势在于其7层的根据URL请求头应用过滤的功能以及sesson会话功能，在门户网站的高并发生产架构中，haproxy软件一般用在4层LVS负载均衡软件的下一层，或者像haproxy官方推荐的也可以挂在硬件负载均衡althon, NS, F5, A10下使用，其表现非常好。从2009年起taobao，京东商城的业务也大面积使用了haproxy作为7层CACHE应用代理。
安装haproxy 模拟真实环境
搭建合适的模拟环境是一个人学习能力的重要体现。例如：人类第一次上太空也没有真正的环境，但是想去太空就是要自己动手去搭建逼真的模拟环境。实验多了就是经验，自然就有解除生产环境的机会了。
名称 接口 IP 用途 MASTER eth0 10.0.0.7 外网管理IP用于WAN数据转发 eth1 172.16.1.7 内网管理IP，用于LAN数据转发 eth2 10.0.10.7 用于服务器间心跳连接（直连） VIP 10.0.0.17 用于提供应用程序A挂载服务 BACKUP eth0 10.0.0.8 外网管理IP，用于WAN数据转发 eth1 172.16.1.8 内网管理IP，用于LAN数据转发 eth2 10.0.10.8 用于服务器间心跳连接（直连） VIP 10.0.0.8 用于提供应用程序B挂载服务 下载安装haproxy 下载地址：http://www.haproxy.org/download/
文档地址：http://www.haproxy.org/download/1.7/doc/configuration.txt
编译haproxy bash 1 2 3 4 make TARGET=linux2628 ARCH=x86_64 # <==64位编译配置 make TARGET=linux2628 ARCH=i386 # <==32位编译配置 make PREFIX=/app/haproxy-1."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"详解haproxy","item":"https://www.oomkill.com/2017/11/haproxy/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"详解haproxy","name":"详解haproxy","description":"haproxy 介绍 haproxy是一个开源的、高性能的基于TCP和HTTP应用代理的高可用的、负载均衡服务软件，它支持双机热备、高可用、负载均衡、虚拟主机、基于TCP和HTTP的应用代理、图形界面查看信息等功能。其配置简单、维护方便，而且拥有很好的对服务器节点的健康检查功能(相当于keepalived健康检查)，当其代理的后端服务器出现故障时，haproxy会自动的将该故障服务器摘除，当故障的服务器恢复后，haproxy还会自动将该服务器自动加入进来提供服务。\nLVS/NGINX对比 haproxy 特别适用于那些高负载、访问量很大，但又需要会话保持及七层应用代理的业务应用。haproxy运行在今天的普通的服务器硬件上，几乎不需要进行任何的优化就可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单、轻松、安全的整合到各种己有的网站架构中，同时，haproxy的代理模式，可以使得所有应用服务器不会暴露到公共网络上，即后面的节点服务器不需要公网IP地址。\n从1.3版本起，haproxy软件引入了frontend,backend的功能，frontend (ad规则匹配)可以让运维管理人员根据任意HTTP请求头内容做规则匹配，然后把请求定向到相关的backend(这个是事先定义好的多个server pools，等待前端把请求转过来的服务器组)。通过frontend和backend，我们可以很容易的买现haproxy的各种7层应用代理功能。\nhaproxy代理模式 haproxy支持两种主要代理模式：\n1、基于4层的tcp应用代理(例如:可用于邮件服务、内部协议通信服务器、MySQL、HTTPS服务等)。\n2、基于7层的http代理。在4层tcp代理模式下，haproxy仅在客户端和服务器之间进行流量转发。但是在7层http代理模式下，haproxy会分析应用层协议，并且能通过允许、拒绝、交换、增加、修改或者删除请求(request)或者回应(response)里指定内容来控制协议。\n官方网站:www.haproxy.org\nhaproxy 解决方案拓扑图 haproxy L4负载均衡应用架构拓扑 haproxy软件的四层tcp应用代理非常优秀，且配置非常简单、方便，比LVS和Nginx的配置要简单很多，首先，配置haproxy不需要在RS端做任何特殊配置 (只要对应服务开启就OK)就可以实现应用代理，其次，haproxy的配置语法和增加虚拟主机功能等也比lvs/nginx简单。并且和商业版的NS (Netscaler)、F5, A10等负载均衡硬件的使用方法和在架构中的位置一模一样。下面是haproxy的Layer4层应用代理的拓扑结构图:\n说明:由于haproxy软件采用的是类NAT模式(本质不同)的应用代理，数据包来去都会经过haproxy，因此，在流量特别大的情况下(门户级别的流量)，其效率和性能不如LVS的DR模式负载均衡。\n在一般的中小型公司，建议采用haproxy做负载均衡，而不要使用LVS或Nginx。为什么强调中小型公司呢?换句话说，千万PV级别以下直接使用haproxy做负载均衡，会让我们负责维护的运维管理人员配置简单、快速、维护方便，出问题好排查。\nhaproxy L7负载均衡应用架构拓扑 haproxy软件的最大优势在于其7层的根据URL请求头应用过滤的功能以及sesson会话功能，在门户网站的高并发生产架构中，haproxy软件一般用在4层LVS负载均衡软件的下一层，或者像haproxy官方推荐的也可以挂在硬件负载均衡althon, NS, F5, A10下使用，其表现非常好。从2009年起taobao，京东商城的业务也大面积使用了haproxy作为7层CACHE应用代理。\n安装haproxy 模拟真实环境\n搭建合适的模拟环境是一个人学习能力的重要体现。例如：人类第一次上太空也没有真正的环境，但是想去太空就是要自己动手去搭建逼真的模拟环境。实验多了就是经验，自然就有解除生产环境的机会了。\n名称 接口 IP 用途 MASTER eth0 10.0.0.7 外网管理IP用于WAN数据转发 eth1 172.16.1.7 内网管理IP，用于LAN数据转发 eth2 10.0.10.7 用于服务器间心跳连接（直连） VIP 10.0.0.17 用于提供应用程序A挂载服务 BACKUP eth0 10.0.0.8 外网管理IP，用于WAN数据转发 eth1 172.16.1.8 内网管理IP，用于LAN数据转发 eth2 10.0.10.8 用于服务器间心跳连接（直连） VIP 10.0.0.8 用于提供应用程序B挂载服务 下载安装haproxy 下载地址：http://www.haproxy.org/download/\n文档地址：http://www.haproxy.org/download/1.7/doc/configuration.txt\n编译haproxy bash 1 2 3 4 make TARGET=linux2628 ARCH=x86_64 # \u0026lt;==64位编译配置 make TARGET=linux2628 ARCH=i386 # \u0026lt;==32位编译配置 make PREFIX=/app/haproxy-1.","keywords":["haproxy"],"articleBody":"haproxy 介绍 haproxy是一个开源的、高性能的基于TCP和HTTP应用代理的高可用的、负载均衡服务软件，它支持双机热备、高可用、负载均衡、虚拟主机、基于TCP和HTTP的应用代理、图形界面查看信息等功能。其配置简单、维护方便，而且拥有很好的对服务器节点的健康检查功能(相当于keepalived健康检查)，当其代理的后端服务器出现故障时，haproxy会自动的将该故障服务器摘除，当故障的服务器恢复后，haproxy还会自动将该服务器自动加入进来提供服务。\nLVS/NGINX对比 haproxy 特别适用于那些高负载、访问量很大，但又需要会话保持及七层应用代理的业务应用。haproxy运行在今天的普通的服务器硬件上，几乎不需要进行任何的优化就可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单、轻松、安全的整合到各种己有的网站架构中，同时，haproxy的代理模式，可以使得所有应用服务器不会暴露到公共网络上，即后面的节点服务器不需要公网IP地址。\n从1.3版本起，haproxy软件引入了frontend,backend的功能，frontend (ad规则匹配)可以让运维管理人员根据任意HTTP请求头内容做规则匹配，然后把请求定向到相关的backend(这个是事先定义好的多个server pools，等待前端把请求转过来的服务器组)。通过frontend和backend，我们可以很容易的买现haproxy的各种7层应用代理功能。\nhaproxy代理模式 haproxy支持两种主要代理模式：\n1、基于4层的tcp应用代理(例如:可用于邮件服务、内部协议通信服务器、MySQL、HTTPS服务等)。\n2、基于7层的http代理。在4层tcp代理模式下，haproxy仅在客户端和服务器之间进行流量转发。但是在7层http代理模式下，haproxy会分析应用层协议，并且能通过允许、拒绝、交换、增加、修改或者删除请求(request)或者回应(response)里指定内容来控制协议。\n官方网站:www.haproxy.org\nhaproxy 解决方案拓扑图 haproxy L4负载均衡应用架构拓扑 haproxy软件的四层tcp应用代理非常优秀，且配置非常简单、方便，比LVS和Nginx的配置要简单很多，首先，配置haproxy不需要在RS端做任何特殊配置 (只要对应服务开启就OK)就可以实现应用代理，其次，haproxy的配置语法和增加虚拟主机功能等也比lvs/nginx简单。并且和商业版的NS (Netscaler)、F5, A10等负载均衡硬件的使用方法和在架构中的位置一模一样。下面是haproxy的Layer4层应用代理的拓扑结构图:\n说明:由于haproxy软件采用的是类NAT模式(本质不同)的应用代理，数据包来去都会经过haproxy，因此，在流量特别大的情况下(门户级别的流量)，其效率和性能不如LVS的DR模式负载均衡。\n在一般的中小型公司，建议采用haproxy做负载均衡，而不要使用LVS或Nginx。为什么强调中小型公司呢?换句话说，千万PV级别以下直接使用haproxy做负载均衡，会让我们负责维护的运维管理人员配置简单、快速、维护方便，出问题好排查。\nhaproxy L7负载均衡应用架构拓扑 haproxy软件的最大优势在于其7层的根据URL请求头应用过滤的功能以及sesson会话功能，在门户网站的高并发生产架构中，haproxy软件一般用在4层LVS负载均衡软件的下一层，或者像haproxy官方推荐的也可以挂在硬件负载均衡althon, NS, F5, A10下使用，其表现非常好。从2009年起taobao，京东商城的业务也大面积使用了haproxy作为7层CACHE应用代理。\n安装haproxy 模拟真实环境\n搭建合适的模拟环境是一个人学习能力的重要体现。例如：人类第一次上太空也没有真正的环境，但是想去太空就是要自己动手去搭建逼真的模拟环境。实验多了就是经验，自然就有解除生产环境的机会了。\n名称 接口 IP 用途 MASTER eth0 10.0.0.7 外网管理IP用于WAN数据转发 eth1 172.16.1.7 内网管理IP，用于LAN数据转发 eth2 10.0.10.7 用于服务器间心跳连接（直连） VIP 10.0.0.17 用于提供应用程序A挂载服务 BACKUP eth0 10.0.0.8 外网管理IP，用于WAN数据转发 eth1 172.16.1.8 内网管理IP，用于LAN数据转发 eth2 10.0.10.8 用于服务器间心跳连接（直连） VIP 10.0.0.8 用于提供应用程序B挂载服务 下载安装haproxy 下载地址：http://www.haproxy.org/download/\n文档地址：http://www.haproxy.org/download/1.7/doc/configuration.txt\n编译haproxy bash 1 2 3 4 make TARGET=linux2628 ARCH=x86_64 # \u003c==64位编译配置 make TARGET=linux2628 ARCH=i386 # \u003c==32位编译配置 make PREFIX=/app/haproxy-1.7.5 install ln -s /app/haproxy-1.7.5/ /app/haproxy 配置内核转发功能 bash 1 2 net.ipv4_forward=1 # \u003c==基于NAT模式的负载均衡器都需要打开系统转发功能 sysctl -p haproxy启动命令 直接运行命令查看帮助\nbash 1 2 3 4 5 6 7 8 9 10 $ /app/haproxy/sbin/haproxy HA-Proxy version 1.7.5 2017/04/03 Copyright 2000-2017 Willy Tarreau Usage : haproxy [-f ","wordCount":"1422","inLanguage":"zh","datePublished":"2017-11-16T00:00:00Z","dateModified":"2022-11-28T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2017/11/haproxy/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">详解haproxy</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2017-11-16</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>1422 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>7 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/ha/>#HA</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#haproxy-%e4%bb%8b%e7%bb%8d aria-label="haproxy 介绍">haproxy 介绍</a><ul><li><a href=#lvsnginx%e5%af%b9%e6%af%94 aria-label=LVS/NGINX对比>LVS/NGINX对比</a><li><a href=#haproxy%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f aria-label=haproxy代理模式>haproxy代理模式</a></ul><li><a href=#haproxy-%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88%e6%8b%93%e6%89%91%e5%9b%be aria-label="haproxy 解决方案拓扑图">haproxy 解决方案拓扑图</a><ul><li><a href=#haproxy-l4%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%ba%94%e7%94%a8%e6%9e%b6%e6%9e%84%e6%8b%93%e6%89%91 aria-label="haproxy L4负载均衡应用架构拓扑">haproxy L4负载均衡应用架构拓扑</a><li><a href=#haproxy-l7%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e5%ba%94%e7%94%a8%e6%9e%b6%e6%9e%84%e6%8b%93%e6%89%91 aria-label="haproxy L7负载均衡应用架构拓扑">haproxy L7负载均衡应用架构拓扑</a></ul><li><a href=#%e5%ae%89%e8%a3%85haproxy aria-label=安装haproxy>安装haproxy</a><ul><li><a href=#%e4%b8%8b%e8%bd%bd%e5%ae%89%e8%a3%85haproxy aria-label=下载安装haproxy>下载安装haproxy</a><li><a href=#%e7%bc%96%e8%af%91haproxy aria-label=编译haproxy>编译haproxy</a><li><a href=#%e9%85%8d%e7%bd%ae%e5%86%85%e6%a0%b8%e8%bd%ac%e5%8f%91%e5%8a%9f%e8%83%bd aria-label=配置内核转发功能>配置内核转发功能</a><li><a href=#haproxy%e5%90%af%e5%8a%a8%e5%91%bd%e4%bb%a4 aria-label=haproxy启动命令>haproxy启动命令</a><li><a href=#haproxy%e6%9c%8d%e5%8a%a1%e8%84%9a%e6%9c%ac aria-label=haproxy服务脚本>haproxy服务脚本</a></ul><li><a href=#haproxy%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label=haproxy配置文件>haproxy配置文件</a><li><a href=#haproxy%e6%97%a5%e5%bf%97%e9%85%8d%e7%bd%ae aria-label=haproxy日志配置>haproxy日志配置</a><li><a href=#%e5%9f%ba%e4%ba%8e%e6%9d%83%e9%87%8d%e7%9a%84%e8%bd%ae%e8%ae%adround-robin aria-label="基于权重的轮训round robin">基于权重的轮训round robin</a><li><a href=#%e8%b4%9f%e8%bd%bd%e6%a8%a1%e5%bc%8f%e5%ae%9e%e9%aa%8c aria-label=负载模式实验>负载模式实验</a><ul><li><a href=#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87 aria-label=环境准备>环境准备</a><li><a href=#tcp%e8%b4%9f%e8%bd%bd%e6%a8%a1%e5%bc%8f%e9%85%8d%e7%bd%ae aria-label=TCP负载模式配置>TCP负载模式配置</a><li><a href=#tcp%e4%bb%a3%e7%90%86%e6%89%80%e5%87%ba%e7%8e%b0%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=TCP代理所出现的问题>TCP代理所出现的问题</a><ul><li><a href=#tcp%e6%a8%a1%e5%bc%8f%e5%bc%80%e5%90%afweb%e7%9b%91%e6%8e%a7%e9%a1%b5%e9%9d%a2%e5%87%ba%e7%8e%b0%e8%b4%9f%e8%bd%bd%e5%87%86%e9%97%ae%e9%a2%98 aria-label=tcp模式开启web监控页面出现负载准问题>tcp模式开启web监控页面出现负载准问题</a><li><a href=#%e4%bb%a3%e7%90%86ssh%e8%b4%9f%e8%bd%bd%e5%87%ba%e7%8e%b0%e5%a6%82%e4%b8%8b%e9%97%ae%e9%a2%98 aria-label=代理ssh负载出现如下问题>代理ssh负载出现如下问题</a></ul><li><a href=#l7%e4%bb%a3%e7%90%86%e5%ae%9e%e9%aa%8c aria-label=L7代理实验>L7代理实验</a></ul><li><a href=#acl aria-label=ACL>ACL</a><li><a href=#web-stats aria-label="web stats">web stats</a><li><a href=#socat%e5%8a%a8%e6%80%81%e6%93%8d%e4%bd%9chaproxy aria-label=socat动态操作haproxy>socat动态操作haproxy</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=haproxy-介绍>haproxy 介绍<a hidden class=anchor aria-hidden=true href=#haproxy-介绍>#</a></h2><p>haproxy是一个开源的、高性能的基于TCP和HTTP应用代理的高可用的、负载均衡服务软件，它支持双机热备、高可用、负载均衡、虚拟主机、基于TCP和HTTP的应用代理、图形界面查看信息等功能。其配置简单、维护方便，而且拥有很好的对服务器节点的健康检查功能(相当于keepalived健康检查)，当其代理的后端服务器出现故障时，haproxy会自动的将该故障服务器摘除，当故障的服务器恢复后，haproxy还会自动将该服务器自动加入进来提供服务。</p><h3 id=lvsnginx对比>LVS/NGINX对比<a hidden class=anchor aria-hidden=true href=#lvsnginx对比>#</a></h3><p>haproxy 特别适用于那些高负载、访问量很大，但又需要会话保持及七层应用代理的业务应用。haproxy运行在今天的普通的服务器硬件上，几乎不需要进行任何的优化就可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单、轻松、安全的整合到各种己有的网站架构中，同时，haproxy的代理模式，可以使得所有应用服务器不会暴露到公共网络上，即后面的节点服务器不需要公网IP地址。</p><p>从1.3版本起，haproxy软件引入了frontend,backend的功能，frontend (ad规则匹配)可以让运维管理人员根据任意HTTP请求头内容做规则匹配，然后把请求定向到相关的backend(这个是事先定义好的多个server pools，等待前端把请求转过来的服务器组)。通过frontend和backend，我们可以很容易的买现haproxy的各种7层应用代理功能。</p><h3 id=haproxy代理模式>haproxy代理模式<a hidden class=anchor aria-hidden=true href=#haproxy代理模式>#</a></h3><p>haproxy支持两种主要代理模式：</p><p>1、基于4层的tcp应用代理(例如:可用于邮件服务、内部协议通信服务器、MySQL、HTTPS服务等)。</p><p>2、基于7层的http代理。在4层tcp代理模式下，haproxy仅在客户端和服务器之间进行流量转发。但是在7层http代理模式下，haproxy会分析应用层协议，并且能通过允许、拒绝、交换、增加、修改或者删除请求(request)或者回应(response)里指定内容来控制协议。</p><p>官方网站:www.haproxy.org</p><h2 id=haproxy-解决方案拓扑图>haproxy 解决方案拓扑图<a hidden class=anchor aria-hidden=true href=#haproxy-解决方案拓扑图>#</a></h2><h3 id=haproxy-l4负载均衡应用架构拓扑>haproxy L4负载均衡应用架构拓扑<a hidden class=anchor aria-hidden=true href=#haproxy-l4负载均衡应用架构拓扑>#</a></h3><p>haproxy软件的四层tcp应用代理非常优秀，且配置非常简单、方便，比LVS和Nginx的配置要简单很多，首先，配置haproxy不需要在RS端做任何特殊配置 (只要对应服务开启就OK)就可以实现应用代理，其次，haproxy的配置语法和增加虚拟主机功能等也比lvs/nginx简单。并且和商业版的NS (Netscaler)、F5, A10等负载均衡硬件的使用方法和在架构中的位置一模一样。下面是haproxy的Layer4层应用代理的拓扑结构图:</p><hr><p>说明:由于haproxy软件采用的是类NAT模式(本质不同)的应用代理，数据包来去都会经过haproxy，因此，在流量特别大的情况下(门户级别的流量)，其效率和性能不如LVS的DR模式负载均衡。</p><hr><p>在一般的中小型公司，建议采用haproxy做负载均衡，而不要使用LVS或Nginx。为什么强调中小型公司呢?换句话说，千万PV级别以下直接使用haproxy做负载均衡，会让我们负责维护的运维管理人员配置简单、快速、维护方便，出问题好排查。</p><h3 id=haproxy-l7负载均衡应用架构拓扑>haproxy L7负载均衡应用架构拓扑<a hidden class=anchor aria-hidden=true href=#haproxy-l7负载均衡应用架构拓扑>#</a></h3><p>haproxy软件的最大优势在于其7层的根据URL请求头应用过滤的功能以及sesson会话功能，在门户网站的高并发生产架构中，haproxy软件一般用在4层LVS负载均衡软件的下一层，或者像haproxy官方推荐的也可以挂在硬件负载均衡althon, NS, F5, A10下使用，其表现非常好。从2009年起taobao，京东商城的业务也大面积使用了haproxy作为7层CACHE应用代理。</p><h2 id=安装haproxy>安装haproxy<a hidden class=anchor aria-hidden=true href=#安装haproxy>#</a></h2><p>模拟真实环境</p><p>搭建合适的模拟环境是一个人学习能力的重要体现。例如：人类第一次上太空也没有真正的环境，但是想去太空就是要自己动手去搭建逼真的模拟环境。实验多了就是经验，自然就有解除生产环境的机会了。</p><table><thead><tr><th>名称</th><th>接口</th><th>IP</th><th>用途</th></tr></thead><tbody><tr><td><font style=background:#659bfd size=3>MASTER</font></td><td>eth0</td><td>10.0.0.7</td><td>外网管理IP用于WAN数据转发</td></tr><tr><td></td><td>eth1</td><td>172.16.1.7</td><td>内网管理IP，用于LAN数据转发</td></tr><tr><td></td><td>eth2</td><td>10.0.10.7</td><td>用于服务器间心跳连接（直连）</td></tr><tr><td>VIP</td><td></td><td>10.0.0.17</td><td>用于提供应用程序A挂载服务</td></tr><tr><td><font style=background:#fee904 size=3>BACKUP</font></td><td>eth0</td><td>10.0.0.8</td><td>外网管理IP，用于WAN数据转发</td></tr><tr><td></td><td>eth1</td><td>172.16.1.8</td><td>内网管理IP，用于LAN数据转发</td></tr><tr><td></td><td>eth2</td><td>10.0.10.8</td><td>用于服务器间心跳连接（直连）</td></tr><tr><td>VIP</td><td></td><td>10.0.0.8</td><td>用于提供应用程序B挂载服务</td></tr></tbody></table><h3 id=下载安装haproxy>下载安装haproxy<a hidden class=anchor aria-hidden=true href=#下载安装haproxy>#</a></h3><p>下载地址：http://www.haproxy.org/download/</p><p>文档地址：http://www.haproxy.org/download/1.7/doc/configuration.txt</p><h3 id=编译haproxy>编译haproxy<a hidden class=anchor aria-hidden=true href=#编译haproxy>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>make <span class=nv>TARGET</span><span class=o>=</span>linux2628 <span class=nv>ARCH</span><span class=o>=</span>x86_64  <span class=c1># &lt;==64位编译配置</span>
</span></span><span class=line><span class=cl>make <span class=nv>TARGET</span><span class=o>=</span>linux2628 <span class=nv>ARCH</span><span class=o>=</span>i386    <span class=c1># &lt;==32位编译配置</span>
</span></span><span class=line><span class=cl>make <span class=nv>PREFIX</span><span class=o>=</span>/app/haproxy-1.7.5 install 
</span></span><span class=line><span class=cl>ln -s /app/haproxy-1.7.5/ /app/haproxy</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=配置内核转发功能>配置内核转发功能<a hidden class=anchor aria-hidden=true href=#配置内核转发功能>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>net.ipv4_forward<span class=o>=</span><span class=m>1</span>  <span class=c1># &lt;==基于NAT模式的负载均衡器都需要打开系统转发功能</span>
</span></span><span class=line><span class=cl>sysctl -p</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=haproxy启动命令>haproxy启动命令<a hidden class=anchor aria-hidden=true href=#haproxy启动命令>#</a></h3><p>直接运行命令查看帮助</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ /app/haproxy/sbin/haproxy
</span></span><span class=line><span class=cl>HA-Proxy version 1.7.5 2017/04/03
</span></span><span class=line><span class=cl>Copyright 2000-2017 Willy Tarreau &lt;willy@haproxy.org&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Usage : haproxy <span class=o>[</span>-f &lt;cfgfile<span class=p>|</span>cfgdir&gt;<span class=o>]</span>* <span class=o>[</span> -vdVD <span class=o>]</span> <span class=o>[</span> -n &lt;maxconn&gt; <span class=o>]</span> <span class=o>[</span> -N &lt;maxpconn&gt; <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>[</span> -p &lt;pidfile&gt; <span class=o>]</span> <span class=o>[</span> -m &lt;max megs&gt; <span class=o>]</span> <span class=o>[</span> -C &lt;dir&gt; <span class=o>]</span> <span class=o>[</span>-- &lt;cfgfile&gt;*<span class=o>]</span>
</span></span><span class=line><span class=cl>        -v displays version <span class=p>;</span> -vv shows known build options.
</span></span><span class=line><span class=cl>        -d enters debug mode <span class=p>;</span> -db only disables background mode.
</span></span><span class=line><span class=cl>        -dM<span class=o>[</span>&lt;byte&gt;<span class=o>]</span> poisons memory with &lt;byte&gt; <span class=o>(</span>defaults to 0x50<span class=o>)</span>
</span></span><span class=line><span class=cl>...</span></span></code></pre></td></tr></table></div></div></div></div><p>命令选项</p><table><thead><tr><th>选项</th><th>说明</th></tr></thead><tbody><tr><td>-D</td><td>以后台守护进程启动服务</td></tr><tr><td>-f</td><td>指定配置文件</td></tr><tr><td>-c</td><td>检查配置文件语法</td></tr><tr><td>-n</td><td>设置最大连接数，一般在配置文件中指定</td></tr><tr><td>-q</td><td>启动时不显示警告</td></tr><tr><td>-m</td><td>限制使用的内存量</td></tr><tr><td>-p</td><td>将pid写入文件</td></tr><tr><td>-sf</td><td>平滑重启</td></tr><tr><td>-st</td><td>强制重启</td></tr></tbody></table><p>注意 <code>-sf</code> 和 <code>-st</code> 重启时需要指定配置文件</p><h3 id=haproxy服务脚本>haproxy服务脚本<a hidden class=anchor aria-hidden=true href=#haproxy服务脚本>#</a></h3><p>在下载解压目录中有默认的启动脚本</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ll /root/tools/haproxy-1.7.5/examples/haproxy.init
</span></span><span class=line><span class=cl>/root/tools/haproxy-1.7.5/examples/haproxy.init</span></span></code></pre></td></tr></table></div></div></div></div><p>自定义启动脚本</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nv>BASE</span><span class=o>=</span>/app/haproxy
</span></span><span class=line><span class=cl><span class=nv>COMM</span><span class=o>=</span><span class=nv>$BASE</span>/sbin/haproxy
</span></span><span class=line><span class=cl><span class=nv>PIDFILE</span><span class=o>=</span><span class=nv>$BASE</span>/var/run/haproxy.pid
</span></span><span class=line><span class=cl><span class=nv>CONF_FILE</span><span class=o>=</span><span class=nv>$BASE</span>/conf/haproxy.conf1
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> in
</span></span><span class=line><span class=cl>	<span class=s1>&#39;start&#39;</span><span class=p>|</span><span class=s1>&#39;START&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>[</span> ! -f <span class=nv>$PIDFILE</span> <span class=o>]</span><span class=p>;</span><span class=k>then</span>
</span></span><span class=line><span class=cl>				<span class=nv>$COMM</span> -f <span class=nv>$CONF_FILE</span> -D
</span></span><span class=line><span class=cl>		<span class=k>else</span>
</span></span><span class=line><span class=cl>				<span class=nb>echo</span> <span class=s1>&#39;haproxy has been started&#39;</span>
</span></span><span class=line><span class=cl>		<span class=k>fi</span>
</span></span><span class=line><span class=cl>		<span class=p>;;</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;status&#39;</span><span class=p>|</span><span class=s1>&#39;STATUS&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>[</span> ! -f <span class=nv>$PIDFILE</span> <span class=o>]</span><span class=p>;</span><span class=k>then</span>
</span></span><span class=line><span class=cl>			<span class=nb>echo</span> <span class=s1>&#39;haproxy is not running&#39;</span>
</span></span><span class=line><span class=cl>			<span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>		<span class=k>fi</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> pid in <span class=k>$(</span>cat <span class=nv>$PIDFILE</span><span class=k>)</span><span class=p>;</span><span class=k>do</span>
</span></span><span class=line><span class=cl>			<span class=nb>kill</span> -0 <span class=nv>$pid</span>
</span></span><span class=line><span class=cl>			<span class=nv>RETVAL</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>[</span> <span class=nv>$RETVAL</span> <span class=o>==</span> <span class=m>0</span> <span class=o>]</span><span class=p>;</span><span class=k>then</span>
</span></span><span class=line><span class=cl>				<span class=nb>echo</span> <span class=s1>&#39;process &#39;</span><span class=nv>$pid</span> <span class=s1>&#39; not running&#39;</span>
</span></span><span class=line><span class=cl>			<span class=k>fi</span>
</span></span><span class=line><span class=cl>		<span class=k>done</span>
</span></span><span class=line><span class=cl>		<span class=nb>echo</span> <span class=s1>&#39;haproxy is running&#39;</span>
</span></span><span class=line><span class=cl>		<span class=p>;;</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;restart&#39;</span><span class=p>|</span><span class=s1>&#39;RESTART&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>		<span class=nv>$COMM</span> -f <span class=nv>$CONF_FILE</span> -sf <span class=k>$(</span>cat <span class=nv>$PIDFILE</span><span class=k>)</span>
</span></span><span class=line><span class=cl>		<span class=p>;;</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;stop&#39;</span><span class=p>|</span><span class=s1>&#39;STOP&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>kill</span> <span class=k>$(</span>cat <span class=nv>$PIDFILE</span><span class=k>)</span>
</span></span><span class=line><span class=cl>		rm -f <span class=nv>$PIDFILE</span>
</span></span><span class=line><span class=cl>		<span class=p>;;</span>
</span></span><span class=line><span class=cl>	<span class=s1>&#39;check&#39;</span><span class=p>|</span><span class=s1>&#39;CHECK&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>		<span class=nv>$COMM</span> -f <span class=nv>$CONF_FILE</span> -c
</span></span><span class=line><span class=cl>		<span class=p>;;</span>
</span></span><span class=line><span class=cl>	*<span class=o>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>echo</span> <span class=s2>&#34;USAGE </span><span class=nv>$0</span><span class=s2> start|stop|restart|status|check|&#34;</span>
</span></span><span class=line><span class=cl>		<span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>		<span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=k>esac</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=haproxy配置文件>haproxy配置文件<a hidden class=anchor aria-hidden=true href=#haproxy配置文件>#</a></h2><p>haproxy 的默认配置文件在下载解压目录下</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/root/tools/haproxy-1.7.5/examples</span></span></code></pre></td></tr></table></div></div></div></div><p>aproxy的配置文件可以分为5部分</p><ul><li><p>global：全局配置参数段，主要用来控制haproxy启动前的进程及系统相关设置。</p></li><li><p>default：配置一些默认参数，如果frontend，backend，listen等段未设置则使用default段配置。</p></li><li><p>listen：</p></li><li><p>frontend：用来匹配接受客户所请求的域名，uri等，并针对不同配置，做不同的请求处理。</p></li><li><p>backend：定义后端服务器集群，以及对后端 服务器的一切权重、队列、连接数等选项的设置。</p></li></ul><p>配置文件示例注释说明</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>global #&lt;==全局配置, 用于设定义全局参数, 属于进程级的配置, 通常与操作系统配置有关
	chroot  /app/haproxy/var/chroot #&lt;==运行路径
	daemon #&lt;==以守护方式运行haproxy
	user    haproxy #&lt;==运行haproxy用户/组, 或者使用关键字uid/gid
    group   haproxy
log		127.0.0.1 local0 debug 
# 全局日志配置指定127.0.0.1:514的syslog服务中local0日志设备。
# 与记录日志的模式[err warning info debug]
    pidfile /app/haproxy/var/run/haproxy.pid
    
maxconn	2000 
#设置每haproxy进程的最大并发连接数, 其等同于命令行选项“-n”; 
# “ulimit -n”自动计算的结果参照此参数设定.
    
    nbproc  1 #&lt;==启动的haproxy进程数量, 只能用于守护进程模式。应该设置为cup核数
    
# ulimit-n 655350  
# 设置每进程所能够打开的最大文件描述符数目。
# 默认情况其会自动进行计算, 因此不推荐修改此选项.    
    
  defaults #&lt;==默认配置

    mode http  #&lt;==默认的模式【tcp:4层； http:7层； health:只返回OK】
    
    log global #&lt;==继承全局的日志定义输出
      
    #option httplog #&lt;==日志类别, httplog
   
    # 如果后端服务器需要记录客户端真实ip, 需要在HTTP请求中添加”X-Forwarded-For”字段;
# 但haproxy自身的健康检测机制访问后端服务器时, 不应将记录访问日志。
# 可用except来排除127.0.0.0，即haproxy本身.
    #option forwardfor except 127.0.0.0/8
option forwardfor

option httpclose 
# 开启http协议中服务器端关闭功能每个请求完毕后主动关闭http通道。
# 使得支持长连接，使得会话可以被重用，使得每一个日志记录都会被记录.
 
    option dontlognull #&lt;==如果产生了一个空连接，那这个空连接的日志将不会记录.
    
    option redispatch	#&lt;==当与后端服务器的会话失败(服务器故障或其他原因)时, 把会话重新分发到其他健康的服务器上; 当故障服务器恢复时, 会话又被定向到已恢复的服务器上;
    
	retries 3  #&lt;==在判定会话失败时的尝试连接的次数
      
    option abortonclose #&lt;==当haproxy负载很高时, 自动结束掉当前队列处理比较久的连接.
   
    timeout http-request 10s #&lt;==默认http请求超时时间
	
    timeout queue 1m	#&lt;==默认队列超时时间, 后端服务器在高负载时, 会将haproxy发来的请求放进一个队列中.
    
    timeout connect 5s	#&lt;==haproxy与后端服务器连接超时时间.
    
    timeout client 1m	#&lt;==客户端与haproxy连接后, 数据传输完毕, 不再有数据传输, 即非活动连接的超时时间.
    
    timeout server 1m	#&lt;==haproxy与后端服务器非活动连接的超时时间.
    
    timeout http-keep-alive 10s #&lt;==默认新的http请求连接建立的超时时间，时间较短时可以尽快释放出资源，节约资源.
    
    timeout check 10s	#&lt;==心跳检测超时时间
      
    maxconn 2000	#&lt;==最大并发连接数
      
    #设置默认的负载均衡方式
    #balance source 
    #balnace leastconn

  listen admin_status 
  # 统计页面配置, frontend和backend的组合体。
  # 监控组的名称可按需自定义
    
    mode http #&lt;==监控运行模式
      
    bind 0.0.0.0:80	#&lt;==统计页面访问端口
      
    maxconn 10  #&lt;==统计页面默认最大连接数
      
    option httplog  #&lt;==#http日志格式
      
    stats enable   #&lt;==开启web统计
      
    stats hide-version 	#&lt;==隐藏统计页面上的haproxy版本信息
      
    stats refresh 30s	#&lt;==监控页面自动刷新时间
      
    stats uri /admin?status #&lt;==统计页面访问url
    
	stats auth admin:111	#&lt;==监控页面的用户和密码:admin, 可设置多个用户名
    
    stats realm hellow world #&lt;==统计页面密码框提示文本
    
    stats admin if TRUE	#&lt;==手工启动/禁用后端服务器, 可通过web管理节点
    
	#设置haproxy错误页面
    #errorfile 400 /usr/local/haproxy/errorfiles/400.http
    #errorfile 403 /usr/local/haproxy/errorfiles/403.http
    #errorfile 408 /usr/local/haproxy/errorfiles/408.http
    #errorfile 500 /usr/local/haproxy/errorfiles/500.http
    #errorfile 502 /usr/local/haproxy/errorfiles/502.http
    #errorfile 503 /usr/local/haproxy/errorfiles/503.http
    #errorfile 504 /usr/local/haproxy/errorfiles/504.http
	
	option forwardfor #&lt;==将用户的IP转发给监控的IP
	option httpchk HEAD /check.html HTTP/1.0 #&lt;==http的健康检查
	
  frontend  WEB_SITE  #&lt;==vip
	bind    *:80
	mode    http
	log     global
	option  httplog    
	option  httpclose  &lt;== http7层代理专用
	default_backend WWW
  backend WWW #&lt;==real server
	option forwardfor header X-REAL-IP
	option httpchk HEAD / HTTP/1.0  &lt;==检查real server是否存活的方式，[get post head]
	server web1 10.0.0.3:80 check inter 2000 rise 30 fall 15  
	server web2 www.test.com check inter 2000 rise 30 fall 15  
# inter为检查间隔 rise为连续30次检查成功则认为有效的。
# fall为连续15次检查失败则认为宕机</code></pre></div></div><h2 id=haproxy日志配置>haproxy日志配置<a hidden class=anchor aria-hidden=true href=#haproxy日志配置>#</a></h2><p><strong><font color=#f8070d size=3>CentOS 5.X</font></strong></p><p>编辑/etc/syslog.conf增加如下配置</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>local0.* /app/haproxy/logs/haproxy.log</span></span></code></pre></td></tr></table></div></div></div></div><p><strong><font color=#f8070d size=3>CentOS 6 & 7</font></strong></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>local0.* -/app/haproxy/logs/haproxy.log 
</span></span><span class=line><span class=cl><span class=c1># 将local0设备的日志定向到haproxy.log因为haproxy使用的local0</span></span></span></code></pre></td></tr></table></div></div></div></div><hr><p><font color=#0215cd size=3>注：使用了local0设备需要将 local0 在 <code>/var/log/message</code> 里制空，否则会记录双份</font></p><hr><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>*.info<span class=p>;</span>mail.none<span class=p>;</span>authpriv.none<span class=p>;</span>cron.none<span class=p>;</span>local0.none<span class=p>;</span>    /var/log/messages</span></span></code></pre></td></tr></table></div></div></div></div><p>修改/etc/sysconfig/syslog</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#-r enables logging from remote machines</span>
</span></span><span class=line><span class=cl><span class=c1># -x disables DNS lookups on messages recieved with -r</span>
</span></span><span class=line><span class=cl><span class=nv>SYSLOGD_OPTIONS</span><span class=o>=</span><span class=s2>&#34;-m 0 -r -c 2&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>重启后生效</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>/etc/init.d/syslog restart  <span class=c1># &lt;== CentOS 5</span>
</span></span><span class=line><span class=cl>/etc/init.d/rsyslog restart <span class=c1># &lt;== CentOS 6</span>
</span></span><span class=line><span class=cl>systemctl restart rsyslog   <span class=c1># &lt;== CentOS 7</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=http://www.cnblogs.com/aaa103439/p/3537163.html target=_blank rel="noopener nofollow noreferrer">http://www.cnblogs.com/aaa103439/p/3537163.html</a></p><p><a href=http://www.cnblogs.com/MacoLee/p/5853413.html target=_blank rel="noopener nofollow noreferrer">http://www.cnblogs.com/MacoLee/p/5853413.html</a></p><h2 id=基于权重的轮训round-robin>基于权重的轮训round robin<a hidden class=anchor aria-hidden=true href=#基于权重的轮训round-robin>#</a></h2><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>server web1 10.0.0.2 check  weight <span class=m>3</span>
</span></span><span class=line><span class=cl>server web1 10.0.0.3 check  weight <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>for</span> n in <span class=o>{</span>0..20<span class=o>}</span><span class=p>;</span><span class=k>do</span> curl 10.0.02<span class=p>;</span>sleep <span class=m>1</span> <span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>leastconn&ndash;> 类似于 lvs中 的 wlc</p><p>不过这里只考虑活动连接数，即选择活动连接数少的。另外，最好在长连接会话中使用，如sql,ldap</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221213234451180.gif><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221213234451180.gif#center alt=image-20221213234451180 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><h2 id=负载模式实验>负载模式实验<a hidden class=anchor aria-hidden=true href=#负载模式实验>#</a></h2><h3 id=环境准备>环境准备<a hidden class=anchor aria-hidden=true href=#环境准备>#</a></h3><table><thead><tr><th>IP</th><th>地位</th></tr></thead><tbody><tr><td>10.0.0.2</td><td>haproxy</td></tr><tr><td>10.0.0.1</td><td>real server 1</td></tr><tr><td>10.0.0.3</td><td>real server 2</td></tr></tbody></table><h3 id=tcp负载模式配置>TCP负载模式配置<a hidden class=anchor aria-hidden=true href=#tcp负载模式配置>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>frontend  WEB_SITE  <span class=c1>#&lt;==vip</span>
</span></span><span class=line><span class=cl>  <span class=nb>bind</span> *:80
</span></span><span class=line><span class=cl>  mode    tcp
</span></span><span class=line><span class=cl>  log     global
</span></span><span class=line><span class=cl>  default_backend WWW
</span></span><span class=line><span class=cl>backend WWW <span class=c1>#&lt;==real server</span>
</span></span><span class=line><span class=cl>  server web1 10.0.0.3:52113 check inter <span class=m>2000</span> rise <span class=m>3</span> fall <span class=m>5</span>
</span></span><span class=line><span class=cl>  server web2 10.0.0.1:52113 check inter <span class=m>2000</span> rise <span class=m>3</span> fall <span class=m>5</span></span></span></code></pre></td></tr></table></div></div></div></div><hr><p><font color=#0215cd size=3>注意：listen可以看做是frontend与bankend的集合，顾如果使用tcp模式代理的话，不要开启web监控</font></p><hr><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-tcp_2.gif><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-tcp_2.gif#center alt=image-20221213234451180 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><h3 id=tcp代理所出现的问题>TCP代理所出现的问题<a hidden class=anchor aria-hidden=true href=#tcp代理所出现的问题>#</a></h3><h4 id=tcp模式开启web监控页面出现负载准问题>tcp模式开启web监控页面出现负载准问题<a hidden class=anchor aria-hidden=true href=#tcp模式开启web监控页面出现负载准问题>#</a></h4><p>开启web监控页面的haproxy日志</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>May <span class=m>19</span> 22:41:02 127.0.0.1 haproxy<span class=o>[</span>2579<span class=o>]</span>: Connect from 192.168.2.1:50820 to 10.0.0.2:80 <span class=o>(</span>WEB_SITE/TCP<span class=o>)</span>
</span></span><span class=line><span class=cl>May <span class=m>19</span> 22:41:02 127.0.0.1 haproxy<span class=o>[</span>2579<span class=o>]</span>: Connect from 192.168.2.1:50820 to 10.0.0.2:80 <span class=o>(</span>WEB_SITE/TCP<span class=o>)</span>
</span></span><span class=line><span class=cl>May <span class=m>19</span> 22:41:02 127.0.0.1 haproxy<span class=o>[</span>2578<span class=o>]</span>: 192.168.2.1:50821 <span class=o>[</span>19/May/2017:22:41:02.405<span class=o>]</span> admin_status admin_status/&lt;STATS&gt; 0/0/0/0/1 <span class=m>200</span> <span class=m>16975</span> - - LR-- 0/0/0/0/0 0/0 <span class=s2>&#34;GET /admin?status HTTP/1.1&#34;</span>
</span></span><span class=line><span class=cl>May <span class=m>19</span> 22:41:02 127.0.0.1 haproxy<span class=o>[</span>2579<span class=o>]</span>: Connect from 192.168.2.1:50822 to 10.0.0.2:80 <span class=o>(</span>WEB_SITE/TCP<span class=o>)</span>
</span></span><span class=line><span class=cl>May <span class=m>19</span> 22:41:02 127.0.0.1 haproxy<span class=o>[</span>2579<span class=o>]</span>: Connect from 192.168.2.1:50822 to 10.0.0.2:80 <span class=o>(</span>WEB_SITE/TCP<span class=o>)</span>
</span></span><span class=line><span class=cl>May <span class=m>19</span> 22:41:02 127.0.0.1 haproxy<span class=o>[</span>2579<span class=o>]</span>: 192.168.2.1:50823 <span class=o>[</span>19/May/2017:22:41:02.816<span class=o>]</span> admin_status admin_status/&lt;STATS&gt; 0/0/0/0/1 <span class=m>200</span> <span class=m>16996</span> - - LR-- 0/0/0/0/0 0/0 <span class=s2>&#34;GET /admin?status HTTP/1.1&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=代理ssh负载出现如下问题>代理ssh负载出现如下问题<a hidden class=anchor aria-hidden=true href=#代理ssh负载出现如下问题>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span></span><span class=line><span class=cl>@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
</span></span><span class=line><span class=cl>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
</span></span><span class=line><span class=cl>IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
</span></span><span class=line><span class=cl>Someone could be eavesdropping on you right now <span class=o>(</span>man-in-the-middle attack<span class=o>)</span>!
</span></span><span class=line><span class=cl>It is also possible that a host key has just been changed.
</span></span><span class=line><span class=cl>The fingerprint <span class=k>for</span> the RSA key sent by the remote host is
</span></span><span class=line><span class=cl>11:f2:f1:05:1e:80:0a:bf:9f:09:20:3f:02:e1:12:b8.
</span></span><span class=line><span class=cl>Please contact your system administrator.
</span></span><span class=line><span class=cl>Add correct host key in /root/.ssh/known_hosts to get rid of this message.
</span></span><span class=line><span class=cl>Offending RSA key in /root/.ssh/known_hosts:1
</span></span><span class=line><span class=cl>RSA host key <span class=k>for</span> <span class=o>[</span>10.0.0.2<span class=o>]</span>:80 has changed and you have requested strict checking.
</span></span><span class=line><span class=cl>Host key verification failed.</span></span></code></pre></td></tr></table></div></div></div></div><p>出现此问题是因为，登陆ssh时使用的是vip，而真正的server是两个，当登陆第一台server时，将指纹保存到vip，当轮训到第二台时，因为已经保存过其他server的指纹了，会提示指纹改变。所以这个不算是问题</p><h3 id=l7代理实验>L7代理实验<a hidden class=anchor aria-hidden=true href=#l7代理实验>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>frontend  WEB_SITE  #&lt;==vip
  bind *:80
  mode    http
  option  httplog
  option  httpclose
  log     global
  default_backend WWW
backend WWW #&lt;==real server
  server web1 10.0.0.3:52113 check inter 2000 rise 3 fall 5
  server web2 10.0.0.1:52113 check inter 2000 rise 3 fall 5</code></pre></div></div><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-http.gif><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-http.gif#center alt=image-20221213234451180 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><h2 id=acl>ACL<a hidden class=anchor aria-hidden=true href=#acl>#</a></h2><p>ACL名称必须由 大小写字母、数字、”-“（破折号）、“_”（下划线）、“.”（点）和 ”:“（冒号）。 ACL名称区分大小写，这意味着 “my_acl” 和 “My_Acl” 是两个不同的ACL。ACL的数量没有强制限制。未使用的不影响性能，他们只是消耗少量的内存。</p><hr><p>注：在http代理模式中uri的请求会被分配到real server的实体路径中</p><hr><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acl &lt;aclname&gt; &lt;criterion&gt; <span class=o>[</span>flags<span class=o>]</span> <span class=o>[</span>operator<span class=o>]</span> &lt;value&gt; ... </span></span></code></pre></td></tr></table></div></div></div></div><p>参数说明：</p><ul><li><p>&lt;aclname> &lt;==ACL名称；</p></li><li><p>&lt;criterion>：测试标准，即对什么信息发起测试；测试方式可以由 [flags] 指定的标志进行调整；而有些测试标准也可以需要为其在之前指定一个操作符 [operator]；</p></li></ul><p>ACL的flag：</p><ul><li>-i：在匹配所有后续模式时忽略大小写。</li><li>-f：从文件加载模式。</li><li>-m：使用特定的模式匹配方法</li><li>-n：禁止DNS解析</li><li>-M：像地图文件一样加载-f指向的文件。</li><li>&ndash; ：强制结束标志。 当字符串看起来像其中一个标志时很有用。</li><li>-u：强制ACL的唯一ID</li></ul><p>&lt;value>：acl测试条件支持的值有以下四类：</p><ol><li>整数或整数范围：如 1024:65535 表示从 1024~65535；仅支持使用正整数(如果出现类似小数的标识，其为通常为版本测试)，且支持使用的操作符有5个，分别为eq、ge、gt、le和lt；</li><li>字符串：支持使用 “-i” 以忽略字符大小写，支持使用 “\” 进行转义；如果在模式首部出现了-i，可以在其之前使用“–”标志位；</li><li>正则表达式：其机制类同字符串匹配；</li><li>IP地址及网络地址</li></ol><p>常用的测试标准(criteria)</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>be_sess_rate<span class=o>(</span>backend<span class=o>)</span> &lt;integer&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>用于测试指定的backend上会话创建的速率(即每秒创建的会话数)是否满足指定的条件；常用于在指定backend上的会话速率过高时将用户请求转发至另外的backend，或用于阻止攻击行为。</p><p>例如：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>acl being_scanned be_sess_rate gt <span class=m>50</span>  <span class=c1># &lt;==此方案是定义在backend里的</span>
</span></span><span class=line><span class=cl>redirect location /error_pages/denied.html <span class=k>if</span> being_scanned</span></span></code></pre></td></tr></table></div></div></div></div><p>sd</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>fe_sess_rate<span class=o>(</span>frontend<span class=o>)</span> &lt;integer&gt;</span></span></code></pre></td></tr></table></div></div></div></div><p>用于测试指定的frontend(或当前frontend)上的会话创建速率是否满足指定的条件；</p><p>常用于为frontend指定一个合理的会话创建速率的上限以防止服务被滥用。例如下面的例子限定入站邮件速率不能大于50封/秒，所有在此指定范围之外的请求都将被延时50毫秒。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>frontend mail
    bind :25
    mode tcp
    maxconn 500
    acl too_fast fe_sess_rate ge 50
    tcp-request inspect-delay 50ms
    tcp-request content accept if ! too_fast
    tcp-request content accept if WAIT_END</code></pre></div></div><p>hdr &lt;string></p><p>用于测试请求报文中的所有首部或指定首部是否满足指定的条件；指定首部时，其名称不区分大小写，且在括号 “()” 中不能有任何多余的空白字符。测试服务器端的响应报文时可以使用 <code>shdr()</code>。例如下面的例子用于测试首部Connection的值是否为close。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>acl url_bao hdr(Host) -i www.baidu.com</code></pre></div></div><p>method &lt;string></p><p>测试HTTP请求报文中使用的方法。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>front test
  use_backend front
  acl me method get
  default_backend back
backend front
  server web01 10.0.0.1:8080 check port 8080 inter 5000 fall 5
backend back
  server w1 10.0.0.3:8080 check port 8080 inter 5000 fall 5</code></pre></div></div><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221214000225672.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221214000225672.png#center alt=image-20221214000225672 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>path_beg &lt;string></p><p>用于测试请求的URL是否以指定的模式开头。</p><p>下面的例子用于测试URL是否以/static、/images、/javascript或/stylesheets头。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>acl url_static path_beg -i /static /images /javascript /stylesheets</code></pre></div></div><p>path_end &lt;string></p><p>用于测试请求的URL是否以指定的模式结尾。</p><p>例如，下面的例子用户测试URL是否以jpg、gif、png、css或js结尾</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>acl url_static path_end -i .jpg .gif .png .css .js</code></pre></div></div><p>hdr_beg &lt;string></p><p>用于测试请求报文的指定首部的开头部分是否符合指定的模式。</p><p>例如，下面的例子用记测试请求是否为提供静态内容的主机img、video、download或ftp。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>acl host_static hdr_beg(host) -i img. video. download. ftp.</code></pre></div></div><p>请求uri中包含static</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>acl timetask_req url_dir -i timetask</code></pre></div></div><p>请求头长度</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>acl cl hdr_cnt(Content-length) eq 0</code></pre></div></div><h2 id=web-stats>web stats<a hidden class=anchor aria-hidden=true href=#web-stats>#</a></h2><p>添加一个 <strong>frontend</strong></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>frontend stats
</span></span><span class=line><span class=cl>	<span class=c1># 必填参数，默认无法访问</span>
</span></span><span class=line><span class=cl>    mode http   
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 统计页面访问端口</span>
</span></span><span class=line><span class=cl>    <span class=nb>bind</span> 0.0.0.0:1080
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 统计页面默认最大连接数</span>
</span></span><span class=line><span class=cl>    maxconn <span class=m>10</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># http日志格式</span>
</span></span><span class=line><span class=cl>    option httplog
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 开启web统计</span>
</span></span><span class=line><span class=cl>    stats <span class=nb>enable</span>
</span></span><span class=line><span class=cl>    <span class=c1># 隐藏统计页面上的haproxy版本信息</span>
</span></span><span class=line><span class=cl>    stats hide-version
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 监控页面自动刷新时间</span>
</span></span><span class=line><span class=cl>    stats refresh 30s
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 统计页面访问url</span>
</span></span><span class=line><span class=cl>    stats uri /admin?status
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 监控页面的用户和密码:admin, 可设置多个用户名</span>
</span></span><span class=line><span class=cl>    stats auth admin:111
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 统计页面密码框提示文本,某些浏览器不适合中文</span>
</span></span><span class=line><span class=cl>    stats realm mCloud<span class=se>\ </span>Haproxy
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 手工启动/禁用后端服务器, 可通过web管理节点</span>
</span></span><span class=line><span class=cl>    stats admin <span class=k>if</span> TRUE</span></span></code></pre></td></tr></table></div></div></div></div><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/wps8A90.tmp.jpg><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/wps8A90.tmp.jpg#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221214000411609.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221214000411609.png#center alt=image-20221214000411609 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><h2 id=socat动态操作haproxy>socat动态操作haproxy<a hidden class=anchor aria-hidden=true href=#socat动态操作haproxy>#</a></h2><p>socat是一个多功能的网络工具软件，名字来由是”Socket CAT”，功能与netcat类似，可以看做netcat的加强版。</p><p><strong>配置haproxy</strong></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>stats socket /app/haproxy/var/run/haproxy.sock mode <span class=m>600</span> level admin
</span></span><span class=line><span class=cl>stats timeout 2m</span></span></code></pre></td></tr></table></div></div></div></div><p><strong>安装socat</strong></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install socat -y</span></span></code></pre></td></tr></table></div></div></div></div><p><strong>远程操作haproxy</strong></p><p>socat帮助</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> help<span class=p>|</span>socat stdio /app/haproxy/var/run/haproxy.sock</span></span></code></pre></td></tr></table></div></div></div></div><p>上线测试摘取集群节点</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> disable server back/w1 <span class=p>|</span>socat stdio /app/haproxy/var/run/haproxy.sock
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nb>enable</span> server back/w1 <span class=p>|</span>socat stdio /app/haproxy/var/run/haproxy.sock</span></span></code></pre></td></tr></table></div></div></div></div><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-socat.gif><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-socat.gif#center alt=image-20221213234451180 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：详解haproxy</p><p>文章链接：<a href=https://www.oomkill.com/2017/11/haproxy/ target=_blank>https://www.oomkill.com/2017/11/haproxy/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2017/02/keepalived/><span>Keepalived 高可用集群应用实践</span></a></li><li><a href=/2017/01/lvs-and-keepalived/><span>LVS & keepalived 集群架构</span></a></li><li><a href=/2016/11/heartbeat/><span>heartbeat权威指南</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/ha/>HA</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2018/02/jenkins-github-tag/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>jenkins github tag使用方式</span>
</a><a class=next href=https://www.oomkill.com/2017/05/ch8-mysql-engine/><span class=title></span>
<span>ch08 - MySQL存储引擎&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/blogs","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/haproxy","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>