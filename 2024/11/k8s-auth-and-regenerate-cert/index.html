<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>TLS Everywhere - 解密kubernetes集群的安全认证 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="kubernetes,cert,auth,证书更换"><meta name=description content="本文是关于Kubernetes 4A解析的第5章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A
在 kubernetes 集群中，所有的通讯都是用 TLS 进行加密和认证，本文使用一次老集群（二进制部署集群）证书更换作为记录，通过这种方式深入对 kubernetes 的认证方式来了解更换证书的步骤，以及一次模拟老集群的更换步骤。
本文使用证书生成工具为 “kubernetes-generator” [1] 专用于 k8s 二进制部署生成证书和安装包的工具。
note 本文中的引用文档使用 web.archive 进行保存，避免官方版本更新，其概念与文档中的概念有变动导致，资料引用失败。 Kubernetes认证方式 为了了解证书更换需要做那些步骤，所以必须了解 k8s 的认证方式，这样才能更好的在更换证书时对集群上部署的业务系统的影响降低到最低。
X509 证书 kube-apiserver 的启动参数 --client-ca-file，可以使用客户端办法机构，英文代号就是熟悉的 “CA” (Certificate authority)，当这个证书传递后，可以验证 kube-apiserver 用于验证向 kube-apiserver 提供的客户端证书，这里包含 k8s 中提供的用户种类的两种：
用户名：对应证书的 CN (Common Name) 用户组：对应证书的O (organization)，用于对一个用户组进行授权，例如 “system:masters” 表示一个组 [1]，允许不受限制地访问 kube-apiserver 静态token kube-apiserver 的启动参数 --token-auth-file，是以文件提供给 kube-apiserver，该 Token 会长期有效，并且如果不重启服务 Token 是不会更新。"><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2024/11/k8s-auth-and-regenerate-cert/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2024/11/k8s-auth-and-regenerate-cert/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-H94HZ5S19Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H94HZ5S19Y")</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="TLS Everywhere - 解密kubernetes集群的安全认证"><meta property="og:description" content="本文是关于Kubernetes 4A解析的第5章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A
在 kubernetes 集群中，所有的通讯都是用 TLS 进行加密和认证，本文使用一次老集群（二进制部署集群）证书更换作为记录，通过这种方式深入对 kubernetes 的认证方式来了解更换证书的步骤，以及一次模拟老集群的更换步骤。
本文使用证书生成工具为 “kubernetes-generator” [1] 专用于 k8s 二进制部署生成证书和安装包的工具。
note 本文中的引用文档使用 web.archive 进行保存，避免官方版本更新，其概念与文档中的概念有变动导致，资料引用失败。 Kubernetes认证方式 为了了解证书更换需要做那些步骤，所以必须了解 k8s 的认证方式，这样才能更好的在更换证书时对集群上部署的业务系统的影响降低到最低。
X509 证书 kube-apiserver 的启动参数 --client-ca-file，可以使用客户端办法机构，英文代号就是熟悉的 “CA” (Certificate authority)，当这个证书传递后，可以验证 kube-apiserver 用于验证向 kube-apiserver 提供的客户端证书，这里包含 k8s 中提供的用户种类的两种：
用户名：对应证书的 CN (Common Name) 用户组：对应证书的O (organization)，用于对一个用户组进行授权，例如 “system:masters” 表示一个组 [1]，允许不受限制地访问 kube-apiserver 静态token kube-apiserver 的启动参数 --token-auth-file，是以文件提供给 kube-apiserver，该 Token 会长期有效，并且如果不重启服务 Token 是不会更新。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2024/11/k8s-auth-and-regenerate-cert/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-24T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-30T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="TLS Everywhere - 解密kubernetes集群的安全认证"><meta name=twitter:description content="本文是关于Kubernetes 4A解析的第5章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A
在 kubernetes 集群中，所有的通讯都是用 TLS 进行加密和认证，本文使用一次老集群（二进制部署集群）证书更换作为记录，通过这种方式深入对 kubernetes 的认证方式来了解更换证书的步骤，以及一次模拟老集群的更换步骤。
本文使用证书生成工具为 “kubernetes-generator” [1] 专用于 k8s 二进制部署生成证书和安装包的工具。
note 本文中的引用文档使用 web.archive 进行保存，避免官方版本更新，其概念与文档中的概念有变动导致，资料引用失败。 Kubernetes认证方式 为了了解证书更换需要做那些步骤，所以必须了解 k8s 的认证方式，这样才能更好的在更换证书时对集群上部署的业务系统的影响降低到最低。
X509 证书 kube-apiserver 的启动参数 --client-ca-file，可以使用客户端办法机构，英文代号就是熟悉的 “CA” (Certificate authority)，当这个证书传递后，可以验证 kube-apiserver 用于验证向 kube-apiserver 提供的客户端证书，这里包含 k8s 中提供的用户种类的两种：
用户名：对应证书的 CN (Common Name) 用户组：对应证书的O (organization)，用于对一个用户组进行授权，例如 “system:masters” 表示一个组 [1]，允许不受限制地访问 kube-apiserver 静态token kube-apiserver 的启动参数 --token-auth-file，是以文件提供给 kube-apiserver，该 Token 会长期有效，并且如果不重启服务 Token 是不会更新。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"TLS Everywhere - 解密kubernetes集群的安全认证","item":"https://www.oomkill.com/2024/11/k8s-auth-and-regenerate-cert/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"TLS Everywhere - 解密kubernetes集群的安全认证","name":"TLS Everywhere - 解密kubernetes集群的安全认证","description":"本文是关于Kubernetes 4A解析的第5章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A\n在 kubernetes 集群中，所有的通讯都是用 TLS 进行加密和认证，本文使用一次老集群（二进制部署集群）证书更换作为记录，通过这种方式深入对 kubernetes 的认证方式来了解更换证书的步骤，以及一次模拟老集群的更换步骤。\n本文使用证书生成工具为 “kubernetes-generator” [1] 专用于 k8s 二进制部署生成证书和安装包的工具。\nnote 本文中的引用文档使用 web.archive 进行保存，避免官方版本更新，其概念与文档中的概念有变动导致，资料引用失败。 Kubernetes认证方式 为了了解证书更换需要做那些步骤，所以必须了解 k8s 的认证方式，这样才能更好的在更换证书时对集群上部署的业务系统的影响降低到最低。\nX509 证书 kube-apiserver 的启动参数 --client-ca-file，可以使用客户端办法机构，英文代号就是熟悉的 “CA” (Certificate authority)，当这个证书传递后，可以验证 kube-apiserver 用于验证向 kube-apiserver 提供的客户端证书，这里包含 k8s 中提供的用户种类的两种：\n用户名：对应证书的 CN (Common Name) 用户组：对应证书的O (organization)，用于对一个用户组进行授权，例如 “system:masters” 表示一个组 [1]，允许不受限制地访问 kube-apiserver 静态token kube-apiserver 的启动参数 --token-auth-file，是以文件提供给 kube-apiserver，该 Token 会长期有效，并且如果不重启服务 Token 是不会更新。","keywords":["kubernetes","cert","auth","证书更换"],"articleBody":" 本文是关于Kubernetes 4A解析的第5章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A\n在 kubernetes 集群中，所有的通讯都是用 TLS 进行加密和认证，本文使用一次老集群（二进制部署集群）证书更换作为记录，通过这种方式深入对 kubernetes 的认证方式来了解更换证书的步骤，以及一次模拟老集群的更换步骤。\n本文使用证书生成工具为 “kubernetes-generator” [1] 专用于 k8s 二进制部署生成证书和安装包的工具。\nnote 本文中的引用文档使用 web.archive 进行保存，避免官方版本更新，其概念与文档中的概念有变动导致，资料引用失败。 Kubernetes认证方式 为了了解证书更换需要做那些步骤，所以必须了解 k8s 的认证方式，这样才能更好的在更换证书时对集群上部署的业务系统的影响降低到最低。\nX509 证书 kube-apiserver 的启动参数 --client-ca-file，可以使用客户端办法机构，英文代号就是熟悉的 “CA” (Certificate authority)，当这个证书传递后，可以验证 kube-apiserver 用于验证向 kube-apiserver 提供的客户端证书，这里包含 k8s 中提供的用户种类的两种：\n用户名：对应证书的 CN (Common Name) 用户组：对应证书的O (organization)，用于对一个用户组进行授权，例如 “system:masters” 表示一个组 [1]，允许不受限制地访问 kube-apiserver 静态token kube-apiserver 的启动参数 --token-auth-file，是以文件提供给 kube-apiserver，该 Token 会长期有效，并且如果不重启服务 Token 是不会更新。\ntip 通常情况下，应避免使用静态 token 功能。 令牌文件的定义必须符合 [a-z0-9]{6}\\.[a-z0-9]{16} 的格式，以 “.” 分割，第一部分是 “Token ID”； 第二部分是“令牌秘密（Token Secret” ；其后是这个用户的 Group，Group 可以包含多个，如果包含多个，则对应的列必须用双引号括起来。\nbash 1 2 token,user,uid,group token,user,uid,\"group1,group2,group3\" 例如\nbash 1 123456.1234567890abcdef,dev,1,system:masters note system:masters 除非有必要，否则，应避免向该组分发证书。该组用户无法通过 ClusterRole 和 clusterRoleBinding 来控制权限，即使删除了所有集群角色，或者从来就没有分配过集群角色。该组的用户，仍然可以直接请求 kube-apiserver 执行任何操作。 使用时可以这样传入\nbash 1 2 curl -k -X GET https://:6443/api/v1/nodes \\ -H \"Authorization: Bearer 3c9984.b947d02c14fe0a7f\" Bootstrap Tokens Bootstrap Tokens 和 “静态Token”是属于相同类型，并存在于kube-system 名称空间中 Secret, 他的类型是 bootstrap.kubernetes.io/token ，==这种设计是为了能够支持 kubeadm==。 的情况下启动集群。[3]\nBootstrap Tokens 和 静态 token 是相同的格式类型，这里就不多做阐述。\n这里我们看一下我们生成的 kubelet 相关证书与配置文件\nkubelet $ cat kubelet # kubernetes kubelet config # # You can add your configuration own! KUBELET_ARGS=\"--v=0 \\ --logtostderr=true \\ --network-plugin=cni \\ --config=/etc/kubernetes/kubelet-config.yaml \\ --kubeconfig=/etc/kubernetes/auth/kubelet.conf \\ --cgroup-driver=cgroupfs \\ --bootstrap-kubeconfig=/etc/kubernetes/auth/bootstrap.conf\" 再查看一下 /etc/kubernetes/auth/bootstrap.conf 的配置文件\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 clusters: - cluster: certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNxRENDQVpBQ0UwYlFJV1BEazYwK3dib05ZczJnZzA0bkM1QXdEUVlKS29aSWh2Y05BUUVMQlFBd0VURVAKTUEwR0ExVUVBd3dHYXpoekxXTmhNQjRYRFRJME1URXlNekF4TVRnMU9Gb1hEVEkwTVRFeU5EQXhNVGcxT0ZvdwpFVEVQTUEwR0ExVUVBd3dHYXpoekxXTmhNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDCkFRRUFuZ1hXRzBpK3N0WXpwRjYyMzJZNlpEZGZjOVZIR3M0THRWbU5sT1RSWnVWeGplZ2JySnhnTGVwLzNvalcKYWNDWWJpejZ1WmdTcEZHWmwrV3RKWXZMaURlOU5iampuaTgzWUYyYWY1MDVBT2gvNjMwc1Z5L2pIdWhvVGNQeApkOVc3YW42TlFiYlF0eVhlaVNHMldDdDlnbmlmdlpnN3VPbzdZYUhqc2pMYWtRbUt6WUhhKy9KaGFHR09LOEFtCkVxay9IV3grR3FSMnFpVDBXbndkTXhWdnluRFNwYTBrTGt6dWZsbFNtTktPL3VxbTQ2azBpWWNta1h4TWF2SlEKQjNQTVF5aFdtOFRJRVdGUWcvTWE0ZytMdDdJcjh2dmIwRWlyemtOZVFtRFJyaHN4K1hieHlUdnpBRVE2aE9MMgpvMldNR09CZGpIdVlSc0NzQW9abE1JdFFoUUlEQVFBQk1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQTN4NlpWCjJZNjlhTWtKYmJpQnA0RmM3YkRaektadk9xOWp2aUgwTjIvNERId2tPQ3FzenlOSkRkN3hVTUV4NE1BSGp0Vm4KSWVOSit4Sk4xM010eW1lYlhkbEw1b2pDTHArTkZSeEdibXdqM2tSUFBUQ3JZa3NEcGdReGlXVjZ5U2ZXMUNsdAo3UmowOU5jTEpqaU1aMjQyVW9qMzh0dmpEdkw3OFdod0FZb2VSaFBMcHptUndPc0plem9ON2FXZ0FXMDJsM0ZxCm9xVFFDUkJ2SkNDSjhMM09IVmZOYW9vNmI0YzNDbVM2RVdXdThuQmYxNHJVaTJNWCszSGJpbVg2R0w4ZTVnbTYKTXp4Q2VKcGxkbndYeDVRekdPWnpzQ1VQZ2xMRFdhMkxBRzg4V0VFVlRqWkVXbDdZZXVrdTBLV2tVSCs0VjR3WQpsbmFnNFM3ZWw0cFMwRVgrCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K server: https://10.0.0.4:6443 name: kubernetes contexts: - context: cluster: kubernetes user: system:bootstrapper name: system:bootstrapper@kubernetes current-context: system:bootstrapper@kubernetes kind: Config preferences: {} users: - name: system:bootstrapper user: token: 3c9984.b947d02c14fe0a7f 可以用命令去求证 certificate-authority-data 是否与 CA 一致。\nbash 1 openssl x509 -noout -text -in \u003c(grep 'certificate-authority-data:' auth/bootstrap.conf | awk '{print $2}'|base64 -d) 使用命令可以查询到这个 bootstrap token 可以操作的权限\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 $ kubectl --token 3c9984.b947d02c14fe0a7f auth can-i --kubeconfig /dev/null --server=https://localhost:6443 --insecure-skip-tls-verify --list Resources Non-Resource URLs Resource Names Verbs *.* [] [] [*] [*] [] [*] selfsubjectaccessreviews.authorization.k8s.io [] [] [create] selfsubjectrulesreviews.authorization.k8s.io [] [] [create] [/api/*] [] [get] [/api] [] [get] [/apis/*] [] [get] [/apis] [] [get] [/healthz] [] [get] [/healthz] [] [get] [/livez] [] [get] [/livez] [] [get] [/openapi/*] [] [get] [/openapi] [] [get] [/readyz] [] [get] [/readyz] [] [get] [/version/] [] [get] [/version/] [] [get] [/version] [] [get] [/version] [] [get] 因为我们在创建集群时，手动执行过这条命令\nbash 1 kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers 这是我们在证书生成脚本中的定义的用户与组\nbash 1 echo \"$BOOTSTRAP_TOKEN,\\\"system:bootstrapper\\\",10001,\\\"system:bootstrappers\\\"\" \u003e /tmp/token.csv tip 在使用 bootstrap token 认证时，system:bootstrappers 组会被默认添加 例如 kubeadm 是使用了 controller-manager 中的 CSRApprovingController 自动对 bootstrap token 进行的签发。当接收到 CSR 时，CSRApprovingController 会验证他的 CSR 的合法性。可以从代码中看出。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func ValidateKubeletClientCSR(req *x509.CertificateRequest, usages sets.String) error { if !reflect.DeepEqual([]string{\"system:nodes\"}, req.Subject.Organization) { return organizationNotSystemNodesErr } if len(req.DNSNames) \u003e 0 { return dnsSANNotAllowedErr } if len(req.EmailAddresses) \u003e 0 { return emailSANNotAllowedErr } if len(req.IPAddresses) \u003e 0 { return ipSANNotAllowedErr } if len(req.URIs) \u003e 0 { return uriSANNotAllowedErr } if !strings.HasPrefix(req.Subject.CommonName, \"system:node:\") { return commonNameNotSystemNode } if !kubeletClientRequiredUsages.Equal(usages) \u0026\u0026 !kubeletClientRequiredUsagesNoRSA.Equal(usages) { return fmt.Errorf(\"usages did not match %v\", kubeletClientRequiredUsages.List()) } return nil } 上述代码中表明了 CSR 的签发需满足的条件：\nSAN Email, IP, URI 必须不提供。 证书的 Organization 字段必须为 system:nodes，例如: O = system:nodes 证书的 commonName 字段必须为 sytem:node: 开头，通常格式定义为 sytem:node:hostname，例如: CN = system:node:debian-demo。 证书 Usage 必须配置 client auth 和 digital signature， 这部分在生成脚本中有配置。 这里做一个小实验，创建一个 匹配上述条件的 CSR，并使用 CertificateSigningRequest 去申请一个证书。\n使用 cfssl 工具准备 CSR\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ cat \u003c\u003c EOF | cfssl genkey - | cfssljson -bare demo { \"CN\": \"system:node:bootstap-demo\", \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"O\": \"system:nodes\" } ] } EOF 使用 openssl 工具准备 CSR\nbash 1 2 3 4 openssl req -new -newkey rsa:2048 -nodes \\ -keyout demo-key.pem \\ -out demo.csr \\ -subj \"/CN=system:node:bootstap-demo/O=system:nodes\" 查看 demo.csr 的详情\nbash 1 2 3 4 5 6 7 8 9 $ openssl req -noout -text -in demo.csr Certificate Request: Data: Version: 1 (0x0) Subject: CN = system:node:bootstap-demo, O = system:nodes Subject Public Key Info: Public Key Algorithm: rsaEncryption Public-Key: (2048 bit) Modulus: 使用 bootstrap token吧 CSR 发送给 apiserver 去申请证书, 需要注意的是 csr 资源的版本 旧版本certificates.k8s.io/v1beta1； certificates.k8s.io/v1 v1.19 。\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 $ cat \u003c\u003c EOF | kubectl --token 3c9984.b947d02c14fe0a7f --insecure-skip-tls-verify --server=https://localhost:6443 apply -f - apiVersion: certificates.k8s.io/v1beta1 kind: CertificateSigningRequest metadata: name: demo-bootstrap-token-csr spec: signerName: kubernetes.io/kube-apiserver-client request: $(openssl req -new -newkey rsa:2048 -nodes -keyout demo-key.pem -subj \"/CN=system:node:bootstap-demo/O=system:nodes\" 2\u003e/dev/null| base64 | tr -d '\\n') usages: - digital signature - key encipherment - client auth EOF 在新版本中（v1.19）kube-controller-manager 中的它会自动审批 signerName 为 kubernetes.io/kube-apiserver-client-kubelet 的 CSR [4]。\n而旧版本的 CertificateSigningRequest 资源不包含 spec.CertificateSigningRequest\nbash 1 2 3 4 5 6 7 8 9 10 11 12 $ cat \u003c\u003c EOF | kubectl --token 3c9984.b947d02c14fe0a7f --insecure-skip-tls-verify --server=https://localhost:6443 apply -f - apiVersion: certificates.k8s.io/v1beta1 kind: CertificateSigningRequest metadata: name: demo-bootstrap-token-csr spec: request: $(openssl req -new -newkey rsa:2048 -nodes -keyout demo-key.pem -subj \"/CN=system:node:bootstap-demo/O=system:nodes\" 2\u003e/dev/null| base64 | tr -d '\\n') usages: - digital signature - key encipherment - client auth EOF 查看\nbash 1 2 $ kubectl get csr demo-bootstrap-token-csr 5s system:bootstrapper Pending 可以使用下面命令查看被签发的证书\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 $ openssl x509 -noout -text -in \u003c(kubectl get csr demo-bootstrap-token-csr -o jsonpath='{.status.certificate}' | base64 -d) Certificate: Data: Version: 3 (0x2) Serial Number: 32:f8:19:58:a5:4c:d0:24:82:6a:09:c4:0b:8a:2d:6c:7a:26:f3:7d Signature Algorithm: sha256WithRSAEncryption Issuer: CN = k8s-ca Validity Not Before: Nov 23 22:59:00 2024 GMT Not After : Nov 24 01:14:01 2024 GMT Subject: O = system:nodes, CN = system:node:bootstap-demo Subject Public Key Info: Public Key Algorithm: rsaEncryption Public-Key: (2048 bit) Modulus: 00:97:ec:7c:55:f5:e4:1b:68:55:a1:74:28:2f:6d: 27:14:72:35:97:dd:b6:a2:ea:e4:29:8e:59:ca:0c: fe:2b:9e:a8:5f:25:b8:b3:d7:3b:b7:26:b5:3a:27: 8f:8d:cc:b4:46:fc:88:b9:0f:55:6f:d1:ca:20:15: 16:2d:58:aa:1f:c9:46:01:b3:a7:10:45:39:5d:fc: 96:c6:ae:59:e0:a5:f0:61:13:f6:49:69:f6:fc:46: 56:5f:db:ac:3b:3f:c8:70:fb:bb:d8:4d:3c:c4:e8: d3:43:12:0f:c8:a2:db:af:62:91:5e:37:2d:ce:5a: 04:a6:d9:66:6c:37:2a:b0:d0:78:2e:a7:02:87:f6: 78:ae:7a:b7:7e:52:19:d1:24:7e:94:c4:b2:ee:32: e7:c3:90:b7:b3:fc:b8:5b:c8:44:af:5d:72:de:81: b8:b5:86:a4:35:80:8f:97:36:77:bb:16:8d:5a:f2: ef:b7:26:67:03:c7:2f:c7:f4:b1:6e:47:fa:a7:ad: 2c:f1:45:e6:3e:19:38:a1:81:52:20:5e:42:85:1c: 1a:30:c6:7b:04:c0:b6:e2:13:82:0b:d8:76:8a:a8: c4:12:9a:66:1e:8a:e6:5f:a4:f2:7a:d9:28:af:d5: 8a:37:89:26:b8:b3:38:98:6d:a9:33:e6:54:3d:87: 8a:81 Exponent: 65537 (0x10001) X509v3 extensions: X509v3 Key Usage: critical Digital Signature, Key Encipherment X509v3 Extended Key Usage: TLS Web Client Authentication X509v3 Basic Constraints: critical CA:FALSE X509v3 Subject Key Identifier: B2:15:FC:C5:FA:2A:53:1A:49:B7:B3:51:32:E4:29:29:2C:76:1E:10 kubelet 配置 bootstrap token\n如果使用 bootstrap token 需要启用对应的配置，需要具备下列条件：\nkube-apiserver 相关配置\nkube-apiserver 启用参数 --enable-bootstrap-token-auth=true kubelet 相关配置\n一个用来存储所生成的密钥和证书的路径\n一个用来指向尚不存在的 kubeconfig 文件的路径；kubelet 会将 bootstrap token 配置文件放到这个位置。\n一个指向 bootstrap token 的 kubeconfig 文件的路径，用来提供 API 服务器的 URL 和启动 bootstrap token。\ntip 在启动 kubelet 时，如果参数 –kubeconfig 所指定的文件并不存在，会使用通过参数 –bootstrap-kubeconfig 所指定的启动引导 kubeconfig 配置来向 apiserver 请求客户端证书。 在证书请求被批复并被 kubelet 收回时，一个引用所生成的密钥和所获得证书的 kubeconfig 文件会被写入到通过 –kubeconfig 所指定的文件路径下。 证书和密钥文件会被放到 –cert-dir 所指定的目录中 [5]。 其他认证方式 其他认证方式指的是 serviceaccount, openid, webhook token等方式，因为这些不属于 kubernetes 集群中的基础认证方式，而是属于扩展认证方式，故这里不会在提及。\n实验 - 证书更换 构建 kubernetes 1.16.10 实验环境 实验环境使用 kubernetes 1.16.10 来模拟常见的老旧集群（通过二进制方式进行部署）证书过期进行更换的问题。通过上面了解到的“基础认证”方式可以快速做到对集群进行证书更换的问题。\n生成证书列表如下\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ├── apiserver-etcd.crt # kube-apiserver访问etcd使用的客户端证书 ├── apiserver-etcd.key # kube-apiserver访问etcd使用的客户端证书 ├── apiserver-kubelet-client.crt # kube-apiserver访问kubelet使用的证书 ├── apiserver-kubelet-client.key # kube-apiserver访问kubelet使用的证书 ├── ca.crt # k8s 集群使用的ca ├── ca.key # k8s 集群使用的ca ├── front-proxy-ca.crt # kube-aggregation使用ca是独立的一套 ├── front-proxy-ca.key # kube-aggregation使用ca是独立的一套 ├── front-proxy-client.crt # kube-aggregation使用 ├── front-proxy-client.key # kube-aggregation使用 ├── kube-apiserver.crt # kube-apiserver使用 ├── kube-apiserver.key # kube-apiserver使用 ├── kube-controller-manager.crt # kube-controller-manager使用 ├── kube-controller-manager.key # kube-controller-manager使用 ├── kube-proxy.crt # kube-proxy使用 ├── kube-proxy.key # kube-proxy使用 ├── kube-scheduler.crt # kube-scheduler使用 ├── kube-scheduler.key # kube-scheduler使用 ├── sa.key # serviceaccount 使用 └── sa.pub # serviceaccount 使用 etcd 证书更换 etcd 证书更换部分主要围绕 etcd 所使用的证书进行规划，例如：\nca server peer client 这里使用脚本套件会根据 kubernetes 官方给的一个 kubernetes 集群所需要的一套证书的标准进行生成。手动更换即可。更换完成后检查集群状态。\ntip 注意 etcd API 版本，3.5可以直接执行，3.5 之下要使用 V3。 bash 1 2 3 4 5 etcdctl --key=/etc/kubernetes/ssl/etcd-cluster-key.pem\\ --cert=/etc/kubernetes/ssl/etcd-cluster.pem \\ --cacert=/etc/kubernetes/ssl/ca.pem \\ --endpoints=\"https://10.0.0.221:2379\" \\ endpoint health 遇到的问题 log etcd: {\"level\":\"info\",\"ts\":\"2024-11-24T12:00:18.546+0800\",\"caller\":\"embed/etcd.go:465\",\"msg\":\"starting with peer TLS\",\"tls-info\":\"cert = /etc/etcd/ssl/etcd-cluster.pem, key = /etc/etcd/ssl/etcd-cluster-key.pem, trusted-ca = /etc/etcd/ssl/ca.pem, client-cert-auth = true, crl-file = \",\"cipher-suites\":[]} etcd: {\"level\":\"info\",\"ts\":\"2024-11-24T12:00:18.546+0800\",\"caller\":\"embed/etcd.go:360\",\"msg\":\"closing etcd server\",\"name\":\"cert-expired-1\",\"data-dir\":\"/var/lib/etcd/{etcd-cluster-name}\",\"advertise-peer-urls\":[\"https://10.0.0.138:2380\"],\"advertise-client-urls\":[\"https://10.0.0.138:2379\"]} 启动后立马停止，这里检查 etcd 证书是否正确。\nkube-apiserver 证书更换 kube-apiserver 所使用的配置参数\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 KUBE_APISERVER_ARGS=\"\\ --advertise-address=10.0.0.221 \\ --allow-privileged=true \\ --anonymous-auth=false \\ --apiserver-count=3 \\ --audit-log-maxage=7 \\ --audit-log-maxbackup=10 \\ --audit-log-maxsize=100 \\ --audit-policy-file=/etc/kubernetes/config/audit-policy.yaml \\ --audit-log-path=/var/log/kubernetes/audit/kubernetes-audit.log \\ --authorization-mode=Node,RBAC \\ --bind-address=10.0.0.221 \\ --client-ca-file=/etc/kubernetes/ssl/ca.pem \\ --enable-aggregator-routing=true \\ --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeClaimResize,TaintNodesByCondition,PodNodeSelector,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,NodeRestriction,Priority,ResourceQuota,PodSecurityPolicy \\ --enable-swagger-ui=true \\ --etcd-cafile=/etc/etcd/ssl/ca.pem \\ --etcd-certfile=/etc/kubernetes/ssl/etcd-cluster.pem \\ --etcd-keyfile=/etc/kubernetes/ssl/etcd-cluster-key.pem \\ --etcd-servers=https://10.0.0.221:2379,https://10.0.0.138:2379,https://10.0.0.131:2379 \\ --event-ttl=1h \\ --feature-gates=ExpandInUsePersistentVolumes=true,ExpandPersistentVolumes=true,RotateKubeletServerCertificate=true \\ --encryption-provider-config=/etc/kubernetes/pki/encryption-config.yaml \\ --insecure-port=0 \\ --kubelet-certificate-authority=/etc/kubernetes/ssl/ca.pem \\ --kubelet-client-certificate=/etc/kubernetes/ssl/admin.pem \\ --kubelet-client-key=/etc/kubernetes/ssl/admin-key.pem \\ --kubelet-https=true \\ --requestheader-client-ca-filel=/etc/kubernetes/ssl/ca.pem \\ --requestheader-allowed-names=aggregator \\ --requestheader-extra-headers-prefix=X-Remote-Extra- \\ --requestheader-group-headers=X-Remote-Group \\ --requestheader-username-headers=X-Remote-User \\ --profiling=false \\ --proxy-client-cert-file=/etc/kubernetes/ssl/kube-aggregration.pem \\ --proxy-client-key-file=/etc/kubernetes/ssl/kube-aggregration-key.pem \\ --runtime-config=api/all \\ --secure-port=6443 \\ --service-account-lookup=true \\ --service-account-key-file=/etc/kubernetes/ssl/service-account.pem \\ --service-cluster-ip-range=10.191.196.0/24 \\ --service-node-port-range=30000-52767 \\ --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \\ --tls-min-version=VersionTLS12 \\ --tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256 \\ --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem\" 注意需要替换的证书部分\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 ## etcd 部分 # etcd 的ca, 套件生成的 etcd 和 k8s 使用的是不同 ca --etcd-cafile=/etc/etcd/ssl/ca.pem \\ # etcd 客户端证书的 key 和 crt --etcd-certfile=/etc/kubernetes/ssl/etcd-cluster.pem \\ --etcd-keyfile=/etc/kubernetes/ssl/etcd-cluster-key.pem \\ ## kube-apiserver 和 kubelet 通讯部分 # k8s 集群中使用的ca --kubelet-certificate-authority=/etc/kubernetes/ssl/ca.pem \\ # kube-apiserver 请求到 kubelet 使用的证书 # 例如在 kubectl logs / kubectl exec 时，kube-apiserver会直接请求 kubelet 这里需要证书正确 --kubelet-client-certificate=/etc/kubernetes/ssl/admin.pem \\ --kubelet-client-key=/etc/kubernetes/ssl/admin-key.pem \\ ## front-proxy部分，这部分主要适用于 kube-apiserver 与外部 apiserver通讯使用 --proxy-client-cert-file=/etc/kubernetes/ssl/kube-aggregration.pem \\ --proxy-client-key-file=/etc/kubernetes/ssl/kube-aggregration-key.pem \\ # serviceaccount --service-account-key-file=/etc/kubernetes/ssl/service-account.pem \\ 遇到的问题 log clientconn.go:1120] grpc: addrConn.createTransport failed to connect to {https://10.0.0.221:2379 0 }. Err :connection error: desc = \"transport: authentication handshake failed: x509: certificate signed by unknown authority (possibly because of \\\"crypto/rsa: verification error\\\" while trying to verify candidate authority certificate \\\"Kubernetes\\\")\". Reconnecting... clientconn.go:1120] grpc: addrConn.createTransport failed to connect to {https://10.0.0.221:2379 0 }. Err :connection error: desc = \"transport: authentication handshake failed: x509: certificate signed by unknown authority (possibly because of \\\"crypto/rsa: verification error\\\" while trying to verify candidate authority certificate \\\"Kubernetes\\\")\". Reconnecting... 报错提示握手认证失败，手动使用 cert 和 key 访问是正常\nbash 1 2 $ etcdctl --key=/etc/kubernetes/ssl/etcd-cluster-key.pem --cert=/etc/kubernetes/ssl/etcd-cluster.pem --cacert=/etc/etcd/ssl/ca.pem --endpoints=\"https://10.0.0.221:2379\" endpoint health https://10.0.0.221:2379 is healthy: successfully committed proposal: took = 11.661676ms 原因：注意 etcd ca 是否正确。要确认下面的均为正确配置才可以\nbash 1 2 3 --etcd-cafile=/etc/etcd/ssl/ca.pem \\ --etcd-certfile=/etc/kubernetes/ssl/etcd-cluster.pem \\ --etcd-keyfile=/etc/kubernetes/ssl/etcd-cluster-key.pem \\ 无法查看 pod 日志 You must be logged in to the server\nbash 1 error: You must be logged in to the server (the server has asked for the client to provide credentials ( pods/log xxx-xxx-xxx)) 这个就是上面提到的，要保证 kube-apiserver 和 kubelet 使用的证书是否一致\nbash 1 2 --kubelet-client-certificate --kubelet-client-key kube-controller-manager 证书更换 bash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 KUBE_CONTROLLER_MANAGER_ARGS=\"\\ --allocate-node-cidrs=false \\ --bind-address=10.0.0.221 \\ --cluster-cidr=10.96.192.0/22 \\ --authorization-always-allow-paths=/healthz,/metrics \\ --cluster-name=kubernetes \\ --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \\ --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \\ --controllers=*,bootstrapsigner,tokencleaner \\ --feature-gates=ExpandInUsePersistentVolumes=true,ExpandPersistentVolumes=true,RotateKubeletServerCertificate=true \\ --kubeconfig=/etc/kubernetes/config/kube-controller-manager.kubeconfig \\ --leader-elect=true \\ --profiling=false \\ --port=0 \\ --node-monitor-grace-period=40s \\ --node-monitor-period=5s \\ --pod-eviction-timeout=2m \\ --root-ca-file=/etc/kubernetes/ssl/ca.pem \\ --service-account-private-key-file=/etc/kubernetes/ssl/service-account-key.pem \\ --service-cluster-ip-range=10.96.0.0/24 \\ --secure-port=10257 \\ --terminated-pod-gc-threshold=250 \\ --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \\ --tls-min-version=VersionTLS12 \\ --tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256 \\ --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \\ --use-service-account-credentials=true\" 除了上面提到的，ca 外，只需要替换 serviceaccount 所需的 key 即可\nbash 1 2 3 4 --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \\ --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \\ # 这个参数和 kube-apiserver 的是一对 --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \\ kube-scheduler 证书更换 bash 1 2 3 4 5 6 7 8 9 10 11 12 KUBE_SCHEDULER_ARGS=\"\\ --bind-address=10.0.0.221 \\ --config=/etc/kubernetes/config/kube-scheduler.yaml \\ --profiling=false \\ --client-ca-file=/etc/kubernetes/ssl/ca.pem \\ --port=0 \\ --secure-port=10259 \\ --feature-gates=ExpandInUsePersistentVolumes=true,ExpandPersistentVolumes=true,RotateKubeletServerCertificate=true \\ --tls-cert-file=/etc/kubernetes/ssl/kube-scheduler.pem \\ --tls-min-version=VersionTLS12 \\ --tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256 \\ --tls-private-key-file=/etc/kubernetes/ssl/kube-scheduler-key.pem\" tip 需要注意的是，除了 kube-apiserver 服务外，其他的组件需要手动更换 kubeconfig 文件。 工作节点证书更换 如果节点使用 bootstrap 证书进行部署的，通常证书不正确 kubelet 会从新自动申请 csr 获取新证书，这部分根据 kubernetes 集群版本不同需要手动进行批准 (kubectl certificate approve)。\n另外一种方式就是，手动重新给每一个节点的 kubelet 重新签发证书，并且替换每一个节点的 kube-proxy 的 kubeconfig 文件 (==这里使用的套件是 bootstrap token==)。生成证书的要求按照 bootstrap token 部分介绍的：\nSAN Email, IP, URI 必须不提供。 证书的 Organization 字段必须为 system:nodes，例如: O = system:nodes 证书的 commonName 字段必须为 sytem:node: 开头，通常格式定义为 sytem:node:hostname，例如: CN = system:node:debian-demo。 证书 Usage 必须配置 client auth 和 digital signature， 这部分在生成脚本中有配置。 更换cni使用证书 例如 calico 使用了etcd时，etcd为外部etcd时，这里的证书也要替换，否则 calico-controller 会无法连接etcd，下图是对应的日志。\n图：calico-controller无法连接etcd 更换serviceaccount 在 kubernetes 官方的 “手动轮换 CA 证书” [6] 一文中有提到，在更新了 CA 之后，集群内 Pod 需要重启以获得新的 Secret 数据。下图是当 Pod 没有重启时，在启动新 Pod 的报错\n图：network: Unauthorized network: Unauthorized 原因如下：\ncni node 没有启动 旧的 default secret 还是旧的，没办法请求到 apiserver 去创建网络空间 当更换完成证书后，检查 node cni 服务全部没问题，但是新建的Pod无法创建网络，提示 network: Unauthorized；重建了所有的 secret后重启 Pod 就恢复了。这时 kubelet 出现日志如下：\nlog kubelet报错日志1 W0113 12:11:06.526394 11195 docker_sandbox.go:394] failed to read pod IP from plugin/docker: networkPlugin cni failed on the status hook for pod \"a01-im-web-5f6f9b4459-p6gnt_a01\": CNI failed to retrieve network namespace path: cannot find network namespace for the terminated container \"c8145349eebe397d4c7f30cb326f20338b668b67ebdfddf5e51be14992a18894\" W0113 12:11:06.528734 11195 docker_sandbox.go:394] failed to read pod IP from plugin/docker: networkPlugin cni failed on the status hook for pod \"a01-im-web-5f6f9b4459-p6gnt_a01\": CNI failed to retrieve network namespace path: cannot find network namespace for the terminated container \"1823c082be12441a1df17875eb9cc9efdb19d7b37d71653c5182b23b7fcab694\" W0113 12:11:06.532607 11195 docker_sandbox.go:394] failed to read pod IP from plugin/docker: networkPlugin cni failed on the status hook for pod \"a01-im-web-5f6f9b4459-p6gnt_a01\": CNI failed to retrieve network namespace path: cannot find network namespace for the terminated container \"1bae78ef6fa9dbb48002984d96b2d6222ddc14caf2e9bf04a9abb8fce7ad4a18\" W0113 12:11:06.534956 11195 docker_sandbox.go:394] failed to read pod IP from plugin/docker: networkPlugin cni failed on the status hook for pod \"a01-im-web-5f6f9b4459-p6gnt_a01\": CNI failed to retrieve network namespace path: cannot find network namespace for the terminated container \"528754d0e7ca862dc6723a573c032f53326d53aff3e768694a11b01090cdf7d1\" W0113 12:11:06.537408 11195 docker_sandbox.go:394] failed to read pod IP from plugin/docker: networkPlugin cni failed on the status hook for pod \"a01-im-web-5f6f9b4459-p6gnt_a01\": CNI failed to retrieve network namespace path: cannot find network namespace for the terminated container \"39e65a5a7250bd14305412a041fce9873f9dee88ecfc85b9b8c21c5db472a353\" W0113 12:11:06.539590 11195 docker_sandbox.go:394] failed to read pod IP from plugin/docker: networkPlugin cni failed on the status hook for pod \"a01-im-web-5f6f9b4459-p6gnt_a01\": CNI failed to retrieve network namespace path: cannot find network namespace for the terminated container \"d52e93aa1163041e20ab0b5e8b200f14a70581252c2424c943d53478e8656a79\" log kubelet报错日志2 6300 kubelet_volumes.go:154] orphaned pod \"a3f45f45-b6e5-4fb8-9d32-d691f966173a\" found, but volume subpaths are still present on disk : There were a total of 1 errors similar to this. Turn up verbosity to see them. 6300 cni.go:364] Error adding push-web-api-6bcc765c4-8r242/0ed92e1b512ecc25414e0540a3bc06060cf4d4ea09ebd0fb9dbe20f1c9e0389e to network calico/k8s-pod-network: Unauthorized 6300 dns.go:135] Nameserver limits were exceeded, some nameservers have been omitted, the applied nameserver line is: 10.190.16.41 10.190.16.42 10.240.16.41 6300 remote_runtime.go:105] RunPodSandbox from runtime service failed: rpc error: code = Unknown desc = failed to set up sandbox container \"0ed92e1b512ecc25414e0540a3bc06060cf4d4ea09ebd0fb9dbe20f1c9e0389e\" network for pod \"push-web-api-6bcc765c4-8r242\": networkPlugin cni failed to set up pod \"push-web-api-6bcc765c4-8r242_prd_user_32as1\" network: Unauthorized 6300 kuberuntime_sandbox.go:68] CreatePodSandbox for pod \"push-web-api-6bcc765c4-8r242_prd_user_32as1(c87c4346-def7-4326-9406-48de0c641a94)\" failed: rpc error: code = Unknown desc = failed to set up sandbox container \"0ed92e1b512ecc25414e0540a3bc06060cf4d4ea09ebd0fb9dbe20f1c9e0389e\" network for pod \"push-web-api-6bcc765c4-8r242\": networkPlugin cni failed to set up pod \"push-web-api-6bcc765c4-8r242_prd_user_32as1\" network: Unauthorized ./kubelet.ph190svr015012.root.log.ERROR.20250113-171637.6300:E0113 17:32:27.121142 6300 kuberuntime_manager.go:710] createPodSandbox for pod \"push-web-api-6bcc765c4-8r242_prd_user_32as1(c87c4346-def7-4326-9406-48de0c641a94)\" failed: rpc error: code = Unknown desc = failed to set up sandbox container \"0ed92e1b512ecc25414e0540a3bc06060cf4d4ea09ebd0fb9dbe20f1c9e0389e\" network for pod \"push-web-api-6bcc765c4-8r242\": networkPlugin cni failed to set up pod \"push-web-api-6bcc765c4-8r242_prd_user_32as1\" network: Unauthorized 6300 pod_workers.go:191] Error syncing pod c87c4346-def7-4326-9406-48de0c641a94 (\"push-web-api-6bcc765c4-8r242_prd_user_32as1(c87c4346-def7-4326-9406-48de0c641a94)\"), skipping: failed to \"CreatePodSandbox\" for \"push-web-api-6bcc765c4-8r242_prd_user_32as1(c87c4346-def7-4326-9406-48de0c641a94)\" with CreatePodSandboxError: \"CreatePodSandbox for pod \\\"push-web-api-6bcc765c4-8r242_prd_user_32as1(c87c4346-def7-4326-9406-48de0c641a94)\\\" failed: rpc error: code = Unknown desc = failed to set up sandbox container \\\"0ed92e1b512ecc25414e0540a3bc06060cf4d4ea09ebd0fb9dbe20f1c9e0389e\\\" network for pod \\\"push-web-api-6bcc765c4-8r242\\\": networkPlugin cni failed to set up pod \\\"push-web-api-6bcc765c4-8r242_prd_user_32as1\\\" network: Unauthorized\" 6300 cni.go:385] Error deleting logging_filebeat-filebeat-68525/131e91d83d51925a5298be7c21f739c5341db9ecde26bf58509c60278caae46e from network calico/k8s-pod-network: context deadline exceeded 6300 remote_runtime.go:128] StopPodSandbox \"131e91d83d51925a5298be7c21f739c5341db9ecde26bf58509c60278caae46e\" from runtime service failed: rpc error: code = Unknown desc = networkPlugin cni failed to teardown pod \"filebeat-filebeat-68525_logging\" network: context deadline exceeded 6300 kuberuntime_manager.go:878] Failed to stop sandbox {\"docker\" \"131e91d83d51925a5298be7c21f739c5341db9ecde26bf58509c60278caae46e\"} 6300 cni.go:385] Error deleting public_public-gameinterface-office-74fc5bdcc-sfp5d/8a049c280b256e6afc5832b2f77d1e90b7b0ae8590e0403b5efedb391c4a1a7f from network calico/k8s-pod-network: context deadline exceeded 6300 remote_runtime.go:128] StopPodSandbox \"8a049c280b256e6afc5832b2f77d1e90b7b0ae8590e0403b5efedb391c4a1a7f\" from runtime service failed: rpc error: code = Unknown desc = networkPlugin cni failed to teardown pod \"public-gameinterface-office-74fc5bdcc-sfp5d_public\" network: context deadline exceeded 遇到的问题 tls: bad certificate 问题原因，更新完成证书后，Pod 中 CA 会更新，但是 secret token 不会自动更新，容器内请求 API 使用 serviceaccount token，当更换 CA 后必须重启 Pod 才能重新在 Pod 内建立新的 token。\nlog I0114 11:25:25.925418 1063 log.go:172] http: TLS handshake error from 10.190.15.40:3418: remote error: tls: bad certificate I0114 11:25:25.931262 1063 log.go:172] http: TLS handshake error from 10.190.15.40:6413: remote error: tls: bad certificate I0114 11:25:25.931643 1063 log.go:172] http: TLS handshake error from 10.190.15.40:61463: remote error: tls: bad certificate I0114 11:25:25.937855 1063 log.go:172] http: TLS handshake error from 10.190.15.40:20758: remote error: tls: bad certificate I0114 11:25:25.939317 1063 log.go:172] http: TLS handshake error from 10.190.15.40:49564: remote error: tls: bad certificate I0114 11:25:25.945868 1063 log.go:172] http: TLS handshake error from 10.190.15.40:54670: remote error: tls: bad certificate I0114 11:25:25.945937 1063 log.go:172] http: TLS handshake error from 10.190.15.40:10809: remote error: tls: bad certificate I0114 11:25:25.954650 1063 log.go:172] http: TLS handshake error from 10.190.15.40:19277: remote error: tls: bad certificate I0114 11:25:25.955125 1063 log.go:172] http: TLS handshake error from 10.190.15.40:12765: remote error: tls: bad certificate I0114 11:25:25.963410 1063 log.go:172] http: TLS handshake error from 10.190.15.40:61484: remote error: tls: bad certificate I0114 11:25:25.963924 1063 log.go:172] http: TLS handshake error from 10.190.15.40:21905: remote error: tls: bad certificate I0114 11:25:25.972193 1063 log.go:172] http: TLS handshake error from 10.190.15.40:47752: remote error: tls: bad certificate I0114 11:25:25.972608 1063 log.go:172] http: TLS handshake error from 10.190.15.40:12960: remote error: tls: bad certificate I0114 11:25:25.972863 1063 log.go:172] http: TLS handshake error from 10.190.15.40:1635: remote error: tls: bad certificate I0114 11:25:25.975030 1063 log.go:172] http: TLS handshake error from 10.190.15.40:23673: remote error: tls: bad certificate I0114 11:25:25.975148 1063 log.go:172] http: TLS handshake error from 10.190.15.40:57676: remote error: tls: bad certificate I0114 11:25:25.982164 1063 log.go:172] http: TLS handshake error from 10.190.15.40:40683: remote error: tls: bad certificate I0114 11:25:25.982192 1063 log.go:172] http: TLS handshake error from 10.190.15.40:11049: remote error: tls: bad certificate I0114 11:25:25.990024 1063 log.go:172] http: TLS handshake error from 10.190.15.40:25287: remote error: tls: bad certificate I0114 11:25:25.990288 1063 log.go:172] http: TLS handshake error from 10.190.15.40:30061: remote error: tls: bad certificate I0114 11:25:25.992142 1063 log.go:172] http: TLS handshake error from 10.190.15.40:38174: remote error: tls: bad certificate I0114 11:25:26.000204 1063 log.go:172] http: TLS handshake error from 10.190.15.40:63942: remote error: tls: bad certificate I0114 11:25:26.002349 1063 log.go:172] http: TLS handshake error from 10.190.15.40:55625: remote error: tls: bad certificate I0114 11:25:26.027144 1063 log.go:172] http: TLS handshake error from 10.190.15.40:46402: remote error: tls: bad certificate I0114 11:25:26.027458 1063 log.go:172] http: TLS handshake error from 10.190.15.40:2822: remote error: tls: bad certificate I0114 11:25:26.036703 1063 log.go:172] http: TLS handshake error from 10.190.15.40:57254: remote error: tls: bad certificate I0114 11:25:26.037100 1063 log.go:172] http: TLS handshake error from 10.190.15.40:53104: remote error: tls: bad certificate 验证上述问题\n使用 SA token 访问 API\nbash 1 2 3 curl -k \\ -H \"Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)\" \\ https://kubernetes.default.svc/api/v1/pods 未重启过的Pod\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 $ ls /var/run/secrets/kubernetes.io/serviceaccount/token /var/run/secrets/kubernetes.io/serviceaccount/token $ curl -k \\un/secrets/kubernetes.io/serviceaccount/token -H \"Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)\" \\ https://kubernetes.default.svc/api/v1/podsecrets/kubernetes.io/serviceaccount/t { https://kubernetes.default.svc/api/v1/pods \"kind\": \"Status\", \"apiVersion\": \"v1\", \"metadata\": {}, \"status\": \"Failure\", \"message\": \"Unauthorized\", \"reason\": \"Unauthorized\", \"code\": 401 } 重启更换过 Token 的 Pod\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 curl -k \\ -H \"Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)\" \\ https://kubernetes.default.svc/api/v1/pods { \"kind\": \"Status\", \"apiVersion\": \"v1\", \"metadata\": {}, \"status\": \"Failure\", \"message\": \"pods is forbidden: User \\\"system:serviceaccount:netbox:default\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" at the cluster scope\", \"reason\": \"Forbidden\", \"details\": { \"kind\": \"pods\" }, \"code\": 403 } 总结 了解了 k8s 集群认证模式（TLS Everywhere）。 通过基础知识知道了换证书需要更换那些地方。 没有尝试官方提到的滚动更新CA的方式。 Reference [1] kubernetes-generator\n[2] 身份认证策略\n[3] 使用启动引导令牌（Bootstrap Tokens）认证\n[4] Kubernetes 签名者\n[5] kubelet 配置\n[6] 手动轮换 CA 证书\n[7] So I became a node: exploiting bootstrap tokens in Azure Kubernetes Service\n[8] How to regenerate Service Account tokens in Kubernetes\n[9] Updating Kubernetes CA certificates the hard way\n","wordCount":"3017","inLanguage":"zh","datePublished":"2024-11-24T00:00:00Z","dateModified":"2024-11-30T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2024/11/k8s-auth-and-regenerate-cert/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">TLS Everywhere - 解密kubernetes集群的安全认证</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2024-11-24</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>3017 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>15 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#kubernetes%e8%ae%a4%e8%af%81%e6%96%b9%e5%bc%8f aria-label=Kubernetes认证方式>Kubernetes认证方式</a><ul><li><a href=#x509-%e8%af%81%e4%b9%a6 aria-label="X509 证书">X509 证书</a><li><a href=#%e9%9d%99%e6%80%81token aria-label=静态token>静态token</a><li><a href=#bootstrap-tokens aria-label="Bootstrap Tokens">Bootstrap Tokens</a><li><a href=#%e5%85%b6%e4%bb%96%e8%ae%a4%e8%af%81%e6%96%b9%e5%bc%8f aria-label=其他认证方式>其他认证方式</a></ul><li><a href=#%e5%ae%9e%e9%aa%8c---%e8%af%81%e4%b9%a6%e6%9b%b4%e6%8d%a2 aria-label="实验 - 证书更换">实验 - 证书更换</a><ul><li><a href=#%e6%9e%84%e5%bb%ba-kubernetes-11610-%e5%ae%9e%e9%aa%8c%e7%8e%af%e5%a2%83 aria-label="构建 kubernetes 1.16.10 实验环境">构建 kubernetes 1.16.10 实验环境</a><li><a href=#etcd-%e8%af%81%e4%b9%a6%e6%9b%b4%e6%8d%a2 aria-label="etcd 证书更换">etcd 证书更换</a><ul><li><a href=#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=遇到的问题>遇到的问题</a></ul><li><a href=#kube-apiserver-%e8%af%81%e4%b9%a6%e6%9b%b4%e6%8d%a2 aria-label="kube-apiserver 证书更换">kube-apiserver 证书更换</a><ul><li><a href=#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98-1 aria-label=遇到的问题>遇到的问题</a></ul><li><a href=#kube-controller-manager-%e8%af%81%e4%b9%a6%e6%9b%b4%e6%8d%a2 aria-label="kube-controller-manager 证书更换">kube-controller-manager 证书更换</a><li><a href=#kube-scheduler-%e8%af%81%e4%b9%a6%e6%9b%b4%e6%8d%a2 aria-label="kube-scheduler 证书更换">kube-scheduler 证书更换</a><li><a href=#%e5%b7%a5%e4%bd%9c%e8%8a%82%e7%82%b9%e8%af%81%e4%b9%a6%e6%9b%b4%e6%8d%a2 aria-label=工作节点证书更换>工作节点证书更换</a><li><a href=#%e6%9b%b4%e6%8d%a2cni%e4%bd%bf%e7%94%a8%e8%af%81%e4%b9%a6 aria-label=更换cni使用证书>更换cni使用证书</a><li><a href=#%e6%9b%b4%e6%8d%a2serviceaccount aria-label=更换serviceaccount>更换serviceaccount</a><ul><li><a href=#%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98-2 aria-label=遇到的问题>遇到的问题</a></ul></ul><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><div class="pe-details admonition abstract"><div class="pe-details-summary admonition-title"><i class="icon fas fa-list-ul fa-fw" aria-hidden=true></i>本文是关于Kubernetes 4A解析的第5章<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content><ul><li><a href=https://www.oomkill.com/2022/11/ch31-authentication/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Authentication源码解析</a></li><li><a href=https://www.oomkill.com/2022/11/ch32-authorization/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Authorization源码解析</a></li><li><a href=https://www.oomkill.com/2022/07/ch33-admission-webhook/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Admission Control源码解析</a></li><li><a href=https://www.oomkill.com/2022/11/ch34-auditing/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Audit源码解析</a></li><li>TLS Everywhere - 解密kubernetes集群的安全认证</li></ul><p>所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A</p></div></div></div><p>在 kubernetes 集群中，所有的通讯都是用 TLS 进行加密和认证，本文使用一次老集群（二进制部署集群）证书更换作为记录，通过这种方式深入对 kubernetes 的认证方式来了解更换证书的步骤，以及一次模拟老集群的更换步骤。</p><p>本文使用证书生成工具为 “kubernetes-generator” <sup><a href=#1>[1]</a></sup> 专用于 k8s 二进制部署生成证书和安装包的工具。</p><div class="pe-details admonition note open"><div class="pe-details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>note<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content>本文中的引用文档使用 web.archive 进行保存，避免官方版本更新，其概念与文档中的概念有变动导致，资料引用失败。</div></div></div><h2 id=kubernetes认证方式>Kubernetes认证方式<a hidden class=anchor aria-hidden=true href=#kubernetes认证方式>#</a></h2><p>为了了解证书更换需要做那些步骤，所以必须了解 k8s 的认证方式，这样才能更好的在更换证书时对集群上部署的业务系统的影响降低到最低。</p><h3 id=x509-证书>X509 证书<a hidden class=anchor aria-hidden=true href=#x509-证书>#</a></h3><p>kube-apiserver 的启动参数 <code>--client-ca-file</code>，可以使用客户端办法机构，英文代号就是熟悉的 “CA” (Certificate authority)，当这个证书传递后，可以验证 kube-apiserver 用于验证向 kube-apiserver 提供的客户端证书，这里包含 k8s 中提供的用户种类的两种：</p><ul><li>用户名：对应证书的 CN (Common Name)</li><li>用户组：对应证书的O (organization)，用于对一个用户组进行授权，例如 “system:masters” 表示一个组 <sup><a href=#1>[1]</a></sup>，允许不受限制地访问 kube-apiserver</li></ul><h3 id=静态token>静态token<a hidden class=anchor aria-hidden=true href=#静态token>#</a></h3><p>kube-apiserver 的启动参数 <code>--token-auth-file</code>，是以文件提供给 kube-apiserver，该 Token 会长期有效，并且如果不重启服务 Token 是不会更新。</p><div class="pe-details admonition warning open"><div class="pe-details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden=true></i>tip<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content>通常情况下，应避免使用静态 token 功能。</div></div></div><p>令牌文件的定义必须符合 <code>[a-z0-9]{6}\.[a-z0-9]{16}</code> 的格式，以 “.” 分割，第一部分是 “Token ID”； 第二部分是“令牌秘密（Token Secret” ；其后是这个用户的 Group，Group 可以包含多个，如果包含多个，则对应的列必须用双引号括起来。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>token,user,uid,group
</span></span><span class=line><span class=cl>token,user,uid,<span class=s2>&#34;group1,group2,group3&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>例如</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>123456.1234567890abcdef,dev,1,system:masters</span></span></code></pre></td></tr></table></div></div></div></div><div class="pe-details admonition note open"><div class="pe-details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>note<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content><code>system:masters</code> 除非有必要，否则，应避免向该组分发证书。该组用户无法通过 ClusterRole 和 clusterRoleBinding 来控制权限，即使删除了所有集群角色，或者从来就没有分配过集群角色。该组的用户，仍然可以直接请求 kube-apiserver 执行任何操作。</div></div></div><p>使用时可以这样传入</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -k -X GET https://&lt;k8s-apiserver&gt;:6443/api/v1/nodes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-H <span class=s2>&#34;Authorization: Bearer 3c9984.b947d02c14fe0a7f&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=bootstrap-tokens>Bootstrap Tokens<a hidden class=anchor aria-hidden=true href=#bootstrap-tokens>#</a></h3><p>Bootstrap Tokens 和 “静态Token”是属于相同类型，并存在于<code>kube-system</code> 名称空间中 Secret, 他的类型是 <code>bootstrap.kubernetes.io/token</code> ，==这种设计是为了能够支持 <code>kubeadm</code>==。 的情况下启动集群。<sup><a href=#3>[3]</a></sup></p><p>Bootstrap Tokens 和 静态 token 是相同的格式类型，这里就不多做阐述。</p><p>这里我们看一下我们生成的 kubelet 相关证书与配置文件</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>kubelet</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-kubelet data-lang=kubelet>$ cat kubelet
# kubernetes kubelet config
#
# You can add your configuration own!
KUBELET_ARGS=&#34;--v=0 \
    --logtostderr=true \
    --network-plugin=cni \
    --config=/etc/kubernetes/kubelet-config.yaml \
    --kubeconfig=/etc/kubernetes/auth/kubelet.conf \
    --cgroup-driver=cgroupfs \
    --bootstrap-kubeconfig=/etc/kubernetes/auth/bootstrap.conf&#34;</code></pre></div></div><p>再查看一下 <code>/etc/kubernetes/auth/bootstrap.conf</code> 的配置文件</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class=l>LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNxRENDQVpBQ0UwYlFJV1BEazYwK3dib05ZczJnZzA0bkM1QXdEUVlKS29aSWh2Y05BUUVMQlFBd0VURVAKTUEwR0ExVUVBd3dHYXpoekxXTmhNQjRYRFRJME1URXlNekF4TVRnMU9Gb1hEVEkwTVRFeU5EQXhNVGcxT0ZvdwpFVEVQTUEwR0ExVUVBd3dHYXpoekxXTmhNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDCkFRRUFuZ1hXRzBpK3N0WXpwRjYyMzJZNlpEZGZjOVZIR3M0THRWbU5sT1RSWnVWeGplZ2JySnhnTGVwLzNvalcKYWNDWWJpejZ1WmdTcEZHWmwrV3RKWXZMaURlOU5iampuaTgzWUYyYWY1MDVBT2gvNjMwc1Z5L2pIdWhvVGNQeApkOVc3YW42TlFiYlF0eVhlaVNHMldDdDlnbmlmdlpnN3VPbzdZYUhqc2pMYWtRbUt6WUhhKy9KaGFHR09LOEFtCkVxay9IV3grR3FSMnFpVDBXbndkTXhWdnluRFNwYTBrTGt6dWZsbFNtTktPL3VxbTQ2azBpWWNta1h4TWF2SlEKQjNQTVF5aFdtOFRJRVdGUWcvTWE0ZytMdDdJcjh2dmIwRWlyemtOZVFtRFJyaHN4K1hieHlUdnpBRVE2aE9MMgpvMldNR09CZGpIdVlSc0NzQW9abE1JdFFoUUlEQVFBQk1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQTN4NlpWCjJZNjlhTWtKYmJpQnA0RmM3YkRaektadk9xOWp2aUgwTjIvNERId2tPQ3FzenlOSkRkN3hVTUV4NE1BSGp0Vm4KSWVOSit4Sk4xM010eW1lYlhkbEw1b2pDTHArTkZSeEdibXdqM2tSUFBUQ3JZa3NEcGdReGlXVjZ5U2ZXMUNsdAo3UmowOU5jTEpqaU1aMjQyVW9qMzh0dmpEdkw3OFdod0FZb2VSaFBMcHptUndPc0plem9ON2FXZ0FXMDJsM0ZxCm9xVFFDUkJ2SkNDSjhMM09IVmZOYW9vNmI0YzNDbVM2RVdXdThuQmYxNHJVaTJNWCszSGJpbVg2R0w4ZTVnbTYKTXp4Q2VKcGxkbndYeDVRekdPWnpzQ1VQZ2xMRFdhMkxBRzg4V0VFVlRqWkVXbDdZZXVrdTBLV2tVSCs0VjR3WQpsbmFnNFM3ZWw0cFMwRVgrCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://10.0.0.4:6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrapper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrapper@kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrapper@kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>preferences</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrapper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>3c9984.b947d02c14fe0a7f</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以用命令去求证 certificate-authority-data 是否与 CA 一致。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl x509 -noout -text -in &lt;<span class=o>(</span>grep <span class=s1>&#39;certificate-authority-data:&#39;</span> auth/bootstrap.conf <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span><span class=p>|</span>base64 -d<span class=o>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>使用命令可以查询到这个 bootstrap token 可以操作的权限</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl --token 3c9984.b947d02c14fe0a7f auth can-i --kubeconfig /dev/null --server<span class=o>=</span>https://localhost:6443 --insecure-skip-tls-verify --list
</span></span><span class=line><span class=cl>Resources                                       Non-Resource URLs   Resource Names   Verbs
</span></span><span class=line><span class=cl>*.*                                             <span class=o>[]</span>                  <span class=o>[]</span>               <span class=o>[</span>*<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>*<span class=o>]</span>                 <span class=o>[]</span>               <span class=o>[</span>*<span class=o>]</span>
</span></span><span class=line><span class=cl>selfsubjectaccessreviews.authorization.k8s.io   <span class=o>[]</span>                  <span class=o>[]</span>               <span class=o>[</span>create<span class=o>]</span>
</span></span><span class=line><span class=cl>selfsubjectrulesreviews.authorization.k8s.io    <span class=o>[]</span>                  <span class=o>[]</span>               <span class=o>[</span>create<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/api/*<span class=o>]</span>            <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/api<span class=o>]</span>              <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/apis/*<span class=o>]</span>           <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/apis<span class=o>]</span>             <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/healthz<span class=o>]</span>          <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/healthz<span class=o>]</span>          <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/livez<span class=o>]</span>            <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/livez<span class=o>]</span>            <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/openapi/*<span class=o>]</span>        <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/openapi<span class=o>]</span>          <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/readyz<span class=o>]</span>           <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/readyz<span class=o>]</span>           <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/version/<span class=o>]</span>         <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/version/<span class=o>]</span>         <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/version<span class=o>]</span>          <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span>
</span></span><span class=line><span class=cl>                                                <span class=o>[</span>/version<span class=o>]</span>          <span class=o>[]</span>               <span class=o>[</span>get<span class=o>]</span></span></span></code></pre></td></tr></table></div></div></div></div><p>因为我们在创建集群时，手动执行过这条命令</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create clusterrolebinding kubelet-bootstrap --clusterrole<span class=o>=</span>system:node-bootstrapper --group<span class=o>=</span>system:bootstrappers</span></span></code></pre></td></tr></table></div></div></div></div><p>这是我们在证书生成脚本中的定义的用户与组</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$BOOTSTRAP_TOKEN</span><span class=s2>,\&#34;system:bootstrapper\&#34;,10001,\&#34;system:bootstrappers\&#34;&#34;</span> &gt; /tmp/token.csv</span></span></code></pre></td></tr></table></div></div></div></div><div class="pe-details admonition warning open"><div class="pe-details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden=true></i>tip<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content>在使用 bootstrap token 认证时，<code>system:bootstrappers</code> 组会被默认添加</div></div></div><p>例如 kubeadm 是使用了 controller-manager 中的 CSRApprovingController 自动对 bootstrap token 进行的签发。当接收到 CSR 时，CSRApprovingController 会验证他的 CSR 的合法性。可以从代码中看出。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ValidateKubeletClientCSR</span><span class=p>(</span><span class=nx>req</span> <span class=o>*</span><span class=nx>x509</span><span class=p>.</span><span class=nx>CertificateRequest</span><span class=p>,</span> <span class=nx>usages</span> <span class=nx>sets</span><span class=p>.</span><span class=nx>String</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>!</span><span class=nx>reflect</span><span class=p>.</span><span class=nf>DeepEqual</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;system:nodes&#34;</span><span class=p>},</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Subject</span><span class=p>.</span><span class=nx>Organization</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>organizationNotSystemNodesErr</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>DNSNames</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>dnsSANNotAllowedErr</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>EmailAddresses</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>emailSANNotAllowedErr</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>IPAddresses</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>ipSANNotAllowedErr</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>URIs</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>uriSANNotAllowedErr</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>!</span><span class=nx>strings</span><span class=p>.</span><span class=nf>HasPrefix</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Subject</span><span class=p>.</span><span class=nx>CommonName</span><span class=p>,</span> <span class=s>&#34;system:node:&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>commonNameNotSystemNode</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>!</span><span class=nx>kubeletClientRequiredUsages</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>usages</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>kubeletClientRequiredUsagesNoRSA</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>usages</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;usages did not match %v&#34;</span><span class=p>,</span> <span class=nx>kubeletClientRequiredUsages</span><span class=p>.</span><span class=nf>List</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>上述代码中表明了 CSR 的签发需满足的条件：</p><ul><li>SAN Email, IP, URI 必须不提供。</li><li>证书的 Organization 字段必须为 <code>system:nodes</code>，例如: O = system:nodes</li><li>证书的 commonName 字段必须为 <code>sytem:node:</code> 开头，通常格式定义为 <em>sytem:node:hostname</em>，例如: CN = system:node:debian-demo。</li><li>证书 Usage 必须配置 <em>client auth</em> 和 <em>digital signature</em>， 这部分在生成脚本中有配置。</li></ul><p>这里做一个小实验，创建一个 匹配上述条件的 CSR，并使用 CertificateSigningRequest 去申请一个证书。</p><p>使用 cfssl 工具准备 CSR</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat <span class=s>&lt;&lt; EOF | cfssl genkey - | cfssljson -bare demo
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;system:node:bootstap-demo&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;O&#34;: &#34;system:nodes&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></td></tr></table></div></div></div></div><p>使用 openssl 工具准备 CSR</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl req -new -newkey rsa:2048 -nodes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-keyout demo-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-out demo.csr <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-subj <span class=s2>&#34;/CN=system:node:bootstap-demo/O=system:nodes&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查看 demo.csr 的详情</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ openssl req -noout -text -in demo.csr 
</span></span><span class=line><span class=cl>Certificate Request:
</span></span><span class=line><span class=cl>    Data:
</span></span><span class=line><span class=cl>        Version: <span class=m>1</span> <span class=o>(</span>0x0<span class=o>)</span>
</span></span><span class=line><span class=cl>        Subject: <span class=nv>CN</span> <span class=o>=</span> system:node:bootstap-demo, <span class=nv>O</span> <span class=o>=</span> system:nodes
</span></span><span class=line><span class=cl>        Subject Public Key Info:
</span></span><span class=line><span class=cl>            Public Key Algorithm: rsaEncryption
</span></span><span class=line><span class=cl>                Public-Key: <span class=o>(</span><span class=m>2048</span> bit<span class=o>)</span>
</span></span><span class=line><span class=cl>                Modulus:</span></span></code></pre></td></tr></table></div></div></div></div><p>使用 bootstrap token吧 CSR 发送给 apiserver 去申请证书, 需要注意的是 csr 资源的版本 旧版本<code>certificates.k8s.io/v1beta1</code>； <code>certificates.k8s.io/v1</code> v1.19 。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat <span class=s>&lt;&lt; EOF | kubectl --token 3c9984.b947d02c14fe0a7f --insecure-skip-tls-verify --server=https://localhost:6443 apply -f - 
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: certificates.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: CertificateSigningRequest
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: demo-bootstrap-token-csr
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  signerName: kubernetes.io/kube-apiserver-client
</span></span></span><span class=line><span class=cl><span class=s>  request: $(openssl req -new -newkey rsa:2048 -nodes -keyout demo-key.pem  -subj &#34;/CN=system:node:bootstap-demo/O=system:nodes&#34; 2&gt;/dev/null| base64 | tr -d &#39;\n&#39;)
</span></span></span><span class=line><span class=cl><span class=s>  usages:
</span></span></span><span class=line><span class=cl><span class=s>  - digital signature
</span></span></span><span class=line><span class=cl><span class=s>  - key encipherment
</span></span></span><span class=line><span class=cl><span class=s>  - client auth
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在新版本中（v1.19）kube-controller-manager 中的它会自动审批 <code>signerName</code> 为 <code>kubernetes.io/kube-apiserver-client-kubelet</code> 的 CSR <sup><a href=#4>[4]</a></sup>。</p><p>而旧版本的 CertificateSigningRequest 资源不包含 spec.CertificateSigningRequest</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat <span class=s>&lt;&lt; EOF | kubectl --token 3c9984.b947d02c14fe0a7f --insecure-skip-tls-verify --server=https://localhost:6443 apply -f - 
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: certificates.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>kind: CertificateSigningRequest
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: demo-bootstrap-token-csr
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  request: $(openssl req -new -newkey rsa:2048 -nodes -keyout demo-key.pem  -subj &#34;/CN=system:node:bootstap-demo/O=system:nodes&#34; 2&gt;/dev/null| base64 | tr -d &#39;\n&#39;)
</span></span></span><span class=line><span class=cl><span class=s>  usages:
</span></span></span><span class=line><span class=cl><span class=s>  - digital signature
</span></span></span><span class=line><span class=cl><span class=s>  - key encipherment
</span></span></span><span class=line><span class=cl><span class=s>  - client auth
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></td></tr></table></div></div></div></div><p>查看</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get csr
</span></span><span class=line><span class=cl>demo-bootstrap-token-csr   5s      system:bootstrapper           Pending</span></span></code></pre></td></tr></table></div></div></div></div><p>可以使用下面命令查看被签发的证书</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ openssl x509 -noout -text -in &lt;<span class=o>(</span>kubectl get csr demo-bootstrap-token-csr -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.certificate}&#39;</span> <span class=p>|</span> base64 -d<span class=o>)</span>
</span></span><span class=line><span class=cl>Certificate:
</span></span><span class=line><span class=cl>    Data:
</span></span><span class=line><span class=cl>        Version: <span class=m>3</span> <span class=o>(</span>0x2<span class=o>)</span>
</span></span><span class=line><span class=cl>        Serial Number:
</span></span><span class=line><span class=cl>            32:f8:19:58:a5:4c:d0:24:82:6a:09:c4:0b:8a:2d:6c:7a:26:f3:7d
</span></span><span class=line><span class=cl>        Signature Algorithm: sha256WithRSAEncryption
</span></span><span class=line><span class=cl>        Issuer: <span class=nv>CN</span> <span class=o>=</span> k8s-ca
</span></span><span class=line><span class=cl>        Validity
</span></span><span class=line><span class=cl>            Not Before: Nov <span class=m>23</span> 22:59:00 <span class=m>2024</span> GMT
</span></span><span class=line><span class=cl>            Not After : Nov <span class=m>24</span> 01:14:01 <span class=m>2024</span> GMT
</span></span><span class=line><span class=cl>        Subject: <span class=nv>O</span> <span class=o>=</span> system:nodes, <span class=nv>CN</span> <span class=o>=</span> system:node:bootstap-demo
</span></span><span class=line><span class=cl>        Subject Public Key Info:
</span></span><span class=line><span class=cl>            Public Key Algorithm: rsaEncryption
</span></span><span class=line><span class=cl>                Public-Key: <span class=o>(</span><span class=m>2048</span> bit<span class=o>)</span>
</span></span><span class=line><span class=cl>                Modulus:
</span></span><span class=line><span class=cl>                    00:97:ec:7c:55:f5:e4:1b:68:55:a1:74:28:2f:6d:
</span></span><span class=line><span class=cl>                    27:14:72:35:97:dd:b6:a2:ea:e4:29:8e:59:ca:0c:
</span></span><span class=line><span class=cl>                    fe:2b:9e:a8:5f:25:b8:b3:d7:3b:b7:26:b5:3a:27:
</span></span><span class=line><span class=cl>                    8f:8d:cc:b4:46:fc:88:b9:0f:55:6f:d1:ca:20:15:
</span></span><span class=line><span class=cl>                    16:2d:58:aa:1f:c9:46:01:b3:a7:10:45:39:5d:fc:
</span></span><span class=line><span class=cl>                    96:c6:ae:59:e0:a5:f0:61:13:f6:49:69:f6:fc:46:
</span></span><span class=line><span class=cl>                    56:5f:db:ac:3b:3f:c8:70:fb:bb:d8:4d:3c:c4:e8:
</span></span><span class=line><span class=cl>                    d3:43:12:0f:c8:a2:db:af:62:91:5e:37:2d:ce:5a:
</span></span><span class=line><span class=cl>                    04:a6:d9:66:6c:37:2a:b0:d0:78:2e:a7:02:87:f6:
</span></span><span class=line><span class=cl>                    78:ae:7a:b7:7e:52:19:d1:24:7e:94:c4:b2:ee:32:
</span></span><span class=line><span class=cl>                    e7:c3:90:b7:b3:fc:b8:5b:c8:44:af:5d:72:de:81:
</span></span><span class=line><span class=cl>                    b8:b5:86:a4:35:80:8f:97:36:77:bb:16:8d:5a:f2:
</span></span><span class=line><span class=cl>                    ef:b7:26:67:03:c7:2f:c7:f4:b1:6e:47:fa:a7:ad:
</span></span><span class=line><span class=cl>                    2c:f1:45:e6:3e:19:38:a1:81:52:20:5e:42:85:1c:
</span></span><span class=line><span class=cl>                    1a:30:c6:7b:04:c0:b6:e2:13:82:0b:d8:76:8a:a8:
</span></span><span class=line><span class=cl>                    c4:12:9a:66:1e:8a:e6:5f:a4:f2:7a:d9:28:af:d5:
</span></span><span class=line><span class=cl>                    8a:37:89:26:b8:b3:38:98:6d:a9:33:e6:54:3d:87:
</span></span><span class=line><span class=cl>                    8a:81
</span></span><span class=line><span class=cl>                Exponent: <span class=m>65537</span> <span class=o>(</span>0x10001<span class=o>)</span>
</span></span><span class=line><span class=cl>        X509v3 extensions:
</span></span><span class=line><span class=cl>            X509v3 Key Usage: critical
</span></span><span class=line><span class=cl>                Digital Signature, Key Encipherment
</span></span><span class=line><span class=cl>            X509v3 Extended Key Usage: 
</span></span><span class=line><span class=cl>                TLS Web Client Authentication
</span></span><span class=line><span class=cl>            X509v3 Basic Constraints: critical
</span></span><span class=line><span class=cl>                CA:FALSE
</span></span><span class=line><span class=cl>            X509v3 Subject Key Identifier: 
</span></span><span class=line><span class=cl>                B2:15:FC:C5:FA:2A:53:1A:49:B7:B3:51:32:E4:29:29:2C:76:1E:10</span></span></code></pre></td></tr></table></div></div></div></div><p><strong>kubelet 配置 bootstrap token</strong></p><p>如果使用 <em>bootstrap token</em> 需要启用对应的配置，需要具备下列条件：</p><ol><li><p>kube-apiserver 相关配置</p><ul><li>kube-apiserver 启用参数 <code>--enable-bootstrap-token-auth=true</code></li></ul></li><li><p>kubelet 相关配置</p><ul><li><p>一个用来存储所生成的密钥和证书的路径</p></li><li><p>一个用来指向尚不存在的 <code>kubeconfig</code> 文件的路径；kubelet 会将 <em>bootstrap token</em> 配置文件放到这个位置。</p></li><li><p>一个指向 <em>bootstrap token</em> 的 <code>kubeconfig</code> 文件的路径，用来提供 API 服务器的 URL 和启动 <em>bootstrap token</em>。</p></li></ul></li></ol><div class="pe-details admonition warning open"><div class="pe-details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden=true></i>tip<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content>在启动 kubelet 时，如果参数 <em><strong>&ndash;kubeconfig</strong></em> 所指定的文件并不存在，会使用通过参数 <em><strong>&ndash;bootstrap-kubeconfig</strong></em> 所指定的启动引导 kubeconfig 配置来向 apiserver 请求客户端证书。 在证书请求被批复并被 kubelet 收回时，一个引用所生成的密钥和所获得证书的 kubeconfig 文件会被写入到通过 <em><strong>&ndash;kubeconfig</strong></em> 所指定的文件路径下。 证书和密钥文件会被放到 <em><strong>&ndash;cert-dir</strong></em> 所指定的目录中 <sup><a href=#5>[5]</a></sup>。</div></div></div><h3 id=其他认证方式>其他认证方式<a hidden class=anchor aria-hidden=true href=#其他认证方式>#</a></h3><p>其他认证方式指的是 serviceaccount, openid, webhook token等方式，因为这些不属于 kubernetes 集群中的基础认证方式，而是属于扩展认证方式，故这里不会在提及。</p><h2 id=实验---证书更换>实验 - 证书更换<a hidden class=anchor aria-hidden=true href=#实验---证书更换>#</a></h2><h3 id=构建-kubernetes-11610-实验环境>构建 kubernetes 1.16.10 实验环境<a hidden class=anchor aria-hidden=true href=#构建-kubernetes-11610-实验环境>#</a></h3><p>实验环境使用 kubernetes 1.16.10 来模拟常见的老旧集群（通过二进制方式进行部署）证书过期进行更换的问题。通过上面了解到的“基础认证”方式可以快速做到对集群进行证书更换的问题。</p><p>生成证书列表如下</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>├── apiserver-etcd.crt <span class=c1># kube-apiserver访问etcd使用的客户端证书</span>
</span></span><span class=line><span class=cl>├── apiserver-etcd.key <span class=c1># kube-apiserver访问etcd使用的客户端证书</span>
</span></span><span class=line><span class=cl>├── apiserver-kubelet-client.crt <span class=c1># kube-apiserver访问kubelet使用的证书</span>
</span></span><span class=line><span class=cl>├── apiserver-kubelet-client.key <span class=c1># kube-apiserver访问kubelet使用的证书</span>
</span></span><span class=line><span class=cl>├── ca.crt <span class=c1># k8s 集群使用的ca</span>
</span></span><span class=line><span class=cl>├── ca.key <span class=c1># k8s 集群使用的ca</span>
</span></span><span class=line><span class=cl>├── front-proxy-ca.crt <span class=c1># kube-aggregation使用ca是独立的一套</span>
</span></span><span class=line><span class=cl>├── front-proxy-ca.key <span class=c1># kube-aggregation使用ca是独立的一套</span>
</span></span><span class=line><span class=cl>├── front-proxy-client.crt <span class=c1># kube-aggregation使用</span>
</span></span><span class=line><span class=cl>├── front-proxy-client.key <span class=c1># kube-aggregation使用</span>
</span></span><span class=line><span class=cl>├── kube-apiserver.crt <span class=c1># kube-apiserver使用</span>
</span></span><span class=line><span class=cl>├── kube-apiserver.key <span class=c1># kube-apiserver使用</span>
</span></span><span class=line><span class=cl>├── kube-controller-manager.crt <span class=c1># kube-controller-manager使用</span>
</span></span><span class=line><span class=cl>├── kube-controller-manager.key <span class=c1># kube-controller-manager使用</span>
</span></span><span class=line><span class=cl>├── kube-proxy.crt <span class=c1># kube-proxy使用</span>
</span></span><span class=line><span class=cl>├── kube-proxy.key <span class=c1># kube-proxy使用</span>
</span></span><span class=line><span class=cl>├── kube-scheduler.crt <span class=c1># kube-scheduler使用</span>
</span></span><span class=line><span class=cl>├── kube-scheduler.key <span class=c1># kube-scheduler使用</span>
</span></span><span class=line><span class=cl>├── sa.key <span class=c1># serviceaccount 使用</span>
</span></span><span class=line><span class=cl>└── sa.pub <span class=c1># serviceaccount 使用</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=etcd-证书更换>etcd 证书更换<a hidden class=anchor aria-hidden=true href=#etcd-证书更换>#</a></h3><p>etcd 证书更换部分主要围绕 etcd 所使用的证书进行规划，例如：</p><ol><li>ca</li><li>server</li><li>peer</li><li>client</li></ol><p>这里使用脚本套件会根据 kubernetes 官方给的一个 kubernetes 集群所需要的一套证书的标准进行生成。手动更换即可。更换完成后检查集群状态。</p><div class="pe-details admonition note open"><div class="pe-details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>tip<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content>注意 etcd API 版本，3.5可以直接执行，3.5 之下要使用 V3。</div></div></div><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>etcdctl --key<span class=o>=</span>/etc/kubernetes/ssl/etcd-cluster-key.pem<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cert<span class=o>=</span>/etc/kubernetes/ssl/etcd-cluster.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cacert<span class=o>=</span>/etc/kubernetes/ssl/ca.pem  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--endpoints<span class=o>=</span><span class=s2>&#34;https://10.0.0.221:2379&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>endpoint health</span></span></code></pre></td></tr></table></div></div></div></div><h4 id=遇到的问题>遇到的问题<a hidden class=anchor aria-hidden=true href=#遇到的问题>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>log</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-log data-lang=log>etcd: {&#34;level&#34;:&#34;info&#34;,&#34;ts&#34;:&#34;2024-11-24T12:00:18.546+0800&#34;,&#34;caller&#34;:&#34;embed/etcd.go:465&#34;,&#34;msg&#34;:&#34;starting with peer TLS&#34;,&#34;tls-info&#34;:&#34;cert = /etc/etcd/ssl/etcd-cluster.pem, key = /etc/etcd/ssl/etcd-cluster-key.pem, trusted-ca = /etc/etcd/ssl/ca.pem, client-cert-auth = true, crl-file = &#34;,&#34;cipher-suites&#34;:[]}

etcd: {&#34;level&#34;:&#34;info&#34;,&#34;ts&#34;:&#34;2024-11-24T12:00:18.546+0800&#34;,&#34;caller&#34;:&#34;embed/etcd.go:360&#34;,&#34;msg&#34;:&#34;closing etcd server&#34;,&#34;name&#34;:&#34;cert-expired-1&#34;,&#34;data-dir&#34;:&#34;/var/lib/etcd/{etcd-cluster-name}&#34;,&#34;advertise-peer-urls&#34;:[&#34;https://10.0.0.138:2380&#34;],&#34;advertise-client-urls&#34;:[&#34;https://10.0.0.138:2379&#34;]}</code></pre></div></div><p>启动后立马停止，这里检查 etcd 证书是否正确。</p><h3 id=kube-apiserver-证书更换>kube-apiserver 证书更换<a hidden class=anchor aria-hidden=true href=#kube-apiserver-证书更换>#</a></h3><p>kube-apiserver 所使用的配置参数</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_APISERVER_ARGS</span><span class=o>=</span><span class=s2>&#34;\
</span></span></span><span class=line><span class=cl><span class=s2>--advertise-address=10.0.0.221 \
</span></span></span><span class=line><span class=cl><span class=s2>--allow-privileged=true \
</span></span></span><span class=line><span class=cl><span class=s2>--anonymous-auth=false \
</span></span></span><span class=line><span class=cl><span class=s2>--apiserver-count=3 \
</span></span></span><span class=line><span class=cl><span class=s2>--audit-log-maxage=7 \
</span></span></span><span class=line><span class=cl><span class=s2>--audit-log-maxbackup=10 \
</span></span></span><span class=line><span class=cl><span class=s2>--audit-log-maxsize=100 \
</span></span></span><span class=line><span class=cl><span class=s2>--audit-policy-file=/etc/kubernetes/config/audit-policy.yaml \
</span></span></span><span class=line><span class=cl><span class=s2>--audit-log-path=/var/log/kubernetes/audit/kubernetes-audit.log \
</span></span></span><span class=line><span class=cl><span class=s2>--authorization-mode=Node,RBAC \
</span></span></span><span class=line><span class=cl><span class=s2>--bind-address=10.0.0.221 \
</span></span></span><span class=line><span class=cl><span class=s2>--client-ca-file=/etc/kubernetes/ssl/ca.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--enable-aggregator-routing=true \
</span></span></span><span class=line><span class=cl><span class=s2>--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,PersistentVolumeClaimResize,TaintNodesByCondition,PodNodeSelector,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,NodeRestriction,Priority,ResourceQuota,PodSecurityPolicy \
</span></span></span><span class=line><span class=cl><span class=s2>--enable-swagger-ui=true \
</span></span></span><span class=line><span class=cl><span class=s2>--etcd-cafile=/etc/etcd/ssl/ca.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--etcd-certfile=/etc/kubernetes/ssl/etcd-cluster.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--etcd-keyfile=/etc/kubernetes/ssl/etcd-cluster-key.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--etcd-servers=https://10.0.0.221:2379,https://10.0.0.138:2379,https://10.0.0.131:2379 \
</span></span></span><span class=line><span class=cl><span class=s2>--event-ttl=1h \
</span></span></span><span class=line><span class=cl><span class=s2>--feature-gates=ExpandInUsePersistentVolumes=true,ExpandPersistentVolumes=true,RotateKubeletServerCertificate=true \
</span></span></span><span class=line><span class=cl><span class=s2>--encryption-provider-config=/etc/kubernetes/pki/encryption-config.yaml \
</span></span></span><span class=line><span class=cl><span class=s2>--insecure-port=0 \
</span></span></span><span class=line><span class=cl><span class=s2>--kubelet-certificate-authority=/etc/kubernetes/ssl/ca.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--kubelet-client-certificate=/etc/kubernetes/ssl/admin.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--kubelet-client-key=/etc/kubernetes/ssl/admin-key.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--kubelet-https=true \
</span></span></span><span class=line><span class=cl><span class=s2>--requestheader-client-ca-filel=/etc/kubernetes/ssl/ca.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--requestheader-allowed-names=aggregator \
</span></span></span><span class=line><span class=cl><span class=s2>--requestheader-extra-headers-prefix=X-Remote-Extra- \
</span></span></span><span class=line><span class=cl><span class=s2>--requestheader-group-headers=X-Remote-Group \
</span></span></span><span class=line><span class=cl><span class=s2>--requestheader-username-headers=X-Remote-User \
</span></span></span><span class=line><span class=cl><span class=s2>--profiling=false \
</span></span></span><span class=line><span class=cl><span class=s2>--proxy-client-cert-file=/etc/kubernetes/ssl/kube-aggregration.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--proxy-client-key-file=/etc/kubernetes/ssl/kube-aggregration-key.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--runtime-config=api/all \
</span></span></span><span class=line><span class=cl><span class=s2>--secure-port=6443 \
</span></span></span><span class=line><span class=cl><span class=s2>--service-account-lookup=true \
</span></span></span><span class=line><span class=cl><span class=s2>--service-account-key-file=/etc/kubernetes/ssl/service-account.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--service-cluster-ip-range=10.191.196.0/24 \
</span></span></span><span class=line><span class=cl><span class=s2>--service-node-port-range=30000-52767 \
</span></span></span><span class=line><span class=cl><span class=s2>--tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--tls-min-version=VersionTLS12 \
</span></span></span><span class=line><span class=cl><span class=s2>--tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256 \
</span></span></span><span class=line><span class=cl><span class=s2>--tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>注意需要替换的证书部分</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>## etcd 部分</span>
</span></span><span class=line><span class=cl><span class=c1># etcd 的ca, 套件生成的 etcd 和 k8s 使用的是不同 ca</span>
</span></span><span class=line><span class=cl>--etcd-cafile<span class=o>=</span>/etc/etcd/ssl/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=c1># etcd 客户端证书的 key 和 crt</span>
</span></span><span class=line><span class=cl>--etcd-certfile<span class=o>=</span>/etc/kubernetes/ssl/etcd-cluster.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--etcd-keyfile<span class=o>=</span>/etc/kubernetes/ssl/etcd-cluster-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>
</span></span><span class=line><span class=cl><span class=c1>## kube-apiserver 和 kubelet 通讯部分</span>
</span></span><span class=line><span class=cl><span class=c1># k8s 集群中使用的ca</span>
</span></span><span class=line><span class=cl>--kubelet-certificate-authority<span class=o>=</span>/etc/kubernetes/ssl/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=c1># kube-apiserver 请求到 kubelet 使用的证书</span>
</span></span><span class=line><span class=cl><span class=c1># 例如在 kubectl logs / kubectl exec 时，kube-apiserver会直接请求 kubelet 这里需要证书正确</span>
</span></span><span class=line><span class=cl>--kubelet-client-certificate<span class=o>=</span>/etc/kubernetes/ssl/admin.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--kubelet-client-key<span class=o>=</span>/etc/kubernetes/ssl/admin-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>
</span></span><span class=line><span class=cl><span class=c1>## front-proxy部分，这部分主要适用于 kube-apiserver 与外部 apiserver通讯使用</span>
</span></span><span class=line><span class=cl>--proxy-client-cert-file<span class=o>=</span>/etc/kubernetes/ssl/kube-aggregration.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--proxy-client-key-file<span class=o>=</span>/etc/kubernetes/ssl/kube-aggregration-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>
</span></span><span class=line><span class=cl><span class=c1># serviceaccount</span>
</span></span><span class=line><span class=cl>--service-account-key-file<span class=o>=</span>/etc/kubernetes/ssl/service-account.pem <span class=err>\</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=遇到的问题-1>遇到的问题<a hidden class=anchor aria-hidden=true href=#遇到的问题-1>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>log</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-log data-lang=log>clientconn.go:1120] grpc: addrConn.createTransport failed to connect to {https://10.0.0.221:2379 0  &lt;nil&gt;}. Err :connection error: desc = &#34;transport: authentication handshake failed: x509: certificate signed by unknown authority (possibly because of \&#34;crypto/rsa: verification error\&#34; while trying to verify candidate authority certificate \&#34;Kubernetes\&#34;)&#34;. Reconnecting...

clientconn.go:1120] grpc: addrConn.createTransport failed to connect to {https://10.0.0.221:2379 0  &lt;nil&gt;}. Err :connection error: desc = &#34;transport: authentication handshake failed: x509: certificate signed by unknown authority (possibly because of \&#34;crypto/rsa: verification error\&#34; while trying to verify candidate authority certificate \&#34;Kubernetes\&#34;)&#34;. Reconnecting...</code></pre></div></div><p>报错提示握手认证失败，手动使用 cert 和 key 访问是正常</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ etcdctl --key<span class=o>=</span>/etc/kubernetes/ssl/etcd-cluster-key.pem --cert<span class=o>=</span>/etc/kubernetes/ssl/etcd-cluster.pem --cacert<span class=o>=</span>/etc/etcd/ssl/ca.pem  --endpoints<span class=o>=</span><span class=s2>&#34;https://10.0.0.221:2379&#34;</span> endpoint health
</span></span><span class=line><span class=cl>https://10.0.0.221:2379 is healthy: successfully committed proposal: <span class=nv>took</span> <span class=o>=</span> 11.661676ms</span></span></code></pre></td></tr></table></div></div></div></div><p>原因：注意 etcd ca 是否正确。要确认下面的均为正确配置才可以</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>--etcd-cafile<span class=o>=</span>/etc/etcd/ssl/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--etcd-certfile<span class=o>=</span>/etc/kubernetes/ssl/etcd-cluster.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--etcd-keyfile<span class=o>=</span>/etc/kubernetes/ssl/etcd-cluster-key.pem <span class=err>\</span></span></span></code></pre></td></tr></table></div></div></div></div><p>无法查看 pod 日志 <em>You must be logged in to the server</em></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>error: You must be logged in to the server <span class=o>(</span>the server has asked <span class=k>for</span> the client to provide credentials <span class=o>(</span> pods/log xxx-xxx-xxx<span class=o>))</span></span></span></code></pre></td></tr></table></div></div></div></div><p>这个就是上面提到的，要保证 kube-apiserver 和 kubelet 使用的证书是否一致</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>--kubelet-client-certificate
</span></span><span class=line><span class=cl>--kubelet-client-key</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=kube-controller-manager-证书更换>kube-controller-manager 证书更换<a hidden class=anchor aria-hidden=true href=#kube-controller-manager-证书更换>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_CONTROLLER_MANAGER_ARGS</span><span class=o>=</span><span class=s2>&#34;\
</span></span></span><span class=line><span class=cl><span class=s2>--allocate-node-cidrs=false \
</span></span></span><span class=line><span class=cl><span class=s2>--bind-address=10.0.0.221 \
</span></span></span><span class=line><span class=cl><span class=s2>--cluster-cidr=10.96.192.0/22 \
</span></span></span><span class=line><span class=cl><span class=s2>--authorization-always-allow-paths=/healthz,/metrics \
</span></span></span><span class=line><span class=cl><span class=s2>--cluster-name=kubernetes \
</span></span></span><span class=line><span class=cl><span class=s2>--cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--controllers=*,bootstrapsigner,tokencleaner \
</span></span></span><span class=line><span class=cl><span class=s2>--feature-gates=ExpandInUsePersistentVolumes=true,ExpandPersistentVolumes=true,RotateKubeletServerCertificate=true \
</span></span></span><span class=line><span class=cl><span class=s2>--kubeconfig=/etc/kubernetes/config/kube-controller-manager.kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s2>--leader-elect=true \
</span></span></span><span class=line><span class=cl><span class=s2>--profiling=false \
</span></span></span><span class=line><span class=cl><span class=s2>--port=0 \
</span></span></span><span class=line><span class=cl><span class=s2>--node-monitor-grace-period=40s \
</span></span></span><span class=line><span class=cl><span class=s2>--node-monitor-period=5s \
</span></span></span><span class=line><span class=cl><span class=s2>--pod-eviction-timeout=2m \
</span></span></span><span class=line><span class=cl><span class=s2>--root-ca-file=/etc/kubernetes/ssl/ca.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--service-account-private-key-file=/etc/kubernetes/ssl/service-account-key.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--service-cluster-ip-range=10.96.0.0/24 \
</span></span></span><span class=line><span class=cl><span class=s2>--secure-port=10257 \
</span></span></span><span class=line><span class=cl><span class=s2>--terminated-pod-gc-threshold=250 \
</span></span></span><span class=line><span class=cl><span class=s2>--tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--tls-min-version=VersionTLS12 \
</span></span></span><span class=line><span class=cl><span class=s2>--tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256 \
</span></span></span><span class=line><span class=cl><span class=s2>--tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--use-service-account-credentials=true&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>除了上面提到的，ca 外，只需要替换 serviceaccount 所需的 key 即可</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>--cluster-signing-cert-file<span class=o>=</span>/etc/kubernetes/ssl/ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cluster-signing-key-file<span class=o>=</span>/etc/kubernetes/ssl/ca-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=c1># 这个参数和 kube-apiserver 的是一对</span>
</span></span><span class=line><span class=cl>--tls-cert-file<span class=o>=</span>/etc/kubernetes/ssl/kube-controller-manager.pem <span class=err>\</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=kube-scheduler-证书更换>kube-scheduler 证书更换<a hidden class=anchor aria-hidden=true href=#kube-scheduler-证书更换>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBE_SCHEDULER_ARGS</span><span class=o>=</span><span class=s2>&#34;\
</span></span></span><span class=line><span class=cl><span class=s2>--bind-address=10.0.0.221 \
</span></span></span><span class=line><span class=cl><span class=s2>--config=/etc/kubernetes/config/kube-scheduler.yaml \
</span></span></span><span class=line><span class=cl><span class=s2>--profiling=false \
</span></span></span><span class=line><span class=cl><span class=s2>--client-ca-file=/etc/kubernetes/ssl/ca.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--port=0 \
</span></span></span><span class=line><span class=cl><span class=s2>--secure-port=10259 \
</span></span></span><span class=line><span class=cl><span class=s2>--feature-gates=ExpandInUsePersistentVolumes=true,ExpandPersistentVolumes=true,RotateKubeletServerCertificate=true \
</span></span></span><span class=line><span class=cl><span class=s2>--tls-cert-file=/etc/kubernetes/ssl/kube-scheduler.pem \
</span></span></span><span class=line><span class=cl><span class=s2>--tls-min-version=VersionTLS12 \
</span></span></span><span class=line><span class=cl><span class=s2>--tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256 \
</span></span></span><span class=line><span class=cl><span class=s2>--tls-private-key-file=/etc/kubernetes/ssl/kube-scheduler-key.pem&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><div class="pe-details admonition warning open"><div class="pe-details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden=true></i>tip<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content>需要注意的是，除了 kube-apiserver 服务外，其他的组件需要手动更换 kubeconfig 文件。</div></div></div><h3 id=工作节点证书更换>工作节点证书更换<a hidden class=anchor aria-hidden=true href=#工作节点证书更换>#</a></h3><p>如果节点使用 bootstrap 证书进行部署的，通常证书不正确 <em>kubelet</em> 会从新自动申请 csr 获取新证书，这部分根据 kubernetes 集群版本不同需要手动进行批准 (<em>kubectl certificate approve</em>)。</p><p>另外一种方式就是，手动重新给每一个节点的 <em>kubelet</em> 重新签发证书，并且替换每一个节点的 <em>kube-proxy</em> 的 kubeconfig 文件 (==这里使用的套件是 bootstrap token==)。生成证书的要求按照 bootstrap token 部分介绍的：</p><ol><li>SAN Email, IP, URI 必须不提供。</li><li>证书的 Organization 字段必须为 <code>system:nodes</code>，例如: O = system:nodes</li><li>证书的 commonName 字段必须为 <code>sytem:node:</code> 开头，通常格式定义为 <em>sytem:node:hostname</em>，例如: CN = system:node:debian-demo。</li><li>证书 Usage 必须配置 <em>client auth</em> 和 <em>digital signature</em>， 这部分在生成脚本中有配置。</li></ol><h3 id=更换cni使用证书>更换cni使用证书<a hidden class=anchor aria-hidden=true href=#更换cni使用证书>#</a></h3><p>例如 calico 使用了etcd时，etcd为外部etcd时，这里的证书也要替换，否则 calico-controller 会无法连接etcd，下图是对应的日志。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20250119225856768.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20250119225856768.png#center alt=image-20250119225856768 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：calico-controller无法连接etcd</center><h3 id=更换serviceaccount>更换serviceaccount<a hidden class=anchor aria-hidden=true href=#更换serviceaccount>#</a></h3><p>在 kubernetes 官方的 “手动轮换 CA 证书” <sup><a href=#6>[6]</a></sup> 一文中有提到，在更新了 CA 之后，集群内 Pod 需要重启以获得新的 Secret 数据。下图是当 Pod 没有重启时，在启动新 Pod 的报错</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20250119231958618.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20250119231958618.png#center alt=image-20250119231958618 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：network: Unauthorized</center><p><em><strong>network: Unauthorized</strong></em> 原因如下：</p><ol><li>cni node 没有启动</li><li>旧的 default secret 还是旧的，没办法请求到 apiserver 去创建网络空间</li></ol><p>当更换完成证书后，检查 node cni 服务全部没问题，但是新建的Pod无法创建网络，提示 <em>network: Unauthorized</em>；重建了所有的 secret后重启 Pod 就恢复了。这时 kubelet 出现日志如下：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>log</span></div><div class=pe-code-block-header-center><span>kubelet报错日志1</span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-log data-lang=log>W0113 12:11:06.526394   11195 docker_sandbox.go:394] failed to read pod IP from plugin/docker: networkPlugin cni failed on the status hook for pod &#34;a01-im-web-5f6f9b4459-p6gnt_a01&#34;: CNI failed to retrieve network namespace path: cannot find network namespace for the terminated container &#34;c8145349eebe397d4c7f30cb326f20338b668b67ebdfddf5e51be14992a18894&#34;
W0113 12:11:06.528734   11195 docker_sandbox.go:394] failed to read pod IP from plugin/docker: networkPlugin cni failed on the status hook for pod &#34;a01-im-web-5f6f9b4459-p6gnt_a01&#34;: CNI failed to retrieve network namespace path: cannot find network namespace for the terminated container &#34;1823c082be12441a1df17875eb9cc9efdb19d7b37d71653c5182b23b7fcab694&#34;
W0113 12:11:06.532607   11195 docker_sandbox.go:394] failed to read pod IP from plugin/docker: networkPlugin cni failed on the status hook for pod &#34;a01-im-web-5f6f9b4459-p6gnt_a01&#34;: CNI failed to retrieve network namespace path: cannot find network namespace for the terminated container &#34;1bae78ef6fa9dbb48002984d96b2d6222ddc14caf2e9bf04a9abb8fce7ad4a18&#34;
W0113 12:11:06.534956   11195 docker_sandbox.go:394] failed to read pod IP from plugin/docker: networkPlugin cni failed on the status hook for pod &#34;a01-im-web-5f6f9b4459-p6gnt_a01&#34;: CNI failed to retrieve network namespace path: cannot find network namespace for the terminated container &#34;528754d0e7ca862dc6723a573c032f53326d53aff3e768694a11b01090cdf7d1&#34;
W0113 12:11:06.537408   11195 docker_sandbox.go:394] failed to read pod IP from plugin/docker: networkPlugin cni failed on the status hook for pod &#34;a01-im-web-5f6f9b4459-p6gnt_a01&#34;: CNI failed to retrieve network namespace path: cannot find network namespace for the terminated container &#34;39e65a5a7250bd14305412a041fce9873f9dee88ecfc85b9b8c21c5db472a353&#34;
W0113 12:11:06.539590   11195 docker_sandbox.go:394] failed to read pod IP from plugin/docker: networkPlugin cni failed on the status hook for pod &#34;a01-im-web-5f6f9b4459-p6gnt_a01&#34;: CNI failed to retrieve network namespace path: cannot find network namespace for the terminated container &#34;d52e93aa1163041e20ab0b5e8b200f14a70581252c2424c943d53478e8656a79&#34;</code></pre></div></div><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>log</span></div><div class=pe-code-block-header-center><span>kubelet报错日志2</span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-log data-lang=log>6300 kubelet_volumes.go:154] orphaned pod &#34;a3f45f45-b6e5-4fb8-9d32-d691f966173a&#34; found, but volume subpaths are still present on disk : There were a total of 1 errors similar to this. Turn up verbosity to see them.
6300 cni.go:364] Error adding push-web-api-6bcc765c4-8r242/0ed92e1b512ecc25414e0540a3bc06060cf4d4ea09ebd0fb9dbe20f1c9e0389e to network calico/k8s-pod-network: Unauthorized
6300 dns.go:135] Nameserver limits were exceeded, some nameservers have been omitted, the applied nameserver line is: 10.190.16.41 10.190.16.42 10.240.16.41
6300 remote_runtime.go:105] RunPodSandbox from runtime service failed: rpc error: code = Unknown desc = failed to set up sandbox container &#34;0ed92e1b512ecc25414e0540a3bc06060cf4d4ea09ebd0fb9dbe20f1c9e0389e&#34; network for pod &#34;push-web-api-6bcc765c4-8r242&#34;: networkPlugin cni failed to set up pod &#34;push-web-api-6bcc765c4-8r242_prd_user_32as1&#34; network: Unauthorized
6300 kuberuntime_sandbox.go:68] CreatePodSandbox for pod &#34;push-web-api-6bcc765c4-8r242_prd_user_32as1(c87c4346-def7-4326-9406-48de0c641a94)&#34; failed: rpc error: code = Unknown desc = failed to set up sandbox container &#34;0ed92e1b512ecc25414e0540a3bc06060cf4d4ea09ebd0fb9dbe20f1c9e0389e&#34; network for pod &#34;push-web-api-6bcc765c4-8r242&#34;: networkPlugin cni failed to set up pod &#34;push-web-api-6bcc765c4-8r242_prd_user_32as1&#34; network: Unauthorized
./kubelet.ph190svr015012.root.log.ERROR.20250113-171637.6300:E0113 17:32:27.121142    6300 kuberuntime_manager.go:710] createPodSandbox for pod &#34;push-web-api-6bcc765c4-8r242_prd_user_32as1(c87c4346-def7-4326-9406-48de0c641a94)&#34; failed: rpc error: code = Unknown desc = failed to set up sandbox container &#34;0ed92e1b512ecc25414e0540a3bc06060cf4d4ea09ebd0fb9dbe20f1c9e0389e&#34; network for pod &#34;push-web-api-6bcc765c4-8r242&#34;: networkPlugin cni failed to set up pod &#34;push-web-api-6bcc765c4-8r242_prd_user_32as1&#34; network: Unauthorized
6300 pod_workers.go:191] Error syncing pod c87c4346-def7-4326-9406-48de0c641a94 (&#34;push-web-api-6bcc765c4-8r242_prd_user_32as1(c87c4346-def7-4326-9406-48de0c641a94)&#34;), skipping: failed to &#34;CreatePodSandbox&#34; for &#34;push-web-api-6bcc765c4-8r242_prd_user_32as1(c87c4346-def7-4326-9406-48de0c641a94)&#34; with CreatePodSandboxError: &#34;CreatePodSandbox for pod \&#34;push-web-api-6bcc765c4-8r242_prd_user_32as1(c87c4346-def7-4326-9406-48de0c641a94)\&#34; failed: rpc error: code = Unknown desc = failed to set up sandbox container \&#34;0ed92e1b512ecc25414e0540a3bc06060cf4d4ea09ebd0fb9dbe20f1c9e0389e\&#34; network for pod \&#34;push-web-api-6bcc765c4-8r242\&#34;: networkPlugin cni failed to set up pod \&#34;push-web-api-6bcc765c4-8r242_prd_user_32as1\&#34; network: Unauthorized&#34;
6300 cni.go:385] Error deleting logging_filebeat-filebeat-68525/131e91d83d51925a5298be7c21f739c5341db9ecde26bf58509c60278caae46e from network calico/k8s-pod-network: context deadline exceeded
6300 remote_runtime.go:128] StopPodSandbox &#34;131e91d83d51925a5298be7c21f739c5341db9ecde26bf58509c60278caae46e&#34; from runtime service failed: rpc error: code = Unknown desc = networkPlugin cni failed to teardown pod &#34;filebeat-filebeat-68525_logging&#34; network: context deadline exceeded
6300 kuberuntime_manager.go:878] Failed to stop sandbox {&#34;docker&#34; &#34;131e91d83d51925a5298be7c21f739c5341db9ecde26bf58509c60278caae46e&#34;}
6300 cni.go:385] Error deleting public_public-gameinterface-office-74fc5bdcc-sfp5d/8a049c280b256e6afc5832b2f77d1e90b7b0ae8590e0403b5efedb391c4a1a7f from network calico/k8s-pod-network: context deadline exceeded
6300 remote_runtime.go:128] StopPodSandbox &#34;8a049c280b256e6afc5832b2f77d1e90b7b0ae8590e0403b5efedb391c4a1a7f&#34; from runtime service failed: rpc error: code = Unknown desc = networkPlugin cni failed to teardown pod &#34;public-gameinterface-office-74fc5bdcc-sfp5d_public&#34; network: context deadline exceeded</code></pre></div></div><h4 id=遇到的问题-2>遇到的问题<a hidden class=anchor aria-hidden=true href=#遇到的问题-2>#</a></h4><p><em><strong>tls: bad certificate</strong></em> 问题原因，更新完成证书后，Pod 中 CA 会更新，但是 secret token 不会自动更新，容器内请求 API 使用 serviceaccount token，当更换 CA 后必须重启 Pod 才能重新在 Pod 内建立新的 token。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>log</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-log data-lang=log>I0114 11:25:25.925418    1063 log.go:172] http: TLS handshake error from 10.190.15.40:3418: remote error: tls: bad certificate
I0114 11:25:25.931262    1063 log.go:172] http: TLS handshake error from 10.190.15.40:6413: remote error: tls: bad certificate
I0114 11:25:25.931643    1063 log.go:172] http: TLS handshake error from 10.190.15.40:61463: remote error: tls: bad certificate
I0114 11:25:25.937855    1063 log.go:172] http: TLS handshake error from 10.190.15.40:20758: remote error: tls: bad certificate
I0114 11:25:25.939317    1063 log.go:172] http: TLS handshake error from 10.190.15.40:49564: remote error: tls: bad certificate
I0114 11:25:25.945868    1063 log.go:172] http: TLS handshake error from 10.190.15.40:54670: remote error: tls: bad certificate
I0114 11:25:25.945937    1063 log.go:172] http: TLS handshake error from 10.190.15.40:10809: remote error: tls: bad certificate
I0114 11:25:25.954650    1063 log.go:172] http: TLS handshake error from 10.190.15.40:19277: remote error: tls: bad certificate
I0114 11:25:25.955125    1063 log.go:172] http: TLS handshake error from 10.190.15.40:12765: remote error: tls: bad certificate
I0114 11:25:25.963410    1063 log.go:172] http: TLS handshake error from 10.190.15.40:61484: remote error: tls: bad certificate
I0114 11:25:25.963924    1063 log.go:172] http: TLS handshake error from 10.190.15.40:21905: remote error: tls: bad certificate
I0114 11:25:25.972193    1063 log.go:172] http: TLS handshake error from 10.190.15.40:47752: remote error: tls: bad certificate
I0114 11:25:25.972608    1063 log.go:172] http: TLS handshake error from 10.190.15.40:12960: remote error: tls: bad certificate
I0114 11:25:25.972863    1063 log.go:172] http: TLS handshake error from 10.190.15.40:1635: remote error: tls: bad certificate
I0114 11:25:25.975030    1063 log.go:172] http: TLS handshake error from 10.190.15.40:23673: remote error: tls: bad certificate
I0114 11:25:25.975148    1063 log.go:172] http: TLS handshake error from 10.190.15.40:57676: remote error: tls: bad certificate
I0114 11:25:25.982164    1063 log.go:172] http: TLS handshake error from 10.190.15.40:40683: remote error: tls: bad certificate
I0114 11:25:25.982192    1063 log.go:172] http: TLS handshake error from 10.190.15.40:11049: remote error: tls: bad certificate
I0114 11:25:25.990024    1063 log.go:172] http: TLS handshake error from 10.190.15.40:25287: remote error: tls: bad certificate
I0114 11:25:25.990288    1063 log.go:172] http: TLS handshake error from 10.190.15.40:30061: remote error: tls: bad certificate
I0114 11:25:25.992142    1063 log.go:172] http: TLS handshake error from 10.190.15.40:38174: remote error: tls: bad certificate
I0114 11:25:26.000204    1063 log.go:172] http: TLS handshake error from 10.190.15.40:63942: remote error: tls: bad certificate
I0114 11:25:26.002349    1063 log.go:172] http: TLS handshake error from 10.190.15.40:55625: remote error: tls: bad certificate
I0114 11:25:26.027144    1063 log.go:172] http: TLS handshake error from 10.190.15.40:46402: remote error: tls: bad certificate
I0114 11:25:26.027458    1063 log.go:172] http: TLS handshake error from 10.190.15.40:2822: remote error: tls: bad certificate
I0114 11:25:26.036703    1063 log.go:172] http: TLS handshake error from 10.190.15.40:57254: remote error: tls: bad certificate
I0114 11:25:26.037100    1063 log.go:172] http: TLS handshake error from 10.190.15.40:53104: remote error: tls: bad certificate</code></pre></div></div><p>验证上述问题</p><p>使用 SA token 访问 API</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -k <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> -H <span class=s2>&#34;Authorization: Bearer </span><span class=k>$(</span>cat /var/run/secrets/kubernetes.io/serviceaccount/token<span class=k>)</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> https://kubernetes.default.svc/api/v1/pods</span></span></code></pre></td></tr></table></div></div></div></div><p>未重启过的Pod</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ls /var/run/secrets/kubernetes.io/serviceaccount/token
</span></span><span class=line><span class=cl>/var/run/secrets/kubernetes.io/serviceaccount/token
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ curl -k <span class=se>\u</span>n/secrets/kubernetes.io/serviceaccount/token
</span></span><span class=line><span class=cl>  -H <span class=s2>&#34;Authorization: Bearer </span><span class=k>$(</span>cat /var/run/secrets/kubernetes.io/serviceaccount/token<span class=k>)</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  https://kubernetes.default.svc/api/v1/podsecrets/kubernetes.io/serviceaccount/t
</span></span><span class=line><span class=cl><span class=o>{</span> https://kubernetes.default.svc/api/v1/pods
</span></span><span class=line><span class=cl>  <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;Status&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;v1&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;metadata&#34;</span>: <span class=o>{}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;Failure&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;Unauthorized&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;reason&#34;</span>: <span class=s2>&#34;Unauthorized&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;code&#34;</span>: <span class=m>401</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>重启更换过 Token 的 Pod</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -k <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -H <span class=s2>&#34;Authorization: Bearer </span><span class=k>$(</span>cat /var/run/secrets/kubernetes.io/serviceaccount/token<span class=k>)</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  https://kubernetes.default.svc/api/v1/pods
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;Status&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;v1&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;metadata&#34;</span>: <span class=o>{}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;status&#34;</span>: <span class=s2>&#34;Failure&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;message&#34;</span>: <span class=s2>&#34;pods is forbidden: User \&#34;system:serviceaccount:netbox:default\&#34; cannot list resource \&#34;pods\&#34; in API group \&#34;\&#34; at the cluster scope&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;reason&#34;</span>: <span class=s2>&#34;Forbidden&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;details&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;pods&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;code&#34;</span>: <span class=m>403</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><ul><li>了解了 k8s 集群认证模式（TLS Everywhere）。</li><li>通过基础知识知道了换证书需要更换那些地方。</li><li>没有尝试官方提到的滚动更新CA的方式。</li></ul><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ul><li><p><sup id=1>[1]</sup> <a href=https://github.com/cylonchau/kubernetes-generator target=_blank rel="noopener nofollow noreferrer"><em>kubernetes-generator</em></a></p></li><li><p><sup id=2>[2]</sup> <a href=https://web.archive.org/web/20250116153657/https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/authentication/#authentication-strategies target=_blank rel="noopener nofollow noreferrer"><em>身份认证策略</em></a></p></li><li><p><sup id=2>[3]</sup> <a href=https://web.archive.org/web/20241217200727/https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/bootstrap-tokens/ target=_blank rel="noopener nofollow noreferrer"><em>使用启动引导令牌（Bootstrap Tokens）认证</em></a></p></li><li><p><sup id=4>[4]</sup> <a href=https://web.archive.org/web/20241217215419/https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/certificate-signing-requests/#kubernetes-signers target=_blank rel="noopener nofollow noreferrer"><em>Kubernetes 签名者</em></a></p></li><li><p><sup id=5>[5]</sup> <a href=https://web.archive.org/web/20250119135851/https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/kubelet-tls-bootstrapping/#client-and-serving-certificates target=_blank rel="noopener nofollow noreferrer"><em>kubelet 配置</em></a></p></li><li><p><sup id=6>[6]</sup> <a href=https://web.archive.org/web/20250119155209/https://kubernetes.io/zh-cn/docs/tasks/tls/manual-rotation-of-ca-certificates/ target=_blank rel="noopener nofollow noreferrer"><em>手动轮换 CA 证书</em></a></p></li><li><p><sup id=7>[7]</sup> <a href=https://web.archive.org/web/20250119155351/https://www.synacktiv.com/publications/so-i-became-a-node-exploiting-bootstrap-tokens-in-azure-kubernetes-service target=_blank rel="noopener nofollow noreferrer"><em>So I became a node: exploiting bootstrap tokens in Azure Kubernetes Service</em></a></p></li><li><p><sup id=8>[8]</sup> <a href="https://web.archive.org/web/20250119155838/https://www.suse.com/support/kb/doc/?id=000020019" target=_blank rel="noopener nofollow noreferrer"><em>How to regenerate Service Account tokens in Kubernetes</em></a></p></li><li><p><sup id=9>[9]</sup> <a href="https://web.archive.org/web/20210317070446/https://deezer.io/updating-kubernetes-ca-certificates-the-hard-way-f9518108791d?gi=7e5c45166275" target=_blank rel="noopener nofollow noreferrer"><em>Updating Kubernetes CA certificates the hard way</em></a></p></li></ul></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：TLS Everywhere - 解密kubernetes集群的安全认证</p><p>文章链接：<a href=https://www.oomkill.com/2024/11/k8s-auth-and-regenerate-cert/ target=_blank>https://www.oomkill.com/2024/11/k8s-auth-and-regenerate-cert/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2023/02/ch23-extend-kube-proxy/><span>深入理解Kubernetes service - 如何扩展现有的kube-proxy架构？</span></a></li><li><a href=/2024/11/debian12-install-k8s-1.16/><span>debian12 - 高版本系统安装旧版本k8s异常处理</span></a></li><li><a href=/2024/06/kubernetes-without-etcd-step-by-step/><span>构建集群kubernetes v1.28并使用kine和mysql替换etcd</span></a></li><li><a href=/2024/04/kubernetes-kubectl-diagnose/><span>探索kubectl - kubectl诊断命令集合</span></a></li><li><a href=/2024/02/kubernetes-update-secert/><span>Kubernetes维护 - secret批量更新</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2024/11/debian12-install-k8s-1.16/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>debian12 - 高版本系统安装旧版本k8s异常处理</span>
</a><a class=next href=https://www.oomkill.com/2024/11/openssl-cnf/><span class=title></span>
<span>openssl.cnf详解&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/blogs","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/k8s-auth-and-regenerate-cert","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>