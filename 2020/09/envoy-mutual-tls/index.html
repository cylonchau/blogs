<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Envoy：TLS双向认证 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="envoy"><meta name=description content="环境准备 主机 角色 数量 front-envoy front envoy 1 service envoy 作为内部后端的envoy 2 end 后端应用程序 2 访问 / front-envoy ==> end * 2 访问 /red/colorful ==> end red 不验证客户端证书 单项tls 访问 /gray/colorful ==> end gray 验证客户端证书 双项tls
docker-compose text 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 version: '3' services: front-envoy: image: envoyproxy/envoy-alpine:v1."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2020/09/envoy-mutual-tls/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2020/09/envoy-mutual-tls/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-H94HZ5S19Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H94HZ5S19Y")</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="Envoy：TLS双向认证"><meta property="og:description" content="环境准备 主机 角色 数量 front-envoy front envoy 1 service envoy 作为内部后端的envoy 2 end 后端应用程序 2 访问 / front-envoy ==> end * 2 访问 /red/colorful ==> end red 不验证客户端证书 单项tls 访问 /gray/colorful ==> end gray 验证客户端证书 双项tls
docker-compose text 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 version: '3' services: front-envoy: image: envoyproxy/envoy-alpine:v1."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2020/09/envoy-mutual-tls/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-29T00:00:00+00:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="Envoy：TLS双向认证"><meta name=twitter:description content="环境准备 主机 角色 数量 front-envoy front envoy 1 service envoy 作为内部后端的envoy 2 end 后端应用程序 2 访问 / front-envoy ==> end * 2 访问 /red/colorful ==> end red 不验证客户端证书 单项tls 访问 /gray/colorful ==> end gray 验证客户端证书 双项tls
docker-compose text 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 version: '3' services: front-envoy: image: envoyproxy/envoy-alpine:v1."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"Envoy：TLS双向认证","item":"https://www.oomkill.com/2020/09/envoy-mutual-tls/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Envoy：TLS双向认证","name":"Envoy：TLS双向认证","description":"环境准备 主机 角色 数量 front-envoy front envoy 1 service envoy 作为内部后端的envoy 2 end 后端应用程序 2 访问 / front-envoy ==\u0026gt; end * 2 访问 /red/colorful ==\u0026gt; end red 不验证客户端证书 单项tls 访问 /gray/colorful ==\u0026gt; end gray 验证客户端证书 双项tls\ndocker-compose text 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 version: \u0026#39;3\u0026#39; services: front-envoy: image: envoyproxy/envoy-alpine:v1.","keywords":["envoy"],"articleBody":"环境准备 主机 角色 数量 front-envoy front envoy 1 service envoy 作为内部后端的envoy 2 end 后端应用程序 2 访问 / front-envoy ==\u003e end * 2 访问 /red/colorful ==\u003e end red 不验证客户端证书 单项tls 访问 /gray/colorful ==\u003e end gray 验证客户端证书 双项tls\ndocker-compose text 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 version: '3' services: front-envoy: image: envoyproxy/envoy-alpine:v1.15-latest environment: - ENVOY_UID=0 ports: - 80:80 - 443:443 - 82:9901 volumes: - ./envoy.yaml:/etc/envoy/envoy.yaml - ./certs/front-envoy/:/etc/envoy/certs/ - ./certs/CA/:/etc/envoy/ca/ networks: envoymesh: aliases: - front-envoy depends_on: - webserver1 - webserver2 gray-envoy: image: envoyproxy/envoy-alpine:v1.15-latest environment: - ENVOY_UID=0 volumes: - ./service_gray.yaml:/etc/envoy/envoy.yaml - ./certs/service_gray/:/etc/envoy/certs/ - ./certs/CA1/:/etc/envoy/ca/ network_mode: \"service:webserver1\" depends_on: - webserver1 red-envoy: image: envoyproxy/envoy-alpine:v1.15-latest environment: - ENVOY_UID=0 volumes: - ./service_red.yaml:/etc/envoy/envoy.yaml - ./certs/service_red/:/etc/envoy/certs/ - ./certs/CA1/:/etc/envoy/ca/ network_mode: \"service:webserver2\" depends_on: - webserver2 webserver1: image: cylonchau/envoy-end:latest networks: envoymesh: aliases: - service_gray - front_envoy environment: - VERSION=v1 - COLORFUL=gray expose: - 90 webserver2: image: cylonchau/envoy-end:latest networks: envoymesh: aliases: - service_red - front_envoy environment: - VERSION=v1 - COLORFUL=red expose: - 90 networks: envoymesh: {} front-envoy text 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 admin: access_log_path: \"/dev/null\" address: socket_address: address: 0.0.0.0 port_value: 9901 static_resources: secrets: - name: servers tls_certificate: certificate_chain: filename: \"/etc/envoy/certs/server.crt\" private_key: filename: \"/etc/envoy/certs/server.key\" - name: clients tls_certificate: certificate_chain: filename: \"/etc/envoy/certs/client.crt\" private_key: filename: \"/etc/envoy/certs/client.key\" - name: validation validation_context: trusted_ca: filename: \"/etc/envoy/ca/ca.crt\" listeners: - name: listener_http address: socket_address: { address: 0.0.0.0, port_value: 80 } filter_chains: - filters: - name: envoy.http_connection_manager typed_config: \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager codec_type: auto stat_prefix: ingress_http route_config: name: local_route virtual_hosts: - name: service domains: [ \"*\" ] routes: - match: { prefix: \"/\" } redirect: https_redirect: true port_redirect: 443 http_filters: - name: envoy.router - name: listener_https address: socket_address: { address: 0.0.0.0, port_value: 443 } filter_chains: - filters: - name: envoy.http_connection_manager typed_config: \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager stat_prefix: ingress_https codec_type: AUTO route_config: name: https_route virtual_hosts: - name: https_route domains: [\"*\"] routes: - match: { prefix: \"/gray/colorful\" } route: prefix_rewrite: \"/colorful\" cluster: gray - match: { prefix: \"/red/colorful\" } route: prefix_rewrite: \"/colorful\" cluster: red - match: { prefix: \"/\" } route: cluster: front_envoy http_filters: - name: envoy.router access_log: - name: envoy.listener.accesslog typed_config: \"@type\": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog path: /dev/stdout log_format: text_format: \"[%START_TIME%] \\\"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\\\" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \\\"%REQ(X-FORWARDED-FOR)%\\\" \\\"%REQ(USER-AGENT)%\\\" \\\"%REQ(X-REQUEST-ID)%\\\" \\\"%REQ(:AUTHORITY)%\\\" \\\"%UPSTREAM_HOST%\\\"\\n\" transport_socket: name: envoy.transport_sockets.tls typed_config: \"@type\": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext common_tls_context: tls_certificate_sds_secret_configs: - name: servers clusters: - name: front_envoy connect_timeout: 0.25s type: strict_dns lb_policy: round_robin load_assignment: cluster_name: front_envoy endpoints: - lb_endpoints: - endpoint: address: socket_address: { address: front_envoy, port_value: 90 } - name: gray connect_timeout: 0.25s type: strict_dns lb_policy: round_robin load_assignment: cluster_name: gray endpoints: - lb_endpoints: - endpoint: address: socket_address: { address: service_gray, port_value: 443 } transport_socket: name: envoy.transport_sockets.tls typed_config: \"@type\": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext common_tls_context: tls_certificate_sds_secret_configs: - name: clients validation_context_sds_secret_config: name: validation - name: red connect_timeout: 0.25s type: strict_dns lb_policy: round_robin load_assignment: cluster_name: red endpoints: - lb_endpoints: - endpoint: address: socket_address: { address: service_red, port_value: 443 } transport_socket: name: envoy.transport_sockets.tls typed_config: \"@type\": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext common_tls_context: tls_certificate_sds_secret_configs: - name: clients service gray text 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 admin: access_log_path: \"/dev/null\" address: socket_address: address: 0.0.0.0 port_value: 9901 static_resources: listeners: - name: listener_https address: socket_address: { address: 0.0.0.0, port_value: 443 } filter_chains: - filters: - name: envoy.http_connection_manager typed_config: \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager stat_prefix: ingress_https codec_type: AUTO route_config: name: https_route virtual_hosts: - name: https_route domains: [\"*\"] routes: - match: { prefix: \"/\" } route: cluster: service_gray http_filters: - name: envoy.router access_log: - name: envoy.listener.accesslog typed_config: \"@type\": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog path: /dev/stdout log_format: text_format: \"[%START_TIME%] \\\"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\\\" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \\\"%REQ(X-FORWARDED-FOR)%\\\" \\\"%REQ(USER-AGENT)%\\\" \\\"%REQ(X-REQUEST-ID)%\\\" \\\"%REQ(:AUTHORITY)%\\\" \\\"%UPSTREAM_HOST%\\\"\\n\" transport_socket: name: envoy.transport_sockets.tls typed_config: \"@type\": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext common_tls_context: tls_certificates: certificate_chain: filename: \"/etc/envoy/certs/server.crt\" private_key: filename: \"/etc/envoy/certs/server.key\" validation_context: trusted_ca: filename: \"/etc/envoy/ca/ca.crt\" require_client_certificate: true clusters: - name: service_gray connect_timeout: 0.25s type: strict_dns lb_policy: round_robin load_assignment: cluster_name: service_gray endpoints: - lb_endpoints: - endpoint: address: socket_address: { address: 127.0.0.1, port_value: 90 } service red text 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 admin: access_log_path: \"/dev/null\" address: socket_address: address: 0.0.0.0 port_value: 9901 static_resources: listeners: - name: listener_https address: socket_address: { address: 0.0.0.0, port_value: 443 } filter_chains: - filters: - name: envoy.http_connection_manager typed_config: \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager stat_prefix: ingress_https codec_type: AUTO route_config: name: https_route virtual_hosts: - name: https_route domains: [\"*\"] routes: - match: { prefix: \"/\" } route: cluster: service_red http_filters: - name: envoy.router access_log: - name: envoy.listener.accesslog typed_config: \"@type\": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog path: /dev/stdout log_format: text_format: \"[%START_TIME%] \\\"%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\\\" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \\\"%REQ(X-FORWARDED-FOR)%\\\" \\\"%REQ(USER-AGENT)%\\\" \\\"%REQ(X-REQUEST-ID)%\\\" \\\"%REQ(:AUTHORITY)%\\\" \\\"%UPSTREAM_HOST%\\\"\\n\" transport_socket: name: envoy.transport_sockets.tls typed_config: \"@type\": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext common_tls_context: tls_certificates: - certificate_chain: filename: \"/etc/envoy/certs/server.crt\" private_key: filename: \"/etc/envoy/certs/server.key\" clusters: - name: service_red connect_timeout: 0.25s type: strict_dns lb_policy: round_robin load_assignment: cluster_name: service_red endpoints: - lb_endpoints: - endpoint: address: socket_address: { address: 127.0.0.1, port_value: 90 } 配置说明 docker-compose\nnetwork_mode: \"service:webserver1\" 指定网络类型，使envoy和后端程序运行在一个网络下\ntext 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 secrets: - name: servers tls_certificate: certificate_chain: filename: \"/etc/envoy/certs/server.crt\" private_key: filename: \"/etc/envoy/certs/server.key\" - name: clients tls_certificate: certificate_chain: filename: \"/etc/envoy/certs/client.crt\" private_key: filename: \"/etc/envoy/certs/client.key\" - name: validation validation_context: trusted_ca: filename: \"/etc/envoy/ca/ca.crt\" server\ntext 1 2 3 4 5 6 7 8 9 10 11 12 13 14 transport_socket: name: envoy.transport_sockets.tls typed_config: \"@type\": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext common_tls_context: tls_certificates: certificate_chain: filename: \"/etc/envoy/certs/server.crt\" private_key: filename: \"/etc/envoy/certs/server.key\" validation_context: # 验证机制的相关配置 trusted_ca: # 信任的ca证书，未指定时不会验证对端证书 filename: \"/etc/envoy/ca/ca.crt\" # 这里指定的为根ca require_client_certificate: true # boolval 设置为ture,Envoy将拒绝没有有效客户端证书的连接。 验证结果 /gray/colorful后端服务开启了验证客户端ca，访问报错，后端程序并没收到请求，因证书无效，envoy销毁了请求 将根ca设置为可信任后 /red/colorful 没开启验证客户端证书\n","wordCount":"1152","inLanguage":"zh","datePublished":"2020-09-29T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2020/09/envoy-mutual-tls/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Envoy：TLS双向认证</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2020-09-29</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>1152 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>6 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/web-middleware/>#Web Middleware</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87 aria-label=环境准备>环境准备</a><ul><li><a href=#docker-compose aria-label=docker-compose>docker-compose</a><li><a href=#front-envoy aria-label=front-envoy>front-envoy</a><li><a href=#service-gray aria-label="service gray">service gray</a><li><a href=#service-red aria-label="service red">service red</a></ul><li><a href=#%e9%85%8d%e7%bd%ae%e8%af%b4%e6%98%8e aria-label=配置说明>配置说明</a><li><a href=#%e9%aa%8c%e8%af%81%e7%bb%93%e6%9e%9c aria-label=验证结果>验证结果</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=环境准备>环境准备<a hidden class=anchor aria-hidden=true href=#环境准备>#</a></h2><table><thead><tr><th>主机</th><th>角色</th><th>数量</th></tr></thead><tbody><tr><td>front-envoy</td><td>front envoy</td><td>1</td></tr><tr><td>service envoy</td><td>作为内部后端的envoy</td><td>2</td></tr><tr><td>end</td><td>后端应用程序</td><td>2</td></tr></tbody></table><p>访问 <code>/</code> front-envoy ==> end * 2
访问 <code>/red/colorful</code> ==> end red 不验证客户端证书 单项tls
访问 <code>/gray/colorful</code> ==> end gray 验证客户端证书 双项tls</p><h3 id=docker-compose>docker-compose<a hidden class=anchor aria-hidden=true href=#docker-compose>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>version: &#39;3&#39;
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  front-envoy:
</span></span><span class=line><span class=cl>    image: envoyproxy/envoy-alpine:v1.15-latest
</span></span><span class=line><span class=cl>    environment: 
</span></span><span class=line><span class=cl>    - ENVOY_UID=0
</span></span><span class=line><span class=cl>    ports:
</span></span><span class=line><span class=cl>    - 80:80
</span></span><span class=line><span class=cl>    - 443:443
</span></span><span class=line><span class=cl>    - 82:9901
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>    - ./envoy.yaml:/etc/envoy/envoy.yaml
</span></span><span class=line><span class=cl>    - ./certs/front-envoy/:/etc/envoy/certs/
</span></span><span class=line><span class=cl>    - ./certs/CA/:/etc/envoy/ca/
</span></span><span class=line><span class=cl>    networks:
</span></span><span class=line><span class=cl>      envoymesh:
</span></span><span class=line><span class=cl>        aliases:
</span></span><span class=line><span class=cl>        - front-envoy
</span></span><span class=line><span class=cl>    depends_on:
</span></span><span class=line><span class=cl>    - webserver1
</span></span><span class=line><span class=cl>    - webserver2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  gray-envoy:
</span></span><span class=line><span class=cl>    image: envoyproxy/envoy-alpine:v1.15-latest
</span></span><span class=line><span class=cl>    environment: 
</span></span><span class=line><span class=cl>    - ENVOY_UID=0
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>    - ./service_gray.yaml:/etc/envoy/envoy.yaml
</span></span><span class=line><span class=cl>    - ./certs/service_gray/:/etc/envoy/certs/
</span></span><span class=line><span class=cl>    - ./certs/CA1/:/etc/envoy/ca/
</span></span><span class=line><span class=cl>    network_mode: &#34;service:webserver1&#34;
</span></span><span class=line><span class=cl>    depends_on:
</span></span><span class=line><span class=cl>    - webserver1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  red-envoy:
</span></span><span class=line><span class=cl>    image: envoyproxy/envoy-alpine:v1.15-latest
</span></span><span class=line><span class=cl>    environment: 
</span></span><span class=line><span class=cl>    - ENVOY_UID=0
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>    - ./service_red.yaml:/etc/envoy/envoy.yaml
</span></span><span class=line><span class=cl>    - ./certs/service_red/:/etc/envoy/certs/
</span></span><span class=line><span class=cl>    - ./certs/CA1/:/etc/envoy/ca/
</span></span><span class=line><span class=cl>    network_mode: &#34;service:webserver2&#34;
</span></span><span class=line><span class=cl>    depends_on:
</span></span><span class=line><span class=cl>    - webserver2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  webserver1:
</span></span><span class=line><span class=cl>    image: cylonchau/envoy-end:latest
</span></span><span class=line><span class=cl>    networks:
</span></span><span class=line><span class=cl>      envoymesh:
</span></span><span class=line><span class=cl>        aliases:
</span></span><span class=line><span class=cl>        - service_gray
</span></span><span class=line><span class=cl>        - front_envoy
</span></span><span class=line><span class=cl>    environment: 
</span></span><span class=line><span class=cl>    - VERSION=v1
</span></span><span class=line><span class=cl>    - COLORFUL=gray
</span></span><span class=line><span class=cl>    expose:
</span></span><span class=line><span class=cl>    - 90
</span></span><span class=line><span class=cl>  webserver2:
</span></span><span class=line><span class=cl>    image: cylonchau/envoy-end:latest
</span></span><span class=line><span class=cl>    networks:
</span></span><span class=line><span class=cl>      envoymesh:
</span></span><span class=line><span class=cl>        aliases:
</span></span><span class=line><span class=cl>        - service_red
</span></span><span class=line><span class=cl>        - front_envoy
</span></span><span class=line><span class=cl>    environment: 
</span></span><span class=line><span class=cl>    - VERSION=v1
</span></span><span class=line><span class=cl>    - COLORFUL=red
</span></span><span class=line><span class=cl>    expose:
</span></span><span class=line><span class=cl>    - 90
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>networks:
</span></span><span class=line><span class=cl>  envoymesh: {}</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=front-envoy>front-envoy<a hidden class=anchor aria-hidden=true href=#front-envoy>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>admin:
</span></span><span class=line><span class=cl>  access_log_path: &#34;/dev/null&#34;
</span></span><span class=line><span class=cl>  address:
</span></span><span class=line><span class=cl>    socket_address:
</span></span><span class=line><span class=cl>      address: 0.0.0.0
</span></span><span class=line><span class=cl>      port_value: 9901
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>static_resources:
</span></span><span class=line><span class=cl>  secrets:
</span></span><span class=line><span class=cl>  - name: servers
</span></span><span class=line><span class=cl>    tls_certificate:
</span></span><span class=line><span class=cl>      certificate_chain:
</span></span><span class=line><span class=cl>        filename: &#34;/etc/envoy/certs/server.crt&#34;
</span></span><span class=line><span class=cl>      private_key:
</span></span><span class=line><span class=cl>        filename: &#34;/etc/envoy/certs/server.key&#34;
</span></span><span class=line><span class=cl>  - name: clients
</span></span><span class=line><span class=cl>    tls_certificate:
</span></span><span class=line><span class=cl>      certificate_chain:
</span></span><span class=line><span class=cl>        filename: &#34;/etc/envoy/certs/client.crt&#34;
</span></span><span class=line><span class=cl>      private_key:
</span></span><span class=line><span class=cl>        filename: &#34;/etc/envoy/certs/client.key&#34;
</span></span><span class=line><span class=cl>  - name: validation
</span></span><span class=line><span class=cl>    validation_context:
</span></span><span class=line><span class=cl>      trusted_ca:
</span></span><span class=line><span class=cl>        filename: &#34;/etc/envoy/ca/ca.crt&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  listeners:
</span></span><span class=line><span class=cl>  - name: listener_http
</span></span><span class=line><span class=cl>    address:
</span></span><span class=line><span class=cl>      socket_address: { address: 0.0.0.0, port_value: 80 }
</span></span><span class=line><span class=cl>    filter_chains:
</span></span><span class=line><span class=cl>    - filters:
</span></span><span class=line><span class=cl>      - name: envoy.http_connection_manager
</span></span><span class=line><span class=cl>        typed_config:
</span></span><span class=line><span class=cl>          &#34;@type&#34;: type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span class=line><span class=cl>          codec_type: auto
</span></span><span class=line><span class=cl>          stat_prefix: ingress_http
</span></span><span class=line><span class=cl>          route_config:
</span></span><span class=line><span class=cl>            name: local_route
</span></span><span class=line><span class=cl>            virtual_hosts:
</span></span><span class=line><span class=cl>            - name: service
</span></span><span class=line><span class=cl>              domains: [ &#34;*&#34; ]
</span></span><span class=line><span class=cl>              routes:
</span></span><span class=line><span class=cl>              - match: { prefix: &#34;/&#34; }
</span></span><span class=line><span class=cl>                redirect:
</span></span><span class=line><span class=cl>                  https_redirect: true
</span></span><span class=line><span class=cl>                  port_redirect: 443
</span></span><span class=line><span class=cl>          http_filters:
</span></span><span class=line><span class=cl>          - name: envoy.router
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  - name: listener_https
</span></span><span class=line><span class=cl>    address:
</span></span><span class=line><span class=cl>      socket_address: { address: 0.0.0.0, port_value: 443 }
</span></span><span class=line><span class=cl>    filter_chains:
</span></span><span class=line><span class=cl>    - filters:
</span></span><span class=line><span class=cl>      - name: envoy.http_connection_manager
</span></span><span class=line><span class=cl>        typed_config:
</span></span><span class=line><span class=cl>          &#34;@type&#34;: type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span class=line><span class=cl>          stat_prefix: ingress_https
</span></span><span class=line><span class=cl>          codec_type: AUTO
</span></span><span class=line><span class=cl>          route_config:
</span></span><span class=line><span class=cl>            name: https_route
</span></span><span class=line><span class=cl>            virtual_hosts:
</span></span><span class=line><span class=cl>            - name: https_route
</span></span><span class=line><span class=cl>              domains: [&#34;*&#34;]
</span></span><span class=line><span class=cl>              routes:
</span></span><span class=line><span class=cl>              - match: { prefix: &#34;/gray/colorful&#34; }
</span></span><span class=line><span class=cl>                route:
</span></span><span class=line><span class=cl>                  prefix_rewrite: &#34;/colorful&#34;
</span></span><span class=line><span class=cl>                  cluster: gray                                
</span></span><span class=line><span class=cl>              - match: { prefix: &#34;/red/colorful&#34; }
</span></span><span class=line><span class=cl>                route:
</span></span><span class=line><span class=cl>                  prefix_rewrite: &#34;/colorful&#34;
</span></span><span class=line><span class=cl>                  cluster: red
</span></span><span class=line><span class=cl>              - match: { prefix: &#34;/&#34; }
</span></span><span class=line><span class=cl>                route:
</span></span><span class=line><span class=cl>                  cluster: front_envoy
</span></span><span class=line><span class=cl>          http_filters:
</span></span><span class=line><span class=cl>          - name: envoy.router
</span></span><span class=line><span class=cl>          access_log:
</span></span><span class=line><span class=cl>          - name: envoy.listener.accesslog
</span></span><span class=line><span class=cl>            typed_config: 
</span></span><span class=line><span class=cl>              &#34;@type&#34;: type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
</span></span><span class=line><span class=cl>              path: /dev/stdout
</span></span><span class=line><span class=cl>              log_format: 
</span></span><span class=line><span class=cl>                text_format: &#34;[%START_TIME%] \&#34;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&#34; %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&#34;%REQ(X-FORWARDED-FOR)%\&#34; \&#34;%REQ(USER-AGENT)%\&#34; \&#34;%REQ(X-REQUEST-ID)%\&#34; \&#34;%REQ(:AUTHORITY)%\&#34; \&#34;%UPSTREAM_HOST%\&#34;\n&#34;
</span></span><span class=line><span class=cl>      transport_socket:
</span></span><span class=line><span class=cl>        name: envoy.transport_sockets.tls
</span></span><span class=line><span class=cl>        typed_config:
</span></span><span class=line><span class=cl>          &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
</span></span><span class=line><span class=cl>          common_tls_context:
</span></span><span class=line><span class=cl>            tls_certificate_sds_secret_configs:
</span></span><span class=line><span class=cl>            - name: servers
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  clusters:
</span></span><span class=line><span class=cl>  - name: front_envoy
</span></span><span class=line><span class=cl>    connect_timeout: 0.25s
</span></span><span class=line><span class=cl>    type: strict_dns
</span></span><span class=line><span class=cl>    lb_policy: round_robin
</span></span><span class=line><span class=cl>    load_assignment:
</span></span><span class=line><span class=cl>      cluster_name: front_envoy
</span></span><span class=line><span class=cl>      endpoints:
</span></span><span class=line><span class=cl>      - lb_endpoints:
</span></span><span class=line><span class=cl>        - endpoint:
</span></span><span class=line><span class=cl>            address:
</span></span><span class=line><span class=cl>              socket_address: { address: front_envoy, port_value: 90 }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  - name: gray
</span></span><span class=line><span class=cl>    connect_timeout: 0.25s
</span></span><span class=line><span class=cl>    type: strict_dns
</span></span><span class=line><span class=cl>    lb_policy: round_robin
</span></span><span class=line><span class=cl>    load_assignment:
</span></span><span class=line><span class=cl>      cluster_name: gray
</span></span><span class=line><span class=cl>      endpoints:
</span></span><span class=line><span class=cl>      - lb_endpoints:
</span></span><span class=line><span class=cl>        - endpoint:
</span></span><span class=line><span class=cl>            address:
</span></span><span class=line><span class=cl>              socket_address: { address: service_gray, port_value: 443 }
</span></span><span class=line><span class=cl>    transport_socket:
</span></span><span class=line><span class=cl>      name: envoy.transport_sockets.tls
</span></span><span class=line><span class=cl>      typed_config:
</span></span><span class=line><span class=cl>        &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
</span></span><span class=line><span class=cl>        common_tls_context:
</span></span><span class=line><span class=cl>          tls_certificate_sds_secret_configs:
</span></span><span class=line><span class=cl>          - name: clients
</span></span><span class=line><span class=cl>          validation_context_sds_secret_config:
</span></span><span class=line><span class=cl>            name: validation
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  - name: red
</span></span><span class=line><span class=cl>    connect_timeout: 0.25s
</span></span><span class=line><span class=cl>    type: strict_dns
</span></span><span class=line><span class=cl>    lb_policy: round_robin
</span></span><span class=line><span class=cl>    load_assignment:
</span></span><span class=line><span class=cl>      cluster_name: red
</span></span><span class=line><span class=cl>      endpoints:
</span></span><span class=line><span class=cl>      - lb_endpoints:
</span></span><span class=line><span class=cl>        - endpoint:
</span></span><span class=line><span class=cl>            address:
</span></span><span class=line><span class=cl>              socket_address: { address: service_red, port_value: 443 } 
</span></span><span class=line><span class=cl>    transport_socket:
</span></span><span class=line><span class=cl>      name: envoy.transport_sockets.tls
</span></span><span class=line><span class=cl>      typed_config:
</span></span><span class=line><span class=cl>        &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
</span></span><span class=line><span class=cl>        common_tls_context:
</span></span><span class=line><span class=cl>          tls_certificate_sds_secret_configs:
</span></span><span class=line><span class=cl>          - name: clients</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=service-gray>service gray<a hidden class=anchor aria-hidden=true href=#service-gray>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>admin:
</span></span><span class=line><span class=cl>  access_log_path: &#34;/dev/null&#34;
</span></span><span class=line><span class=cl>  address:
</span></span><span class=line><span class=cl>    socket_address:
</span></span><span class=line><span class=cl>      address: 0.0.0.0
</span></span><span class=line><span class=cl>      port_value: 9901
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>static_resources:
</span></span><span class=line><span class=cl>  listeners:
</span></span><span class=line><span class=cl>  - name: listener_https
</span></span><span class=line><span class=cl>    address:
</span></span><span class=line><span class=cl>      socket_address: { address: 0.0.0.0, port_value: 443 }
</span></span><span class=line><span class=cl>    filter_chains:
</span></span><span class=line><span class=cl>    - filters:
</span></span><span class=line><span class=cl>      - name: envoy.http_connection_manager
</span></span><span class=line><span class=cl>        typed_config:
</span></span><span class=line><span class=cl>          &#34;@type&#34;: type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span class=line><span class=cl>          stat_prefix: ingress_https
</span></span><span class=line><span class=cl>          codec_type: AUTO
</span></span><span class=line><span class=cl>          route_config:
</span></span><span class=line><span class=cl>            name: https_route
</span></span><span class=line><span class=cl>            virtual_hosts:
</span></span><span class=line><span class=cl>            - name: https_route
</span></span><span class=line><span class=cl>              domains: [&#34;*&#34;]
</span></span><span class=line><span class=cl>              routes:
</span></span><span class=line><span class=cl>              - match: { prefix: &#34;/&#34; }
</span></span><span class=line><span class=cl>                route:
</span></span><span class=line><span class=cl>                  cluster: service_gray
</span></span><span class=line><span class=cl>          http_filters:
</span></span><span class=line><span class=cl>          - name: envoy.router
</span></span><span class=line><span class=cl>          access_log:
</span></span><span class=line><span class=cl>          - name: envoy.listener.accesslog
</span></span><span class=line><span class=cl>            typed_config: 
</span></span><span class=line><span class=cl>              &#34;@type&#34;: type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
</span></span><span class=line><span class=cl>              path: /dev/stdout
</span></span><span class=line><span class=cl>              log_format: 
</span></span><span class=line><span class=cl>                text_format: &#34;[%START_TIME%] \&#34;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&#34; %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&#34;%REQ(X-FORWARDED-FOR)%\&#34; \&#34;%REQ(USER-AGENT)%\&#34; \&#34;%REQ(X-REQUEST-ID)%\&#34; \&#34;%REQ(:AUTHORITY)%\&#34; \&#34;%UPSTREAM_HOST%\&#34;\n&#34;
</span></span><span class=line><span class=cl>      transport_socket:
</span></span><span class=line><span class=cl>        name: envoy.transport_sockets.tls
</span></span><span class=line><span class=cl>        typed_config:
</span></span><span class=line><span class=cl>          &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
</span></span><span class=line><span class=cl>          common_tls_context:
</span></span><span class=line><span class=cl>            tls_certificates:
</span></span><span class=line><span class=cl>              certificate_chain:
</span></span><span class=line><span class=cl>                filename: &#34;/etc/envoy/certs/server.crt&#34;
</span></span><span class=line><span class=cl>              private_key:
</span></span><span class=line><span class=cl>                filename: &#34;/etc/envoy/certs/server.key&#34;
</span></span><span class=line><span class=cl>            validation_context:
</span></span><span class=line><span class=cl>              trusted_ca:
</span></span><span class=line><span class=cl>                filename: &#34;/etc/envoy/ca/ca.crt&#34;    
</span></span><span class=line><span class=cl>          require_client_certificate: true
</span></span><span class=line><span class=cl>          
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  clusters:
</span></span><span class=line><span class=cl>  - name: service_gray
</span></span><span class=line><span class=cl>    connect_timeout: 0.25s
</span></span><span class=line><span class=cl>    type: strict_dns
</span></span><span class=line><span class=cl>    lb_policy: round_robin
</span></span><span class=line><span class=cl>    load_assignment:
</span></span><span class=line><span class=cl>      cluster_name: service_gray
</span></span><span class=line><span class=cl>      endpoints:
</span></span><span class=line><span class=cl>      - lb_endpoints:
</span></span><span class=line><span class=cl>        - endpoint:
</span></span><span class=line><span class=cl>            address:
</span></span><span class=line><span class=cl>              socket_address: { address: 127.0.0.1, port_value: 90 }</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=service-red>service red<a hidden class=anchor aria-hidden=true href=#service-red>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>admin:
</span></span><span class=line><span class=cl>  access_log_path: &#34;/dev/null&#34;
</span></span><span class=line><span class=cl>  address:
</span></span><span class=line><span class=cl>    socket_address:
</span></span><span class=line><span class=cl>      address: 0.0.0.0
</span></span><span class=line><span class=cl>      port_value: 9901
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>static_resources:
</span></span><span class=line><span class=cl>  listeners:
</span></span><span class=line><span class=cl>  - name: listener_https
</span></span><span class=line><span class=cl>    address:
</span></span><span class=line><span class=cl>      socket_address: { address: 0.0.0.0, port_value: 443 }
</span></span><span class=line><span class=cl>    filter_chains:
</span></span><span class=line><span class=cl>    - filters:
</span></span><span class=line><span class=cl>      - name: envoy.http_connection_manager
</span></span><span class=line><span class=cl>        typed_config:
</span></span><span class=line><span class=cl>          &#34;@type&#34;: type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
</span></span><span class=line><span class=cl>          stat_prefix: ingress_https
</span></span><span class=line><span class=cl>          codec_type: AUTO
</span></span><span class=line><span class=cl>          route_config:
</span></span><span class=line><span class=cl>            name: https_route
</span></span><span class=line><span class=cl>            virtual_hosts:
</span></span><span class=line><span class=cl>            - name: https_route
</span></span><span class=line><span class=cl>              domains: [&#34;*&#34;]
</span></span><span class=line><span class=cl>              routes:
</span></span><span class=line><span class=cl>              - match: { prefix: &#34;/&#34; }
</span></span><span class=line><span class=cl>                route:
</span></span><span class=line><span class=cl>                  cluster: service_red
</span></span><span class=line><span class=cl>          http_filters:
</span></span><span class=line><span class=cl>          - name: envoy.router
</span></span><span class=line><span class=cl>          access_log:
</span></span><span class=line><span class=cl>          - name: envoy.listener.accesslog
</span></span><span class=line><span class=cl>            typed_config: 
</span></span><span class=line><span class=cl>              &#34;@type&#34;: type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
</span></span><span class=line><span class=cl>              path: /dev/stdout
</span></span><span class=line><span class=cl>              log_format: 
</span></span><span class=line><span class=cl>                text_format: &#34;[%START_TIME%] \&#34;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&#34; %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% \&#34;%REQ(X-FORWARDED-FOR)%\&#34; \&#34;%REQ(USER-AGENT)%\&#34; \&#34;%REQ(X-REQUEST-ID)%\&#34; \&#34;%REQ(:AUTHORITY)%\&#34; \&#34;%UPSTREAM_HOST%\&#34;\n&#34;
</span></span><span class=line><span class=cl>      transport_socket:
</span></span><span class=line><span class=cl>        name: envoy.transport_sockets.tls
</span></span><span class=line><span class=cl>        typed_config:
</span></span><span class=line><span class=cl>          &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
</span></span><span class=line><span class=cl>          common_tls_context:
</span></span><span class=line><span class=cl>            tls_certificates:
</span></span><span class=line><span class=cl>            - certificate_chain:
</span></span><span class=line><span class=cl>                filename: &#34;/etc/envoy/certs/server.crt&#34;
</span></span><span class=line><span class=cl>              private_key:
</span></span><span class=line><span class=cl>                filename: &#34;/etc/envoy/certs/server.key&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  clusters:
</span></span><span class=line><span class=cl>  - name: service_red
</span></span><span class=line><span class=cl>    connect_timeout: 0.25s
</span></span><span class=line><span class=cl>    type: strict_dns
</span></span><span class=line><span class=cl>    lb_policy: round_robin
</span></span><span class=line><span class=cl>    load_assignment:
</span></span><span class=line><span class=cl>      cluster_name: service_red
</span></span><span class=line><span class=cl>      endpoints:
</span></span><span class=line><span class=cl>      - lb_endpoints:
</span></span><span class=line><span class=cl>        - endpoint:
</span></span><span class=line><span class=cl>            address:
</span></span><span class=line><span class=cl>              socket_address: { address: 127.0.0.1, port_value: 90 }</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=配置说明>配置说明<a hidden class=anchor aria-hidden=true href=#配置说明>#</a></h2><p>docker-compose</p><p><code>network_mode: "service:webserver1"</code> 指定网络类型，使envoy和后端程序运行在一个网络下</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>  secrets:
</span></span><span class=line><span class=cl>  - name: servers
</span></span><span class=line><span class=cl>    tls_certificate:
</span></span><span class=line><span class=cl>      certificate_chain:
</span></span><span class=line><span class=cl>        filename: &#34;/etc/envoy/certs/server.crt&#34;
</span></span><span class=line><span class=cl>      private_key:
</span></span><span class=line><span class=cl>        filename: &#34;/etc/envoy/certs/server.key&#34;
</span></span><span class=line><span class=cl>  - name: clients
</span></span><span class=line><span class=cl>    tls_certificate:
</span></span><span class=line><span class=cl>      certificate_chain:
</span></span><span class=line><span class=cl>        filename: &#34;/etc/envoy/certs/client.crt&#34;
</span></span><span class=line><span class=cl>      private_key:
</span></span><span class=line><span class=cl>        filename: &#34;/etc/envoy/certs/client.key&#34;
</span></span><span class=line><span class=cl>  - name: validation
</span></span><span class=line><span class=cl>    validation_context:
</span></span><span class=line><span class=cl>      trusted_ca:
</span></span><span class=line><span class=cl>        filename: &#34;/etc/envoy/ca/ca.crt&#34;</span></span></code></pre></td></tr></table></div></div></div></div><p>server</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>      transport_socket:
</span></span><span class=line><span class=cl>        name: envoy.transport_sockets.tls
</span></span><span class=line><span class=cl>        typed_config:
</span></span><span class=line><span class=cl>          &#34;@type&#34;: type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
</span></span><span class=line><span class=cl>          common_tls_context:
</span></span><span class=line><span class=cl>            tls_certificates:
</span></span><span class=line><span class=cl>              certificate_chain:
</span></span><span class=line><span class=cl>                filename: &#34;/etc/envoy/certs/server.crt&#34;
</span></span><span class=line><span class=cl>              private_key:
</span></span><span class=line><span class=cl>                filename: &#34;/etc/envoy/certs/server.key&#34;
</span></span><span class=line><span class=cl>            validation_context:    # 验证机制的相关配置
</span></span><span class=line><span class=cl>              trusted_ca: # 信任的ca证书，未指定时不会验证对端证书
</span></span><span class=line><span class=cl>                filename: &#34;/etc/envoy/ca/ca.crt&#34;   # 这里指定的为根ca
</span></span><span class=line><span class=cl>          require_client_certificate: true # boolval 设置为ture,Envoy将拒绝没有有效客户端证书的连接。</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=验证结果>验证结果<a hidden class=anchor aria-hidden=true href=#验证结果>#</a></h2><p><code>/gray/colorful</code>后端服务开启了验证客户端ca，访问报错，后端程序并没收到请求，因证书无效，envoy销毁了请求<div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1380340-20200929231821628-50877692.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1380340-20200929231821628-50877692.png#center alt onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1380340-20200929231918489-3001705.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1380340-20200929231918489-3001705.png#center alt onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>将根ca设置为可信任后<div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1380340-20200929232146680-1136391150.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1380340-20200929232146680-1136391150.png#center alt onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p><code>/red/colorful</code> 没开启验证客户端证书</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1380340-20200929232026122-1666246149.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1380340-20200929232026122-1666246149.png#center alt onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：Envoy：TLS双向认证</p><p>文章链接：<a href=https://www.oomkill.com/2020/09/envoy-mutual-tls/ target=_blank>https://www.oomkill.com/2020/09/envoy-mutual-tls/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2020/09/envoy-access-log/><span>Envoy开启访问日志 access_log</span></a></li><li><a href=/2020/09/envoy-real-ip/><span>记录经过envoy代理后获取客户端真实IP</span></a></li><li><a href=/2020/09/outlier-detection/><span>Envoy 离群检测</span></a></li><li><a href=/2020/09/initiative-health-check/><span>Envoy的主动健康监测</span></a></li><li><a href=/2020/09/envoy-v3-api-tls/><span>Envoy V3APi 开启 TLS</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/web-middleware/>Web Middleware</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2020/10/zimbra-troubleshooing/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>zimbra安装故障记录</span>
</a><a class=next href=https://www.oomkill.com/2020/09/centos7-dbus-troubleshooting/><span class=title></span>
<span>Centos7 dbus问题总结&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/blogs","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/envoy-mutual-tls","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>