<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>深入理解Kubernetes service - kube-proxy架构分析 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="kubernetes,kubernetes service,kube-proxy,kube-proxy源码"><meta name=description content="前提概述 kubernetes集群中运行在每个Worker节点上的组件 kube-proxy，本文讲解的是如何快速的了解 kube-proxy 的软件架构，而不是流程的分析，专注于 proxy 层面的设计讲解，而不会贴大量的代码
kube-proxy软件设计 kube-proxy 在设计上分为三个模块 server 于 proxy：
server: 是一个常驻进程用于处理service的事件 proxy: 是 kube-proxy 的工作核心，实际上的角色是一个 service controller，通过监听 node, service, endpoint 而生成规则 proxier: 是实现service的组件，例如iptables, ipvs&mldr;. 如何快速读懂kube-proxy源码 要想快速读懂 kube-proxy 源码就需要对 kube-proxy 设计有深刻的了解，例如需要看 kube-proxy 的实现，我们就可以看 proxy的部分，下列是 proxy 部分的目录结构
bash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 $ tree -L 1 . ├── BUILD ├── OWNERS ├── apis ├── config ├── healthcheck ├── iptables ├── ipvs ├── metaproxier ├── metrics ├── userspace ├── util ├── winuserspace ├── winkernel ├── doc."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2023/02/ch19-kube-proxy-code/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2023/02/ch19-kube-proxy-code/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-H94HZ5S19Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H94HZ5S19Y")</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="深入理解Kubernetes service - kube-proxy架构分析"><meta property="og:description" content="前提概述 kubernetes集群中运行在每个Worker节点上的组件 kube-proxy，本文讲解的是如何快速的了解 kube-proxy 的软件架构，而不是流程的分析，专注于 proxy 层面的设计讲解，而不会贴大量的代码
kube-proxy软件设计 kube-proxy 在设计上分为三个模块 server 于 proxy：
server: 是一个常驻进程用于处理service的事件 proxy: 是 kube-proxy 的工作核心，实际上的角色是一个 service controller，通过监听 node, service, endpoint 而生成规则 proxier: 是实现service的组件，例如iptables, ipvs&mldr;. 如何快速读懂kube-proxy源码 要想快速读懂 kube-proxy 源码就需要对 kube-proxy 设计有深刻的了解，例如需要看 kube-proxy 的实现，我们就可以看 proxy的部分，下列是 proxy 部分的目录结构
bash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 $ tree -L 1 . ├── BUILD ├── OWNERS ├── apis ├── config ├── healthcheck ├── iptables ├── ipvs ├── metaproxier ├── metrics ├── userspace ├── util ├── winuserspace ├── winkernel ├── doc."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2023/02/ch19-kube-proxy-code/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-06T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-12T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入理解Kubernetes service - kube-proxy架构分析"><meta name=twitter:description content="前提概述 kubernetes集群中运行在每个Worker节点上的组件 kube-proxy，本文讲解的是如何快速的了解 kube-proxy 的软件架构，而不是流程的分析，专注于 proxy 层面的设计讲解，而不会贴大量的代码
kube-proxy软件设计 kube-proxy 在设计上分为三个模块 server 于 proxy：
server: 是一个常驻进程用于处理service的事件 proxy: 是 kube-proxy 的工作核心，实际上的角色是一个 service controller，通过监听 node, service, endpoint 而生成规则 proxier: 是实现service的组件，例如iptables, ipvs&mldr;. 如何快速读懂kube-proxy源码 要想快速读懂 kube-proxy 源码就需要对 kube-proxy 设计有深刻的了解，例如需要看 kube-proxy 的实现，我们就可以看 proxy的部分，下列是 proxy 部分的目录结构
bash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 $ tree -L 1 . ├── BUILD ├── OWNERS ├── apis ├── config ├── healthcheck ├── iptables ├── ipvs ├── metaproxier ├── metrics ├── userspace ├── util ├── winuserspace ├── winkernel ├── doc."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"深入理解Kubernetes service - kube-proxy架构分析","item":"https://www.oomkill.com/2023/02/ch19-kube-proxy-code/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"深入理解Kubernetes service - kube-proxy架构分析","name":"深入理解Kubernetes service - kube-proxy架构分析","description":"前提概述 kubernetes集群中运行在每个Worker节点上的组件 kube-proxy，本文讲解的是如何快速的了解 kube-proxy 的软件架构，而不是流程的分析，专注于 proxy 层面的设计讲解，而不会贴大量的代码\nkube-proxy软件设计 kube-proxy 在设计上分为三个模块 server 于 proxy：\nserver: 是一个常驻进程用于处理service的事件 proxy: 是 kube-proxy 的工作核心，实际上的角色是一个 service controller，通过监听 node, service, endpoint 而生成规则 proxier: 是实现service的组件，例如iptables, ipvs\u0026hellip;. 如何快速读懂kube-proxy源码 要想快速读懂 kube-proxy 源码就需要对 kube-proxy 设计有深刻的了解，例如需要看 kube-proxy 的实现，我们就可以看 proxy的部分，下列是 proxy 部分的目录结构\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 $ tree -L 1 . ├── BUILD ├── OWNERS ├── apis ├── config ├── healthcheck ├── iptables ├── ipvs ├── metaproxier ├── metrics ├── userspace ├── util ├── winuserspace ├── winkernel ├── doc.","keywords":["kubernetes","kubernetes service","kube-proxy","kube-proxy源码"],"articleBody":"前提概述 kubernetes集群中运行在每个Worker节点上的组件 kube-proxy，本文讲解的是如何快速的了解 kube-proxy 的软件架构，而不是流程的分析，专注于 proxy 层面的设计讲解，而不会贴大量的代码\nkube-proxy软件设计 kube-proxy 在设计上分为三个模块 server 于 proxy：\nserver: 是一个常驻进程用于处理service的事件 proxy: 是 kube-proxy 的工作核心，实际上的角色是一个 service controller，通过监听 node, service, endpoint 而生成规则 proxier: 是实现service的组件，例如iptables, ipvs…. 如何快速读懂kube-proxy源码 要想快速读懂 kube-proxy 源码就需要对 kube-proxy 设计有深刻的了解，例如需要看 kube-proxy 的实现，我们就可以看 proxy的部分，下列是 proxy 部分的目录结构\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 $ tree -L 1 . ├── BUILD ├── OWNERS ├── apis ├── config ├── healthcheck ├── iptables ├── ipvs ├── metaproxier ├── metrics ├── userspace ├── util ├── winuserspace ├── winkernel ├── doc.go ├── endpoints.go ├── endpoints_test.go ├── endpointslicecache.go ├── endpointslicecache_test.go ├── service.go ├── service_test.go ├── topology.go ├── topology_test.go └── types.go 目录 ipvs, iptables, 就是所知的 kube-proxy 提供的两种 load balancer 目录 apis, 则是kube-proxy 配置文件资源类型的定义，--config=/etc/kubernetes/kube-proxy-config.yaml 所指定问题的shema 目录config: 定义了每种资源的handler需要实现什么 service.go, endpoints.go：是controller的实现 type.go: 是每个资源的interface定义，例如： Provider: 规定了每个proxier需要实现什么 ServicePort: service 控制器需要实现什么 Endpoint: service 控制器需要实现什么 上述是整个 proxy 的一级结构\nservice controller service控制器换句话说，就是工作内容类似于kubernetes集群中的pod控制器那些，所作的工作就是监听对应资源做出相应事件处理，而这个处理被定义为 handler\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 type Provider interface { config.EndpointsHandler config.EndpointSliceHandler config.ServiceHandler config.NodeHandler // Sync immediately synchronizes the Provider's current state to proxy rules. Sync() // SyncLoop runs periodic work. // This is expected to run as a goroutine or as the main loop of the app. // It does not return. SyncLoop() } 由上面代码可以看到，每一个Provider 即 proxier （用于实现的LB的控制器）都需要包含对应资源的事件处理函数于 一个 Sync() 和 SyncLoop()，所以这里将总结为 controller 而不是用于这里给到的术语\n同理，其他类型的 controller 则是相同与 service controller\n深入理解proxier 这里将以 ipvs 为例，如图所示，这将是一个 proxier 的实现，而 proxier.go 则是真实的 proxier 实现\n图：Kubernetes API 请求的请求处理步骤图（详细） 而 ipvs 的 proxier 则是如下定义的\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 type Proxier struct { // endpointsChanges and serviceChanges contains all changes to endpoints and // services that happened since last syncProxyRules call. For a single object, // changes are accumulated, i.e. previous is state from before all of them, // current is state after applying all of those. endpointsChanges *proxy.EndpointChangeTracker serviceChanges *proxy.ServiceChangeTracker mu sync.Mutex // protects the following fields serviceMap proxy.ServiceMap endpointsMap proxy.EndpointsMap portsMap map[utilproxy.LocalPort]utilproxy.Closeable nodeLabels map[string]string // endpointsSynced, endpointSlicesSynced, and servicesSynced are set to true when // corresponding objects are synced after startup. This is used to avoid updating // ipvs rules with some partial data after kube-proxy restart. endpointsSynced bool endpointSlicesSynced bool servicesSynced bool initialized int32 syncRunner *async.BoundedFrequencyRunner // governs calls to syncProxyRules // These are effectively const and do not need the mutex to be held. syncPeriod time.Duration minSyncPeriod time.Duration // Values are CIDR's to exclude when cleaning up IPVS rules. excludeCIDRs []*net.IPNet // Set to true to set sysctls arp_ignore and arp_announce strictARP bool iptables utiliptables.Interface ipvs utilipvs.Interface ipset utilipset.Interface exec utilexec.Interface masqueradeAll bool masqueradeMark string localDetector proxyutiliptables.LocalTrafficDetector hostname string nodeIP net.IP portMapper utilproxy.PortOpener recorder record.EventRecorder serviceHealthServer healthcheck.ServiceHealthServer healthzServer healthcheck.ProxierHealthUpdater ipvsScheduler string // Added as a member to the struct to allow injection for testing. ipGetter IPGetter // The following buffers are used to reuse memory and avoid allocations // that are significantly impacting performance. iptablesData *bytes.Buffer filterChainsData *bytes.Buffer natChains *bytes.Buffer filterChains *bytes.Buffer natRules *bytes.Buffer filterRules *bytes.Buffer // Added as a member to the struct to allow injection for testing. netlinkHandle NetLinkHandle // ipsetList is the list of ipsets that ipvs proxier used. ipsetList map[string]*IPSet // Values are as a parameter to select the interfaces which nodeport works. nodePortAddresses []string // networkInterfacer defines an interface for several net library functions. // Inject for test purpose. networkInterfacer utilproxy.NetworkInterfacer gracefuldeleteManager *GracefulTerminationManager } 再看这个结构体的 structure，发现他实现了上述提到的 Handler 和 Sync()\n可以看到 Sync() 的实现是调用 runner.Run()\ngo 1 2 3 4 5 6 7 func (proxier *Proxier) Sync() { if proxier.healthzServer != nil { proxier.healthzServer.QueuedUpdate() } metrics.SyncProxyRulesLastQueuedTimestamp.SetToCurrentTime() proxier.syncRunner.Run() } 而 handler 中的任意事件的触发则是调用 Sync()\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // handler 不同的事件均指向 On{rs}Update() 函数 func (proxier *Proxier) OnEndpointsAdd(endpoints *v1.Endpoints) { proxier.OnEndpointsUpdate(nil, endpoints) } // OnEndpointsDelete is called whenever deletion of an existing endpoints object is observed. func (proxier *Proxier) OnEndpointsDelete(endpoints *v1.Endpoints) { proxier.OnEndpointsUpdate(endpoints, nil) } ... // 而 update 调用的则是 Sync() func (proxier *Proxier) OnEndpointsUpdate(oldEndpoints, endpoints *v1.Endpoints) { if proxier.endpointsChanges.Update(oldEndpoints, endpoints) \u0026\u0026 proxier.isInitialized() { proxier.Sync() } } 到了这里，明了了 runner 才是这个 proxier 的核心，被定义于 proxier 结构图的 syncRunner 在初始化时被注入了函数 syncProxyRules()\ngo 1 2 3 4 5 6 7 8 func NewProxier(ipt utiliptables.Interface, ... proxier.syncRunner = async.NewBoundedFrequencyRunner(\"sync-runner\", proxier.syncProxyRules, minSyncPeriod, syncPeriod, burstSyncs) proxier.gracefuldeleteManager.Run() return proxier, nil } syncProxyRules() 而这个 syncProxyRules() 则是完成了整个 ipvs 以及 service 的生命周期\n对于了解kubernetes架构的同学来说，kube-proxy 完成的功能就是 ipvs 的规则管理，那么换句话说就是干预 ipvs 规则的生命周期，也就是分析函数 syncProxyRules() 是如何干预这些规则的。\nsyncProxyRules() 将动作分为两部分，一是对 ipvs 资源的增改，二是对资源的销毁；引入完概念后，就开始进行分析吧。\n600多行的代码看起来很困难，那就拆分成步骤进行分析\nstep1 前期准备工作 为什么这么叫第一部分呢？看下列代码就知道，做的工作和 ipvs rules 没多大关系\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 func (proxier *Proxier) syncProxyRules() { // 互斥锁 proxier.mu.Lock() defer proxier.mu.Unlock() // don't sync rules till we've received services and endpoints // 在等待接收完信息前，不同步收到的 services和endpoints资源 if !proxier.isInitialized() { klog.V(2).Info(\"Not syncing ipvs rules until Services and Endpoints have been received from master\") return } // Keep track of how long syncs take. // 记录同步耗时 start := time.Now() defer func() { metrics.SyncProxyRulesLatency.Observe(metrics.SinceInSeconds(start)) klog.V(4).Infof(\"syncProxyRules took %v\", time.Since(start)) }() // 获取本地多个IP地址 localAddrs, err := utilproxy.GetLocalAddrs() if err != nil { klog.Errorf(\"Failed to get local addresses during proxy sync: %v, assuming external IPs are not local\", err) } else if len(localAddrs) == 0 { klog.Warning(\"No local addresses found, assuming all external IPs are not local\") } localAddrSet := utilnet.IPSet{} localAddrSet.Insert(localAddrs...) // We assume that if this was called, we really want to sync them, // even if nothing changed in the meantime. In other words, callers are // responsible for detecting no-op changes and not calling this function. // 这两步骤正如注释所讲，如果在资源修改的前提下需要同步，也就是update操作包含了增改 serviceUpdateResult := proxy.UpdateServiceMap(proxier.serviceMap, proxier.serviceChanges) endpointUpdateResult := proxier.endpointsMap.Update(proxier.endpointsChanges) // 陈腐的UDP信息处理 staleServices := serviceUpdateResult.UDPStaleClusterIP // merge stale services gathered from updateEndpointsMap for _, svcPortName := range endpointUpdateResult.StaleServiceNames { if svcInfo, ok := proxier.serviceMap[svcPortName]; ok \u0026\u0026 svcInfo != nil \u0026\u0026 conntrack.IsClearConntrackNeeded(svcInfo.Protocol()) { klog.V(2).Infof(\"Stale %s service %v -\u003e %s\", strings.ToLower(string(svcInfo.Protocol())), svcPortName, svcInfo.ClusterIP().String()) staleServices.Insert(svcInfo.ClusterIP().String()) for _, extIP := range svcInfo.ExternalIPStrings() { staleServices.Insert(extIP) } } } step2：构建IPVS规则 首先会经历一些预处理的操作 这部分掠过了 L1042-L1140\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 klog.V(3).Infof(\"Syncing ipvs Proxier rules\") // Begin install iptables // Reset all buffers used later. // This is to avoid memory reallocations and thus improve performance. proxier.natChains.Reset() proxier.natRules.Reset() proxier.filterChains.Reset() proxier.filterRules.Reset() // Write table headers. writeLine(proxier.filterChains, \"*filter\") writeLine(proxier.natChains, \"*nat\") proxier.createAndLinkeKubeChain() // make sure dummy interface exists in the system where ipvs Proxier will bind service address on it _, err = proxier.netlinkHandle.EnsureDummyDevice(DefaultDummyDevice) if err != nil { klog.Errorf(\"Failed to create dummy interface: %s, error: %v\", DefaultDummyDevice, err) return } // make sure ip sets exists in the system. for _, set := range proxier.ipsetList { if err := ensureIPSet(set); err != nil { return } set.resetEntries() } // Accumulate the set of local ports that we will be holding open once this update is complete replacementPortsMap := map[utilproxy.LocalPort]utilproxy.Closeable{} // activeIPVSServices represents IPVS service successfully created in this round of sync activeIPVSServices := map[string]bool{} // currentIPVSServices represent IPVS services listed from the system currentIPVSServices := make(map[string]*utilipvs.VirtualServer) // activeBindAddrs represents ip address successfully bind to DefaultDummyDevice in this round of sync activeBindAddrs := map[string]bool{} bindedAddresses, err := proxier.ipGetter.BindedIPs() if err != nil { klog.Errorf(\"error listing addresses binded to dummy interface, error: %v\", err) } // 检查是否是nodeport类型 hasNodePort := false for _, svc := range proxier.serviceMap { svcInfo, ok := svc.(*serviceInfo) if ok \u0026\u0026 svcInfo.NodePort() != 0 { hasNodePort = true break } } // Both nodeAddresses and nodeIPs can be reused for all nodePort services // and only need to be computed if we have at least one nodePort service. var ( // List of node addresses to listen on if a nodePort is set. nodeAddresses []string // List of node IP addresses to be used as IPVS services if nodePort is set. nodeIPs []net.IP ) if hasNodePort { nodeAddrSet, err := utilproxy.GetNodeAddresses(proxier.nodePortAddresses, proxier.networkInterfacer) if err != nil { klog.Errorf(\"Failed to get node ip address matching nodeport cidr: %v\", err) } else { nodeAddresses = nodeAddrSet.List() for _, address := range nodeAddresses { if utilproxy.IsZeroCIDR(address) { nodeIPs, err = proxier.ipGetter.NodeIPs() if err != nil { klog.Errorf(\"Failed to list all node IPs from host, err: %v\", err) } break } nodeIPs = append(nodeIPs, net.ParseIP(address)) } } } 接下来是整个构建ipvs规则的关键部分，大概200-300行代码，通过循环 serviceMap 拿到每一个 service 的信息，然后在通过 循环 endpointsMap[svcName] 得到每个 service下所属的 endpoint ，然后构建 ipvs 的规则\nL1141-L1542 这里也包含了 nodeport, clusterIP, ingress等不同的service类型\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 // Build IPVS rules for each service. for svcName, svc := range proxier.serviceMap { svcInfo, ok := svc.(*serviceInfo) if !ok { klog.Errorf(\"Failed to cast serviceInfo %q\", svcName.String()) continue } isIPv6 := utilnet.IsIPv6(svcInfo.ClusterIP()) protocol := strings.ToLower(string(svcInfo.Protocol())) // Precompute svcNameString; with many services the many calls // to ServicePortName.String() show up in CPU profiles. svcNameString := svcName.String() // 循环endpoint // Handle traffic that loops back to the originator with SNAT. for _, e := range proxier.endpointsMap[svcName] { ep, ok := e.(*proxy.BaseEndpointInfo) if !ok { klog.Errorf(\"Failed to cast BaseEndpointInfo %q\", e.String()) continue } if !ep.IsLocal { continue } epIP := ep.IP() epPort, err := ep.Port() // Error parsing this endpoint has been logged. Skip to next endpoint. if epIP == \"\" || err != nil { continue } entry := \u0026utilipset.Entry{ IP: epIP, Port: epPort, Protocol: protocol, IP2: epIP, SetType: utilipset.HashIPPortIP, } if valid := proxier.ipsetList[kubeLoopBackIPSet].validateEntry(entry); !valid { klog.Errorf(\"%s\", fmt.Sprintf(EntryInvalidErr, entry, proxier.ipsetList[kubeLoopBackIPSet].Name)) continue } proxier.ipsetList[kubeLoopBackIPSet].activeEntries.Insert(entry.String()) } // Capture the clusterIP. // ipset call entry := \u0026utilipset.Entry{ IP: svcInfo.ClusterIP().String(), Port: svcInfo.Port(), Protocol: protocol, SetType: utilipset.HashIPPort, } // add service Cluster IP:Port to kubeServiceAccess ip set for the purpose of solving hairpin. // proxier.kubeServiceAccessSet.activeEntries.Insert(entry.String()) if valid := proxier.ipsetList[kubeClusterIPSet].validateEntry(entry); !valid { klog.Errorf(\"%s\", fmt.Sprintf(EntryInvalidErr, entry, proxier.ipsetList[kubeClusterIPSet].Name)) continue } proxier.ipsetList[kubeClusterIPSet].activeEntries.Insert(entry.String()) // ipvs call serv := \u0026utilipvs.VirtualServer{ Address: svcInfo.ClusterIP(), Port: uint16(svcInfo.Port()), Protocol: string(svcInfo.Protocol()), Scheduler: proxier.ipvsScheduler, } // Set session affinity flag and timeout for IPVS service if svcInfo.SessionAffinityType() == v1.ServiceAffinityClientIP { serv.Flags |= utilipvs.FlagPersistent serv.Timeout = uint32(svcInfo.StickyMaxAgeSeconds()) } // We need to bind ClusterIP to dummy interface, so set `bindAddr` parameter to `true` in syncService() if err := proxier.syncService(svcNameString, serv, true, bindedAddresses); err == nil { activeIPVSServices[serv.String()] = true activeBindAddrs[serv.Address.String()] = true // ExternalTrafficPolicy only works for NodePort and external LB traffic, does not affect ClusterIP // So we still need clusterIP rules in onlyNodeLocalEndpoints mode. if err := proxier.syncEndpoint(svcName, false, serv); err != nil { klog.Errorf(\"Failed to sync endpoint for service: %v, err: %v\", serv, err) } } else { klog.Errorf(\"Failed to sync service: %v, err: %v\", serv, err) } // Capture externalIPs. for _, externalIP := range svcInfo.ExternalIPStrings() { // If the \"external\" IP happens to be an IP that is local to this // machine, hold the local port open so no other process can open it // (because the socket might open but it would never work). if (svcInfo.Protocol() != v1.ProtocolSCTP) \u0026\u0026 localAddrSet.Has(net.ParseIP(externalIP)) { // We do not start listening on SCTP ports, according to our agreement in the SCTP support KEP lp := utilproxy.LocalPort{ Description: \"externalIP for \" + svcNameString, IP: externalIP, Port: svcInfo.Port(), Protocol: protocol, } if proxier.portsMap[lp] != nil { klog.V(4).Infof(\"Port %s was open before and is still needed\", lp.String()) replacementPortsMap[lp] = proxier.portsMap[lp] } else { socket, err := proxier.portMapper.OpenLocalPort(\u0026lp, isIPv6) if err != nil { msg := fmt.Sprintf(\"can't open %s, skipping this externalIP: %v\", lp.String(), err) proxier.recorder.Eventf( \u0026v1.ObjectReference{ Kind: \"Node\", Name: proxier.hostname, UID: types.UID(proxier.hostname), Namespace: \"\", }, v1.EventTypeWarning, err.Error(), msg) klog.Error(msg) continue } replacementPortsMap[lp] = socket } } // We're holding the port, so it's OK to install IPVS rules. // ipset call entry := \u0026utilipset.Entry{ IP: externalIP, Port: svcInfo.Port(), Protocol: protocol, SetType: utilipset.HashIPPort, } if utilfeature.DefaultFeatureGate.Enabled(features.ExternalPolicyForExternalIP) \u0026\u0026 svcInfo.OnlyNodeLocalEndpoints() { if valid := proxier.ipsetList[kubeExternalIPLocalSet].validateEntry(entry); !valid { klog.Errorf(\"%s\", fmt.Sprintf(EntryInvalidErr, entry, proxier.ipsetList[kubeExternalIPLocalSet].Name)) continue } proxier.ipsetList[kubeExternalIPLocalSet].activeEntries.Insert(entry.String()) } else { // We have to SNAT packets to external IPs. if valid := proxier.ipsetList[kubeExternalIPSet].validateEntry(entry); !valid { klog.Errorf(\"%s\", fmt.Sprintf(EntryInvalidErr, entry, proxier.ipsetList[kubeExternalIPSet].Name)) continue } proxier.ipsetList[kubeExternalIPSet].activeEntries.Insert(entry.String()) } // ipvs call serv := \u0026utilipvs.VirtualServer{ Address: net.ParseIP(externalIP), Port: uint16(svcInfo.Port()), Protocol: string(svcInfo.Protocol()), Scheduler: proxier.ipvsScheduler, } if svcInfo.SessionAffinityType() == v1.ServiceAffinityClientIP { serv.Flags |= utilipvs.FlagPersistent serv.Timeout = uint32(svcInfo.StickyMaxAgeSeconds()) } if err := proxier.syncService(svcNameString, serv, true, bindedAddresses); err == nil { activeIPVSServices[serv.String()] = true activeBindAddrs[serv.Address.String()] = true onlyNodeLocalEndpoints := false if utilfeature.DefaultFeatureGate.Enabled(features.ExternalPolicyForExternalIP) { onlyNodeLocalEndpoints = svcInfo.OnlyNodeLocalEndpoints() } if err := proxier.syncEndpoint(svcName, onlyNodeLocalEndpoints, serv); err != nil { klog.Errorf(\"Failed to sync endpoint for service: %v, err: %v\", serv, err) } } else { klog.Errorf(\"Failed to sync service: %v, err: %v\", serv, err) } } // Capture load-balancer ingress. for _, ingress := range svcInfo.LoadBalancerIPStrings() { if ingress != \"\" { // ipset call entry = \u0026utilipset.Entry{ IP: ingress, Port: svcInfo.Port(), Protocol: protocol, SetType: utilipset.HashIPPort, } // add service load balancer ingressIP:Port to kubeServiceAccess ip set for the purpose of solving hairpin. // proxier.kubeServiceAccessSet.activeEntries.Insert(entry.String()) // If we are proxying globally, we need to masquerade in case we cross nodes. // If we are proxying only locally, we can retain the source IP. if valid := proxier.ipsetList[kubeLoadBalancerSet].validateEntry(entry); !valid { klog.Errorf(\"%s\", fmt.Sprintf(EntryInvalidErr, entry, proxier.ipsetList[kubeLoadBalancerSet].Name)) continue } proxier.ipsetList[kubeLoadBalancerSet].activeEntries.Insert(entry.String()) // insert loadbalancer entry to lbIngressLocalSet if service externaltrafficpolicy=local if svcInfo.OnlyNodeLocalEndpoints() { if valid := proxier.ipsetList[kubeLoadBalancerLocalSet].validateEntry(entry); !valid { klog.Errorf(\"%s\", fmt.Sprintf(EntryInvalidErr, entry, proxier.ipsetList[kubeLoadBalancerLocalSet].Name)) continue } proxier.ipsetList[kubeLoadBalancerLocalSet].activeEntries.Insert(entry.String()) } if len(svcInfo.LoadBalancerSourceRanges()) != 0 { // The service firewall rules are created based on ServiceSpec.loadBalancerSourceRanges field. // This currently works for loadbalancers that preserves source ips. // For loadbalancers which direct traffic to service NodePort, the firewall rules will not apply. if valid := proxier.ipsetList[kubeLoadbalancerFWSet].validateEntry(entry); !valid { klog.Errorf(\"%s\", fmt.Sprintf(EntryInvalidErr, entry, proxier.ipsetList[kubeLoadbalancerFWSet].Name)) continue } proxier.ipsetList[kubeLoadbalancerFWSet].activeEntries.Insert(entry.String()) allowFromNode := false for _, src := range svcInfo.LoadBalancerSourceRanges() { // ipset call entry = \u0026utilipset.Entry{ IP: ingress, Port: svcInfo.Port(), Protocol: protocol, Net: src, SetType: utilipset.HashIPPortNet, } // enumerate all white list source cidr if valid := proxier.ipsetList[kubeLoadBalancerSourceCIDRSet].validateEntry(entry); !valid { klog.Errorf(\"%s\", fmt.Sprintf(EntryInvalidErr, entry, proxier.ipsetList[kubeLoadBalancerSourceCIDRSet].Name)) continue } proxier.ipsetList[kubeLoadBalancerSourceCIDRSet].activeEntries.Insert(entry.String()) // ignore error because it has been validated _, cidr, _ := net.ParseCIDR(src) if cidr.Contains(proxier.nodeIP) { allowFromNode = true } } // generally, ip route rule was added to intercept request to loadbalancer vip from the // loadbalancer's backend hosts. In this case, request will not hit the loadbalancer but loop back directly. // Need to add the following rule to allow request on host. if allowFromNode { entry = \u0026utilipset.Entry{ IP: ingress, Port: svcInfo.Port(), Protocol: protocol, IP2: ingress, SetType: utilipset.HashIPPortIP, } // enumerate all white list source ip if valid := proxier.ipsetList[kubeLoadBalancerSourceIPSet].validateEntry(entry); !valid { klog.Errorf(\"%s\", fmt.Sprintf(EntryInvalidErr, entry, proxier.ipsetList[kubeLoadBalancerSourceIPSet].Name)) continue } proxier.ipsetList[kubeLoadBalancerSourceIPSet].activeEntries.Insert(entry.String()) } } // ipvs call serv := \u0026utilipvs.VirtualServer{ Address: net.ParseIP(ingress), Port: uint16(svcInfo.Port()), Protocol: string(svcInfo.Protocol()), Scheduler: proxier.ipvsScheduler, } if svcInfo.SessionAffinityType() == v1.ServiceAffinityClientIP { serv.Flags |= utilipvs.FlagPersistent serv.Timeout = uint32(svcInfo.StickyMaxAgeSeconds()) } if err := proxier.syncService(svcNameString, serv, true, bindedAddresses); err == nil { activeIPVSServices[serv.String()] = true activeBindAddrs[serv.Address.String()] = true if err := proxier.syncEndpoint(svcName, svcInfo.OnlyNodeLocalEndpoints(), serv); err != nil { klog.Errorf(\"Failed to sync endpoint for service: %v, err: %v\", serv, err) } } else { klog.Errorf(\"Failed to sync service: %v, err: %v\", serv, err) } } } if svcInfo.NodePort() != 0 { if len(nodeAddresses) == 0 || len(nodeIPs) == 0 { // Skip nodePort configuration since an error occurred when // computing nodeAddresses or nodeIPs. continue } var lps []utilproxy.LocalPort for _, address := range nodeAddresses { lp := utilproxy.LocalPort{ Description: \"nodePort for \" + svcNameString, IP: address, Port: svcInfo.NodePort(), Protocol: protocol, } if utilproxy.IsZeroCIDR(address) { // Empty IP address means all lp.IP = \"\" lps = append(lps, lp) // If we encounter a zero CIDR, then there is no point in processing the rest of the addresses. break } lps = append(lps, lp) } // For ports on node IPs, open the actual port and hold it. for _, lp := range lps { if proxier.portsMap[lp] != nil { klog.V(4).Infof(\"Port %s was open before and is still needed\", lp.String()) replacementPortsMap[lp] = proxier.portsMap[lp] // We do not start listening on SCTP ports, according to our agreement in the // SCTP support KEP } else if svcInfo.Protocol() != v1.ProtocolSCTP { socket, err := proxier.portMapper.OpenLocalPort(\u0026lp, isIPv6) if err != nil { klog.Errorf(\"can't open %s, skipping this nodePort: %v\", lp.String(), err) continue } if lp.Protocol == \"udp\" { conntrack.ClearEntriesForPort(proxier.exec, lp.Port, isIPv6, v1.ProtocolUDP) } replacementPortsMap[lp] = socket } // We're holding the port, so it's OK to install ipvs rules. } // Nodeports need SNAT, unless they're local. // ipset call var ( nodePortSet *IPSet entries []*utilipset.Entry ) switch protocol { case \"tcp\": nodePortSet = proxier.ipsetList[kubeNodePortSetTCP] entries = []*utilipset.Entry{{ // No need to provide ip info Port: svcInfo.NodePort(), Protocol: protocol, SetType: utilipset.BitmapPort, }} case \"udp\": nodePortSet = proxier.ipsetList[kubeNodePortSetUDP] entries = []*utilipset.Entry{{ // No need to provide ip info Port: svcInfo.NodePort(), Protocol: protocol, SetType: utilipset.BitmapPort, }} case \"sctp\": nodePortSet = proxier.ipsetList[kubeNodePortSetSCTP] // Since hash ip:port is used for SCTP, all the nodeIPs to be used in the SCTP ipset entries. entries = []*utilipset.Entry{} for _, nodeIP := range nodeIPs { entries = append(entries, \u0026utilipset.Entry{ IP: nodeIP.String(), Port: svcInfo.NodePort(), Protocol: protocol, SetType: utilipset.HashIPPort, }) } default: // It should never hit klog.Errorf(\"Unsupported protocol type: %s\", protocol) } if nodePortSet != nil { entryInvalidErr := false for _, entry := range entries { if valid := nodePortSet.validateEntry(entry); !valid { klog.Errorf(\"%s\", fmt.Sprintf(EntryInvalidErr, entry, nodePortSet.Name)) entryInvalidErr = true break } nodePortSet.activeEntries.Insert(entry.String()) } if entryInvalidErr { continue } } // Add externaltrafficpolicy=local type nodeport entry if svcInfo.OnlyNodeLocalEndpoints() { var nodePortLocalSet *IPSet switch protocol { case \"tcp\": nodePortLocalSet = proxier.ipsetList[kubeNodePortLocalSetTCP] case \"udp\": nodePortLocalSet = proxier.ipsetList[kubeNodePortLocalSetUDP] case \"sctp\": nodePortLocalSet = proxier.ipsetList[kubeNodePortLocalSetSCTP] default: // It should never hit klog.Errorf(\"Unsupported protocol type: %s\", protocol) } if nodePortLocalSet != nil { entryInvalidErr := false for _, entry := range entries { if valid := nodePortLocalSet.validateEntry(entry); !valid { klog.Errorf(\"%s\", fmt.Sprintf(EntryInvalidErr, entry, nodePortLocalSet.Name)) entryInvalidErr = true break } nodePortLocalSet.activeEntries.Insert(entry.String()) } if entryInvalidErr { continue } } } // Build ipvs kernel routes for each node ip address for _, nodeIP := range nodeIPs { // ipvs call serv := \u0026utilipvs.VirtualServer{ Address: nodeIP, Port: uint16(svcInfo.NodePort()), Protocol: string(svcInfo.Protocol()), Scheduler: proxier.ipvsScheduler, } if svcInfo.SessionAffinityType() == v1.ServiceAffinityClientIP { serv.Flags |= utilipvs.FlagPersistent serv.Timeout = uint32(svcInfo.StickyMaxAgeSeconds()) } // There is no need to bind Node IP to dummy interface, so set parameter `bindAddr` to `false`. if err := proxier.syncService(svcNameString, serv, false, bindedAddresses); err == nil { activeIPVSServices[serv.String()] = true if err := proxier.syncEndpoint(svcName, svcInfo.OnlyNodeLocalEndpoints(), serv); err != nil { klog.Errorf(\"Failed to sync endpoint for service: %v, err: %v\", serv, err) } } else { klog.Errorf(\"Failed to sync service: %v, err: %v\", serv, err) } } } } 其中有两个非常重要的函数 syncService() 于 syncEndpoint() 这两个定义了同步的过程\nsyncService() 函数表示了增加或删除一个service，如果存在则修改，如果存在则添加\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 func (proxier *Proxier) syncService(svcName string, vs *utilipvs.VirtualServer, bindAddr bool, bindedAddresses sets.String) error { appliedVirtualServer, _ := proxier.ipvs.GetVirtualServer(vs) if appliedVirtualServer == nil || !appliedVirtualServer.Equal(vs) { if appliedVirtualServer == nil { // IPVS service is not found, create a new service klog.V(3).Infof(\"Adding new service %q %s:%d/%s\", svcName, vs.Address, vs.Port, vs.Protocol) if err := proxier.ipvs.AddVirtualServer(vs); err != nil { klog.Errorf(\"Failed to add IPVS service %q: %v\", svcName, err) return err } } else { // IPVS service was changed, update the existing one // During updates, service VIP will not go down klog.V(3).Infof(\"IPVS service %s was changed\", svcName) if err := proxier.ipvs.UpdateVirtualServer(vs); err != nil { klog.Errorf(\"Failed to update IPVS service, err:%v\", err) return err } } } // bind service address to dummy interface if bindAddr { // always attempt to bind if bindedAddresses is nil, // otherwise check if it's already binded and return early if bindedAddresses != nil \u0026\u0026 bindedAddresses.Has(vs.Address.String()) { return nil } klog.V(4).Infof(\"Bind addr %s\", vs.Address.String()) _, err := proxier.netlinkHandle.EnsureAddressBind(vs.Address.String(), DefaultDummyDevice) if err != nil { klog.Errorf(\"Failed to bind service address to dummy device %q: %v\", svcName, err) return err } } return nil } 同理 syncEndpoint() 也是相同的操作\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 func (proxier *Proxier) syncEndpoint(svcPortName proxy.ServicePortName, onlyNodeLocalEndpoints bool, vs *utilipvs.VirtualServer) error { appliedVirtualServer, err := proxier.ipvs.GetVirtualServer(vs) if err != nil || appliedVirtualServer == nil { klog.Errorf(\"Failed to get IPVS service, error: %v\", err) return err } // curEndpoints represents IPVS destinations listed from current system. curEndpoints := sets.NewString() // newEndpoints represents Endpoints watched from API Server. newEndpoints := sets.NewString() curDests, err := proxier.ipvs.GetRealServers(appliedVirtualServer) if err != nil { klog.Errorf(\"Failed to list IPVS destinations, error: %v\", err) return err } for _, des := range curDests { curEndpoints.Insert(des.String()) } endpoints := proxier.endpointsMap[svcPortName] // Service Topology will not be enabled in the following cases: // 1. externalTrafficPolicy=Local (mutually exclusive with service topology). // 2. ServiceTopology is not enabled. // 3. EndpointSlice is not enabled (service topology depends on endpoint slice // to get topology information). if !onlyNodeLocalEndpoints \u0026\u0026 utilfeature.DefaultFeatureGate.Enabled(features.ServiceTopology) \u0026\u0026 utilfeature.DefaultFeatureGate.Enabled(features.EndpointSliceProxying) { endpoints = proxy.FilterTopologyEndpoint(proxier.nodeLabels, proxier.serviceMap[svcPortName].TopologyKeys(), endpoints) } for _, epInfo := range endpoints { if onlyNodeLocalEndpoints \u0026\u0026 !epInfo.GetIsLocal() { continue } newEndpoints.Insert(epInfo.String()) } // Create new endpoints for _, ep := range newEndpoints.List() { ip, port, err := net.SplitHostPort(ep) if err != nil { klog.Errorf(\"Failed to parse endpoint: %v, error: %v\", ep, err) continue } portNum, err := strconv.Atoi(port) if err != nil { klog.Errorf(\"Failed to parse endpoint port %s, error: %v\", port, err) continue } newDest := \u0026utilipvs.RealServer{ Address: net.ParseIP(ip), Port: uint16(portNum), Weight: 1, } if curEndpoints.Has(ep) { // check if newEndpoint is in gracefulDelete list, if true, delete this ep immediately uniqueRS := GetUniqueRSName(vs, newDest) if !proxier.gracefuldeleteManager.InTerminationList(uniqueRS) { continue } klog.V(5).Infof(\"new ep %q is in graceful delete list\", uniqueRS) err := proxier.gracefuldeleteManager.MoveRSOutofGracefulDeleteList(uniqueRS) if err != nil { klog.Errorf(\"Failed to delete endpoint: %v in gracefulDeleteQueue, error: %v\", ep, err) continue } } err = proxier.ipvs.AddRealServer(appliedVirtualServer, newDest) if err != nil { klog.Errorf(\"Failed to add destination: %v, error: %v\", newDest, err) continue } } // Delete old endpoints for _, ep := range curEndpoints.Difference(newEndpoints).UnsortedList() { // if curEndpoint is in gracefulDelete, skip uniqueRS := vs.String() + \"/\" + ep if proxier.gracefuldeleteManager.InTerminationList(uniqueRS) { continue } ip, port, err := net.SplitHostPort(ep) if err != nil { klog.Errorf(\"Failed to parse endpoint: %v, error: %v\", ep, err) continue } portNum, err := strconv.Atoi(port) if err != nil { klog.Errorf(\"Failed to parse endpoint port %s, error: %v\", port, err) continue } delDest := \u0026utilipvs.RealServer{ Address: net.ParseIP(ip), Port: uint16(portNum), } klog.V(5).Infof(\"Using graceful delete to delete: %v\", uniqueRS) err = proxier.gracefuldeleteManager.GracefulDeleteRS(appliedVirtualServer, delDest) if err != nil { klog.Errorf(\"Failed to delete destination: %v, error: %v\", uniqueRS, err) continue } } return nil } 接下来就是同步规则的步骤了，L1544-L1621\nstep 3：规则的删除 粗略翻到这里可能有一个疑问？没有提到删除，删除时包含在 syncXX() 函数中的\n例如在 syncEndpoint() 中会看是否在 终止列表中，如果在跳过，如果不在加入\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 if curEndpoints.Has(ep) { // check if newEndpoint is in gracefulDelete list, if true, delete this ep immediately uniqueRS := GetUniqueRSName(vs, newDest) if !proxier.gracefuldeleteManager.InTerminationList(uniqueRS) { continue } klog.V(5).Infof(\"new ep %q is in graceful delete list\", uniqueRS) err := proxier.gracefuldeleteManager.MoveRSOutofGracefulDeleteList(uniqueRS) if err != nil { klog.Errorf(\"Failed to delete endpoint: %v in gracefulDeleteQueue, error: %v\", ep, err) continue } } 而 gracefuldeleteManager 是一个 一直运行的协程，在初始化 proxier 时被 Run()\ngo 1 2 3 4 // Run start a goroutine to try to delete rs in the graceful delete rsList with an interval 1 minute func (m *GracefulTerminationManager) Run() { go wait.Until(m.tryDeleteRs, rsCheckDeleteInterval, wait.NeverStop) } proxier.go\ngo 1 2 3 proxier.syncRunner = async.NewBoundedFrequencyRunner(\"sync-runner\", proxier.syncProxyRules, minSyncPeriod, syncPeriod, burstSyncs) proxier.gracefuldeleteManager.Run() return proxier, nil 总结 到这里已经清楚的掌握了 kube-proxy 的架构，接下来的会为扩展kubernetes中service架构，以及手撸一个 kube-proxy做准备；本系列第三部分：如何扩展现有的kube-proxy架构\n文中的知识都是个人根据理解整理的，如有不对的地方欢迎指出，感谢各位大佬\nReference\n[1] dual-stack service\n","wordCount":"4454","inLanguage":"zh","datePublished":"2023-02-06T00:00:00Z","dateModified":"2023-02-12T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2023/02/ch19-kube-proxy-code/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">深入理解Kubernetes service - kube-proxy架构分析</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2023-02-06</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>4454 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>21 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a>
<a href=https://www.oomkill.com/tags/kubernetes-develop/>#Kubernetes Develop</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e5%89%8d%e6%8f%90%e6%a6%82%e8%bf%b0 aria-label=前提概述>前提概述</a><li><a href=#kube-proxy%e8%bd%af%e4%bb%b6%e8%ae%be%e8%ae%a1 aria-label=kube-proxy软件设计>kube-proxy软件设计</a><li><a href=#%e5%a6%82%e4%bd%95%e5%bf%ab%e9%80%9f%e8%af%bb%e6%87%82kube-proxy%e6%ba%90%e7%a0%81 aria-label=如何快速读懂kube-proxy源码>如何快速读懂kube-proxy源码</a><li><a href=#service-controller aria-label="service controller">service controller</a><li><a href=#%e6%b7%b1%e5%85%a5%e7%90%86%e8%a7%a3proxier aria-label=深入理解proxier>深入理解proxier</a><li><a href=#syncproxyrules aria-label=syncProxyRules()>syncProxyRules()</a><ul><li><a href=#step1-%e5%89%8d%e6%9c%9f%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c aria-label="step1 前期准备工作">step1 前期准备工作</a><li><a href=#step2%e6%9e%84%e5%bb%baipvs%e8%a7%84%e5%88%99 aria-label=step2：构建IPVS规则>step2：构建IPVS规则</a><li><a href=#step-3%e8%a7%84%e5%88%99%e7%9a%84%e5%88%a0%e9%99%a4 aria-label="step 3：规则的删除">step 3：规则的删除</a></ul><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=前提概述>前提概述<a hidden class=anchor aria-hidden=true href=#前提概述>#</a></h2><p>kubernetes集群中运行在每个Worker节点上的组件 <strong>kube-proxy</strong>，本文讲解的是如何快速的了解 kube-proxy 的软件架构，而不是流程的分析，专注于 proxy 层面的设计讲解，而不会贴大量的代码</p><h2 id=kube-proxy软件设计>kube-proxy软件设计<a hidden class=anchor aria-hidden=true href=#kube-proxy软件设计>#</a></h2><p>kube-proxy 在设计上分为三个模块 server 于 <a href=https://github.com/kubernetes/kubernetes/tree/master/cmd/kube-proxy target=_blank rel="noopener nofollow noreferrer">proxy</a>：</p><ul><li><a href=https://github.com/kubernetes/kubernetes/tree/master/cmd/kube-proxy target=_blank rel="noopener nofollow noreferrer">server</a>: 是一个常驻进程用于处理service的事件</li><li><a href=https://github.com/kubernetes/kubernetes/tree/v1.24.5/pkg/proxy target=_blank rel="noopener nofollow noreferrer">proxy</a>: 是 kube-proxy 的工作核心，实际上的角色是一个 service controller，通过监听 node, service, endpoint 而生成规则</li><li><a href=https://github.com/kubernetes/kubernetes/blob/v1.24.5/pkg/proxy/ipvs/proxier.go target=_blank rel="noopener nofollow noreferrer">proxier</a>: 是实现service的组件，例如iptables, ipvs&mldr;.</li></ul><h2 id=如何快速读懂kube-proxy源码>如何快速读懂kube-proxy源码<a hidden class=anchor aria-hidden=true href=#如何快速读懂kube-proxy源码>#</a></h2><p>要想快速读懂 kube-proxy 源码就需要对 kube-proxy 设计有深刻的了解，例如需要看 kube-proxy 的实现，我们就可以看 proxy的部分，下列是 proxy 部分的目录结构</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ tree -L <span class=m>1</span>
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── BUILD
</span></span><span class=line><span class=cl>├── OWNERS
</span></span><span class=line><span class=cl>├── apis
</span></span><span class=line><span class=cl>├── config
</span></span><span class=line><span class=cl>├── healthcheck
</span></span><span class=line><span class=cl>├── iptables
</span></span><span class=line><span class=cl>├── ipvs
</span></span><span class=line><span class=cl>├── metaproxier
</span></span><span class=line><span class=cl>├── metrics
</span></span><span class=line><span class=cl>├── userspace
</span></span><span class=line><span class=cl>├── util
</span></span><span class=line><span class=cl>├── winuserspace
</span></span><span class=line><span class=cl>├── winkernel
</span></span><span class=line><span class=cl>├── doc.go
</span></span><span class=line><span class=cl>├── endpoints.go
</span></span><span class=line><span class=cl>├── endpoints_test.go
</span></span><span class=line><span class=cl>├── endpointslicecache.go
</span></span><span class=line><span class=cl>├── endpointslicecache_test.go
</span></span><span class=line><span class=cl>├── service.go
</span></span><span class=line><span class=cl>├── service_test.go
</span></span><span class=line><span class=cl>├── topology.go
</span></span><span class=line><span class=cl>├── topology_test.go
</span></span><span class=line><span class=cl>└── types.go</span></span></code></pre></td></tr></table></div></div></div></div><ul><li>目录 ipvs, iptables, 就是所知的 kube-proxy 提供的两种 load balancer</li><li>目录 apis, 则是kube-proxy 配置文件资源类型的定义，<code>--config=/etc/kubernetes/kube-proxy-config.yaml</code> 所指定问题的shema</li><li>目录config: 定义了每种资源的handler需要实现什么</li><li>service.go, endpoints.go：是controller的实现</li><li>type.go: 是每个资源的interface定义，例如：<ul><li>Provider: 规定了每个proxier需要实现什么</li><li>ServicePort: service 控制器需要实现什么</li><li>Endpoint: service 控制器需要实现什么</li></ul></li></ul><p>上述是整个 proxy 的一级结构</p><h2 id=service-controller>service controller<a hidden class=anchor aria-hidden=true href=#service-controller>#</a></h2><p>service控制器换句话说，就是工作内容类似于kubernetes集群中的pod控制器那些，所作的工作就是监听对应资源做出相应事件处理，而这个处理被定义为 <a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/types.go#L30-L41 target=_blank rel="noopener nofollow noreferrer">handler</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Provider</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span><span class=p>.</span><span class=nx>EndpointsHandler</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span><span class=p>.</span><span class=nx>EndpointSliceHandler</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span><span class=p>.</span><span class=nx>ServiceHandler</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span><span class=p>.</span><span class=nx>NodeHandler</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Sync immediately synchronizes the Provider&#39;s current state to proxy rules.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// SyncLoop runs periodic work.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This is expected to run as a goroutine or as the main loop of the app.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// It does not return.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>SyncLoop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>由上面代码可以看到，每一个Provider 即 proxier （用于实现的LB的控制器）都需要包含对应资源的事件处理函数于 一个 <code>Sync()</code> 和 <code>SyncLoop()</code>，所以这里将总结为 controller 而不是用于这里给到的术语</p><p>同理，其他类型的 controller 则是相同与 service controller</p><h2 id=深入理解proxier>深入理解proxier<a hidden class=anchor aria-hidden=true href=#深入理解proxier>#</a></h2><p>这里将以 ipvs 为例，如图所示，这将是一个 proxier 的实现，而 proxier.go 则是真实的 proxier 实现</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20230212221556051.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20230212221556051.png#center alt=image-20230212221556051 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：Kubernetes API 请求的请求处理步骤图（详细）</center><p>而 ipvs 的 <a href=https://github.com/kubernetes/kubernetes/blob/v1.24.5/pkg/proxy/ipvs/proxier.go target=_blank rel="noopener nofollow noreferrer">proxier</a> 则是如下定义的</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Proxier</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// endpointsChanges and serviceChanges contains all changes to endpoints and
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// services that happened since last syncProxyRules call. For a single object,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// changes are accumulated, i.e. previous is state from before all of them,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// current is state after applying all of those.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>endpointsChanges</span> <span class=o>*</span><span class=nx>proxy</span><span class=p>.</span><span class=nx>EndpointChangeTracker</span>
</span></span><span class=line><span class=cl>	<span class=nx>serviceChanges</span>   <span class=o>*</span><span class=nx>proxy</span><span class=p>.</span><span class=nx>ServiceChangeTracker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>mu</span>           <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span> <span class=c1>// protects the following fields
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>serviceMap</span>   <span class=nx>proxy</span><span class=p>.</span><span class=nx>ServiceMap</span>
</span></span><span class=line><span class=cl>	<span class=nx>endpointsMap</span> <span class=nx>proxy</span><span class=p>.</span><span class=nx>EndpointsMap</span>
</span></span><span class=line><span class=cl>	<span class=nx>portsMap</span>     <span class=kd>map</span><span class=p>[</span><span class=nx>utilproxy</span><span class=p>.</span><span class=nx>LocalPort</span><span class=p>]</span><span class=nx>utilproxy</span><span class=p>.</span><span class=nx>Closeable</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodeLabels</span>   <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=c1>// endpointsSynced, endpointSlicesSynced, and servicesSynced are set to true when
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// corresponding objects are synced after startup. This is used to avoid updating
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// ipvs rules with some partial data after kube-proxy restart.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>endpointsSynced</span>      <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=nx>endpointSlicesSynced</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=nx>servicesSynced</span>       <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=nx>initialized</span>          <span class=kt>int32</span>
</span></span><span class=line><span class=cl>	<span class=nx>syncRunner</span>           <span class=o>*</span><span class=nx>async</span><span class=p>.</span><span class=nx>BoundedFrequencyRunner</span> <span class=c1>// governs calls to syncProxyRules
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// These are effectively const and do not need the mutex to be held.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>syncPeriod</span>    <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>	<span class=nx>minSyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Values are CIDR&#39;s to exclude when cleaning up IPVS rules.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>excludeCIDRs</span> <span class=p>[]</span><span class=o>*</span><span class=nx>net</span><span class=p>.</span><span class=nx>IPNet</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Set to true to set sysctls arp_ignore and arp_announce
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>strictARP</span>      <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=nx>iptables</span>       <span class=nx>utiliptables</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nx>ipvs</span>           <span class=nx>utilipvs</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nx>ipset</span>          <span class=nx>utilipset</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nx>exec</span>           <span class=nx>utilexec</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nx>masqueradeAll</span>  <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=nx>masqueradeMark</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>localDetector</span>  <span class=nx>proxyutiliptables</span><span class=p>.</span><span class=nx>LocalTrafficDetector</span>
</span></span><span class=line><span class=cl>	<span class=nx>hostname</span>       <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodeIP</span>         <span class=nx>net</span><span class=p>.</span><span class=nx>IP</span>
</span></span><span class=line><span class=cl>	<span class=nx>portMapper</span>     <span class=nx>utilproxy</span><span class=p>.</span><span class=nx>PortOpener</span>
</span></span><span class=line><span class=cl>	<span class=nx>recorder</span>       <span class=nx>record</span><span class=p>.</span><span class=nx>EventRecorder</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>serviceHealthServer</span> <span class=nx>healthcheck</span><span class=p>.</span><span class=nx>ServiceHealthServer</span>
</span></span><span class=line><span class=cl>	<span class=nx>healthzServer</span>       <span class=nx>healthcheck</span><span class=p>.</span><span class=nx>ProxierHealthUpdater</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ipvsScheduler</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Added as a member to the struct to allow injection for testing.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ipGetter</span> <span class=nx>IPGetter</span>
</span></span><span class=line><span class=cl>	<span class=c1>// The following buffers are used to reuse memory and avoid allocations
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// that are significantly impacting performance.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>iptablesData</span>     <span class=o>*</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>	<span class=nx>filterChainsData</span> <span class=o>*</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>	<span class=nx>natChains</span>        <span class=o>*</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>	<span class=nx>filterChains</span>     <span class=o>*</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>	<span class=nx>natRules</span>         <span class=o>*</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>	<span class=nx>filterRules</span>      <span class=o>*</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Added as a member to the struct to allow injection for testing.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>netlinkHandle</span> <span class=nx>NetLinkHandle</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ipsetList is the list of ipsets that ipvs proxier used.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ipsetList</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>IPSet</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Values are as a parameter to select the interfaces which nodeport works.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>nodePortAddresses</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=c1>// networkInterfacer defines an interface for several net library functions.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Inject for test purpose.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>networkInterfacer</span>     <span class=nx>utilproxy</span><span class=p>.</span><span class=nx>NetworkInterfacer</span>
</span></span><span class=line><span class=cl>	<span class=nx>gracefuldeleteManager</span> <span class=o>*</span><span class=nx>GracefulTerminationManager</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>再看这个结构体的 structure，发现他实现了上述提到的 Handler 和 <a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L843-L849 target=_blank rel="noopener nofollow noreferrer">Sync()</a></p><p>可以看到 Sync() 的实现是调用 runner.Run()</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>proxier</span> <span class=o>*</span><span class=nx>Proxier</span><span class=p>)</span> <span class=nf>Sync</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>healthzServer</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>proxier</span><span class=p>.</span><span class=nx>healthzServer</span><span class=p>.</span><span class=nf>QueuedUpdate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nx>SyncProxyRulesLastQueuedTimestamp</span><span class=p>.</span><span class=nf>SetToCurrentTime</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>syncRunner</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而 handler 中的任意事件的触发则是调用 Sync()</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// handler 不同的事件均指向 On{rs}Update() 函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>proxier</span> <span class=o>*</span><span class=nx>Proxier</span><span class=p>)</span> <span class=nf>OnEndpointsAdd</span><span class=p>(</span><span class=nx>endpoints</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Endpoints</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nf>OnEndpointsUpdate</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=nx>endpoints</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// OnEndpointsDelete is called whenever deletion of an existing endpoints object is observed.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>proxier</span> <span class=o>*</span><span class=nx>Proxier</span><span class=p>)</span> <span class=nf>OnEndpointsDelete</span><span class=p>(</span><span class=nx>endpoints</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Endpoints</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nf>OnEndpointsUpdate</span><span class=p>(</span><span class=nx>endpoints</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 而 update 调用的则是 Sync()
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>proxier</span> <span class=o>*</span><span class=nx>Proxier</span><span class=p>)</span> <span class=nf>OnEndpointsUpdate</span><span class=p>(</span><span class=nx>oldEndpoints</span><span class=p>,</span> <span class=nx>endpoints</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Endpoints</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>endpointsChanges</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>oldEndpoints</span><span class=p>,</span> <span class=nx>endpoints</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>proxier</span><span class=p>.</span><span class=nf>isInitialized</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>proxier</span><span class=p>.</span><span class=nf>Sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>到了这里，明了了 runner 才是这个 proxier 的核心，被定义于 proxier 结构图的 <a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L232 target=_blank rel="noopener nofollow noreferrer">syncRunner</a> 在初始化时被注入了函数 syncProxyRules()</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewProxier</span><span class=p>(</span><span class=nx>ipt</span> <span class=nx>utiliptables</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=nx>proxier</span><span class=p>.</span><span class=nx>syncRunner</span> <span class=p>=</span> <span class=nx>async</span><span class=p>.</span><span class=nf>NewBoundedFrequencyRunner</span><span class=p>(</span><span class=s>&#34;sync-runner&#34;</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>syncProxyRules</span><span class=p>,</span> <span class=nx>minSyncPeriod</span><span class=p>,</span> <span class=nx>syncPeriod</span><span class=p>,</span> <span class=nx>burstSyncs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>gracefuldeleteManager</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>proxier</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=syncproxyrules>syncProxyRules()<a hidden class=anchor aria-hidden=true href=#syncproxyrules>#</a></h2><p>而这个 <a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L1004-L1621 target=_blank rel="noopener nofollow noreferrer">syncProxyRules()</a> 则是完成了整个 ipvs 以及 service 的生命周期</p><p>对于了解kubernetes架构的同学来说，kube-proxy 完成的功能就是 ipvs 的规则管理，那么换句话说就是干预 ipvs 规则的生命周期，也就是分析函数 syncProxyRules() 是如何干预这些规则的。</p><p>syncProxyRules() 将动作分为两部分，一是对 ipvs 资源的增改，二是对资源的销毁；引入完概念后，就开始进行分析吧。</p><p>600多行的代码看起来很困难，那就拆分成步骤进行分析</p><h3 id=step1-前期准备工作>step1 前期准备工作<a hidden class=anchor aria-hidden=true href=#step1-前期准备工作>#</a></h3><p>为什么这么叫第一部分呢？看下列代码就知道，做的工作和 ipvs rules 没多大关系</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>proxier</span> <span class=o>*</span><span class=nx>Proxier</span><span class=p>)</span> <span class=nf>syncProxyRules</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 互斥锁
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=c1>// don&#39;t sync rules till we&#39;ve received services and endpoints
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 在等待接收完信息前，不同步收到的 services和endpoints资源
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>proxier</span><span class=p>.</span><span class=nf>isInitialized</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Not syncing ipvs rules until Services and Endpoints have been received from master&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Keep track of how long syncs take.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 记录同步耗时
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>start</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>SyncProxyRulesLatency</span><span class=p>.</span><span class=nf>Observe</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;syncProxyRules took %v&#34;</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取本地多个IP地址
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>localAddrs</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>utilproxy</span><span class=p>.</span><span class=nf>GetLocalAddrs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to get local addresses during proxy sync: %v, assuming external IPs are not local&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>localAddrs</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Warning</span><span class=p>(</span><span class=s>&#34;No local addresses found, assuming all external IPs are not local&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>localAddrSet</span> <span class=o>:=</span> <span class=nx>utilnet</span><span class=p>.</span><span class=nx>IPSet</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>localAddrSet</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>localAddrs</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// We assume that if this was called, we really want to sync them,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// even if nothing changed in the meantime. In other words, callers are
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// responsible for detecting no-op changes and not calling this function.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 这两步骤正如注释所讲，如果在资源修改的前提下需要同步，也就是update操作包含了增改
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>serviceUpdateResult</span> <span class=o>:=</span> <span class=nx>proxy</span><span class=p>.</span><span class=nf>UpdateServiceMap</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>serviceMap</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>serviceChanges</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>endpointUpdateResult</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>endpointsMap</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>endpointsChanges</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 陈腐的UDP信息处理
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>staleServices</span> <span class=o>:=</span> <span class=nx>serviceUpdateResult</span><span class=p>.</span><span class=nx>UDPStaleClusterIP</span>
</span></span><span class=line><span class=cl>    <span class=c1>// merge stale services gathered from updateEndpointsMap
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>svcPortName</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>endpointUpdateResult</span><span class=p>.</span><span class=nx>StaleServiceNames</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>serviceMap</span><span class=p>[</span><span class=nx>svcPortName</span><span class=p>];</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=nx>svcInfo</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>conntrack</span><span class=p>.</span><span class=nf>IsClearConntrackNeeded</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Protocol</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Stale %s service %v -&gt; %s&#34;</span><span class=p>,</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Protocol</span><span class=p>())),</span> <span class=nx>svcPortName</span><span class=p>,</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ClusterIP</span><span class=p>().</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=nx>staleServices</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ClusterIP</span><span class=p>().</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>extIP</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ExternalIPStrings</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>staleServices</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>extIP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=step2构建ipvs规则>step2：构建IPVS规则<a hidden class=anchor aria-hidden=true href=#step2构建ipvs规则>#</a></h3><p>首先会经历一些预处理的操作 这部分掠过了 <a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L1042-L1140 target=_blank rel="noopener nofollow noreferrer">L1042-L1140</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Syncing ipvs Proxier rules&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Begin install iptables
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Reset all buffers used later.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This is to avoid memory reallocations and thus improve performance.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>natChains</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>natRules</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>filterChains</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nx>filterRules</span><span class=p>.</span><span class=nf>Reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Write table headers.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>writeLine</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>filterChains</span><span class=p>,</span> <span class=s>&#34;*filter&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>writeLine</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>natChains</span><span class=p>,</span> <span class=s>&#34;*nat&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>proxier</span><span class=p>.</span><span class=nf>createAndLinkeKubeChain</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// make sure dummy interface exists in the system where ipvs Proxier will bind service address on it
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>netlinkHandle</span><span class=p>.</span><span class=nf>EnsureDummyDevice</span><span class=p>(</span><span class=nx>DefaultDummyDevice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to create dummy interface: %s, error: %v&#34;</span><span class=p>,</span> <span class=nx>DefaultDummyDevice</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// make sure ip sets exists in the system.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>set</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>ensureIPSet</span><span class=p>(</span><span class=nx>set</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>set</span><span class=p>.</span><span class=nf>resetEntries</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Accumulate the set of local ports that we will be holding open once this update is complete
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>replacementPortsMap</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>utilproxy</span><span class=p>.</span><span class=nx>LocalPort</span><span class=p>]</span><span class=nx>utilproxy</span><span class=p>.</span><span class=nx>Closeable</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// activeIPVSServices represents IPVS service successfully created in this round of sync
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>activeIPVSServices</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>bool</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// currentIPVSServices represent IPVS services listed from the system
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>currentIPVSServices</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>utilipvs</span><span class=p>.</span><span class=nx>VirtualServer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// activeBindAddrs represents ip address successfully bind to DefaultDummyDevice in this round of sync
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>activeBindAddrs</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>bool</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>bindedAddresses</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipGetter</span><span class=p>.</span><span class=nf>BindedIPs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error listing addresses binded to dummy interface, error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 检查是否是nodeport类型
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>hasNodePort</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>svc</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>serviceMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>svcInfo</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>svc</span><span class=p>.(</span><span class=o>*</span><span class=nx>serviceInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>NodePort</span><span class=p>()</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>hasNodePort</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Both nodeAddresses and nodeIPs can be reused for all nodePort services
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// and only need to be computed if we have at least one nodePort service.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=c1>// List of node addresses to listen on if a nodePort is set.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>nodeAddresses</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>		<span class=c1>// List of node IP addresses to be used as IPVS services if nodePort is set.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>nodeIPs</span> <span class=p>[]</span><span class=nx>net</span><span class=p>.</span><span class=nx>IP</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>hasNodePort</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodeAddrSet</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>utilproxy</span><span class=p>.</span><span class=nf>GetNodeAddresses</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>nodePortAddresses</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>networkInterfacer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to get node ip address matching nodeport cidr: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>nodeAddresses</span> <span class=p>=</span> <span class=nx>nodeAddrSet</span><span class=p>.</span><span class=nf>List</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>address</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodeAddresses</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>utilproxy</span><span class=p>.</span><span class=nf>IsZeroCIDR</span><span class=p>(</span><span class=nx>address</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>nodeIPs</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipGetter</span><span class=p>.</span><span class=nf>NodeIPs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to list all node IPs from host, err: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=k>break</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>nodeIPs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>nodeIPs</span><span class=p>,</span> <span class=nx>net</span><span class=p>.</span><span class=nf>ParseIP</span><span class=p>(</span><span class=nx>address</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>接下来是整个构建ipvs规则的关键部分，大概200-300行代码，通过循环 serviceMap 拿到每一个 service 的信息，然后在通过 循环 endpointsMap[svcName] 得到每个 service下所属的 endpoint ，然后构建 ipvs 的规则</p><p><a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L1141-L1542 target=_blank rel="noopener nofollow noreferrer">L1141-L1542</a> 这里也包含了 nodeport, clusterIP, ingress等不同的service类型</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=c1>// Build IPVS rules for each service.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>svcName</span><span class=p>,</span> <span class=nx>svc</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>serviceMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>svcInfo</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>svc</span><span class=p>.(</span><span class=o>*</span><span class=nx>serviceInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to cast serviceInfo %q&#34;</span><span class=p>,</span> <span class=nx>svcName</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>isIPv6</span> <span class=o>:=</span> <span class=nx>utilnet</span><span class=p>.</span><span class=nf>IsIPv6</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ClusterIP</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=nx>protocol</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Protocol</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Precompute svcNameString; with many services the many calls
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// to ServicePortName.String() show up in CPU profiles.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>svcNameString</span> <span class=o>:=</span> <span class=nx>svcName</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>        <span class=c1>// 循环endpoint
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// Handle traffic that loops back to the originator with SNAT.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>endpointsMap</span><span class=p>[</span><span class=nx>svcName</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ep</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>e</span><span class=p>.(</span><span class=o>*</span><span class=nx>proxy</span><span class=p>.</span><span class=nx>BaseEndpointInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to cast BaseEndpointInfo %q&#34;</span><span class=p>,</span> <span class=nx>e</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ep</span><span class=p>.</span><span class=nx>IsLocal</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>epIP</span> <span class=o>:=</span> <span class=nx>ep</span><span class=p>.</span><span class=nf>IP</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>epPort</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ep</span><span class=p>.</span><span class=nf>Port</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Error parsing this endpoint has been logged. Skip to next endpoint.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>epIP</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=o>||</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>entry</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>utilipset</span><span class=p>.</span><span class=nx>Entry</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>IP</span><span class=p>:</span>       <span class=nx>epIP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Port</span><span class=p>:</span>     <span class=nx>epPort</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Protocol</span><span class=p>:</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>IP2</span><span class=p>:</span>      <span class=nx>epIP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>SetType</span><span class=p>:</span>  <span class=nx>utilipset</span><span class=p>.</span><span class=nx>HashIPPortIP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>valid</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoopBackIPSet</span><span class=p>].</span><span class=nf>validateEntry</span><span class=p>(</span><span class=nx>entry</span><span class=p>);</span> <span class=p>!</span><span class=nx>valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>EntryInvalidErr</span><span class=p>,</span> <span class=nx>entry</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoopBackIPSet</span><span class=p>].</span><span class=nx>Name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoopBackIPSet</span><span class=p>].</span><span class=nx>activeEntries</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Capture the clusterIP.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// ipset call
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>entry</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>utilipset</span><span class=p>.</span><span class=nx>Entry</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>IP</span><span class=p>:</span>       <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ClusterIP</span><span class=p>().</span><span class=nf>String</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Port</span><span class=p>:</span>     <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Protocol</span><span class=p>:</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>SetType</span><span class=p>:</span>  <span class=nx>utilipset</span><span class=p>.</span><span class=nx>HashIPPort</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// add service Cluster IP:Port to kubeServiceAccess ip set for the purpose of solving hairpin.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// proxier.kubeServiceAccessSet.activeEntries.Insert(entry.String())
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>valid</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeClusterIPSet</span><span class=p>].</span><span class=nf>validateEntry</span><span class=p>(</span><span class=nx>entry</span><span class=p>);</span> <span class=p>!</span><span class=nx>valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>EntryInvalidErr</span><span class=p>,</span> <span class=nx>entry</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeClusterIPSet</span><span class=p>].</span><span class=nx>Name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeClusterIPSet</span><span class=p>].</span><span class=nx>activeEntries</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=c1>// ipvs call
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>serv</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>utilipvs</span><span class=p>.</span><span class=nx>VirtualServer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Address</span><span class=p>:</span>   <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ClusterIP</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Port</span><span class=p>:</span>      <span class=nb>uint16</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Protocol</span><span class=p>:</span>  <span class=nb>string</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Protocol</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Scheduler</span><span class=p>:</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipvsScheduler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Set session affinity flag and timeout for IPVS service
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>SessionAffinityType</span><span class=p>()</span> <span class=o>==</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ServiceAffinityClientIP</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>serv</span><span class=p>.</span><span class=nx>Flags</span> <span class=o>|=</span> <span class=nx>utilipvs</span><span class=p>.</span><span class=nx>FlagPersistent</span>
</span></span><span class=line><span class=cl>			<span class=nx>serv</span><span class=p>.</span><span class=nx>Timeout</span> <span class=p>=</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>StickyMaxAgeSeconds</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// We need to bind ClusterIP to dummy interface, so set `bindAddr` parameter to `true` in syncService()
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nf>syncService</span><span class=p>(</span><span class=nx>svcNameString</span><span class=p>,</span> <span class=nx>serv</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>bindedAddresses</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>activeIPVSServices</span><span class=p>[</span><span class=nx>serv</span><span class=p>.</span><span class=nf>String</span><span class=p>()]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=nx>activeBindAddrs</span><span class=p>[</span><span class=nx>serv</span><span class=p>.</span><span class=nx>Address</span><span class=p>.</span><span class=nf>String</span><span class=p>()]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=c1>// ExternalTrafficPolicy only works for NodePort and external LB traffic, does not affect ClusterIP
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// So we still need clusterIP rules in onlyNodeLocalEndpoints mode.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nf>syncEndpoint</span><span class=p>(</span><span class=nx>svcName</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>serv</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to sync endpoint for service: %v, err: %v&#34;</span><span class=p>,</span> <span class=nx>serv</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to sync service: %v, err: %v&#34;</span><span class=p>,</span> <span class=nx>serv</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Capture externalIPs.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>externalIP</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>ExternalIPStrings</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// If the &#34;external&#34; IP happens to be an IP that is local to this
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// machine, hold the local port open so no other process can open it
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// (because the socket might open but it would never work).
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Protocol</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ProtocolSCTP</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>localAddrSet</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>net</span><span class=p>.</span><span class=nf>ParseIP</span><span class=p>(</span><span class=nx>externalIP</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// We do not start listening on SCTP ports, according to our agreement in the SCTP support KEP
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>lp</span> <span class=o>:=</span> <span class=nx>utilproxy</span><span class=p>.</span><span class=nx>LocalPort</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Description</span><span class=p>:</span> <span class=s>&#34;externalIP for &#34;</span> <span class=o>+</span> <span class=nx>svcNameString</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>IP</span><span class=p>:</span>          <span class=nx>externalIP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Port</span><span class=p>:</span>        <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Protocol</span><span class=p>:</span>    <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>portsMap</span><span class=p>[</span><span class=nx>lp</span><span class=p>]</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Port %s was open before and is still needed&#34;</span><span class=p>,</span> <span class=nx>lp</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>					<span class=nx>replacementPortsMap</span><span class=p>[</span><span class=nx>lp</span><span class=p>]</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>portsMap</span><span class=p>[</span><span class=nx>lp</span><span class=p>]</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>socket</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>portMapper</span><span class=p>.</span><span class=nf>OpenLocalPort</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>lp</span><span class=p>,</span> <span class=nx>isIPv6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>msg</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;can&#39;t open %s, skipping this externalIP: %v&#34;</span><span class=p>,</span> <span class=nx>lp</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>						<span class=nx>proxier</span><span class=p>.</span><span class=nx>recorder</span><span class=p>.</span><span class=nf>Eventf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>							<span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>ObjectReference</span><span class=p>{</span>
</span></span><span class=line><span class=cl>								<span class=nx>Kind</span><span class=p>:</span>      <span class=s>&#34;Node&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>								<span class=nx>Name</span><span class=p>:</span>      <span class=nx>proxier</span><span class=p>.</span><span class=nx>hostname</span><span class=p>,</span>
</span></span><span class=line><span class=cl>								<span class=nx>UID</span><span class=p>:</span>       <span class=nx>types</span><span class=p>.</span><span class=nf>UID</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>hostname</span><span class=p>),</span>
</span></span><span class=line><span class=cl>								<span class=nx>Namespace</span><span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=p>},</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventTypeWarning</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						<span class=nx>klog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						<span class=k>continue</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>replacementPortsMap</span><span class=p>[</span><span class=nx>lp</span><span class=p>]</span> <span class=p>=</span> <span class=nx>socket</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=c1>// We&#39;re holding the port, so it&#39;s OK to install IPVS rules.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>			<span class=c1>// ipset call
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>entry</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>utilipset</span><span class=p>.</span><span class=nx>Entry</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>IP</span><span class=p>:</span>       <span class=nx>externalIP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Port</span><span class=p>:</span>     <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Protocol</span><span class=p>:</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>SetType</span><span class=p>:</span>  <span class=nx>utilipset</span><span class=p>.</span><span class=nx>HashIPPort</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>ExternalPolicyForExternalIP</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>OnlyNodeLocalEndpoints</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>valid</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeExternalIPLocalSet</span><span class=p>].</span><span class=nf>validateEntry</span><span class=p>(</span><span class=nx>entry</span><span class=p>);</span> <span class=p>!</span><span class=nx>valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>EntryInvalidErr</span><span class=p>,</span> <span class=nx>entry</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeExternalIPLocalSet</span><span class=p>].</span><span class=nx>Name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=k>continue</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeExternalIPLocalSet</span><span class=p>].</span><span class=nx>activeEntries</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// We have to SNAT packets to external IPs.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=nx>valid</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeExternalIPSet</span><span class=p>].</span><span class=nf>validateEntry</span><span class=p>(</span><span class=nx>entry</span><span class=p>);</span> <span class=p>!</span><span class=nx>valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>EntryInvalidErr</span><span class=p>,</span> <span class=nx>entry</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeExternalIPSet</span><span class=p>].</span><span class=nx>Name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=k>continue</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeExternalIPSet</span><span class=p>].</span><span class=nx>activeEntries</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// ipvs call
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>serv</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>utilipvs</span><span class=p>.</span><span class=nx>VirtualServer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Address</span><span class=p>:</span>   <span class=nx>net</span><span class=p>.</span><span class=nf>ParseIP</span><span class=p>(</span><span class=nx>externalIP</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Port</span><span class=p>:</span>      <span class=nb>uint16</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Protocol</span><span class=p>:</span>  <span class=nb>string</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Protocol</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Scheduler</span><span class=p>:</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipvsScheduler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>SessionAffinityType</span><span class=p>()</span> <span class=o>==</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ServiceAffinityClientIP</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>serv</span><span class=p>.</span><span class=nx>Flags</span> <span class=o>|=</span> <span class=nx>utilipvs</span><span class=p>.</span><span class=nx>FlagPersistent</span>
</span></span><span class=line><span class=cl>				<span class=nx>serv</span><span class=p>.</span><span class=nx>Timeout</span> <span class=p>=</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>StickyMaxAgeSeconds</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nf>syncService</span><span class=p>(</span><span class=nx>svcNameString</span><span class=p>,</span> <span class=nx>serv</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>bindedAddresses</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>activeIPVSServices</span><span class=p>[</span><span class=nx>serv</span><span class=p>.</span><span class=nf>String</span><span class=p>()]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>				<span class=nx>activeBindAddrs</span><span class=p>[</span><span class=nx>serv</span><span class=p>.</span><span class=nx>Address</span><span class=p>.</span><span class=nf>String</span><span class=p>()]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=nx>onlyNodeLocalEndpoints</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>ExternalPolicyForExternalIP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>onlyNodeLocalEndpoints</span> <span class=p>=</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>OnlyNodeLocalEndpoints</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nf>syncEndpoint</span><span class=p>(</span><span class=nx>svcName</span><span class=p>,</span> <span class=nx>onlyNodeLocalEndpoints</span><span class=p>,</span> <span class=nx>serv</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to sync endpoint for service: %v, err: %v&#34;</span><span class=p>,</span> <span class=nx>serv</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to sync service: %v, err: %v&#34;</span><span class=p>,</span> <span class=nx>serv</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Capture load-balancer ingress.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ingress</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>LoadBalancerIPStrings</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>ingress</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// ipset call
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>entry</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>utilipset</span><span class=p>.</span><span class=nx>Entry</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>IP</span><span class=p>:</span>       <span class=nx>ingress</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Port</span><span class=p>:</span>     <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Protocol</span><span class=p>:</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>SetType</span><span class=p>:</span>  <span class=nx>utilipset</span><span class=p>.</span><span class=nx>HashIPPort</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=c1>// add service load balancer ingressIP:Port to kubeServiceAccess ip set for the purpose of solving hairpin.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// proxier.kubeServiceAccessSet.activeEntries.Insert(entry.String())
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// If we are proxying globally, we need to masquerade in case we cross nodes.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// If we are proxying only locally, we can retain the source IP.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=nx>valid</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadBalancerSet</span><span class=p>].</span><span class=nf>validateEntry</span><span class=p>(</span><span class=nx>entry</span><span class=p>);</span> <span class=p>!</span><span class=nx>valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>EntryInvalidErr</span><span class=p>,</span> <span class=nx>entry</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadBalancerSet</span><span class=p>].</span><span class=nx>Name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=k>continue</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadBalancerSet</span><span class=p>].</span><span class=nx>activeEntries</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>				<span class=c1>// insert loadbalancer entry to lbIngressLocalSet if service externaltrafficpolicy=local
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>OnlyNodeLocalEndpoints</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>valid</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadBalancerLocalSet</span><span class=p>].</span><span class=nf>validateEntry</span><span class=p>(</span><span class=nx>entry</span><span class=p>);</span> <span class=p>!</span><span class=nx>valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>EntryInvalidErr</span><span class=p>,</span> <span class=nx>entry</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadBalancerLocalSet</span><span class=p>].</span><span class=nx>Name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>						<span class=k>continue</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadBalancerLocalSet</span><span class=p>].</span><span class=nx>activeEntries</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>LoadBalancerSourceRanges</span><span class=p>())</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// The service firewall rules are created based on ServiceSpec.loadBalancerSourceRanges field.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=c1>// This currently works for loadbalancers that preserves source ips.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=c1>// For loadbalancers which direct traffic to service NodePort, the firewall rules will not apply.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=k>if</span> <span class=nx>valid</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadbalancerFWSet</span><span class=p>].</span><span class=nf>validateEntry</span><span class=p>(</span><span class=nx>entry</span><span class=p>);</span> <span class=p>!</span><span class=nx>valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>EntryInvalidErr</span><span class=p>,</span> <span class=nx>entry</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadbalancerFWSet</span><span class=p>].</span><span class=nx>Name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>						<span class=k>continue</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadbalancerFWSet</span><span class=p>].</span><span class=nx>activeEntries</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>					<span class=nx>allowFromNode</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>					<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>src</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>LoadBalancerSourceRanges</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=c1>// ipset call
</span></span></span><span class=line><span class=cl><span class=c1></span>						<span class=nx>entry</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>utilipset</span><span class=p>.</span><span class=nx>Entry</span><span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>IP</span><span class=p>:</span>       <span class=nx>ingress</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=nx>Port</span><span class=p>:</span>     <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>							<span class=nx>Protocol</span><span class=p>:</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=nx>Net</span><span class=p>:</span>      <span class=nx>src</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=nx>SetType</span><span class=p>:</span>  <span class=nx>utilipset</span><span class=p>.</span><span class=nx>HashIPPortNet</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>						<span class=c1>// enumerate all white list source cidr
</span></span></span><span class=line><span class=cl><span class=c1></span>						<span class=k>if</span> <span class=nx>valid</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadBalancerSourceCIDRSet</span><span class=p>].</span><span class=nf>validateEntry</span><span class=p>(</span><span class=nx>entry</span><span class=p>);</span> <span class=p>!</span><span class=nx>valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>EntryInvalidErr</span><span class=p>,</span> <span class=nx>entry</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadBalancerSourceCIDRSet</span><span class=p>].</span><span class=nx>Name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>							<span class=k>continue</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>						<span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadBalancerSourceCIDRSet</span><span class=p>].</span><span class=nx>activeEntries</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>						<span class=c1>// ignore error because it has been validated
</span></span></span><span class=line><span class=cl><span class=c1></span>						<span class=nx>_</span><span class=p>,</span> <span class=nx>cidr</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>ParseCIDR</span><span class=p>(</span><span class=nx>src</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=nx>cidr</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>nodeIP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>allowFromNode</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=c1>// generally, ip route rule was added to intercept request to loadbalancer vip from the
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=c1>// loadbalancer&#39;s backend hosts. In this case, request will not hit the loadbalancer but loop back directly.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=c1>// Need to add the following rule to allow request on host.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=k>if</span> <span class=nx>allowFromNode</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>entry</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>utilipset</span><span class=p>.</span><span class=nx>Entry</span><span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>IP</span><span class=p>:</span>       <span class=nx>ingress</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=nx>Port</span><span class=p>:</span>     <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>							<span class=nx>Protocol</span><span class=p>:</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=nx>IP2</span><span class=p>:</span>      <span class=nx>ingress</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=nx>SetType</span><span class=p>:</span>  <span class=nx>utilipset</span><span class=p>.</span><span class=nx>HashIPPortIP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>						<span class=c1>// enumerate all white list source ip
</span></span></span><span class=line><span class=cl><span class=c1></span>						<span class=k>if</span> <span class=nx>valid</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadBalancerSourceIPSet</span><span class=p>].</span><span class=nf>validateEntry</span><span class=p>(</span><span class=nx>entry</span><span class=p>);</span> <span class=p>!</span><span class=nx>valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>EntryInvalidErr</span><span class=p>,</span> <span class=nx>entry</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadBalancerSourceIPSet</span><span class=p>].</span><span class=nx>Name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>							<span class=k>continue</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>						<span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeLoadBalancerSourceIPSet</span><span class=p>].</span><span class=nx>activeEntries</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=c1>// ipvs call
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>serv</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>utilipvs</span><span class=p>.</span><span class=nx>VirtualServer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Address</span><span class=p>:</span>   <span class=nx>net</span><span class=p>.</span><span class=nf>ParseIP</span><span class=p>(</span><span class=nx>ingress</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Port</span><span class=p>:</span>      <span class=nb>uint16</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Port</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Protocol</span><span class=p>:</span>  <span class=nb>string</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Protocol</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Scheduler</span><span class=p>:</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipvsScheduler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>SessionAffinityType</span><span class=p>()</span> <span class=o>==</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ServiceAffinityClientIP</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>serv</span><span class=p>.</span><span class=nx>Flags</span> <span class=o>|=</span> <span class=nx>utilipvs</span><span class=p>.</span><span class=nx>FlagPersistent</span>
</span></span><span class=line><span class=cl>					<span class=nx>serv</span><span class=p>.</span><span class=nx>Timeout</span> <span class=p>=</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>StickyMaxAgeSeconds</span><span class=p>())</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nf>syncService</span><span class=p>(</span><span class=nx>svcNameString</span><span class=p>,</span> <span class=nx>serv</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>bindedAddresses</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>activeIPVSServices</span><span class=p>[</span><span class=nx>serv</span><span class=p>.</span><span class=nf>String</span><span class=p>()]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>					<span class=nx>activeBindAddrs</span><span class=p>[</span><span class=nx>serv</span><span class=p>.</span><span class=nx>Address</span><span class=p>.</span><span class=nf>String</span><span class=p>()]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nf>syncEndpoint</span><span class=p>(</span><span class=nx>svcName</span><span class=p>,</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>OnlyNodeLocalEndpoints</span><span class=p>(),</span> <span class=nx>serv</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to sync endpoint for service: %v, err: %v&#34;</span><span class=p>,</span> <span class=nx>serv</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to sync service: %v, err: %v&#34;</span><span class=p>,</span> <span class=nx>serv</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>NodePort</span><span class=p>()</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodeAddresses</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodeIPs</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Skip nodePort configuration since an error occurred when
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// computing nodeAddresses or nodeIPs.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=nx>lps</span> <span class=p>[]</span><span class=nx>utilproxy</span><span class=p>.</span><span class=nx>LocalPort</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>address</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodeAddresses</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>lp</span> <span class=o>:=</span> <span class=nx>utilproxy</span><span class=p>.</span><span class=nx>LocalPort</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Description</span><span class=p>:</span> <span class=s>&#34;nodePort for &#34;</span> <span class=o>+</span> <span class=nx>svcNameString</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>IP</span><span class=p>:</span>          <span class=nx>address</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Port</span><span class=p>:</span>        <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>NodePort</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Protocol</span><span class=p>:</span>    <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>utilproxy</span><span class=p>.</span><span class=nf>IsZeroCIDR</span><span class=p>(</span><span class=nx>address</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// Empty IP address means all
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>lp</span><span class=p>.</span><span class=nx>IP</span> <span class=p>=</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>					<span class=nx>lps</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>lps</span><span class=p>,</span> <span class=nx>lp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=c1>// If we encounter a zero CIDR, then there is no point in processing the rest of the addresses.
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=k>break</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>lps</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>lps</span><span class=p>,</span> <span class=nx>lp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// For ports on node IPs, open the actual port and hold it.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>lp</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>lps</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>portsMap</span><span class=p>[</span><span class=nx>lp</span><span class=p>]</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Port %s was open before and is still needed&#34;</span><span class=p>,</span> <span class=nx>lp</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>					<span class=nx>replacementPortsMap</span><span class=p>[</span><span class=nx>lp</span><span class=p>]</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>portsMap</span><span class=p>[</span><span class=nx>lp</span><span class=p>]</span>
</span></span><span class=line><span class=cl>					<span class=c1>// We do not start listening on SCTP ports, according to our agreement in the
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=c1>// SCTP support KEP
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Protocol</span><span class=p>()</span> <span class=o>!=</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ProtocolSCTP</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>socket</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>portMapper</span><span class=p>.</span><span class=nf>OpenLocalPort</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>lp</span><span class=p>,</span> <span class=nx>isIPv6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;can&#39;t open %s, skipping this nodePort: %v&#34;</span><span class=p>,</span> <span class=nx>lp</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						<span class=k>continue</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>lp</span><span class=p>.</span><span class=nx>Protocol</span> <span class=o>==</span> <span class=s>&#34;udp&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>conntrack</span><span class=p>.</span><span class=nf>ClearEntriesForPort</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>exec</span><span class=p>,</span> <span class=nx>lp</span><span class=p>.</span><span class=nx>Port</span><span class=p>,</span> <span class=nx>isIPv6</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ProtocolUDP</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>replacementPortsMap</span><span class=p>[</span><span class=nx>lp</span><span class=p>]</span> <span class=p>=</span> <span class=nx>socket</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=c1>// We&#39;re holding the port, so it&#39;s OK to install ipvs rules.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// Nodeports need SNAT, unless they&#39;re local.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// ipset call
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=nx>nodePortSet</span> <span class=o>*</span><span class=nx>IPSet</span>
</span></span><span class=line><span class=cl>				<span class=nx>entries</span>     <span class=p>[]</span><span class=o>*</span><span class=nx>utilipset</span><span class=p>.</span><span class=nx>Entry</span>
</span></span><span class=line><span class=cl>			<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>switch</span> <span class=nx>protocol</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s>&#34;tcp&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>nodePortSet</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeNodePortSetTCP</span><span class=p>]</span>
</span></span><span class=line><span class=cl>				<span class=nx>entries</span> <span class=p>=</span> <span class=p>[]</span><span class=o>*</span><span class=nx>utilipset</span><span class=p>.</span><span class=nx>Entry</span><span class=p>{{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// No need to provide ip info
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>Port</span><span class=p>:</span>     <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>NodePort</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Protocol</span><span class=p>:</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>SetType</span><span class=p>:</span>  <span class=nx>utilipset</span><span class=p>.</span><span class=nx>BitmapPort</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>}}</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s>&#34;udp&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>nodePortSet</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeNodePortSetUDP</span><span class=p>]</span>
</span></span><span class=line><span class=cl>				<span class=nx>entries</span> <span class=p>=</span> <span class=p>[]</span><span class=o>*</span><span class=nx>utilipset</span><span class=p>.</span><span class=nx>Entry</span><span class=p>{{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// No need to provide ip info
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>Port</span><span class=p>:</span>     <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>NodePort</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Protocol</span><span class=p>:</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>SetType</span><span class=p>:</span>  <span class=nx>utilipset</span><span class=p>.</span><span class=nx>BitmapPort</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>}}</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=s>&#34;sctp&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>nodePortSet</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeNodePortSetSCTP</span><span class=p>]</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Since hash ip:port is used for SCTP, all the nodeIPs to be used in the SCTP ipset entries.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>entries</span> <span class=p>=</span> <span class=p>[]</span><span class=o>*</span><span class=nx>utilipset</span><span class=p>.</span><span class=nx>Entry</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>				<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>nodeIP</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodeIPs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>entries</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>entries</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>utilipset</span><span class=p>.</span><span class=nx>Entry</span><span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>IP</span><span class=p>:</span>       <span class=nx>nodeIP</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>						<span class=nx>Port</span><span class=p>:</span>     <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>NodePort</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>						<span class=nx>Protocol</span><span class=p>:</span> <span class=nx>protocol</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=nx>SetType</span><span class=p>:</span>  <span class=nx>utilipset</span><span class=p>.</span><span class=nx>HashIPPort</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=p>})</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=c1>// It should never hit
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Unsupported protocol type: %s&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>nodePortSet</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>entryInvalidErr</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>				<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>entry</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>entries</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>valid</span> <span class=o>:=</span> <span class=nx>nodePortSet</span><span class=p>.</span><span class=nf>validateEntry</span><span class=p>(</span><span class=nx>entry</span><span class=p>);</span> <span class=p>!</span><span class=nx>valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>EntryInvalidErr</span><span class=p>,</span> <span class=nx>entry</span><span class=p>,</span> <span class=nx>nodePortSet</span><span class=p>.</span><span class=nx>Name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>						<span class=nx>entryInvalidErr</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>						<span class=k>break</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>nodePortSet</span><span class=p>.</span><span class=nx>activeEntries</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>entryInvalidErr</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>continue</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// Add externaltrafficpolicy=local type nodeport entry
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>OnlyNodeLocalEndpoints</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=kd>var</span> <span class=nx>nodePortLocalSet</span> <span class=o>*</span><span class=nx>IPSet</span>
</span></span><span class=line><span class=cl>				<span class=k>switch</span> <span class=nx>protocol</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=s>&#34;tcp&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=nx>nodePortLocalSet</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeNodePortLocalSetTCP</span><span class=p>]</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=s>&#34;udp&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=nx>nodePortLocalSet</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeNodePortLocalSetUDP</span><span class=p>]</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=s>&#34;sctp&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=nx>nodePortLocalSet</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipsetList</span><span class=p>[</span><span class=nx>kubeNodePortLocalSetSCTP</span><span class=p>]</span>
</span></span><span class=line><span class=cl>				<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=c1>// It should never hit
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Unsupported protocol type: %s&#34;</span><span class=p>,</span> <span class=nx>protocol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>nodePortLocalSet</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>entryInvalidErr</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>					<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>entry</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>entries</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=nx>valid</span> <span class=o>:=</span> <span class=nx>nodePortLocalSet</span><span class=p>.</span><span class=nf>validateEntry</span><span class=p>(</span><span class=nx>entry</span><span class=p>);</span> <span class=p>!</span><span class=nx>valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=nx>EntryInvalidErr</span><span class=p>,</span> <span class=nx>entry</span><span class=p>,</span> <span class=nx>nodePortLocalSet</span><span class=p>.</span><span class=nx>Name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>							<span class=nx>entryInvalidErr</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>							<span class=k>break</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>						<span class=nx>nodePortLocalSet</span><span class=p>.</span><span class=nx>activeEntries</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>entry</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>entryInvalidErr</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=k>continue</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// Build ipvs kernel routes for each node ip address
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>nodeIP</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodeIPs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// ipvs call
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>serv</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>utilipvs</span><span class=p>.</span><span class=nx>VirtualServer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Address</span><span class=p>:</span>   <span class=nx>nodeIP</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Port</span><span class=p>:</span>      <span class=nb>uint16</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>NodePort</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Protocol</span><span class=p>:</span>  <span class=nb>string</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>Protocol</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Scheduler</span><span class=p>:</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipvsScheduler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>SessionAffinityType</span><span class=p>()</span> <span class=o>==</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ServiceAffinityClientIP</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>serv</span><span class=p>.</span><span class=nx>Flags</span> <span class=o>|=</span> <span class=nx>utilipvs</span><span class=p>.</span><span class=nx>FlagPersistent</span>
</span></span><span class=line><span class=cl>					<span class=nx>serv</span><span class=p>.</span><span class=nx>Timeout</span> <span class=p>=</span> <span class=nb>uint32</span><span class=p>(</span><span class=nx>svcInfo</span><span class=p>.</span><span class=nf>StickyMaxAgeSeconds</span><span class=p>())</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=c1>// There is no need to bind Node IP to dummy interface, so set parameter `bindAddr` to `false`.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nf>syncService</span><span class=p>(</span><span class=nx>svcNameString</span><span class=p>,</span> <span class=nx>serv</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>bindedAddresses</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>activeIPVSServices</span><span class=p>[</span><span class=nx>serv</span><span class=p>.</span><span class=nf>String</span><span class=p>()]</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nf>syncEndpoint</span><span class=p>(</span><span class=nx>svcName</span><span class=p>,</span> <span class=nx>svcInfo</span><span class=p>.</span><span class=nf>OnlyNodeLocalEndpoints</span><span class=p>(),</span> <span class=nx>serv</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to sync endpoint for service: %v, err: %v&#34;</span><span class=p>,</span> <span class=nx>serv</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to sync service: %v, err: %v&#34;</span><span class=p>,</span> <span class=nx>serv</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>其中有两个非常重要的函数 <a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L1215-L1229 target=_blank rel="noopener nofollow noreferrer">syncService()</a> 于 <a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L1215-L1229 target=_blank rel="noopener nofollow noreferrer">syncEndpoint()</a> 这两个定义了同步的过程</p><p><a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L1921-L1959 target=_blank rel="noopener nofollow noreferrer">syncService()</a> 函数表示了增加或删除一个service，如果存在则修改，如果存在则添加</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>proxier</span> <span class=o>*</span><span class=nx>Proxier</span><span class=p>)</span> <span class=nf>syncService</span><span class=p>(</span><span class=nx>svcName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>vs</span> <span class=o>*</span><span class=nx>utilipvs</span><span class=p>.</span><span class=nx>VirtualServer</span><span class=p>,</span> <span class=nx>bindAddr</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>bindedAddresses</span> <span class=nx>sets</span><span class=p>.</span><span class=nx>String</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>appliedVirtualServer</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipvs</span><span class=p>.</span><span class=nf>GetVirtualServer</span><span class=p>(</span><span class=nx>vs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>appliedVirtualServer</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=p>!</span><span class=nx>appliedVirtualServer</span><span class=p>.</span><span class=nf>Equal</span><span class=p>(</span><span class=nx>vs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>appliedVirtualServer</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// IPVS service is not found, create a new service
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Adding new service %q %s:%d/%s&#34;</span><span class=p>,</span> <span class=nx>svcName</span><span class=p>,</span> <span class=nx>vs</span><span class=p>.</span><span class=nx>Address</span><span class=p>,</span> <span class=nx>vs</span><span class=p>.</span><span class=nx>Port</span><span class=p>,</span> <span class=nx>vs</span><span class=p>.</span><span class=nx>Protocol</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipvs</span><span class=p>.</span><span class=nf>AddVirtualServer</span><span class=p>(</span><span class=nx>vs</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to add IPVS service %q: %v&#34;</span><span class=p>,</span> <span class=nx>svcName</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// IPVS service was changed, update the existing one
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// During updates, service VIP will not go down
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;IPVS service %s was changed&#34;</span><span class=p>,</span> <span class=nx>svcName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipvs</span><span class=p>.</span><span class=nf>UpdateVirtualServer</span><span class=p>(</span><span class=nx>vs</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to update IPVS service, err:%v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// bind service address to dummy interface
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>bindAddr</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// always attempt to bind if bindedAddresses is nil,
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// otherwise check if it&#39;s already binded and return early
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>bindedAddresses</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>bindedAddresses</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>vs</span><span class=p>.</span><span class=nx>Address</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Bind addr %s&#34;</span><span class=p>,</span> <span class=nx>vs</span><span class=p>.</span><span class=nx>Address</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>netlinkHandle</span><span class=p>.</span><span class=nf>EnsureAddressBind</span><span class=p>(</span><span class=nx>vs</span><span class=p>.</span><span class=nx>Address</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span> <span class=nx>DefaultDummyDevice</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to bind service address to dummy device %q: %v&#34;</span><span class=p>,</span> <span class=nx>svcName</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>同理 <a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L1961-L2090 target=_blank rel="noopener nofollow noreferrer">syncEndpoint()</a> 也是相同的操作</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>proxier</span> <span class=o>*</span><span class=nx>Proxier</span><span class=p>)</span> <span class=nf>syncEndpoint</span><span class=p>(</span><span class=nx>svcPortName</span> <span class=nx>proxy</span><span class=p>.</span><span class=nx>ServicePortName</span><span class=p>,</span> <span class=nx>onlyNodeLocalEndpoints</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>vs</span> <span class=o>*</span><span class=nx>utilipvs</span><span class=p>.</span><span class=nx>VirtualServer</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>appliedVirtualServer</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipvs</span><span class=p>.</span><span class=nf>GetVirtualServer</span><span class=p>(</span><span class=nx>vs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>appliedVirtualServer</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to get IPVS service, error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// curEndpoints represents IPVS destinations listed from current system.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>curEndpoints</span> <span class=o>:=</span> <span class=nx>sets</span><span class=p>.</span><span class=nf>NewString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// newEndpoints represents Endpoints watched from API Server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>newEndpoints</span> <span class=o>:=</span> <span class=nx>sets</span><span class=p>.</span><span class=nf>NewString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>curDests</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipvs</span><span class=p>.</span><span class=nf>GetRealServers</span><span class=p>(</span><span class=nx>appliedVirtualServer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to list IPVS destinations, error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>des</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>curDests</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>curEndpoints</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>des</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>endpoints</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>endpointsMap</span><span class=p>[</span><span class=nx>svcPortName</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Service Topology will not be enabled in the following cases:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 1. externalTrafficPolicy=Local (mutually exclusive with service topology).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 2. ServiceTopology is not enabled.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 3. EndpointSlice is not enabled (service topology depends on endpoint slice
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// to get topology information).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>onlyNodeLocalEndpoints</span> <span class=o>&amp;&amp;</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>ServiceTopology</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>utilfeature</span><span class=p>.</span><span class=nx>DefaultFeatureGate</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>(</span><span class=nx>features</span><span class=p>.</span><span class=nx>EndpointSliceProxying</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>endpoints</span> <span class=p>=</span> <span class=nx>proxy</span><span class=p>.</span><span class=nf>FilterTopologyEndpoint</span><span class=p>(</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>nodeLabels</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>serviceMap</span><span class=p>[</span><span class=nx>svcPortName</span><span class=p>].</span><span class=nf>TopologyKeys</span><span class=p>(),</span> <span class=nx>endpoints</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>epInfo</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>endpoints</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>onlyNodeLocalEndpoints</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>epInfo</span><span class=p>.</span><span class=nf>GetIsLocal</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>newEndpoints</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>epInfo</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Create new endpoints
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ep</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>newEndpoints</span><span class=p>.</span><span class=nf>List</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ip</span><span class=p>,</span> <span class=nx>port</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>SplitHostPort</span><span class=p>(</span><span class=nx>ep</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to parse endpoint: %v, error: %v&#34;</span><span class=p>,</span> <span class=nx>ep</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>portNum</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to parse endpoint port %s, error: %v&#34;</span><span class=p>,</span> <span class=nx>port</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>newDest</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>utilipvs</span><span class=p>.</span><span class=nx>RealServer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Address</span><span class=p>:</span> <span class=nx>net</span><span class=p>.</span><span class=nf>ParseIP</span><span class=p>(</span><span class=nx>ip</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Port</span><span class=p>:</span>    <span class=nb>uint16</span><span class=p>(</span><span class=nx>portNum</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Weight</span><span class=p>:</span>  <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>curEndpoints</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>ep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// check if newEndpoint is in gracefulDelete list, if true, delete this ep immediately
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>uniqueRS</span> <span class=o>:=</span> <span class=nf>GetUniqueRSName</span><span class=p>(</span><span class=nx>vs</span><span class=p>,</span> <span class=nx>newDest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>gracefuldeleteManager</span><span class=p>.</span><span class=nf>InTerminationList</span><span class=p>(</span><span class=nx>uniqueRS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;new ep %q is in graceful delete list&#34;</span><span class=p>,</span> <span class=nx>uniqueRS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>gracefuldeleteManager</span><span class=p>.</span><span class=nf>MoveRSOutofGracefulDeleteList</span><span class=p>(</span><span class=nx>uniqueRS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to delete endpoint: %v in gracefulDeleteQueue, error: %v&#34;</span><span class=p>,</span> <span class=nx>ep</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>ipvs</span><span class=p>.</span><span class=nf>AddRealServer</span><span class=p>(</span><span class=nx>appliedVirtualServer</span><span class=p>,</span> <span class=nx>newDest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to add destination: %v, error: %v&#34;</span><span class=p>,</span> <span class=nx>newDest</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Delete old endpoints
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ep</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>curEndpoints</span><span class=p>.</span><span class=nf>Difference</span><span class=p>(</span><span class=nx>newEndpoints</span><span class=p>).</span><span class=nf>UnsortedList</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// if curEndpoint is in gracefulDelete, skip
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>uniqueRS</span> <span class=o>:=</span> <span class=nx>vs</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span> <span class=o>+</span> <span class=s>&#34;/&#34;</span> <span class=o>+</span> <span class=nx>ep</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>gracefuldeleteManager</span><span class=p>.</span><span class=nf>InTerminationList</span><span class=p>(</span><span class=nx>uniqueRS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>ip</span><span class=p>,</span> <span class=nx>port</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>SplitHostPort</span><span class=p>(</span><span class=nx>ep</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to parse endpoint: %v, error: %v&#34;</span><span class=p>,</span> <span class=nx>ep</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>portNum</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to parse endpoint port %s, error: %v&#34;</span><span class=p>,</span> <span class=nx>port</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>delDest</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>utilipvs</span><span class=p>.</span><span class=nx>RealServer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Address</span><span class=p>:</span> <span class=nx>net</span><span class=p>.</span><span class=nf>ParseIP</span><span class=p>(</span><span class=nx>ip</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Port</span><span class=p>:</span>    <span class=nb>uint16</span><span class=p>(</span><span class=nx>portNum</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Using graceful delete to delete: %v&#34;</span><span class=p>,</span> <span class=nx>uniqueRS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=p>=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>gracefuldeleteManager</span><span class=p>.</span><span class=nf>GracefulDeleteRS</span><span class=p>(</span><span class=nx>appliedVirtualServer</span><span class=p>,</span> <span class=nx>delDest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to delete destination: %v, error: %v&#34;</span><span class=p>,</span> <span class=nx>uniqueRS</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>接下来就是同步规则的步骤了，<a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L1544-L1621 target=_blank rel="noopener nofollow noreferrer">L1544-L1621</a></p><h3 id=step-3规则的删除>step 3：规则的删除<a hidden class=anchor aria-hidden=true href=#step-3规则的删除>#</a></h3><p>粗略翻到这里可能有一个疑问？没有提到删除，删除时包含在 syncXX() 函数中的</p><p>例如在 <a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L2063-L2088 target=_blank rel="noopener nofollow noreferrer">syncEndpoint()</a> 中会看是否在 终止列表中，如果在跳过，如果不在加入</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nx>curEndpoints</span><span class=p>.</span><span class=nf>Has</span><span class=p>(</span><span class=nx>ep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// check if newEndpoint is in gracefulDelete list, if true, delete this ep immediately
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>uniqueRS</span> <span class=o>:=</span> <span class=nf>GetUniqueRSName</span><span class=p>(</span><span class=nx>vs</span><span class=p>,</span> <span class=nx>newDest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>proxier</span><span class=p>.</span><span class=nx>gracefuldeleteManager</span><span class=p>.</span><span class=nf>InTerminationList</span><span class=p>(</span><span class=nx>uniqueRS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;new ep %q is in graceful delete list&#34;</span><span class=p>,</span> <span class=nx>uniqueRS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>gracefuldeleteManager</span><span class=p>.</span><span class=nf>MoveRSOutofGracefulDeleteList</span><span class=p>(</span><span class=nx>uniqueRS</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to delete endpoint: %v in gracefulDeleteQueue, error: %v&#34;</span><span class=p>,</span> <span class=nx>ep</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而 <a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L275 target=_blank rel="noopener nofollow noreferrer">gracefuldeleteManager</a> 是一个 一直运行的协程，在初始化 proxier 时被 Run()</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Run start a goroutine to try to delete rs in the graceful delete rsList with an interval 1 minute
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>GracefulTerminationManager</span><span class=p>)</span> <span class=nf>Run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>tryDeleteRs</span><span class=p>,</span> <span class=nx>rsCheckDeleteInterval</span><span class=p>,</span> <span class=nx>wait</span><span class=p>.</span><span class=nx>NeverStop</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/e979822c185a14537054f15808a118d7fcce1d6e/pkg/proxy/ipvs/proxier.go#L508 target=_blank rel="noopener nofollow noreferrer">proxier.go</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>proxier</span><span class=p>.</span><span class=nx>syncRunner</span> <span class=p>=</span> <span class=nx>async</span><span class=p>.</span><span class=nf>NewBoundedFrequencyRunner</span><span class=p>(</span><span class=s>&#34;sync-runner&#34;</span><span class=p>,</span> <span class=nx>proxier</span><span class=p>.</span><span class=nx>syncProxyRules</span><span class=p>,</span> <span class=nx>minSyncPeriod</span><span class=p>,</span> <span class=nx>syncPeriod</span><span class=p>,</span> <span class=nx>burstSyncs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>proxier</span><span class=p>.</span><span class=nx>gracefuldeleteManager</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>proxier</span><span class=p>,</span> <span class=kc>nil</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>到这里已经清楚的掌握了 kube-proxy 的架构，接下来的会为扩展kubernetes中service架构，以及手撸一个 kube-proxy做准备；本系列第三部分：<a href=https://cylonchau.github.io/ch3.7-admission-webhook.html target=_blank rel="noopener nofollow noreferrer">如何扩展现有的kube-proxy架构</a></p><p>文中的知识都是个人根据理解整理的，如有不对的地方欢迎指出，感谢各位大佬</p><blockquote><p><strong>Reference</strong></p><p><sup id=5>[1]</sup> <a href=https://kubernetes.io/docs/concepts/services-networking/dual-stack/ target=_blank rel="noopener nofollow noreferrer"><em>dual-stack service</em></a></p></blockquote></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：深入理解Kubernetes service - kube-proxy架构分析</p><p>文章链接：<a href=https://www.oomkill.com/2023/02/ch19-kube-proxy-code/ target=_blank>https://www.oomkill.com/2023/02/ch19-kube-proxy-code/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2023/02/ch17-service-controller/><span>深入理解Kubernetes service - 你真的理解service吗？</span></a></li><li><a href=/2022/11/ch34-auditing/><span>深入理解Kubernetes 4A - Audit源码解析</span></a></li><li><a href=/2022/11/ch32-authorization/><span>深入理解Kubernetes 4A - Authorization源码解析</span></a></li><li><a href=/2022/11/ch31-authentication/><span>深入理解Kubernetes 4A - Authentication源码解析</span></a></li><li><a href=/2022/08/ch22-custom-scheduler/><span>基于Prometheus的Kubernetes网络调度器</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li><li><a href=https://www.oomkill.com/tags/kubernetes-develop/>Kubernetes Develop</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2023/02/ch23-extend-kube-proxy/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>深入理解Kubernetes service - 如何扩展现有的kube-proxy架构？</span>
</a><a class=next href=https://www.oomkill.com/2023/02/ch17-service-controller/><span class=title></span>
<span>深入理解Kubernetes service - 你真的理解service吗？&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/blogs","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch19 kube-proxy code","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>