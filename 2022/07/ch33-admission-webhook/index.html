<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>深入理解Kubernetes 4A - Admission Control源码解析 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="kubernetes,develop,admission controller,admission webhook,4A"><meta name=description content="本文是关于Kubernetes 4A解析的第3章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A
如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大
BACKGROUND admission controllers的特点：
可定制性：准入功能可针对不同的场景进行调整。 可预防性：审计则是为了检测问题，而准入控制器可以预防问题发生 可扩展性：在kubernetes自有的验证机制外，增加了另外的防线，弥补了RBAC仅能对资源提供安全保证。 下图，显示了用户操作资源的流程，可以看出 admission controllers 作用是在通过身份验证资源持久化之前起到拦截作用。在准入控制器的加入会使kubernetes增加了更高级的安全功能。
图：Kubernetes API 请求的请求处理步骤图 Source：https://kubernetes.io/blog/2019/03/21/a-guide-to-kubernetes-admission-controllers/ 这里找到一个大佬博客画的图，通过两张图可以很清晰的了解到admission webhook流程，与官方给出的不一样的地方在于，这里清楚地定位了kubernetes admission webhook 处于准入控制中，RBAC之后，push 之前。
图：Kubernetes API 请求的请求处理步骤图（详细） Source：https://www.armosec.io/blog/kubernetes-admission-controller/ 两种控制器有什么区别？ 根据官方提供的说法是
Mutating controllers may modify related objects to the requests they admit; validating controllers may not
从结构图中也可以看出，validating 是在持久化之前，而 Mutating 是在结构验证前，根据这些特性我们可以使用 Mutating 修改这个资源对象内容（如增加验证的信息），在 validating 中验证是否合法。"><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2022/07/ch33-admission-webhook/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2022/07/ch33-admission-webhook/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-H94HZ5S19Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H94HZ5S19Y")</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="深入理解Kubernetes 4A - Admission Control源码解析"><meta property="og:description" content="本文是关于Kubernetes 4A解析的第3章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A
如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大
BACKGROUND admission controllers的特点：
可定制性：准入功能可针对不同的场景进行调整。 可预防性：审计则是为了检测问题，而准入控制器可以预防问题发生 可扩展性：在kubernetes自有的验证机制外，增加了另外的防线，弥补了RBAC仅能对资源提供安全保证。 下图，显示了用户操作资源的流程，可以看出 admission controllers 作用是在通过身份验证资源持久化之前起到拦截作用。在准入控制器的加入会使kubernetes增加了更高级的安全功能。
图：Kubernetes API 请求的请求处理步骤图 Source：https://kubernetes.io/blog/2019/03/21/a-guide-to-kubernetes-admission-controllers/ 这里找到一个大佬博客画的图，通过两张图可以很清晰的了解到admission webhook流程，与官方给出的不一样的地方在于，这里清楚地定位了kubernetes admission webhook 处于准入控制中，RBAC之后，push 之前。
图：Kubernetes API 请求的请求处理步骤图（详细） Source：https://www.armosec.io/blog/kubernetes-admission-controller/ 两种控制器有什么区别？ 根据官方提供的说法是
Mutating controllers may modify related objects to the requests they admit; validating controllers may not
从结构图中也可以看出，validating 是在持久化之前，而 Mutating 是在结构验证前，根据这些特性我们可以使用 Mutating 修改这个资源对象内容（如增加验证的信息），在 validating 中验证是否合法。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2022/07/ch33-admission-webhook/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-11T00:00:00+00:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入理解Kubernetes 4A - Admission Control源码解析"><meta name=twitter:description content="本文是关于Kubernetes 4A解析的第3章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A
如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大
BACKGROUND admission controllers的特点：
可定制性：准入功能可针对不同的场景进行调整。 可预防性：审计则是为了检测问题，而准入控制器可以预防问题发生 可扩展性：在kubernetes自有的验证机制外，增加了另外的防线，弥补了RBAC仅能对资源提供安全保证。 下图，显示了用户操作资源的流程，可以看出 admission controllers 作用是在通过身份验证资源持久化之前起到拦截作用。在准入控制器的加入会使kubernetes增加了更高级的安全功能。
图：Kubernetes API 请求的请求处理步骤图 Source：https://kubernetes.io/blog/2019/03/21/a-guide-to-kubernetes-admission-controllers/ 这里找到一个大佬博客画的图，通过两张图可以很清晰的了解到admission webhook流程，与官方给出的不一样的地方在于，这里清楚地定位了kubernetes admission webhook 处于准入控制中，RBAC之后，push 之前。
图：Kubernetes API 请求的请求处理步骤图（详细） Source：https://www.armosec.io/blog/kubernetes-admission-controller/ 两种控制器有什么区别？ 根据官方提供的说法是
Mutating controllers may modify related objects to the requests they admit; validating controllers may not
从结构图中也可以看出，validating 是在持久化之前，而 Mutating 是在结构验证前，根据这些特性我们可以使用 Mutating 修改这个资源对象内容（如增加验证的信息），在 validating 中验证是否合法。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"深入理解Kubernetes 4A - Admission Control源码解析","item":"https://www.oomkill.com/2022/07/ch33-admission-webhook/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"深入理解Kubernetes 4A - Admission Control源码解析","name":"深入理解Kubernetes 4A - Admission Control源码解析","description":"本文是关于Kubernetes 4A解析的第3章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A\n如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大\nBACKGROUND admission controllers的特点：\n可定制性：准入功能可针对不同的场景进行调整。 可预防性：审计则是为了检测问题，而准入控制器可以预防问题发生 可扩展性：在kubernetes自有的验证机制外，增加了另外的防线，弥补了RBAC仅能对资源提供安全保证。 下图，显示了用户操作资源的流程，可以看出 admission controllers 作用是在通过身份验证资源持久化之前起到拦截作用。在准入控制器的加入会使kubernetes增加了更高级的安全功能。\n图：Kubernetes API 请求的请求处理步骤图 Source：https://kubernetes.io/blog/2019/03/21/a-guide-to-kubernetes-admission-controllers/ 这里找到一个大佬博客画的图，通过两张图可以很清晰的了解到admission webhook流程，与官方给出的不一样的地方在于，这里清楚地定位了kubernetes admission webhook 处于准入控制中，RBAC之后，push 之前。\n图：Kubernetes API 请求的请求处理步骤图（详细） Source：https://www.armosec.io/blog/kubernetes-admission-controller/ 两种控制器有什么区别？ 根据官方提供的说法是\nMutating controllers may modify related objects to the requests they admit; validating controllers may not\n从结构图中也可以看出，validating 是在持久化之前，而 Mutating 是在结构验证前，根据这些特性我们可以使用 Mutating 修改这个资源对象内容（如增加验证的信息），在 validating 中验证是否合法。","keywords":["kubernetes","develop","admission controller","admission webhook","4A"],"articleBody":" 本文是关于Kubernetes 4A解析的第3章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A\n如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大\nBACKGROUND admission controllers的特点：\n可定制性：准入功能可针对不同的场景进行调整。 可预防性：审计则是为了检测问题，而准入控制器可以预防问题发生 可扩展性：在kubernetes自有的验证机制外，增加了另外的防线，弥补了RBAC仅能对资源提供安全保证。 下图，显示了用户操作资源的流程，可以看出 admission controllers 作用是在通过身份验证资源持久化之前起到拦截作用。在准入控制器的加入会使kubernetes增加了更高级的安全功能。\n图：Kubernetes API 请求的请求处理步骤图 Source：https://kubernetes.io/blog/2019/03/21/a-guide-to-kubernetes-admission-controllers/ 这里找到一个大佬博客画的图，通过两张图可以很清晰的了解到admission webhook流程，与官方给出的不一样的地方在于，这里清楚地定位了kubernetes admission webhook 处于准入控制中，RBAC之后，push 之前。\n图：Kubernetes API 请求的请求处理步骤图（详细） Source：https://www.armosec.io/blog/kubernetes-admission-controller/ 两种控制器有什么区别？ 根据官方提供的说法是\nMutating controllers may modify related objects to the requests they admit; validating controllers may not\n从结构图中也可以看出，validating 是在持久化之前，而 Mutating 是在结构验证前，根据这些特性我们可以使用 Mutating 修改这个资源对象内容（如增加验证的信息），在 validating 中验证是否合法。\ncomposition of admission controllers kubernetes中的 admission controllers 由两部分组成：\n内置在APIServer中的准入控制器 build-in li.st 特殊的控制器；也是内置在APIServer中，但提供一些自定义的功能 MutatingAdmission ValidatingAdmission Mutating 控制器可以修改他们处理的资源对象，Validating 控制器不会。当在任何一个阶段中的任何控制器拒绝这个了请求，则会立即拒绝整个请求，并将错误返回。\nadmission webhook 由于准入控制器是内置在 kube-apiserver 中的，这种情况下就限制了admission controller的可扩展性。在这种背景下，kubernetes提供了一种可扩展的准入控制器 extensible admission controllers，这种行为叫做动态准入控制 Dynamic Admission Control，而提供这个功能的就是 admission webhook 。\nadmission webhook 通俗来讲就是 HTTP 回调，通过定义一个http server，接收准入请求并处理。用户可以通过kubernetes提供的两种类型的 admission webhook，validating admission webhook 和 mutating admission webhook。来完成自定义的准入策略的处理。\nwebhook 就是\n注：从上面的流程图也可以看出，admission webhook 也是有顺序的。首先调用mutating webhook，然后会调用validating webhook。\n如何使用准入控制器 使用条件：kubernetes v1.16 使用 admissionregistration.k8s.io/v1 ；kubernetes v1.9 使用 admissionregistration.k8s.io/v1beta1。\n如何在集群中开启准入控制器? ：查看kube-apiserver 的启动参数 --enable-admission-plugins ；通过该参数来配置要启动的准入控制器，如 --enable-admission-plugins=NodeRestriction 多个准入控制器以 , 分割，顺序无关紧要。 反之使用 --disable-admission-plugins 参数可以关闭相应的准入控制器（Refer to apiserver opts）。\n通过 kubectl 命令可以看到，当前kubernetes集群所支持准入控制器的版本\nbash 1 2 3 $ kubectl api-versions | grep admissionregistration.k8s.io/v1 admissionregistration.k8s.io/v1 admissionregistration.k8s.io/v1beta1 webhook工作原理 通过上面的学习，已经了解到了两种webhook的工作原理如下所示：\nmutating webhook，会在持久化前拦截在 MutatingWebhookConfiguration 中定义的规则匹配的请求。MutatingAdmissionWebhook 通过向 mutating webhook 服务器发送准入请求来执行验证。\nvalidaing webhook，会在持久化前拦截在 ValidatingWebhookConfiguration 中定义的规则匹配的请求。ValidatingAdmissionWebhook 通过将准入请求发送到 validating webhook server来执行验证。\n那么接下来将从源码中看这个在这个工作流程中，究竟做了些什么？\n资源类型 对于 1.9 版本之后，也就是 v1 版本 ，admission 被定义在 k8s.io\\api\\admissionregistration\\v1\\types.go ，大同小异，因为本地只有1.18集群，所以以这个讲解。\n对于 Validating Webhook 来讲实现主要都在webhook中\ngo 1 2 3 4 5 6 7 8 9 10 type ValidatingWebhookConfiguration struct { // 每个api必须包含下列的metadata，这个是kubernetes规范，可以在注释中的url看到相关文档 metav1.TypeMeta `json:\",inline\"` metav1.ObjectMeta `json:\"metadata,omitempty\" protobuf:\"bytes,1,opt,name=metadata\"` // Webhooks在这里被表示为[]ValidatingWebhook，表示我们可以注册多个 // +optional // +patchMergeKey=name // +patchStrategy=merge Webhooks []ValidatingWebhook `json:\"webhooks,omitempty\" patchStrategy:\"merge\" patchMergeKey:\"name\" protobuf:\"bytes,2,rep,name=Webhooks\"` } webhook，则是对这种类型的webhook提供的操作、资源等。对于这部分不做过多的注释了，因为这里本身为kubernetes API资源，官网有很详细的例子与说明。这里更多字段的意思的可以参考官方 doc\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type ValidatingWebhook struct { // admission webhook的名词，Required Name string `json:\"name\" protobuf:\"bytes,1,opt,name=name\"` // ClientConfig 定义了与webhook通讯的方式 Required ClientConfig WebhookClientConfig `json:\"clientConfig\" protobuf:\"bytes,2,opt,name=clientConfig\"` // rule表示了webhook对于哪些资源及子资源的操作进行关注 Rules []RuleWithOperations `json:\"rules,omitempty\" protobuf:\"bytes,3,rep,name=rules\"` // FailurePolicy 对于无法识别的value将如何处理，allowed/Ignore optional FailurePolicy *FailurePolicyType `json:\"failurePolicy,omitempty\" protobuf:\"bytes,4,opt,name=failurePolicy,casttype=FailurePolicyType\"` // matchPolicy 定义了如何使用“rules”列表来匹配传入的请求。 MatchPolicy *MatchPolicyType `json:\"matchPolicy,omitempty\" protobuf:\"bytes,9,opt,name=matchPolicy,casttype=MatchPolicyType\"` NamespaceSelector *metav1.LabelSelector `json:\"namespaceSelector,omitempty\" protobuf:\"bytes,5,opt,name=namespaceSelector\"` SideEffects *SideEffectClass `json:\"sideEffects\" protobuf:\"bytes,6,opt,name=sideEffects,casttype=SideEffectClass\"` AdmissionReviewVersions []string `json:\"admissionReviewVersions\" protobuf:\"bytes,8,rep,name=admissionReviewVersions\"` } 到这里了解了一个webhook资源的定义，那么这个如何使用呢？通过 Find Usages 找到一个 k8s.io/apiserver/pkg/admission/plugin/webhook/accessors.go 在使用它。这里没有注释，但在结构上可以看出，包含客户端与一系列选择器组成\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 type mutatingWebhookAccessor struct { *v1.MutatingWebhook uid string configurationName string initObjectSelector sync.Once objectSelector labels.Selector objectSelectorErr error initNamespaceSelector sync.Once namespaceSelector labels.Selector namespaceSelectorErr error initClient sync.Once client *rest.RESTClient clientErr error } accessor 因为包含了整个webhookconfig定义的一些动作（这里个人这么觉得）。\naccessor.go 下面 有一个 GetRESTClient 方法 ，通过这里可以看出，这里做的就是使用根据 accessor 构造一个客户端。\ngo 1 2 3 4 5 6 func (m *mutatingWebhookAccessor) GetRESTClient(clientManager *webhookutil.ClientManager) (*rest.RESTClient, error) { m.initClient.Do(func() { m.client, m.clientErr = clientManager.HookClient(hookClientConfigForWebhook(m)) }) return m.client, m.clientErr } 到这步骤已经没必要往下看了，因已经知道这里是请求webhook前的步骤了，下面就是何时请求了。\nk8s.io\\apiserver\\pkg\\admission\\plugin\\webhook\\validating\\dispatcher.go 下面有两个方法，Dispatch去请求我们自己定义的webhook\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 func (d *validatingDispatcher) Dispatch(ctx context.Context, attr admission.Attributes, o admission.ObjectInterfaces, hooks []webhook.WebhookAccessor) error { var relevantHooks []*generic.WebhookInvocation // Construct all the versions we need to call our webhooks versionedAttrs := map[schema.GroupVersionKind]*generic.VersionedAttributes{} for _, hook := range hooks { invocation, statusError := d.plugin.ShouldCallHook(hook, attr, o) if statusError != nil { return statusError } if invocation == nil { continue } relevantHooks = append(relevantHooks, invocation) // If we already have this version, continue if _, ok := versionedAttrs[invocation.Kind]; ok { continue } versionedAttr, err := generic.NewVersionedAttributes(attr, invocation.Kind, o) if err != nil { return apierrors.NewInternalError(err) } versionedAttrs[invocation.Kind] = versionedAttr } if len(relevantHooks) == 0 { // no matching hooks return nil } // Check if the request has already timed out before spawning remote calls select { case \u003c-ctx.Done(): // parent context is canceled or timed out, no point in continuing return apierrors.NewTimeoutError(\"request did not complete within requested timeout\", 0) default: } wg := sync.WaitGroup{} errCh := make(chan error, len(relevantHooks)) wg.Add(len(relevantHooks)) // 循环所有相关的注册的hook for i := range relevantHooks { go func(invocation *generic.WebhookInvocation) { defer wg.Done() // invacation 中有一个 Accessor,Accessor注册了一个相关的webhookconfig // 也就是我们 kubectl -f 注册进来的那个webhook的相关配置 hook, ok := invocation.Webhook.GetValidatingWebhook() if !ok { utilruntime.HandleError(fmt.Errorf(\"validating webhook dispatch requires v1.ValidatingWebhook, but got %T\", hook)) return } versionedAttr := versionedAttrs[invocation.Kind] t := time.Now() // 调用了callHook去请求我们自定义的webhook err := d.callHook(ctx, hook, invocation, versionedAttr) ignoreClientCallFailures := hook.FailurePolicy != nil \u0026\u0026 *hook.FailurePolicy == v1.Ignore rejected := false if err != nil { switch err := err.(type) { case *webhookutil.ErrCallingWebhook: if !ignoreClientCallFailures { rejected = true admissionmetrics.Metrics.ObserveWebhookRejection(hook.Name, \"validating\", string(versionedAttr.Attributes.GetOperation()), admissionmetrics.WebhookRejectionCallingWebhookError, 0) } case *webhookutil.ErrWebhookRejection: rejected = true admissionmetrics.Metrics.ObserveWebhookRejection(hook.Name, \"validating\", string(versionedAttr.Attributes.GetOperation()), admissionmetrics.WebhookRejectionNoError, int(err.Status.ErrStatus.Code)) default: rejected = true admissionmetrics.Metrics.ObserveWebhookRejection(hook.Name, \"validating\", string(versionedAttr.Attributes.GetOperation()), admissionmetrics.WebhookRejectionAPIServerInternalError, 0) } } admissionmetrics.Metrics.ObserveWebhook(time.Since(t), rejected, versionedAttr.Attributes, \"validating\", hook.Name) if err == nil { return } if callErr, ok := err.(*webhookutil.ErrCallingWebhook); ok { if ignoreClientCallFailures { klog.Warningf(\"Failed calling webhook, failing open %v: %v\", hook.Name, callErr) utilruntime.HandleError(callErr) return } klog.Warningf(\"Failed calling webhook, failing closed %v: %v\", hook.Name, err) errCh \u003c- apierrors.NewInternalError(err) return } if rejectionErr, ok := err.(*webhookutil.ErrWebhookRejection); ok { err = rejectionErr.Status } klog.Warningf(\"rejected by webhook %q: %#v\", hook.Name, err) errCh \u003c- err }(relevantHooks[i]) } wg.Wait() close(errCh) var errs []error for e := range errCh { errs = append(errs, e) } if len(errs) == 0 { return nil } if len(errs) \u003e 1 { for i := 1; i \u003c len(errs); i++ { // TODO: merge status errors; until then, just return the first one. utilruntime.HandleError(errs[i]) } } return errs[0] } callHook 可以理解为真正去请求我们自定义的webhook服务的动作\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 func (d *validatingDispatcher) callHook(ctx context.Context, h *v1.ValidatingWebhook, invocation *generic.WebhookInvocation, attr *generic.VersionedAttributes) error { if attr.Attributes.IsDryRun() { if h.SideEffects == nil { return \u0026webhookutil.ErrCallingWebhook{WebhookName: h.Name, Reason: fmt.Errorf(\"Webhook SideEffects is nil\")} } if !(*h.SideEffects == v1.SideEffectClassNone || *h.SideEffects == v1.SideEffectClassNoneOnDryRun) { return webhookerrors.NewDryRunUnsupportedErr(h.Name) } } uid, request, response, err := webhookrequest.CreateAdmissionObjects(attr, invocation) if err != nil { return \u0026webhookutil.ErrCallingWebhook{WebhookName: h.Name, Reason: err} } // 发生请求，可以看到，这里从上面的讲到的地方获取了一个客户端 client, err := invocation.Webhook.GetRESTClient(d.cm) if err != nil { return \u0026webhookutil.ErrCallingWebhook{WebhookName: h.Name, Reason: err} } trace := utiltrace.New(\"Call validating webhook\", utiltrace.Field{\"configuration\", invocation.Webhook.GetConfigurationName()}, utiltrace.Field{\"webhook\", h.Name}, utiltrace.Field{\"resource\", attr.GetResource()}, utiltrace.Field{\"subresource\", attr.GetSubresource()}, utiltrace.Field{\"operation\", attr.GetOperation()}, utiltrace.Field{\"UID\", uid}) defer trace.LogIfLong(500 * time.Millisecond) // 这里设置超时，超时时长就是在yaml资源清单中设置的那个值 if h.TimeoutSeconds != nil { var cancel context.CancelFunc ctx, cancel = context.WithTimeout(ctx, time.Duration(*h.TimeoutSeconds)*time.Second) defer cancel() } // 直接用post请求我们自己定义的webhook接口 r := client.Post().Body(request) // if the context has a deadline, set it as a parameter to inform the backend if deadline, hasDeadline := ctx.Deadline(); hasDeadline { // compute the timeout if timeout := time.Until(deadline); timeout \u003e 0 { // if it's not an even number of seconds, round up to the nearest second if truncated := timeout.Truncate(time.Second); truncated != timeout { timeout = truncated + time.Second } // set the timeout r.Timeout(timeout) } } if err := r.Do(ctx).Into(response); err != nil { return \u0026webhookutil.ErrCallingWebhook{WebhookName: h.Name, Reason: err} } trace.Step(\"Request completed\") result, err := webhookrequest.VerifyAdmissionResponse(uid, false, response) if err != nil { return \u0026webhookutil.ErrCallingWebhook{WebhookName: h.Name, Reason: err} } for k, v := range result.AuditAnnotations { key := h.Name + \"/\" + k if err := attr.Attributes.AddAnnotation(key, v); err != nil { klog.Warningf(\"Failed to set admission audit annotation %s to %s for validating webhook %s: %v\", key, v, h.Name, err) } } if result.Allowed { return nil } return \u0026webhookutil.ErrWebhookRejection{Status: webhookerrors.ToStatusErr(h.Name, result.Result)} } 走到这里基本上对 admission webhook 有了大致的了解，可以知道这个操作是由 apiserver 完成的。下面就实际操作下自定义一个webhook。\n这里还有两个概念，就是请求参数 AdmissionRequest 和相应参数 AdmissionResponse，这些可以在 callHook 中看到，这两个参数被定义在 k8s.io\\api\\admission\\v1\\types.go ；这两个参数也就是我们在自定义 webhook 时需要处理接收到的body的结构，以及我们响应内容数据结构。\n如何编写一个自定义的admission webhook 通过上面的学习了解到了，自定义的webhook就是做为kubernetes提供给用户两种admission controller来验证自定义业务的一个中间件 admission webhook。本质上他是一个HTTP Server，用户可以使用任何语言来完成这部分功能。当然，如果涉及到需要对kubernetes集群资源操作的话，还是建议使用kubernetes官方提供了SDK的编程语言来完成自定义的webhook。\n那么完成一个自定义admission webhook需要两个步骤：\n将相关的webhook config注册给kubernetes，也就是让kubernetes知道你的webhook 准备一个http server来处理 apiserver发过来验证的信息 注：这里使用go net/http包，本身不区分方法处理HTTP的何种请求，如果用其他框架实现的，如django，需要指定对应方法需要为POST\n向kubernetes注册webhook对象 kubernetes提供的两种类型可自定义的准入控制器，和其他资源一样，可以利用资源清单，动态配置那些资源要被adminssion webhook处理。 kubernetes将这种形式抽象为两种资源：\nValidatingWebhookConfiguration\nMutatingWebhookConfiguration\nValidatingAdmission yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 apiVersion: admissionregistration.k8s.io/v1 kind: ValidatingWebhookConfiguration metadata: name: \"pod-policy.example.com\" webhooks: - name: \"pod-policy.example.com\" rules: - apiGroups: [\"\"] # 拦截资源的Group \"\" 表示 core。\"*\" 表示所有。 apiVersions: [\"v1\"] # 拦截资源的版本 operations: [\"CREATE\"] # 什么请求下拦截 resources: [\"pods\"] # 拦截什么资源 scope: \"Namespaced\" # 生效的范围，cluster还是namespace \"*\"表示没有范围限制。 clientConfig: # 我们部署的webhook服务， service: # service是在cluster-in模式下 namespace: \"example-namespace\" name: \"example-service\" port: 443 # 服务的端口 path: \"/validate\" # path是对应用于验证的接口 # caBundle是提供给 admission webhook CA证书 caBundle: \"Ci0tLS0tQk...","wordCount":"3731","inLanguage":"zh","datePublished":"2022-07-11T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2022/07/ch33-admission-webhook/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">深入理解Kubernetes 4A - Admission Control源码解析</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-07-11</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>3731 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>18 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes-develop/>#Kubernetes Develop</a>
<a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#background aria-label=BACKGROUND>BACKGROUND</a><ul><li><a href=#%e4%b8%a4%e7%a7%8d%e6%8e%a7%e5%88%b6%e5%99%a8%e6%9c%89%e4%bb%80%e4%b9%88%e5%8c%ba%e5%88%ab aria-label=两种控制器有什么区别？>两种控制器有什么区别？</a><li><a href=#composition-of-admission-controllers aria-label="composition of admission controllers">composition of admission controllers</a><li><a href=#admission-webhook aria-label="admission webhook">admission webhook</a></ul><li><a href=#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e5%87%86%e5%85%a5%e6%8e%a7%e5%88%b6%e5%99%a8 aria-label=如何使用准入控制器>如何使用准入控制器</a><li><a href=#webhook%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86 aria-label=webhook工作原理>webhook工作原理</a><ul><li><a href=#%e8%b5%84%e6%ba%90%e7%b1%bb%e5%9e%8b aria-label=资源类型>资源类型</a></ul><li><a href=#%e5%a6%82%e4%bd%95%e7%bc%96%e5%86%99%e4%b8%80%e4%b8%aa%e8%87%aa%e5%ae%9a%e4%b9%89%e7%9a%84admission-webhook aria-label="如何编写一个自定义的admission webhook">如何编写一个自定义的admission webhook</a><ul><li><a href=#%e5%90%91kubernetes%e6%b3%a8%e5%86%8cwebhook%e5%af%b9%e8%b1%a1 aria-label=向kubernetes注册webhook对象>向kubernetes注册webhook对象</a><ul><li><a href=#validatingadmission aria-label=ValidatingAdmission>ValidatingAdmission</a><li><a href=#mutatingadmission aria-label=MutatingAdmission>MutatingAdmission</a></ul><li><a href=#%e5%87%86%e5%a4%87%e4%b8%80%e4%b8%aawebhook aria-label=准备一个webhook>准备一个webhook</a><ul><li><a href=#%e8%bf%99%e9%87%8c%e9%9c%80%e8%a6%81%e4%b8%bb%e4%b9%89%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=这里需要主义的问题>这里需要主义的问题</a></ul><li><a href=#%e5%87%86%e5%a4%87%e8%af%81%e4%b9%a6 aria-label=准备证书>准备证书</a><li><a href=#%e9%80%9a%e8%bf%87%e9%83%a8%e7%bd%b2%e6%b5%8b%e8%af%95%e7%bb%93%e6%9e%9c aria-label=通过部署测试结果>通过部署测试结果</a></ul><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><div class="pe-details admonition abstract"><div class="pe-details-summary admonition-title"><i class="icon fas fa-list-ul fa-fw" aria-hidden=true></i>本文是关于Kubernetes 4A解析的第3章<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content><ul><li><a href=https://www.oomkill.com/2022/11/ch31-authentication/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Authentication源码解析</a></li><li>深入理解Kubernetes 4A - Authorization源码解析</li><li><a href=https://www.oomkill.com/2022/07/ch33-admission-webhook/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Admission Control源码解析</a></li><li><a href=https://www.oomkill.com/2022/11/ch34-auditing/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Audit源码解析</a></li><li><a href=https://www.oomkill.com/2024/11/k8s-auth-and-regenerate-cert/ target=_blank rel="noopener nofollow noreferrer">TLS Everywhere - 解密kubernetes集群的安全认证</a></li></ul><p>所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A</p></div></div></div><p>如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大</p><h2 id=background>BACKGROUND<a hidden class=anchor aria-hidden=true href=#background>#</a></h2><p><strong>admission controllers的特点</strong>：</p><ul><li>可定制性：准入功能可针对不同的场景进行调整。</li><li>可预防性：审计则是为了检测问题，而准入控制器可以预防问题发生</li><li>可扩展性：在kubernetes自有的验证机制外，增加了另外的防线，弥补了RBAC仅能对资源提供安全保证。</li></ul><p>下图，显示了用户操作资源的流程，可以看出 <em>admission controllers</em> 作用是在通过身份验证资源持久化之前起到拦截作用。在准入控制器的加入会使kubernetes增加了更高级的安全功能。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/admission-controller-phases.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/admission-controller-phases.png#center alt=准入控制器阶段 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：Kubernetes API 请求的请求处理步骤图</center><center><em>Source：</em>https://kubernetes.io/blog/2019/03/21/a-guide-to-kubernetes-admission-controllers/</center><p>这里找到一个大佬博客画的图，通过两张图可以很清晰的了解到admission webhook流程，与官方给出的不一样的地方在于，这里清楚地定位了kubernetes admission webhook 处于准入控制中，RBAC之后，push 之前。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/vhesGDFN3dLdzXwS7vzPdXkI3aglQYZgGhjc-Cx_boaV6URKFFoe8mFRZZUuJyGHywa_bOkeUlIkm-nJkCVMHPk9dr2dXFwNzAQJKzft2phsTcEDjdObjmugBcYtpdPLpLIYuIGzeFYvtsR2Lw.jpeg><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/vhesGDFN3dLdzXwS7vzPdXkI3aglQYZgGhjc-Cx_boaV6URKFFoe8mFRZZUuJyGHywa_bOkeUlIkm-nJkCVMHPk9dr2dXFwNzAQJKzft2phsTcEDjdObjmugBcYtpdPLpLIYuIGzeFYvtsR2Lw.jpeg#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：Kubernetes API 请求的请求处理步骤图（详细）</center><center><em>Source：</em>https://www.armosec.io/blog/kubernetes-admission-controller/</center><h3 id=两种控制器有什么区别>两种控制器有什么区别？<a hidden class=anchor aria-hidden=true href=#两种控制器有什么区别>#</a></h3><p>根据官方提供的说法是</p><blockquote><p>Mutating controllers may modify related objects to the requests they admit; validating controllers may not</p></blockquote><p>从结构图中也可以看出，<code>validating </code>是在持久化之前，而 <code>Mutating </code>是在结构验证前，根据这些特性我们可以使用 <code>Mutating</code> 修改这个资源对象内容（如增加验证的信息），在 <code>validating</code> 中验证是否合法。</p><h3 id=composition-of-admission-controllers>composition of admission controllers<a hidden class=anchor aria-hidden=true href=#composition-of-admission-controllers>#</a></h3><p>kubernetes中的 <em>admission controllers</em> 由两部分组成：</p><ul><li>内置在APIServer中的准入控制器 <a href=https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-do target=_blank rel="noopener nofollow noreferrer">build-in li.st</a></li><li>特殊的控制器；也是内置在APIServer中，但提供一些自定义的功能<ul><li>MutatingAdmission</li><li>ValidatingAdmission</li></ul></li></ul><p>Mutating 控制器可以修改他们处理的资源对象，Validating 控制器不会。当在任何一个阶段中的任何控制器拒绝这个了请求，则会立即拒绝整个请求，并将错误返回。</p><h3 id=admission-webhook>admission webhook<a hidden class=anchor aria-hidden=true href=#admission-webhook>#</a></h3><p>由于准入控制器是内置在 <code>kube-apiserver</code> 中的，这种情况下就限制了admission controller的可扩展性。在这种背景下，kubernetes提供了一种可扩展的准入控制器 <code>extensible admission controllers</code>，这种行为叫做动态准入控制 <code>Dynamic Admission Control</code>，而提供这个功能的就是 <code>admission webhook</code> 。</p><p><code>admission webhook</code> 通俗来讲就是 HTTP 回调，通过定义一个http server，接收准入请求并处理。用户可以通过kubernetes提供的两种类型的 <code>admission webhook</code>，<em>validating admission webhook</em> 和 <em>mutating admission webhook</em>。来完成自定义的准入策略的处理。</p><p>webhook 就是</p><blockquote><p>注：从上面的流程图也可以看出，admission webhook 也是有顺序的。首先调用mutating webhook，然后会调用validating webhook。</p></blockquote><h2 id=如何使用准入控制器>如何使用准入控制器<a hidden class=anchor aria-hidden=true href=#如何使用准入控制器>#</a></h2><p><strong>使用条件</strong>：kubernetes v1.16 使用 <code>admissionregistration.k8s.io/v1</code> ；kubernetes v1.9 使用 <code>admissionregistration.k8s.io/v1beta1</code>。</p><p><strong>如何在集群中开启准入控制器?</strong> ：查看kube-apiserver 的启动参数 <code>--enable-admission-plugins</code> ；通过该参数来配置要启动的准入控制器，如 <code>--enable-admission-plugins=NodeRestriction</code> 多个准入控制器以 <code>,</code> 分割，顺序无关紧要。 反之使用 <code>--disable-admission-plugins</code> 参数可以关闭相应的准入控制器（Refer to <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/#options target=_blank rel="noopener nofollow noreferrer">apiserver opts</a>）。</p><p>通过 <code>kubectl</code> 命令可以看到，当前kubernetes集群所支持准入控制器的版本</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl api-versions <span class=p>|</span> grep admissionregistration.k8s.io/v1
</span></span><span class=line><span class=cl>admissionregistration.k8s.io/v1
</span></span><span class=line><span class=cl>admissionregistration.k8s.io/v1beta1</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=webhook工作原理>webhook工作原理<a hidden class=anchor aria-hidden=true href=#webhook工作原理>#</a></h2><p>通过上面的学习，已经了解到了两种webhook的工作原理如下所示：</p><blockquote><p>mutating webhook，会在持久化前拦截在 MutatingWebhookConfiguration 中定义的规则匹配的请求。MutatingAdmissionWebhook 通过向 mutating webhook 服务器发送准入请求来执行验证。</p><p>validaing webhook，会在持久化前拦截在 <code>ValidatingWebhookConfiguration</code> 中定义的规则匹配的请求。ValidatingAdmissionWebhook 通过将准入请求发送到 validating webhook server来执行验证。</p></blockquote><p>那么接下来将从源码中看这个在这个工作流程中，究竟做了些什么？</p><h3 id=资源类型>资源类型<a hidden class=anchor aria-hidden=true href=#资源类型>#</a></h3><p>对于 1.9 版本之后，也就是 <code>v1</code> 版本 ，admission 被定义在 <a href=https://github.com/kubernetes/kubernetes/blob/v1.18.20/staging/src/k8s.io/api/admissionregistration/v1/types.go target=_blank rel="noopener nofollow noreferrer">k8s.io\api\admissionregistration\v1\types.go</a> ，大同小异，因为本地只有1.18集群，所以以这个讲解。</p><p>对于 <code>Validating Webhook</code> 来讲实现主要都在webhook中</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ValidatingWebhookConfiguration</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 每个api必须包含下列的metadata，这个是kubernetes规范，可以在注释中的url看到相关文档
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span> <span class=s>`json:&#34;,inline&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span> <span class=s>`json:&#34;metadata,omitempty&#34; protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Webhooks在这里被表示为[]ValidatingWebhook，表示我们可以注册多个
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// +optional
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// +patchMergeKey=name
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// +patchStrategy=merge
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Webhooks</span> <span class=p>[]</span><span class=nx>ValidatingWebhook</span> <span class=s>`json:&#34;webhooks,omitempty&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;name&#34; protobuf:&#34;bytes,2,rep,name=Webhooks&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>webhook，则是对这种类型的webhook提供的操作、资源等。对于这部分不做过多的注释了，因为这里本身为kubernetes API资源，官网有很详细的例子与说明。这里更多字段的意思的可以参考官方 <a href=https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-configuration target=_blank rel="noopener nofollow noreferrer">doc</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ValidatingWebhook</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>//  admission webhook的名词，Required
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Name</span> <span class=kt>string</span> <span class=s>`json:&#34;name&#34; protobuf:&#34;bytes,1,opt,name=name&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// ClientConfig 定义了与webhook通讯的方式 Required
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ClientConfig</span> <span class=nx>WebhookClientConfig</span> <span class=s>`json:&#34;clientConfig&#34; protobuf:&#34;bytes,2,opt,name=clientConfig&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// rule表示了webhook对于哪些资源及子资源的操作进行关注
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Rules</span> <span class=p>[]</span><span class=nx>RuleWithOperations</span> <span class=s>`json:&#34;rules,omitempty&#34; protobuf:&#34;bytes,3,rep,name=rules&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// FailurePolicy 对于无法识别的value将如何处理，allowed/Ignore optional
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>FailurePolicy</span> <span class=o>*</span><span class=nx>FailurePolicyType</span> <span class=s>`json:&#34;failurePolicy,omitempty&#34; protobuf:&#34;bytes,4,opt,name=failurePolicy,casttype=FailurePolicyType&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// matchPolicy 定义了如何使用“rules”列表来匹配传入的请求。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>MatchPolicy</span> <span class=o>*</span><span class=nx>MatchPolicyType</span> <span class=s>`json:&#34;matchPolicy,omitempty&#34; protobuf:&#34;bytes,9,opt,name=matchPolicy,casttype=MatchPolicyType&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>NamespaceSelector</span> <span class=o>*</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>LabelSelector</span> <span class=s>`json:&#34;namespaceSelector,omitempty&#34; protobuf:&#34;bytes,5,opt,name=namespaceSelector&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>SideEffects</span> <span class=o>*</span><span class=nx>SideEffectClass</span> <span class=s>`json:&#34;sideEffects&#34; protobuf:&#34;bytes,6,opt,name=sideEffects,casttype=SideEffectClass&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>AdmissionReviewVersions</span> <span class=p>[]</span><span class=kt>string</span> <span class=s>`json:&#34;admissionReviewVersions&#34; protobuf:&#34;bytes,8,rep,name=admissionReviewVersions&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>到这里了解了一个webhook资源的定义，那么这个如何使用呢？通过 <code>Find Usages</code> 找到一个 <a href=https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/admission/plugin/webhook/accessors.go target=_blank rel="noopener nofollow noreferrer">k8s.io/apiserver/pkg/admission/plugin/webhook/accessors.go</a> 在使用它。这里没有注释，但在结构上可以看出，包含客户端与一系列选择器组成</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>mutatingWebhookAccessor</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>MutatingWebhook</span>
</span></span><span class=line><span class=cl>	<span class=nx>uid</span>               <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>configurationName</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>initObjectSelector</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Once</span>
</span></span><span class=line><span class=cl>	<span class=nx>objectSelector</span>     <span class=nx>labels</span><span class=p>.</span><span class=nx>Selector</span>
</span></span><span class=line><span class=cl>	<span class=nx>objectSelectorErr</span>  <span class=kt>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>initNamespaceSelector</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Once</span>
</span></span><span class=line><span class=cl>	<span class=nx>namespaceSelector</span>     <span class=nx>labels</span><span class=p>.</span><span class=nx>Selector</span>
</span></span><span class=line><span class=cl>	<span class=nx>namespaceSelectorErr</span>  <span class=kt>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>initClient</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Once</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span>     <span class=o>*</span><span class=nx>rest</span><span class=p>.</span><span class=nx>RESTClient</span>
</span></span><span class=line><span class=cl>	<span class=nx>clientErr</span>  <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>accessor</code> 因为包含了整个webhookconfig定义的一些动作（这里个人这么觉得）。</p><p><code>accessor.go</code> 下面 有一个 <code>GetRESTClient</code> 方法 ，通过这里可以看出，这里做的就是使用根据 <code>accessor</code> 构造一个客户端。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>m</span> <span class=o>*</span><span class=nx>mutatingWebhookAccessor</span><span class=p>)</span> <span class=nf>GetRESTClient</span><span class=p>(</span><span class=nx>clientManager</span> <span class=o>*</span><span class=nx>webhookutil</span><span class=p>.</span><span class=nx>ClientManager</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>rest</span><span class=p>.</span><span class=nx>RESTClient</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>m</span><span class=p>.</span><span class=nx>initClient</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>m</span><span class=p>.</span><span class=nx>client</span><span class=p>,</span> <span class=nx>m</span><span class=p>.</span><span class=nx>clientErr</span> <span class=p>=</span> <span class=nx>clientManager</span><span class=p>.</span><span class=nf>HookClient</span><span class=p>(</span><span class=nf>hookClientConfigForWebhook</span><span class=p>(</span><span class=nx>m</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>m</span><span class=p>.</span><span class=nx>client</span><span class=p>,</span> <span class=nx>m</span><span class=p>.</span><span class=nx>clientErr</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>到这步骤已经没必要往下看了，因已经知道这里是请求webhook前的步骤了，下面就是何时请求了。</p><p><a href=https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/apiserver/pkg/admission/plugin/webhook/validating/dispatcher.go target=_blank rel="noopener nofollow noreferrer">k8s.io\apiserver\pkg\admission\plugin\webhook\validating\dispatcher.go</a> 下面有两个方法，Dispatch去请求我们自己定义的webhook</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>validatingDispatcher</span><span class=p>)</span> <span class=nf>Dispatch</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>attr</span> <span class=nx>admission</span><span class=p>.</span><span class=nx>Attributes</span><span class=p>,</span> <span class=nx>o</span> <span class=nx>admission</span><span class=p>.</span><span class=nx>ObjectInterfaces</span><span class=p>,</span> <span class=nx>hooks</span> <span class=p>[]</span><span class=nx>webhook</span><span class=p>.</span><span class=nx>WebhookAccessor</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>relevantHooks</span> <span class=p>[]</span><span class=o>*</span><span class=nx>generic</span><span class=p>.</span><span class=nx>WebhookInvocation</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Construct all the versions we need to call our webhooks
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>versionedAttrs</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionKind</span><span class=p>]</span><span class=o>*</span><span class=nx>generic</span><span class=p>.</span><span class=nx>VersionedAttributes</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>hook</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>hooks</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>invocation</span><span class=p>,</span> <span class=nx>statusError</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nx>plugin</span><span class=p>.</span><span class=nf>ShouldCallHook</span><span class=p>(</span><span class=nx>hook</span><span class=p>,</span> <span class=nx>attr</span><span class=p>,</span> <span class=nx>o</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>statusError</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>statusError</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>invocation</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>relevantHooks</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>relevantHooks</span><span class=p>,</span> <span class=nx>invocation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=c1>// If we already have this version, continue
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>versionedAttrs</span><span class=p>[</span><span class=nx>invocation</span><span class=p>.</span><span class=nx>Kind</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>versionedAttr</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>generic</span><span class=p>.</span><span class=nf>NewVersionedAttributes</span><span class=p>(</span><span class=nx>attr</span><span class=p>,</span> <span class=nx>invocation</span><span class=p>.</span><span class=nx>Kind</span><span class=p>,</span> <span class=nx>o</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>apierrors</span><span class=p>.</span><span class=nf>NewInternalError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>versionedAttrs</span><span class=p>[</span><span class=nx>invocation</span><span class=p>.</span><span class=nx>Kind</span><span class=p>]</span> <span class=p>=</span> <span class=nx>versionedAttr</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>relevantHooks</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// no matching hooks
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Check if the request has already timed out before spawning remote calls
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>		<span class=c1>// parent context is canceled or timed out, no point in continuing
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>apierrors</span><span class=p>.</span><span class=nf>NewTimeoutError</span><span class=p>(</span><span class=s>&#34;request did not complete within requested timeout&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span> <span class=o>:=</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>errCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>error</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>relevantHooks</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>relevantHooks</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 循环所有相关的注册的hook
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>relevantHooks</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>invocation</span> <span class=o>*</span><span class=nx>generic</span><span class=p>.</span><span class=nx>WebhookInvocation</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>defer</span> <span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1>// invacation 中有一个 Accessor,Accessor注册了一个相关的webhookconfig
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 也就是我们 kubectl -f 注册进来的那个webhook的相关配置
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>hook</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>invocation</span><span class=p>.</span><span class=nx>Webhook</span><span class=p>.</span><span class=nf>GetValidatingWebhook</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;validating webhook dispatch requires v1.ValidatingWebhook, but got %T&#34;</span><span class=p>,</span> <span class=nx>hook</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>versionedAttr</span> <span class=o>:=</span> <span class=nx>versionedAttrs</span><span class=p>[</span><span class=nx>invocation</span><span class=p>.</span><span class=nx>Kind</span><span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=nx>t</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 调用了callHook去请求我们自定义的webhook
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>err</span> <span class=o>:=</span> <span class=nx>d</span><span class=p>.</span><span class=nf>callHook</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>hook</span><span class=p>,</span> <span class=nx>invocation</span><span class=p>,</span> <span class=nx>versionedAttr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>ignoreClientCallFailures</span> <span class=o>:=</span> <span class=nx>hook</span><span class=p>.</span><span class=nx>FailurePolicy</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=o>*</span><span class=nx>hook</span><span class=p>.</span><span class=nx>FailurePolicy</span> <span class=o>==</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>Ignore</span>
</span></span><span class=line><span class=cl>			<span class=nx>rejected</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>switch</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=o>*</span><span class=nx>webhookutil</span><span class=p>.</span><span class=nx>ErrCallingWebhook</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>!</span><span class=nx>ignoreClientCallFailures</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>rejected</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>						<span class=nx>admissionmetrics</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>.</span><span class=nf>ObserveWebhookRejection</span><span class=p>(</span><span class=nx>hook</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=s>&#34;validating&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>versionedAttr</span><span class=p>.</span><span class=nx>Attributes</span><span class=p>.</span><span class=nf>GetOperation</span><span class=p>()),</span> <span class=nx>admissionmetrics</span><span class=p>.</span><span class=nx>WebhookRejectionCallingWebhookError</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=o>*</span><span class=nx>webhookutil</span><span class=p>.</span><span class=nx>ErrWebhookRejection</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=nx>rejected</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>					<span class=nx>admissionmetrics</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>.</span><span class=nf>ObserveWebhookRejection</span><span class=p>(</span><span class=nx>hook</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=s>&#34;validating&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>versionedAttr</span><span class=p>.</span><span class=nx>Attributes</span><span class=p>.</span><span class=nf>GetOperation</span><span class=p>()),</span> <span class=nx>admissionmetrics</span><span class=p>.</span><span class=nx>WebhookRejectionNoError</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>ErrStatus</span><span class=p>.</span><span class=nx>Code</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=nx>rejected</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>					<span class=nx>admissionmetrics</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>.</span><span class=nf>ObserveWebhookRejection</span><span class=p>(</span><span class=nx>hook</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=s>&#34;validating&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>versionedAttr</span><span class=p>.</span><span class=nx>Attributes</span><span class=p>.</span><span class=nf>GetOperation</span><span class=p>()),</span> <span class=nx>admissionmetrics</span><span class=p>.</span><span class=nx>WebhookRejectionAPIServerInternalError</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>admissionmetrics</span><span class=p>.</span><span class=nx>Metrics</span><span class=p>.</span><span class=nf>ObserveWebhook</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>t</span><span class=p>),</span> <span class=nx>rejected</span><span class=p>,</span> <span class=nx>versionedAttr</span><span class=p>.</span><span class=nx>Attributes</span><span class=p>,</span> <span class=s>&#34;validating&#34;</span><span class=p>,</span> <span class=nx>hook</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>callErr</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=o>*</span><span class=nx>webhookutil</span><span class=p>.</span><span class=nx>ErrCallingWebhook</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>ignoreClientCallFailures</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>Warningf</span><span class=p>(</span><span class=s>&#34;Failed calling webhook, failing open %v: %v&#34;</span><span class=p>,</span> <span class=nx>hook</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>callErr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>callErr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Warningf</span><span class=p>(</span><span class=s>&#34;Failed calling webhook, failing closed %v: %v&#34;</span><span class=p>,</span> <span class=nx>hook</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>errCh</span> <span class=o>&lt;-</span> <span class=nx>apierrors</span><span class=p>.</span><span class=nf>NewInternalError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>rejectionErr</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=o>*</span><span class=nx>webhookutil</span><span class=p>.</span><span class=nx>ErrWebhookRejection</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>err</span> <span class=p>=</span> <span class=nx>rejectionErr</span><span class=p>.</span><span class=nx>Status</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Warningf</span><span class=p>(</span><span class=s>&#34;rejected by webhook %q: %#v&#34;</span><span class=p>,</span> <span class=nx>hook</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>errCh</span> <span class=o>&lt;-</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}(</span><span class=nx>relevantHooks</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nb>close</span><span class=p>(</span><span class=nx>errCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>errs</span> <span class=p>[]</span><span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>errCh</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>errs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>errs</span><span class=p>,</span> <span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>errs</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>errs</span><span class=p>);</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// TODO: merge status errors; until then, just return the first one.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>errs</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>errs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/6adee9d4fb7a0cf3eec148448792e2ab091e1720/staging/src/k8s.io/apiserver/pkg/admission/plugin/webhook/validating/dispatcher.go#L216-L301 target=_blank rel="noopener nofollow noreferrer">callHook</a> 可以理解为真正去请求我们自定义的webhook服务的动作</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>d</span> <span class=o>*</span><span class=nx>validatingDispatcher</span><span class=p>)</span> <span class=nf>callHook</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>h</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>ValidatingWebhook</span><span class=p>,</span> <span class=nx>invocation</span> <span class=o>*</span><span class=nx>generic</span><span class=p>.</span><span class=nx>WebhookInvocation</span><span class=p>,</span> <span class=nx>attr</span> <span class=o>*</span><span class=nx>generic</span><span class=p>.</span><span class=nx>VersionedAttributes</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>attr</span><span class=p>.</span><span class=nx>Attributes</span><span class=p>.</span><span class=nf>IsDryRun</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>h</span><span class=p>.</span><span class=nx>SideEffects</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=o>&amp;</span><span class=nx>webhookutil</span><span class=p>.</span><span class=nx>ErrCallingWebhook</span><span class=p>{</span><span class=nx>WebhookName</span><span class=p>:</span> <span class=nx>h</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Reason</span><span class=p>:</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Webhook SideEffects is nil&#34;</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>!(</span><span class=o>*</span><span class=nx>h</span><span class=p>.</span><span class=nx>SideEffects</span> <span class=o>==</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>SideEffectClassNone</span> <span class=o>||</span> <span class=o>*</span><span class=nx>h</span><span class=p>.</span><span class=nx>SideEffects</span> <span class=o>==</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>SideEffectClassNoneOnDryRun</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=nx>webhookerrors</span><span class=p>.</span><span class=nf>NewDryRunUnsupportedErr</span><span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>uid</span><span class=p>,</span> <span class=nx>request</span><span class=p>,</span> <span class=nx>response</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>webhookrequest</span><span class=p>.</span><span class=nf>CreateAdmissionObjects</span><span class=p>(</span><span class=nx>attr</span><span class=p>,</span> <span class=nx>invocation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>&amp;</span><span class=nx>webhookutil</span><span class=p>.</span><span class=nx>ErrCallingWebhook</span><span class=p>{</span><span class=nx>WebhookName</span><span class=p>:</span> <span class=nx>h</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Reason</span><span class=p>:</span> <span class=nx>err</span><span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 发生请求，可以看到，这里从上面的讲到的地方获取了一个客户端
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>invocation</span><span class=p>.</span><span class=nx>Webhook</span><span class=p>.</span><span class=nf>GetRESTClient</span><span class=p>(</span><span class=nx>d</span><span class=p>.</span><span class=nx>cm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>&amp;</span><span class=nx>webhookutil</span><span class=p>.</span><span class=nx>ErrCallingWebhook</span><span class=p>{</span><span class=nx>WebhookName</span><span class=p>:</span> <span class=nx>h</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Reason</span><span class=p>:</span> <span class=nx>err</span><span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nx>trace</span> <span class=o>:=</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;Call validating webhook&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=s>&#34;configuration&#34;</span><span class=p>,</span> <span class=nx>invocation</span><span class=p>.</span><span class=nx>Webhook</span><span class=p>.</span><span class=nf>GetConfigurationName</span><span class=p>()},</span>
</span></span><span class=line><span class=cl>      <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=s>&#34;webhook&#34;</span><span class=p>,</span> <span class=nx>h</span><span class=p>.</span><span class=nx>Name</span><span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=s>&#34;resource&#34;</span><span class=p>,</span> <span class=nx>attr</span><span class=p>.</span><span class=nf>GetResource</span><span class=p>()},</span>
</span></span><span class=line><span class=cl>      <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=s>&#34;subresource&#34;</span><span class=p>,</span> <span class=nx>attr</span><span class=p>.</span><span class=nf>GetSubresource</span><span class=p>()},</span>
</span></span><span class=line><span class=cl>      <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=s>&#34;operation&#34;</span><span class=p>,</span> <span class=nx>attr</span><span class=p>.</span><span class=nf>GetOperation</span><span class=p>()},</span>
</span></span><span class=line><span class=cl>      <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=s>&#34;UID&#34;</span><span class=p>,</span> <span class=nx>uid</span><span class=p>})</span>
</span></span><span class=line><span class=cl>   <span class=k>defer</span> <span class=nx>trace</span><span class=p>.</span><span class=nf>LogIfLong</span><span class=p>(</span><span class=mi>500</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// 这里设置超时，超时时长就是在yaml资源清单中设置的那个值
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=nx>h</span><span class=p>.</span><span class=nx>TimeoutSeconds</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>var</span> <span class=nx>cancel</span> <span class=nx>context</span><span class=p>.</span><span class=nx>CancelFunc</span>
</span></span><span class=line><span class=cl>      <span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=o>*</span><span class=nx>h</span><span class=p>.</span><span class=nx>TimeoutSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 直接用post请求我们自己定义的webhook接口
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>r</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Post</span><span class=p>().</span><span class=nf>Body</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// if the context has a deadline, set it as a parameter to inform the backend
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=nx>deadline</span><span class=p>,</span> <span class=nx>hasDeadline</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Deadline</span><span class=p>();</span> <span class=nx>hasDeadline</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// compute the timeout
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=nx>timeout</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>deadline</span><span class=p>);</span> <span class=nx>timeout</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=c1>// if it&#39;s not an even number of seconds, round up to the nearest second
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=k>if</span> <span class=nx>truncated</span> <span class=o>:=</span> <span class=nx>timeout</span><span class=p>.</span><span class=nf>Truncate</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>);</span> <span class=nx>truncated</span> <span class=o>!=</span> <span class=nx>timeout</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>timeout</span> <span class=p>=</span> <span class=nx>truncated</span> <span class=o>+</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=c1>// set the timeout
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=nx>r</span><span class=p>.</span><span class=nf>Timeout</span><span class=p>(</span><span class=nx>timeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Into</span><span class=p>(</span><span class=nx>response</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>&amp;</span><span class=nx>webhookutil</span><span class=p>.</span><span class=nx>ErrCallingWebhook</span><span class=p>{</span><span class=nx>WebhookName</span><span class=p>:</span> <span class=nx>h</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Reason</span><span class=p>:</span> <span class=nx>err</span><span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nx>trace</span><span class=p>.</span><span class=nf>Step</span><span class=p>(</span><span class=s>&#34;Request completed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>webhookrequest</span><span class=p>.</span><span class=nf>VerifyAdmissionResponse</span><span class=p>(</span><span class=nx>uid</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>&amp;</span><span class=nx>webhookutil</span><span class=p>.</span><span class=nx>ErrCallingWebhook</span><span class=p>{</span><span class=nx>WebhookName</span><span class=p>:</span> <span class=nx>h</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Reason</span><span class=p>:</span> <span class=nx>err</span><span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>result</span><span class=p>.</span><span class=nx>AuditAnnotations</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>key</span> <span class=o>:=</span> <span class=nx>h</span><span class=p>.</span><span class=nx>Name</span> <span class=o>+</span> <span class=s>&#34;/&#34;</span> <span class=o>+</span> <span class=nx>k</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>attr</span><span class=p>.</span><span class=nx>Attributes</span><span class=p>.</span><span class=nf>AddAnnotation</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>v</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nx>klog</span><span class=p>.</span><span class=nf>Warningf</span><span class=p>(</span><span class=s>&#34;Failed to set admission audit annotation %s to %s for validating webhook %s: %v&#34;</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>v</span><span class=p>,</span> <span class=nx>h</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>result</span><span class=p>.</span><span class=nx>Allowed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=o>&amp;</span><span class=nx>webhookutil</span><span class=p>.</span><span class=nx>ErrWebhookRejection</span><span class=p>{</span><span class=nx>Status</span><span class=p>:</span> <span class=nx>webhookerrors</span><span class=p>.</span><span class=nf>ToStatusErr</span><span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>result</span><span class=p>.</span><span class=nx>Result</span><span class=p>)}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>走到这里基本上对 <code>admission webhook</code> 有了大致的了解，可以知道这个操作是由 apiserver 完成的。下面就实际操作下自定义一个webhook。</p><p>这里还有两个概念，就是请求参数 <a href=https://github.com/kubernetes/kubernetes/blob/6adee9d4fb7a0cf3eec148448792e2ab091e1720/staging/src/k8s.io/api/admission/v1/types.go#L40-L113 target=_blank rel="noopener nofollow noreferrer">AdmissionRequest</a> 和相应参数 <a href=https://github.com/kubernetes/kubernetes/blob/6adee9d4fb7a0cf3eec148448792e2ab091e1720/staging/src/k8s.io/api/admission/v1/types.go#L116-L150 target=_blank rel="noopener nofollow noreferrer">AdmissionResponse</a>，这些可以在 <code>callHook</code> 中看到，这两个参数被定义在 <a href=https://github.com/kubernetes/kubernetes/blob/master/staging/src/k8s.io/api/admission/v1/types.go#L29-L37 target=_blank rel="noopener nofollow noreferrer">k8s.io\api\admission\v1\types.go</a> ；这两个参数也就是我们在自定义 webhook 时需要处理接收到的body的结构，以及我们响应内容数据结构。</p><h2 id=如何编写一个自定义的admission-webhook>如何编写一个自定义的admission webhook<a hidden class=anchor aria-hidden=true href=#如何编写一个自定义的admission-webhook>#</a></h2><p>通过上面的学习了解到了，自定义的webhook就是做为kubernetes提供给用户两种admission controller来验证自定义业务的一个中间件 admission webhook。本质上他是一个HTTP Server，用户可以使用任何语言来完成这部分功能。当然，如果涉及到需要对kubernetes集群资源操作的话，还是建议使用kubernetes官方提供了SDK的编程语言来完成自定义的webhook。</p><p>那么完成一个自定义admission webhook需要两个步骤：</p><ul><li>将相关的webhook config注册给kubernetes，也就是让kubernetes知道你的webhook</li><li>准备一个http server来处理 apiserver发过来验证的信息</li></ul><blockquote><p>注：这里使用go net/http包，本身不区分方法处理HTTP的何种请求，如果用其他框架实现的，如django，需要指定对应方法需要为POST</p></blockquote><h3 id=向kubernetes注册webhook对象>向kubernetes注册webhook对象<a hidden class=anchor aria-hidden=true href=#向kubernetes注册webhook对象>#</a></h3><p>kubernetes提供的两种类型可自定义的准入控制器，和其他资源一样，可以利用资源清单，动态配置那些资源要被adminssion webhook处理。 kubernetes将这种形式抽象为两种资源：</p><ul><li><p>ValidatingWebhookConfiguration</p></li><li><p>MutatingWebhookConfiguration</p></li></ul><h4 id=validatingadmission>ValidatingAdmission<a hidden class=anchor aria-hidden=true href=#validatingadmission>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>admissionregistration.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ValidatingWebhookConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;pod-policy.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>webhooks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;pod-policy.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>   </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 拦截资源的Group &#34;&#34; 表示 core。&#34;*&#34; 表示所有。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;v1&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 拦截资源的版本</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>operations</span><span class=p>:</span><span class=w>  </span><span class=p>[</span><span class=s2>&#34;CREATE&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 什么请求下拦截</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>   </span><span class=p>[</span><span class=s2>&#34;pods&#34;</span><span class=p>]</span><span class=w>  </span><span class=c># 拦截什么资源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scope</span><span class=p>:</span><span class=w>       </span><span class=s2>&#34;Namespaced&#34;</span><span class=w> </span><span class=c># 生效的范围，cluster还是namespace &#34;*&#34;表示没有范围限制。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clientConfig</span><span class=p>:</span><span class=w> </span><span class=c># 我们部署的webhook服务，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=c># service是在cluster-in模式下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;example-namespace&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;example-service&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>443</span><span class=w> </span><span class=c># 服务的端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/validate&#34;</span><span class=w> </span><span class=c># path是对应用于验证的接口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># caBundle是提供给 admission webhook CA证书  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>caBundle</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle containing the CA that signed the webhook&#39;s serving certificate&gt;...tLS0K&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>admissionReviewVersions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;v1&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;v1beta1&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sideEffects</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w> </span><span class=c># 1-30s直接，表示请求api的超时时间</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=mutatingadmission>MutatingAdmission<a hidden class=anchor aria-hidden=true href=#mutatingadmission>#</a></h4><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>admissionregistration.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ValidatingWebhookConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;valipod-policy.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>webhooks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;valipod-policy.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>   </span><span class=p>[</span><span class=s2>&#34;apps&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 拦截资源的Group &#34;&#34; 表示 core。&#34;*&#34; 表示所有。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apiVersions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;v1&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 拦截资源的版本</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>operations</span><span class=p>:</span><span class=w>  </span><span class=p>[</span><span class=s2>&#34;CREATE&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 什么请求下拦截</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>   </span><span class=p>[</span><span class=s2>&#34;deployments&#34;</span><span class=p>]</span><span class=w>  </span><span class=c># 拦截什么资源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>scope</span><span class=p>:</span><span class=w>       </span><span class=s2>&#34;Namespaced&#34;</span><span class=w> </span><span class=c># 生效的范围，cluster还是namespace &#34;*&#34;表示没有范围限制。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clientConfig</span><span class=p>:</span><span class=w> </span><span class=c># 我们部署的webhook服务，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://10.0.0.1:81/validate&#34;</span><span class=w> </span><span class=c># 这里是外部模式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      service: # service是在cluster-in模式下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#        namespace: &#34;default&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#        name: &#34;admission-webhook&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#        port: 81 # 服务的端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#        path: &#34;/mutate&#34; # path是对应用于验证的接口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># caBundle是提供给 admission webhook CA证书</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>caBundle</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle containing the CA that signed the webhook&#39;s serving certificate&gt;...tLS0K&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>admissionReviewVersions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;v1&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sideEffects</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w> </span><span class=c># 1-30s直接，表示请求api的超时时间</span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>注：对于webhook，也可以引入外部的服务，并非必须部署到集群内部</p></blockquote><p>对于外部服务来讲，需要 <code>clientConfig</code> 中的 <code>service</code> , 更换为 <code>url</code> ; 通过 <code>url</code> 参数可以将一个外部的服务引入</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>admissionregistration.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>MutatingWebhookConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>webhooks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-webhook.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clientConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://my-webhook.example.com:9443/my-webhook-path&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>...</span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>注：这里的url规则必须准守下列形式：</p><ul><li><code>scheme://host:port/path</code></li><li>使用了url 时，这里不应填写集群内的服务</li><li><code>scheme</code> 必须是 https，不能为http，这就意味着，引入外部时也需要</li><li>配置时使用了，<code>?xx=xx</code> 的参数也是不被允许的（官方说法是这样的，通过源码学习了解到因为会发送特定的请求体，所以无需管参数）</li></ul></blockquote><p>更多的配置可以参考kubernetes官方提供的 <a href=https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/extensible-admission-controllers/#webhook-configuration target=_blank rel="noopener nofollow noreferrer">doc</a></p><h3 id=准备一个webhook>准备一个webhook<a hidden class=anchor aria-hidden=true href=#准备一个webhook>#</a></h3><p>让我们编写我们的 webhook server。将创建两个钩子，<code>/mutate</code> 与 <code>/validate</code>；</p><ul><li><code>/mutate</code> 将在创建deployment资源时，基于版本，给资源加上注释 <code>webhook.example.com/allow: true</code></li><li><code>/validate</code> 将对 <code>/mutate</code> 增加的 <code>allow:true</code> 那么则继续，否则拒绝。</li></ul><p>这里为了方便，全部写在一起了，实际上不符合软件的设计。在kubernetes代码库中也提供了一个<a href=https://github.com/kubernetes/kubernetes/blob/release-1.21/test/images/agnhost/webhook/main.go target=_blank rel="noopener nofollow noreferrer">webhook server</a>，可以参考他这个webhook server来学习具体要做什么</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;crypto/tls&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os/signal&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;syscall&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>v1admission</span> <span class=s>&#34;k8s.io/api/admission/v1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/runtime/serializer&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>appv1</span> <span class=s>&#34;k8s.io/api/apps/v1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/klog&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>patch</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Op</span>    <span class=kt>string</span>            <span class=s>`json:&#34;op&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Path</span>  <span class=kt>string</span>            <span class=s>`json:&#34;path&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Value</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span> <span class=s>`json:&#34;value&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>serve</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>body</span> <span class=p>[]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>body</span> <span class=p>=</span> <span class=nx>data</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;receive request: %v....&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>body</span><span class=p>)[:</span><span class=mi>130</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>body</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;admission request body is empty&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;admission request body is empty&#34;</span><span class=p>).</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>admission</span> <span class=nx>v1admission</span><span class=p>.</span><span class=nx>AdmissionReview</span>
</span></span><span class=line><span class=cl>	<span class=nx>codefc</span> <span class=o>:=</span> <span class=nx>serializer</span><span class=p>.</span><span class=nf>NewCodecFactory</span><span class=p>(</span><span class=nx>runtime</span><span class=p>.</span><span class=nf>NewScheme</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>decoder</span> <span class=o>:=</span> <span class=nx>codefc</span><span class=p>.</span><span class=nf>UniversalDeserializer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>decoder</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=nx>body</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>admission</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>msg</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;Request could not be decoded: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>msg</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>admission</span><span class=p>.</span><span class=nx>Request</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;admission review can&#39;t be used: Request field is nil&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;admission review can&#39;t be used: Request field is nil&#34;</span><span class=p>).</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>RequestURI</span><span class=p>,</span> <span class=s>&#34;?&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;/mutate&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>req</span> <span class=o>:=</span> <span class=nx>admission</span><span class=p>.</span><span class=nx>Request</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>admissionResp</span> <span class=nx>v1admission</span><span class=p>.</span><span class=nx>AdmissionReview</span>
</span></span><span class=line><span class=cl>		<span class=nx>admissionResp</span><span class=p>.</span><span class=nx>APIVersion</span> <span class=p>=</span> <span class=nx>admission</span><span class=p>.</span><span class=nx>APIVersion</span>
</span></span><span class=line><span class=cl>		<span class=nx>admissionResp</span><span class=p>.</span><span class=nx>Kind</span> <span class=p>=</span> <span class=nx>admission</span><span class=p>.</span><span class=nx>Kind</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;AdmissionReview for Kind=%v, Namespace=%v Name=%v UID=%v Operation=%v&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>req</span><span class=p>.</span><span class=nx>Kind</span><span class=p>.</span><span class=nx>Kind</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Operation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Kind</span><span class=p>.</span><span class=nx>Kind</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=s>&#34;Deployment&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>				<span class=nx>respstr</span> <span class=p>[]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>				<span class=nx>err</span>     <span class=kt>error</span>
</span></span><span class=line><span class=cl>				<span class=nx>deploy</span>  <span class=nx>appv1</span><span class=p>.</span><span class=nx>Deployment</span>
</span></span><span class=line><span class=cl>			<span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Object</span><span class=p>.</span><span class=nx>Raw</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>deploy</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>respStructure</span> <span class=o>:=</span> <span class=nx>v1admission</span><span class=p>.</span><span class=nx>AdmissionResponse</span><span class=p>{</span><span class=nx>Result</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Status</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Message</span><span class=p>:</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;could not unmarshal resouces review request: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Code</span><span class=p>:</span>    <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>}}</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;could not unmarshal resouces review request: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>respstr</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>respStructure</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;could not unmarshal resouces review response: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;could not unmarshal resouces review response: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>respstr</span><span class=p>),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>current_annotations</span> <span class=o>:=</span> <span class=nx>deploy</span><span class=p>.</span><span class=nf>GetAnnotations</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>pl</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>patch</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>current_annotations</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>pl</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>pl</span><span class=p>,</span> <span class=nx>patch</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Op</span><span class=p>:</span>   <span class=s>&#34;add&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Path</span><span class=p>:</span> <span class=s>&#34;/metadata/annotations&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Value</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>k</span><span class=p>:</span> <span class=nx>v</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=p>},</span>
</span></span><span class=line><span class=cl>				<span class=p>})</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>pl</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>pl</span><span class=p>,</span> <span class=nx>patch</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Op</span><span class=p>:</span>   <span class=s>&#34;add&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Path</span><span class=p>:</span> <span class=s>&#34;/metadata/annotations&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Value</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>deploy</span><span class=p>.</span><span class=nx>Name</span> <span class=o>+</span> <span class=s>&#34;/Allow&#34;</span><span class=p>:</span> <span class=s>&#34;true&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>annotationbyte</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>pl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>respStructure</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>v1admission</span><span class=p>.</span><span class=nx>AdmissionResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>UID</span><span class=p>:</span>     <span class=nx>req</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Allowed</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Patch</span><span class=p>:</span>   <span class=nx>annotationbyte</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>PatchType</span><span class=p>:</span> <span class=kd>func</span><span class=p>()</span> <span class=o>*</span><span class=nx>v1admission</span><span class=p>.</span><span class=nx>PatchType</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>t</span> <span class=o>:=</span> <span class=nx>v1admission</span><span class=p>.</span><span class=nx>PatchTypeJSONPatch</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=o>&amp;</span><span class=nx>t</span>
</span></span><span class=line><span class=cl>				<span class=p>}(),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Result</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Status</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Message</span><span class=p>:</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;could not unmarshal resouces review request: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Code</span><span class=p>:</span>    <span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>admissionResp</span><span class=p>.</span><span class=nx>Response</span> <span class=p>=</span> <span class=nx>respStructure</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;sending response: %s....&#34;</span><span class=p>,</span> <span class=nx>admissionResp</span><span class=p>.</span><span class=nx>Response</span><span class=p>.</span><span class=nf>String</span><span class=p>()[:</span><span class=mi>130</span><span class=p>])</span>
</span></span><span class=line><span class=cl>			<span class=nx>respByte</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>admissionResp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Can&#39;t encode response messages: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;prepare to write response...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>w</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>respByte</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Can&#39;t write response: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;could not write response: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;unsupport resouces review request type&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;unsupport resouces review request type&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;/validate&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>req</span> <span class=o>:=</span> <span class=nx>admission</span><span class=p>.</span><span class=nx>Request</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>admissionResp</span> <span class=nx>v1admission</span><span class=p>.</span><span class=nx>AdmissionReview</span>
</span></span><span class=line><span class=cl>		<span class=nx>admissionResp</span><span class=p>.</span><span class=nx>APIVersion</span> <span class=p>=</span> <span class=nx>admission</span><span class=p>.</span><span class=nx>APIVersion</span>
</span></span><span class=line><span class=cl>		<span class=nx>admissionResp</span><span class=p>.</span><span class=nx>Kind</span> <span class=p>=</span> <span class=nx>admission</span><span class=p>.</span><span class=nx>Kind</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;AdmissionReview for Kind=%v, Namespace=%v Name=%v UID=%v Operation=%v&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>req</span><span class=p>.</span><span class=nx>Kind</span><span class=p>.</span><span class=nx>Kind</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Operation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>			<span class=nx>deploy</span>  <span class=nx>appv1</span><span class=p>.</span><span class=nx>Deployment</span>
</span></span><span class=line><span class=cl>			<span class=nx>respstr</span> <span class=p>[]</span><span class=kt>byte</span>
</span></span><span class=line><span class=cl>		<span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Kind</span><span class=p>.</span><span class=nx>Kind</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=s>&#34;Deployment&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Object</span><span class=p>.</span><span class=nx>Raw</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>deploy</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>respStructure</span> <span class=o>:=</span> <span class=nx>v1admission</span><span class=p>.</span><span class=nx>AdmissionResponse</span><span class=p>{</span><span class=nx>Result</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Status</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Message</span><span class=p>:</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;could not unmarshal resouces review request: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Code</span><span class=p>:</span>    <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>}}</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;could not unmarshal resouces review request: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>respstr</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>respStructure</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;could not unmarshal resouces review response: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>					<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;could not unmarshal resouces review response: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>).</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>respstr</span><span class=p>),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>al</span> <span class=o>:=</span> <span class=nx>deploy</span><span class=p>.</span><span class=nf>GetAnnotations</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>respStructure</span> <span class=o>:=</span> <span class=nx>v1admission</span><span class=p>.</span><span class=nx>AdmissionResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>UID</span><span class=p>:</span> <span class=nx>req</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>al</span><span class=p>[</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s/Allow&#34;</span><span class=p>,</span> <span class=nx>deploy</span><span class=p>.</span><span class=nx>Name</span><span class=p>)]</span> <span class=o>==</span> <span class=s>&#34;true&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>respStructure</span><span class=p>.</span><span class=nx>Allowed</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=nx>respStructure</span><span class=p>.</span><span class=nx>Result</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Status</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Code</span><span class=p>:</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>respStructure</span><span class=p>.</span><span class=nx>Allowed</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>			<span class=nx>respStructure</span><span class=p>.</span><span class=nx>Result</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Status</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Code</span><span class=p>:</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusForbidden</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Reason</span><span class=p>:</span> <span class=kd>func</span><span class=p>()</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>StatusReason</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>StatusReasonForbidden</span>
</span></span><span class=line><span class=cl>				<span class=p>}(),</span>
</span></span><span class=line><span class=cl>				<span class=nx>Message</span><span class=p>:</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;the resource %s couldn&#39;t to allow entry.&#34;</span><span class=p>,</span> <span class=nx>deploy</span><span class=p>.</span><span class=nx>Kind</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>admissionResp</span><span class=p>.</span><span class=nx>Response</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>respStructure</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;sending response: %s....&#34;</span><span class=p>,</span> <span class=nx>admissionResp</span><span class=p>.</span><span class=nx>Response</span><span class=p>.</span><span class=nf>String</span><span class=p>()[:</span><span class=mi>130</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=nx>respByte</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>admissionResp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Can&#39;t encode response messages: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;prepare to write response...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>w</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>respByte</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Can&#39;t write response: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;could not write response: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>cert</span><span class=p>,</span> <span class=nx>key</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>cert</span> <span class=p>=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;TLS_CERT&#34;</span><span class=p>);</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cert</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cert</span> <span class=p>=</span> <span class=s>&#34;./tls/tls.crt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>key</span> <span class=p>=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;TLS_KEY&#34;</span><span class=p>);</span> <span class=nb>len</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>key</span> <span class=p>=</span> <span class=s>&#34;./tls/tls.key&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ca</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>tls</span><span class=p>.</span><span class=nf>LoadX509KeyPair</span><span class=p>(</span><span class=nx>cert</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>server</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Addr</span><span class=p>:</span> <span class=s>&#34;:81&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>TLSConfig</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>tls</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Certificates</span><span class=p>:</span> <span class=p>[]</span><span class=nx>tls</span><span class=p>.</span><span class=nx>Certificate</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>ca</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>httpserver</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>NewServeMux</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>httpserver</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/validate&#34;</span><span class=p>,</span> <span class=nx>serve</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>httpserver</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/mutate&#34;</span><span class=p>,</span> <span class=nx>serve</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>httpserver</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/ping&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s %s&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>RequestURI</span><span class=p>,</span> <span class=s>&#34;pong&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprint</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;pong&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=nx>server</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>=</span> <span class=nx>httpserver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>server</span><span class=p>.</span><span class=nf>ListenAndServeTLS</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Failed to listen and serve webhook server: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;starting serve.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>signalChan</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>signalChan</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>signalChan</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Got shut signal, shutting...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>server</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>());</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;HTTP server Shutdown: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>对应的Dockerfile</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>docker</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl><span class=k>FROM</span><span class=s> golang:alpine AS builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>MAINTAINER</span><span class=s> cylon</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /admission</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./ /admission<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENV</span> GOPROXY https://goproxy.cn,direct<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    sed -i <span class=s1>&#39;s/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g&#39;</span> /etc/apk/repositories <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    apk add upx  <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nv>GOOS</span><span class=o>=</span>linux <span class=nv>GOARCH</span><span class=o>=</span>amd64 <span class=nv>CGO_ENABLED</span><span class=o>=</span><span class=m>0</span> go build -ldflags <span class=s2>&#34;-s -w&#34;</span> -o webhook main.go <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    upx -1 webhook <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    chmod +x webhook<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> alpine AS runner</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /go/admission</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /admission/webhook .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>VOLUME</span> <span class=p>[</span><span class=s2>&#34;/admission&#34;</span><span class=p>]</span></span></span></code></pre></td></tr></table></div></div></div></div><p>集群内部部署所需的资源清单</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>admission-webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>admission-webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>81</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>81</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>simple-webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>simple-webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>simple-webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>simple-webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>simple-webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>cylonchau/simple-webhook:v0.0.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;./webhook&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;TLS_CERT&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./tls/tls.crt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;TLS_KEY&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;./tls/tls.key&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NS_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>metadata.namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>81</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tlsdir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/go/admission/tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tlsdir</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>admissionregistration.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>MutatingWebhookConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;pod-policy.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>webhooks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;pod-policy.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>   </span><span class=p>[</span><span class=s2>&#34;apps&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 拦截资源的Group &#34;&#34; 表示 core。&#34;*&#34; 表示所有。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>apiVersions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;v1&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 拦截资源的版本</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>operations</span><span class=p>:</span><span class=w>  </span><span class=p>[</span><span class=s2>&#34;CREATE&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 什么请求下拦截</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>   </span><span class=p>[</span><span class=s2>&#34;deployments&#34;</span><span class=p>]</span><span class=w>  </span><span class=c># 拦截什么资源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scope</span><span class=p>:</span><span class=w>       </span><span class=s2>&#34;Namespaced&#34;</span><span class=w> </span><span class=c># 生效的范围，cluster还是namespace &#34;*&#34;表示没有范围限制。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>clientConfig</span><span class=p>:</span><span class=w> </span><span class=c># 我们部署的webhook服务，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://10.0.0.1:81/mutate&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      service: # service是在cluster-in模式下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#        namespace: &#34;default&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#        name: &#34;admission-webhook&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#        port: 81 # 服务的端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#        path: &#34;/mutate&#34; # path是对应用于验证的接口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># caBundle是提供给 admission webhook CA证书</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>caBundle</span><span class=p>:</span><span class=w> </span><span class=l>Put you CA (base64 encode) in here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>admissionReviewVersions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;v1&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>sideEffects</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w> </span><span class=c># 1-30s直接，表示请求api的超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>admissionregistration.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ValidatingWebhookConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;valipod-policy.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>webhooks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;valipod-policy.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>   </span><span class=p>[</span><span class=s2>&#34;apps&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 拦截资源的Group &#34;&#34; 表示 core。&#34;*&#34; 表示所有。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>apiVersions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;v1&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 拦截资源的版本</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>operations</span><span class=p>:</span><span class=w>  </span><span class=p>[</span><span class=s2>&#34;CREATE&#34;</span><span class=p>]</span><span class=w> </span><span class=c># 什么请求下拦截</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>   </span><span class=p>[</span><span class=s2>&#34;deployments&#34;</span><span class=p>]</span><span class=w>  </span><span class=c># 拦截什么资源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>scope</span><span class=p>:</span><span class=w>       </span><span class=s2>&#34;Namespaced&#34;</span><span class=w> </span><span class=c># 生效的范围，cluster还是namespace &#34;*&#34;表示没有范围限制。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clientConfig</span><span class=p>:</span><span class=w> </span><span class=c># 我们部署的webhook服务，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#      service: # service是在cluster-in模式下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#        namespace: &#34;default&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#        name: &#34;admission-webhook&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#        port: 81 # 服务的端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#        path: &#34;/mutate&#34; # path是对应用于验证的接口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># caBundle是提供给 admission webhook CA证书</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>caBundle</span><span class=p>:</span><span class=w> </span><span class=l>Put you CA (base64 encode) in here</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>admissionReviewVersions</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;v1&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sideEffects</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w> </span><span class=c># 1-30s直接，表示请求api的超时时间</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=这里需要主义的问题>这里需要主义的问题<a hidden class=anchor aria-hidden=true href=#这里需要主义的问题>#</a></h4><p><strong>证书问题</strong></p><p>如果需要 <code>cluster-in</code> ，那么则需要对对应webhookconfig资源配置 <code>service</code> ；如果使用的是外部部署，则需要配置对应访问地址，如：<em>&ldquo;https://xxxx:port/method&rdquo;</em></p><p>这两种方式的证书均需要对应的 <code>subjectAltName</code> ，<code>cluster-in</code> 模式 需要对应service名称，如，至少包含<code>serviceName.NS.svc</code> 这一个域名。</p><p>下面就是证书类问题的错误</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Failed calling webhook, failing closed pod-policy.example.com: failed calling webhook &#34;pod-policy.example.com&#34;: Post https://admission-webhook.default.svc:81/mutate?timeout=5s: x509: certificate signed by unknown authority (possibly because of &#34;crypto/rsa: verification error&#34; while trying to verify candidate authority certificate &#34;admission-webhook-ca&#34;)</span></span></code></pre></td></tr></table></div></div></div></div><p><strong>相应信息问题</strong></p><p>上面我们了解到的APIServer是去发出 <code>v1admission.AdmissionReview</code> 也就是 Request 和 Response类型的，所以，为了更清晰的表示出问题所在，需要对响应格式中的 <code>Reason</code> 与 <code>Message</code> 配置，这也就是我们在客户端看到的报错信息。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Status</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Code</span><span class=p>:</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusForbidden</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Reason</span><span class=p>:</span> <span class=kd>func</span><span class=p>()</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>StatusReason</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>StatusReasonForbidden</span>
</span></span><span class=line><span class=cl>    <span class=p>}(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>Message</span><span class=p>:</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;the resource %s couldn&#39;t to allow entry.&#34;</span><span class=p>,</span> <span class=nx>deploy</span><span class=p>.</span><span class=nx>Kind</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>通过上面的设置用户可以看到下列错误</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f nginx.yaml 
</span></span><span class=line><span class=cl>Error from server <span class=o>(</span>Forbidden<span class=o>)</span>: error when creating <span class=s2>&#34;nginx.yaml&#34;</span>: admission webhook <span class=s2>&#34;valipod-policy.example.com&#34;</span> denied the request: the resource Deployment couldn<span class=err>&#39;</span>t to allow entry.</span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>注：必须的参数还包含，UID，allowed，这两个是必须的，上面阐述的只是对用户友好的提示信息</p></blockquote><p>下面的报错就是对相应格式设置错误</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>Error</span> <span class=nx>from</span> <span class=nf>server</span> <span class=p>(</span><span class=nx>InternalError</span><span class=p>):</span> <span class=kt>error</span> <span class=nx>when</span> <span class=nx>creating</span> <span class=s>&#34;nginx.yaml&#34;</span><span class=p>:</span> <span class=nx>Internal</span> <span class=kt>error</span> <span class=nx>occurred</span><span class=p>:</span> <span class=nx>failed</span> <span class=nx>calling</span> <span class=nx>webhook</span> <span class=s>&#34;pod-policy.example.com&#34;</span><span class=p>:</span> <span class=nx>the</span> <span class=nx>server</span> <span class=nx>rejected</span> <span class=nx>our</span> <span class=nx>request</span> <span class=k>for</span> <span class=nx>an</span> <span class=nx>unknown</span> <span class=nx>reason</span></span></span></code></pre></td></tr></table></div></div></div></div><p><strong>相应信息版本问题</strong></p><p>相应信息也需要指定一个版本，这个与请求来的结构中拿即可</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>admissionResp</span><span class=p>.</span><span class=nx>APIVersion</span> <span class=p>=</span> <span class=nx>admission</span><span class=p>.</span><span class=nx>APIVersion</span>
</span></span><span class=line><span class=cl><span class=nx>admissionResp</span><span class=p>.</span><span class=nx>Kind</span> <span class=p>=</span> <span class=nx>admission</span><span class=p>.</span><span class=nx>Kind</span></span></span></code></pre></td></tr></table></div></div></div></div><p>下面是没有为对应相应信息配置对应KV的值出现的报错</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Error from server (InternalError): error when creating &#34;nginx.yaml&#34;: Internal error occurred: failed calling webhook &#34;pod-policy.example.com&#34;: expected webhook response of admission.k8s.io/v1, Kind=AdmissionReview, got /, Kind=</span></span></code></pre></td></tr></table></div></div></div></div><p><strong>关于patch</strong></p><p>kubernetes中patch使用的是特定的规范，如 <code>jsonpatch</code></p><blockquote><p>kubernetes当前唯一支持的 <code>patchType</code> 是 <code>JSONPatch</code>。 有关更多详细信息，请参见 <a href=https://jsonpatch.com/ target=_blank rel="noopener nofollow noreferrer">JSON patch</a></p><p>对于 <code>jsonpatch</code> 是一个固定的类型，在go中必须定义其结构体</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>json</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;op&#34;</span><span class=p>:</span> <span class=s2>&#34;add&#34;</span><span class=p>,</span> <span class=c1>// 做什么操作
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;/spec/replicas&#34;</span><span class=p>,</span> <span class=c1>// 操作的路径
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=mi>3</span> <span class=c1>// 对应添加的key value
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div></blockquote><p>下面就是字符串类型设置为布尔型产生的报错</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Error from server <span class=o>(</span>InternalError<span class=o>)</span>: error when creating <span class=s2>&#34;nginx.yaml&#34;</span>: Internal error occurred: v1.Deployment.ObjectMeta: v1.ObjectMeta.Annotations: ReadString: expects <span class=s2>&#34; or n, but found t, error found in #10 byte of ...|t/Allow&#34;</span>:true<span class=o>}</span>,<span class=s2>&#34;crea|..., bigger context ...|tadata&#34;</span>:<span class=o>{</span><span class=s2>&#34;annotations&#34;</span>:<span class=o>{</span><span class=s2>&#34;nginx-deployment/Allow&#34;</span>:true<span class=o>}</span>,<span class=s2>&#34;creationTimestamp&#34;</span>:null,<span class=s2>&#34;managedFields&#34;</span>:<span class=o>[{</span><span class=s2>&#34;m|..</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=准备证书>准备证书<a hidden class=anchor aria-hidden=true href=#准备证书>#</a></h3><p>Ubuntu</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>touch ./demoCAindex.txt
</span></span><span class=line><span class=cl>touch ./demoCA/serial 
</span></span><span class=line><span class=cl>touch ./demoCA/crlnumber
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=m>01</span> &gt; ./demoCA/serial
</span></span><span class=line><span class=cl>mkdir ./demoCA/newcerts
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl genrsa -out cakey.pem <span class=m>2048</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl req -new <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-x509 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-key cakey.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-out cacert.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-days <span class=m>3650</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-subj <span class=s2>&#34;/CN=admission webhook ca&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl genrsa -out tls.key <span class=m>2048</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl req -new <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-key tls.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-subj <span class=s2>&#34;/CN=admission webhook client&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-reqexts webhook <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-config &lt;<span class=o>(</span>cat /etc/ssl/openssl.cnf <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	&lt;<span class=o>(</span><span class=nb>printf</span> <span class=s2>&#34;[webhook]\nsubjectAltName=DNS: admission-webhook, DNS: admission-webhook.default.svc, DNS: admission-webhook.default.svc.cluster.local, IP:10.0.0.1,  IP:10.0.0.4&#34;</span><span class=o>))</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-out tls.csr
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/= match/= optional/g&#39;</span> /etc/ssl/openssl.cnf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl ca <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-in tls.csr <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-cert cacert.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-keyfile cakey.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-out tls.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-days <span class=m>300</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-extensions webhook <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-extfile &lt;<span class=o>(</span>cat /etc/ssl/openssl.cnf <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    &lt;<span class=o>(</span><span class=nb>printf</span> <span class=s2>&#34;[webhook]\nsubjectAltName=DNS: admission-webhook, DNS: admission-webhook.default.svc, DNS: admission-webhook.default.svc.cluster.local, IP:10.0.0.1,  IP:10.0.0.4&#34;</span><span class=o>))</span></span></span></code></pre></td></tr></table></div></div></div></div><p>CentOS</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>touch /etc/pki/CA/index.txt
</span></span><span class=line><span class=cl>touch /etc/pki/CA/serial <span class=c1># 下一个要颁发的编号 16进制</span>
</span></span><span class=line><span class=cl>touch /etc/pki/CA/crlnumber
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=m>01</span> &gt; /etc/pki/CA/serial
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl req -new <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-x509 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-key cakey.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-out cacert.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-days <span class=m>3650</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-subj <span class=s2>&#34;/CN=admission webhook ca&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl genrsa -out tls.key <span class=m>2048</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl req -new <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-key tls.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-subj <span class=s2>&#34;/CN=admission webhook client&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-reqexts webhook <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-config &lt;<span class=o>(</span>cat /etc/pki/tls/openssl.cnf <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	&lt;<span class=o>(</span><span class=nb>printf</span> <span class=s2>&#34;[webhook]\nsubjectAltName=DNS: admission-webhook, DNS: admission-webhook.default.svc, DNS: admission-webhook.default.svc.cluster.local, IP:10.0.0.1,  IP:10.0.0.4&#34;</span><span class=o>))</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-out tls.csr
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/= match/= optional/g&#39;</span> /etc/ssl/openssl.cnf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl ca <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-in tls.csr <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-cert cacert.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-keyfile cakey.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-out tls.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-days <span class=m>300</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-extensions webhook <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	-extfile &lt;<span class=o>(</span>cat /etc/pki/tls/openssl.cnf <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    &lt;<span class=o>(</span><span class=nb>printf</span> <span class=s2>&#34;[webhook]\nsubjectAltName=DNS: admission-webhook, DNS: admission-webhook.default.svc, DNS: admission-webhook.default.svc.cluster.local, IP:10.0.0.1,  IP:10.0.0.4&#34;</span><span class=o>))</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=通过部署测试结果>通过部署测试结果<a hidden class=anchor aria-hidden=true href=#通过部署测试结果>#</a></h3><p>可以看到我们自己注入的 annotation <code>nginx-deployment/Allow: true</code>，在该示例中，仅为演示过程，而不是真的策略，实际环境中可以根据情况进行定制自己的策略。</p><p>结果可以看出，当在 <code>mutating</code> 中不通过，即缺少对应的 annotation 标签 , 则 <code>validating</code> 会不允许准入</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl describe deploy nginx-deployment
</span></span><span class=line><span class=cl>Name:                   nginx-deployment
</span></span><span class=line><span class=cl>Namespace:              default
</span></span><span class=line><span class=cl>CreationTimestamp:      Mon, <span class=m>11</span> Jul <span class=m>2022</span> 20:25:16 +0800
</span></span><span class=line><span class=cl>Labels:                 &lt;none&gt;
</span></span><span class=line><span class=cl>Annotations:            deployment.kubernetes.io/revision: <span class=m>1</span>
</span></span><span class=line><span class=cl>                        nginx-deployment/Allow: <span class=nb>true</span>
</span></span><span class=line><span class=cl>Selector:               <span class=nv>app</span><span class=o>=</span>nginx
</span></span><span class=line><span class=cl>Replicas:               <span class=m>1</span> desired <span class=p>|</span> <span class=m>1</span> updated <span class=p>|</span> <span class=m>1</span> total <span class=p>|</span> <span class=m>1</span> available <span class=p>|</span> <span class=m>0</span> unavailable
</span></span><span class=line><span class=cl>StrategyType:           RollingUpdate
</span></span><span class=line><span class=cl>MinReadySeconds:        <span class=m>0</span>
</span></span><span class=line><span class=cl>RollingUpdateStrategy:  25% max unavailable, 25% max surge
</span></span><span class=line><span class=cl>Pod Template:
</span></span><span class=line><span class=cl>  Labels:  <span class=nv>app</span><span class=o>=</span>nginx
</span></span><span class=line><span class=cl>  Containers:
</span></span><span class=line><span class=cl>   nginx:
</span></span><span class=line><span class=cl>    Image:        nginx:1.14.2</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ul><li><p><a href=https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/ target=_blank rel="noopener nofollow noreferrer">extensible admission controllers</a></p></li><li><p><a href=https://developer.aliyun.com/article/703438 target=_blank rel="noopener nofollow noreferrer">K8S client-go Patch example</a></p></li><li><p><a href=https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/extensible-admission-controllers/#response target=_blank rel="noopener nofollow noreferrer">admission controllers response</a></p></li><li><p><a href=https://kubernetes.io/blog/2019/03/21/a-guide-to-kubernetes-admission-controllers/ target=_blank rel="noopener nofollow noreferrer">a guide to kubernetes admission controllers</a></p></li></ul></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：深入理解Kubernetes 4A - Admission Control源码解析</p><p>文章链接：<a href=https://www.oomkill.com/2022/07/ch33-admission-webhook/ target=_blank>https://www.oomkill.com/2022/07/ch33-admission-webhook/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2022/06/ch27-leader-election/><span>源码分析Kubernetes HA机制 - leader election</span></a></li><li><a href=/2022/06/ch15-controller-runtime/><span>源码分析Kubernetes controller组件 - controller-runtime</span></a></li><li><a href=/2022/06/ch04-apiserver-aggregation/><span>扩展Kubernetes API的另一种方式 - APIServer aggregation</span></a></li><li><a href=/2022/06/ch14-code-generator/><span>kubernetes代码生成器 - code-generator</span></a></li><li><a href=/2022/06/ch12-controller/><span>手写一个kubernetes controller</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes-develop/>Kubernetes Develop</a></li><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2022/07/ch16-scheduler/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>kubernetes的决策组件 - kube-scheduler原理分析</span>
</a><a class=next href=https://www.oomkill.com/2022/07/visio-custom-icon/><span class=title></span>
<span>如何为visio扩展云服务图标&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/blogs","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch33 admission webhook","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>