<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>深入理解Kubernetes 4A - Audit源码解析 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="kubernetes,kubernetes Audit,k8s Audit webhook,4A"><meta name=description content="本文是关于Kubernetes 4A解析的第4章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A
Overview 审计是信息系统中非常重要的一部分，Kubernetes 1.11中也增加了审计 (Auditing) 功能，通过审计功能获得 deployment, ns,等资源操作的事件。
objective：
从设计角度了解Auditing在kubernets中是如何实现的 了解kubernetes auditing webhook 完成实验，通过webhook来收集审计日志 如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大。
Kubernetes Auditing 根据Kubernetes官方描述审计在kubernetes中是有控制平面 kube-apiserver 中产生的一个事件，记录了集群中所操作的资源，审计围绕下列几个维度来记录事件的：
发生了什么 发生的事件 谁触发的 发生动作的对象 在哪里检查到动作的 从哪触发的 处理行为是什么 审计生命周期开始于组件 kube-apiserver 准入控制阶段，在每个阶段内都会产生审计事件并经过预处理后写入后端，目前后端包含webhook与日志文件。
审计日志功能增加了 kube-apiserver 的内存消耗，因为会为每个请求存储了审计所需的上下文。内存的消耗取决于审计日志配置 [1]。
审计事件设计 审计的schema不同于资源API的设计，没有 metav1.ObjectMeta 属性，Event是一个事件的结构体，Policy是事件配置，属于kubernetes资源，在代码 k8s.io/apiserver/pkg/apis/audit/types.go 可以看到
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type Event struct { metav1."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2022/11/ch34-auditing/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2022/11/ch34-auditing/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-H94HZ5S19Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H94HZ5S19Y")</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="深入理解Kubernetes 4A - Audit源码解析"><meta property="og:description" content="本文是关于Kubernetes 4A解析的第4章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A
Overview 审计是信息系统中非常重要的一部分，Kubernetes 1.11中也增加了审计 (Auditing) 功能，通过审计功能获得 deployment, ns,等资源操作的事件。
objective：
从设计角度了解Auditing在kubernets中是如何实现的 了解kubernetes auditing webhook 完成实验，通过webhook来收集审计日志 如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大。
Kubernetes Auditing 根据Kubernetes官方描述审计在kubernetes中是有控制平面 kube-apiserver 中产生的一个事件，记录了集群中所操作的资源，审计围绕下列几个维度来记录事件的：
发生了什么 发生的事件 谁触发的 发生动作的对象 在哪里检查到动作的 从哪触发的 处理行为是什么 审计生命周期开始于组件 kube-apiserver 准入控制阶段，在每个阶段内都会产生审计事件并经过预处理后写入后端，目前后端包含webhook与日志文件。
审计日志功能增加了 kube-apiserver 的内存消耗，因为会为每个请求存储了审计所需的上下文。内存的消耗取决于审计日志配置 [1]。
审计事件设计 审计的schema不同于资源API的设计，没有 metav1.ObjectMeta 属性，Event是一个事件的结构体，Policy是事件配置，属于kubernetes资源，在代码 k8s.io/apiserver/pkg/apis/audit/types.go 可以看到
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type Event struct { metav1."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2022/11/ch34-auditing/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-24T00:00:00+00:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入理解Kubernetes 4A - Audit源码解析"><meta name=twitter:description content="本文是关于Kubernetes 4A解析的第4章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A
Overview 审计是信息系统中非常重要的一部分，Kubernetes 1.11中也增加了审计 (Auditing) 功能，通过审计功能获得 deployment, ns,等资源操作的事件。
objective：
从设计角度了解Auditing在kubernets中是如何实现的 了解kubernetes auditing webhook 完成实验，通过webhook来收集审计日志 如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大。
Kubernetes Auditing 根据Kubernetes官方描述审计在kubernetes中是有控制平面 kube-apiserver 中产生的一个事件，记录了集群中所操作的资源，审计围绕下列几个维度来记录事件的：
发生了什么 发生的事件 谁触发的 发生动作的对象 在哪里检查到动作的 从哪触发的 处理行为是什么 审计生命周期开始于组件 kube-apiserver 准入控制阶段，在每个阶段内都会产生审计事件并经过预处理后写入后端，目前后端包含webhook与日志文件。
审计日志功能增加了 kube-apiserver 的内存消耗，因为会为每个请求存储了审计所需的上下文。内存的消耗取决于审计日志配置 [1]。
审计事件设计 审计的schema不同于资源API的设计，没有 metav1.ObjectMeta 属性，Event是一个事件的结构体，Policy是事件配置，属于kubernetes资源，在代码 k8s.io/apiserver/pkg/apis/audit/types.go 可以看到
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type Event struct { metav1."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"深入理解Kubernetes 4A - Audit源码解析","item":"https://www.oomkill.com/2022/11/ch34-auditing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"深入理解Kubernetes 4A - Audit源码解析","name":"深入理解Kubernetes 4A - Audit源码解析","description":"本文是关于Kubernetes 4A解析的第4章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A\nOverview 审计是信息系统中非常重要的一部分，Kubernetes 1.11中也增加了审计 (Auditing) 功能，通过审计功能获得 deployment, ns,等资源操作的事件。\nobjective：\n从设计角度了解Auditing在kubernets中是如何实现的 了解kubernetes auditing webhook 完成实验，通过webhook来收集审计日志 如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大。\nKubernetes Auditing 根据Kubernetes官方描述审计在kubernetes中是有控制平面 kube-apiserver 中产生的一个事件，记录了集群中所操作的资源，审计围绕下列几个维度来记录事件的：\n发生了什么 发生的事件 谁触发的 发生动作的对象 在哪里检查到动作的 从哪触发的 处理行为是什么 审计生命周期开始于组件 kube-apiserver 准入控制阶段，在每个阶段内都会产生审计事件并经过预处理后写入后端，目前后端包含webhook与日志文件。\n审计日志功能增加了 kube-apiserver 的内存消耗，因为会为每个请求存储了审计所需的上下文。内存的消耗取决于审计日志配置 [1]。\n审计事件设计 审计的schema不同于资源API的设计，没有 metav1.ObjectMeta 属性，Event是一个事件的结构体，Policy是事件配置，属于kubernetes资源，在代码 k8s.io/apiserver/pkg/apis/audit/types.go 可以看到\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type Event struct { metav1.","keywords":["kubernetes","kubernetes Audit","k8s Audit webhook","4A"],"articleBody":" 本文是关于Kubernetes 4A解析的第4章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A\nOverview 审计是信息系统中非常重要的一部分，Kubernetes 1.11中也增加了审计 (Auditing) 功能，通过审计功能获得 deployment, ns,等资源操作的事件。\nobjective：\n从设计角度了解Auditing在kubernets中是如何实现的 了解kubernetes auditing webhook 完成实验，通过webhook来收集审计日志 如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大。\nKubernetes Auditing 根据Kubernetes官方描述审计在kubernetes中是有控制平面 kube-apiserver 中产生的一个事件，记录了集群中所操作的资源，审计围绕下列几个维度来记录事件的：\n发生了什么 发生的事件 谁触发的 发生动作的对象 在哪里检查到动作的 从哪触发的 处理行为是什么 审计生命周期开始于组件 kube-apiserver 准入控制阶段，在每个阶段内都会产生审计事件并经过预处理后写入后端，目前后端包含webhook与日志文件。\n审计日志功能增加了 kube-apiserver 的内存消耗，因为会为每个请求存储了审计所需的上下文。内存的消耗取决于审计日志配置 [1]。\n审计事件设计 审计的schema不同于资源API的设计，没有 metav1.ObjectMeta 属性，Event是一个事件的结构体，Policy是事件配置，属于kubernetes资源，在代码 k8s.io/apiserver/pkg/apis/audit/types.go 可以看到\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type Event struct { metav1.TypeMeta `json:\",inline\"` Level Level `json:\"level\" protobuf:\"bytes,1,opt,name=level,casttype=Level\" AuditID types.UID `json:\"auditID\" protobuf:\"bytes,2,opt,name=auditID,casttype=k8s.io/apimachinery/pkg/types.UID\"` Stage Stage `json:\"stage\" protobuf:\"bytes,3,opt,name=stage,casttype=Stage\"` RequestURI string `json:\"requestURI\" protobuf:\"bytes,4,opt,name=requestURI\"` Verb string `json:\"verb\" protobuf:\"bytes,5,opt,name=verb\"` User authnv1.UserInfo `json:\"user\" protobuf:\"bytes,6,opt,name=user\"` ImpersonatedUser *authnv1.UserInfo `json:\"impersonatedUser,omitempty\" protobuf:\"bytes,7,opt,name=impersonatedUser\"` SourceIPs []string `json:\"sourceIPs,omitempty\" protobuf:\"bytes,8,rep,name=sourceIPs\"` UserAgent string `json:\"userAgent,omitempty\" protobuf:\"bytes,16,opt,name=userAgent\"` ObjectRef *ObjectReference `json:\"objectRef,omitempty\" protobuf:\"bytes,9,opt,name=objectRef\"` // +optional ResponseStatus *metav1.Status `json:\"responseStatus,omitempty\" protobuf:\"bytes,10,opt,name=responseStatus\"` ... } 对于记录的认证事件来说，会根据请求阶段记录审计的阶段，主要分为下属集中情况，每个请求会记录其中一个验证阶段，如代码所示 [1]\ngo 1 2 3 4 5 6 7 8 9 10 11 const ( // 这个阶段是audit handler收到请求后立即生成事件的阶段，然后委托handler chain处理。 StageRequestReceived Stage = \"RequestReceived\" // 这个阶段阶段仅对长时间运行的请求如 watch // 将在发送响应标头后，响应正文之前生成的阶段 StageResponseStarted Stage = \"ResponseStarted\" // 这个阶段是发送相应体后的事件。 StageResponseComplete Stage = \"ResponseComplete\" // 如果程序出现panic，则触发这个阶段 StagePanic Stage = \"Panic\" ) 审计工作流程 审计真正工作的地方在 k8s.io/apiserver/pkg/endpoints/filters/audit.go.WithAudit 函数，下面对与官方文档说明与这个实际代码进行结合\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 func WithAudit(handler http.Handler, sink audit.Sink, policy audit.PolicyRuleEvaluator, longRunningCheck request.LongRunningRequestCheck) http.Handler { // sink是一个backend（webhook 或 日志），policy则是自定义的事件配置 // 如果两者之一未配置，则不会使用审计功能 if sink == nil || policy == nil { return handler } return http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) { // 通过给定的配置与请求构建出一个事件 context // 这里可以看到 auditContext, err := evaluatePolicyAndCreateAuditEvent(req, policy) if err != nil { utilruntime.HandleError(fmt.Errorf(\"failed to create audit event: %v\", err)) responsewriters.InternalError(w, req, errors.New(\"failed to create audit event\")) return } // 下面代码可以看出是对事件context进行构建，与拿到来自请求Context ev := auditContext.Event if ev == nil || req.Context() == nil { handler.ServeHTTP(w, req) return } req = req.WithContext(audit.WithAuditContext(req.Context(), auditContext)) ctx := req.Context() omitStages := auditContext.RequestAuditConfig.OmitStages // 这里到StageRequestReceived阶段，如果是收到请求阶段则通过注入的后端进行处理 ev.Stage = auditinternal.StageRequestReceived if processed := processAuditEvent(ctx, sink, ev, omitStages); !processed { audit.ApiserverAuditDroppedCounter.WithContext(ctx).Inc() responsewriters.InternalError(w, req, errors.New(\"failed to store audit event\")) return } // 拦截watch类长请求的状态码 var longRunningSink audit.Sink if longRunningCheck != nil { ri, _ := request.RequestInfoFrom(ctx) if longRunningCheck(req, ri) { longRunningSink = sink } } respWriter := decorateResponseWriter(ctx, w, ev, longRunningSink, omitStages) // send audit event when we leave this func, either via a panic or cleanly. In the case of long // running requests, this will be the second audit event. // 在离开函数前会处理 ResponseStarted、ResponseComplete、Panic这三个阶段 defer func() { if r := recover(); r != nil { defer panic(r) // 当前发生panic的请求 ev.Stage = auditinternal.StagePanic ev.ResponseStatus = \u0026metav1.Status{ Code: http.StatusInternalServerError, Status: metav1.StatusFailure, Reason: metav1.StatusReasonInternalError, Message: fmt.Sprintf(\"APIServer panic'd: %v\", r), } processAuditEvent(ctx, sink, ev, omitStages) return } // if no StageResponseStarted event was sent b/c neither a status code nor a body was sent, fake it here // But Audit-Id http header will only be sent when http.ResponseWriter.WriteHeader is called. fakedSuccessStatus := \u0026metav1.Status{ Code: http.StatusOK, Status: metav1.StatusSuccess, Message: \"Connection closed early\", } if ev.ResponseStatus == nil \u0026\u0026 longRunningSink != nil { ev.ResponseStatus = fakedSuccessStatus ev.Stage = auditinternal.StageResponseStarted processAuditEvent(ctx, longRunningSink, ev, omitStages) } // ResponseStarted 在响应头发送后，响应体发送前的事件。watch会触发他 ev.Stage = auditinternal.StageResponseComplete if ev.ResponseStatus == nil { // 没有相应状态 正是上面构造的fakedSuccessStatus ev.ResponseStatus = fakedSuccessStatus } // 将事件发送到后端 processAuditEvent(ctx, sink, ev, omitStages) }() handler.ServeHTTP(respWriter, req) }) } 在评估请求时，会调用 GetAuthorizerAttributes(ctx) ，这里通过授权记录然后来通过给定的审计配置来\n当在将事件发送到后端时，使用 processAuditEvent() 函数，最终修改时间后会转交至后端函数，例如webhook，会请求后端配置的webhook url的客户端，最终被执行 return sink.ProcessEvents(ev)\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (b *backend) processEvents(ev ...*auditinternal.Event) error { var list auditinternal.EventList for _, e := range ev { list.Items = append(list.Items, *e) } return b.w.WithExponentialBackoff(context.Background(), func() rest.Result { trace := utiltrace.New(\"Call Audit Events webhook\", utiltrace.Field{\"name\", b.name}, utiltrace.Field{\"event-count\", len(list.Items)}) // Only log audit webhook traces that exceed a 25ms per object limit plus a 50ms request overhead allowance. The high per object limit used here is primarily to allow enough time for the serialization/deserialization of audit events, which contain nested request and response objects plus additional event fields. defer trace.LogIfLong(time.Duration(50+25*len(list.Items)) * time.Millisecond) return b.w.RestClient.Post().Body(\u0026list).Do(context.TODO()) }).Error() } 在 k8s.io/apiserver/pkg/endpoints/filters/audit.go.evaluatePolicyAndCreateAuditEvent 会评估请求的级别和规则，而 k8s.io/apiserver/pkg/audit/policy/checker.go\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func (p *policyRuleEvaluator) EvaluatePolicyRule(attrs authorizer.Attributes) auditinternal.RequestAuditConfigWithLevel { for _, rule := range p.Rules { // 评估则是评估用户与用户组，verb，ns,非API资源 /metrics /healthz if ruleMatches(\u0026rule, attrs) { // 通过后，则将这条规则与配置返回 return auditinternal.RequestAuditConfigWithLevel{ Level: rule.Level, RequestAuditConfig: auditinternal.RequestAuditConfig{ OmitStages: rule.OmitStages, OmitManagedFields: isOmitManagedFields(\u0026rule, p.OmitManagedFields), }, } } } // 如果条件都不满足，则构建一个 return auditinternal.RequestAuditConfigWithLevel{ Level: DefaultAuditLevel, RequestAuditConfig: auditinternal.RequestAuditConfig{ OmitStages: p.OmitStages, OmitManagedFields: p.OmitManagedFields, }, } } k8s.io/apiserver/pkg/audit/request.go.NewEventFromRequest 创建出审计事件对象被上面 evaluatePolicyAndCreateAuditEvent 返回\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // evaluatePolicyAndCreateAuditEvent is responsible for evaluating the audit // policy configuration applicable to the request and create a new audit // event that will be written to the API audit log. // - error if anything bad happened func evaluatePolicyAndCreateAuditEvent(req *http.Request, policy audit.PolicyRuleEvaluator) (*audit.AuditContext, error) { ctx := req.Context() attribs, err := GetAuthorizerAttributes(ctx) if err != nil { return nil, fmt.Errorf(\"failed to GetAuthorizerAttributes: %v\", err) } ls := policy.EvaluatePolicyRule(attribs) audit.ObservePolicyLevel(ctx, ls.Level) if ls.Level == auditinternal.LevelNone { // Don't audit. return \u0026audit.AuditContext{ RequestAuditConfig: ls.RequestAuditConfig, }, nil } requestReceivedTimestamp, ok := request.ReceivedTimestampFrom(ctx) if !ok { requestReceivedTimestamp = time.Now() } ev, err := audit.NewEventFromRequest(req, requestReceivedTimestamp, ls.Level, attribs) if err != nil { return nil, fmt.Errorf(\"failed to complete audit event from request: %v\", err) } return \u0026audit.AuditContext{ RequestAuditConfig: ls.RequestAuditConfig, Event: ev, }, nil } 到这里，已经清楚的了解到，Kubernetes审计工作与什么位置了，而对于Kubernetes准入给出的登录（Authentication），授权 (Authorization) 与 准入控制 (Admission control) 三个阶段来说，Audition 位于授权之后，正如下图所示，而这个真正的流程在kubernetes中有个属于叫 handler chain 整个链条中，准入与审计只是其中一部分。\n图：Kubernetes 4A 的 handler chain\n由图再结合代码可以看出，所有的客户端访问API都需要经过完整经由整个链条，而 Auditing 事件的构建是需要获取经由验证过的用户等资源构建出的事件，首次发生的为 StageRequestReceived ，这将在收到请求后执行，而由代码又可知，因为在最终结束掉整个请求时会执行 WithAudit 函数，这就为 StageResponseComplete 与 StageResponseStarted 这两个阶段被执行，而这个将发生在被注册的 handler 完成后，也就是 Admission control 后因为 AC 是在每个真实REST中被执行。TODO\n审计策略级别 [2] 审计策略级别是控制审计记录将记录那些对象的数据内容，当事件被处理时，会按照配置的审计规则进行比较。而使用该功能需要 kube-apiserver 开启参数 --audit-policy-file 指定对应的配置，如果未指定则默认不记录任何事件，可供定义的级别有四个，被定义在 k8s.io/apiserver/pkg/apis/audit/v1/types.go 中\ngo 1 2 3 4 5 6 7 8 9 10 11 12 const ( // LevelNone disables auditing LevelNone Level = \"None\" // LevelMetadata provides the basic level of auditing. LevelMetadata Level = \"Metadata\" // LevelRequest provides Metadata level of auditing, and additionally // logs the request object (does not apply for non-resource requests). LevelRequest Level = \"Request\" // LevelRequestResponse provides Request level of auditing, and additionally // logs the response object (does not apply for non-resource requests). LevelRequestResponse Level = \"RequestResponse\" ) None： 不记录符合该规则的事件 Metadata：只记录请求元数据（如User, timestamp, resources, verb），不记录请求和响应体。 Request：记录事件元数据和请求体，不记录响应体。 RequestResponse： 记录事件元数据，请求和响应体 下面是Kubernetes官网给出的 Policy 的配置 [2]\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 apiVersion: audit.k8s.io/v1 # This is required. kind: Policy # omitStages 代表忽略该阶段所有请求事件 # RequestReceived 这里配置的指在RequestReceived阶段忽略所有请求事件 omitStages: - \"RequestReceived\" rules: # 记录将以RequestResponse级别的格式记录pod更改 - level: RequestResponse resources: - group: \"\" # 这里资源的配置必须与RBAC配置的一致，pods将不支持pods/log这类子资源 resources: [\"pods\"] # 如果需要配置子资源按照下列方式 - level: Metadata resources: - group: \"\" resources: [\"pods/log\", \"pods/status\"] # 不记录的资源为controller-leader的configmaps资源的请求 - level: None resources: - group: \"\" resources: [\"configmaps\"] resourceNames: [\"controller-leader\"] # 不记录用户为 \"system:kube-proxy\" 发起的对 endpoints与services资源的watch请求事件 - level: None users: [\"system:kube-proxy\"] verbs: [\"watch\"] resources: - group: \"\" # core API group resources: [\"endpoints\", \"services\"] # 每个登录成功的用户，都会被追加一个用户组为 \"system:authenticated\" # 下述规则为不记录包含非资源类型的URL的已认证请求 - level: None userGroups: [\"system:authenticated\"] nonResourceURLs: - \"/api*\" # Wildcard matching. - \"/version\" # 记录kube-system名称空间configmap更改事件的请求体与元数据 - level: Request resources: - group: \"\" # core API group resources: [\"configmaps\"] # This rule only applies to resources in the \"kube-system\" namespace. # The empty string \"\" can be used to select non-namespaced resources. namespaces: [\"kube-system\"] # 事件将记录所有名称空间内对于configmap与secret资源改变的元数据 - level: Metadata resources: - group: \"\" # core API group resources: [\"secrets\", \"configmaps\"] # 记录对group为core与extensions下的资源类型请求的 请求体与元数据（request级别） - level: Request resources: - group: \"\" # core API group - group: \"extensions\" # Version of group should NOT be included. # 这种属于泛规则，会记录所有上述其他之外的所有类型请求的元数据 # 类似于授权，小权限在前，* 最后 - level: Metadata # Long-running requests like watches that fall under this rule will not # generate an audit event in RequestReceived. omitStages: - \"RequestReceived\" Backend [3] kubernetes目前为Auditing 提供了两个后端，日志方式与webhook方式，kubernetes审计事件会遵循 audit.k8s.io 结构写入到后端。\n日志模式配置 启用日志模式只需要配置几个参数 [4]\n--audit-log-path 写入审计事件的日志路径。这个是必须配置的否则默认输出到STDOUT --audit-log-maxage 审计日志文件保留的最大天数 --audit-log-maxbackup 审计日志保留的的最大数量 --audit-log-maxsize 审计日志文件最大大小（单位M）大于会切割 例如配置\nbash 1 2 3 --audit-policy-file=/etc/kubernetes/audit-policy.yaml \\ --audit-log-path=/var/log/kubernetes/audit.log \\ --audit-log-maxsize=20M webhook [5] webhook是指审计事件将由 kube-apiserver 发送到webhook服务中记录，开启webhook只需要配置 --audit-webhook-config-file 与 --audit-policy-file 两个参数，而其他的则是对该模式的辅助\n--audit-webhook-config-file ：webhook的配置文件，格式是kubeconfig类型，所有的信息不是kubernetes api配置，而是webhook相关信息\n--audit-webhook-initial-backoff ：第一次失败后重试事件，随后仍失败后将以指数方式退避重试\n--audit-webhook-mode ：发送至webhook的模式。 batch, blocking, blocking-strict 。\n例如配置\nyaml 1 2 3 --audit-policy-file=/etc/kubernetes/audit-policy.yaml \\ --audit-webhook-config-file=/etc/kubernetes/auth/audit-webhook.yaml \\ --audit-webhook-mode=batch \\ 对于initialBackoff 的退避重试则如代码所示 k8s.io/apiserver/pkg/server/options/audit.go\ngo 1 2 3 4 5 6 7 8 9 func (o *AuditWebhookOptions) newUntruncatedBackend(customDial utilnet.DialFunc) (audit.Backend, error) { groupVersion, _ := schema.ParseGroupVersion(o.GroupVersionString) webhook, err := pluginwebhook.NewBackend(o.ConfigFile, groupVersion, webhook.DefaultRetryBackoffWithInitialDelay(o.InitialBackoff), customDial) if err != nil { return nil, fmt.Errorf(\"initializing audit webhook: %v\", err) } webhook = o.BatchOptions.wrapBackend(webhook) return webhook, nil } 在函数 k8s.io/apiserver/pkg/util/webhook/webhook.go.DefaultRetryBackoffWithInitialDelay 中看到 通过 wait.Backoff 进行的\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 return wait.Backoff{ // 时间间隔，用于调用 Step 方法时返回的时间间隔 Duration: initialBackoffDelay, // 用于计算下次的时间间隔，不能为负数 // Factor 大于 0 时，Backoff 在计算下次的时间间隔时都会根据 // Duration * Factor，Factor * Duration 不能大于 Cap Factor: 1.5, // 抖动，Jitter \u003e 0 时，每次迭代的时间间隔都会额外加上 0 - Duration * Jitter 的随机时间, // 并且抖动出的时间不会设置为 Duration，而且不受 Caps 的限制 Jitter: 0.2, // 进行指数回退(*Factor) 操作的次数 // 当 Factor * Duration \u003e Cap 时 Steps 会被设置为 0, Duration 设置为 Cap // 也就是说后续的迭代时间间隔都会返回 Duration Steps: 5, // 还有一个cap（Cap time.Duration），是最大的时间间隔 } 批处理 日志后端与webhook后端都支持批处理模式，默认值为webhook默认开启batch，而log则被禁用\n--audit-log-mode/--audit-webhook-mode ：参数通过将webhook替换为log则为对应的 batch 模式的参数，可以通过 kube-apiserver --help|grep \"audit\"|grep batch 查看 batch 默认值，缓冲事件进行异步批量处理 --audit-webhook-batch-buffer-size：批处理之前要缓冲的事件数。如果传入事件的溢出，则被丢弃。 --audit-webhook-batch-max-size：定义每一批中的最大事件数 --audit-webhook-batch-max-wait：批处理队列未满时等待的事件，到时强制写入一次 --audit-webhook-batch-throttle-qps：定义每秒最大平均批次 --audit-webhook-batch-throttle-burst：如果之前还没使用throttle-qps之前，发送的最大批数，通常情况下为第一次启动时生效的参数 blocking 阻止 apiserver 处理每个单独事件 blocking-strict：与 blocking 相同，但当 RequestReceived 阶段的审计日志记录失败时，对 kube-apiserver 的整个请求都将失败 参数调整 适当的调整参数与策略可以有效适应 kuber-apiserver 的负载，如在记录日志时应只记录所需的事件，而不是所有的事件，这样可以避免 APIServer不必要开销，例如：\n每个请求存在多个阶段，而审计时其实不关心响应等信息，可以只记录 RequestReceived 的 metadata 级别。 “pods/log”, “pods/status” 在记录时应该区分子资源类型，而不要直接写 pods 或 pods/* kubernetes系统组件内的事件如果没有特殊要求可以不记录 对于资源类型，如configmap的请求其实没必要记录 审计记录应严格按照外部用户记录，而不是所有请求 如何适配APIServer的负载能力，正如官方给的示例一样，如果 kube-apiserver 每秒收到100个请求，而记录事件为 ResponseStarted 和ResponseComplete 阶段，此时会记录的条数约 200/s ，如果batch缓冲区为100，那么需要配置的参数至少2Qps/s。再假设后端处理能力为5秒，那么缓冲区需要配置的大小至少为5秒的事件，即1000条evnet，10个batch。正如下图所示：\n图：审计批处理参数调优结构图 Source：https://www.cnblogs.com/zhangmingcheng/p/16539514.html\n而kube-apiserver提供了两个Prometheus指标可以用于监控审计子系统的状态\napiserver_audit_event_total 审计事件的总数 apiserver_audit_error_total 由于错误而被丢弃的审计事件总数，例如panic类型事件 实验：Audit Webhook 编写一个webhook，用于处理接收到的日志，这里直接打印\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func serveAudit(w http.ResponseWriter, r *http.Request) { b, err := ioutil.ReadAll(r.Body) if err != nil { httpError(w, err) return } var eventList audit.EventList err = json.Unmarshal(b, \u0026eventList) if err != nil { klog.V(3).Info(\"Json convert err: \", err) httpError(w, err) return } for _, event := range eventList.Items { // here is your logic fmt.Printf(\"审计ID %s: 用户\u003c%s\u003e, 请求对象\u003c%s\u003e, 操作\u003c%s\u003e, 请求阶段\u003c%s\u003e\\n\", event.AuditID, event.User.UID, event.RequestURI, event.Verb, event.Stage, ) } w.WriteHeader(http.StatusOK) } 当使用命令执行查看Pod的操作时，会看到webhook收到的下述审计日志\n操作命令\nbash 1 for n in `seq 1 100`; do kubectl get pod --user=admin; done 审计日志\nlog 审计ID c0313416-f950-4361-9823-7c4792b143fd: 用户, 请求对象, 操作, 请求阶段 审计ID db2390c1-83cf-42e7-b589-70cd04003d0e: 用户, 请求对象, 操作, 请求阶段 审计ID a8fc2ff9-d0c5-4263-901c-b5974fd58026: 用户, 请求对象, 操作, 请求阶段 总结 kubernetes通过插件的方式提供了提供了一个IT系统 4A模型为集群提供了安全保障，与传统的4A (Authentication, Authorization, Accounting, Auditing) 不同的是，对于 Accounting 与 Authentication 在kubernetes中设计来说 Kubernetes没有用户的实现而是一个抽象，这使得Kubernetes可以更灵活使用任意的用户系统完成登录（OID, X.509, webhook, proxy, SA….），而对于授权来说，Kubernetes 通过多种授权模型(RBAC, ABAC, Node, Webhook)，为集群提供了灵活的权限；而不同的是，通过 Admission Control 可以为集群提供更多的安全策略，例如镜像策略，通过三方提供的控制器来自定义更多的安全策略，如OPA。而这种设计为Kubernetes集群提供了一种更灵活的安全。\nReference [1] Auditing\n[2] Audit policy\n[3] Audit backends\n[4] Log backend\n[5] Webhook backend\n[6] Event batching\n[7] Parameter tuning\n[8] Privilege Management Infrastructure\n[9] Kubernetes 审计（Auditing）功能详解\n[10] kubernetes 审计日志功能\n","wordCount":"1844","inLanguage":"zh","datePublished":"2022-11-24T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2022/11/ch34-auditing/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">深入理解Kubernetes 4A - Audit源码解析</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-11-24</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>1844 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>9 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a>
<a href=https://www.oomkill.com/tags/kubernetes-develop/>#Kubernetes Develop</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a><li><a href=#kubernetes-auditing aria-label="Kubernetes Auditing">Kubernetes Auditing</a><li><a href=#%e5%ae%a1%e8%ae%a1%e4%ba%8b%e4%bb%b6%e8%ae%be%e8%ae%a1 aria-label=审计事件设计>审计事件设计</a><li><a href=#%e5%ae%a1%e8%ae%a1%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b aria-label=审计工作流程>审计工作流程</a><li><a href=#%e5%ae%a1%e8%ae%a1%e7%ad%96%e7%95%a5%e7%ba%a7%e5%88%ab-supa-href22asup aria-label="审计策略级别 [2]">审计策略级别 <sup><a href=#2>[2]</a></sup></a><li><a href=#backend-supa-href33asup aria-label="Backend [3]">Backend <sup><a href=#3>[3]</a></sup></a><ul><li><a href=#%e6%97%a5%e5%bf%97%e6%a8%a1%e5%bc%8f%e9%85%8d%e7%bd%ae aria-label=日志模式配置>日志模式配置</a><li><a href=#webhook-supa-href55asup aria-label="webhook [5]">webhook <sup><a href=#5>[5]</a></sup></a><li><a href=#%e6%89%b9%e5%a4%84%e7%90%86 aria-label=批处理>批处理</a></ul><li><a href=#%e5%8f%82%e6%95%b0%e8%b0%83%e6%95%b4 aria-label=参数调整>参数调整</a><li><a href=#%e5%ae%9e%e9%aa%8caudit-webhook aria-label="实验：Audit Webhook">实验：Audit Webhook</a><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><div class="pe-details admonition abstract"><div class="pe-details-summary admonition-title"><i class="icon fas fa-list-ul fa-fw" aria-hidden=true></i>本文是关于Kubernetes 4A解析的第4章<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content><ul><li><a href=https://www.oomkill.com/2022/11/ch31-authentication/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Authentication源码解析</a></li><li><a href=https://www.oomkill.com/2022/11/ch32-authorization/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Authorization源码解析</a></li><li><a href=https://www.oomkill.com/2022/07/ch33-admission-webhook/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Admission Control源码解析</a></li><li>深入理解Kubernetes 4A - Audit源码解析</li><li><a href=https://www.oomkill.com/2024/11/k8s-auth-and-regenerate-cert/ target=_blank rel="noopener nofollow noreferrer">TLS Everywhere - 解密kubernetes集群的安全认证</a></li></ul><p>所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A</p></div></div></div><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>审计是信息系统中非常重要的一部分，Kubernetes 1.11中也增加了审计 (<em><strong>Auditing</strong></em>) 功能，通过审计功能获得 deployment, ns,等资源操作的事件。</p><p><strong>objective</strong>：</p><ul><li>从设计角度了解Auditing在kubernets中是如何实现的</li><li>了解kubernetes auditing webhook</li><li>完成实验，通过webhook来收集审计日志</li></ul><p>如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大。</p><h2 id=kubernetes-auditing>Kubernetes Auditing<a hidden class=anchor aria-hidden=true href=#kubernetes-auditing>#</a></h2><p>根据Kubernetes官方描述审计在kubernetes中是有控制平面 <em>kube-apiserver</em> 中产生的一个事件，记录了集群中所操作的资源，审计围绕下列几个维度来记录事件的：</p><ul><li>发生了什么</li><li>发生的事件</li><li>谁触发的</li><li>发生动作的对象</li><li>在哪里检查到动作的</li><li>从哪触发的</li><li>处理行为是什么</li></ul><p>审计生命周期开始于组件 <em>kube-apiserver</em> 准入控制阶段，在每个阶段内都会产生审计事件并经过预处理后写入后端，目前后端包含webhook与日志文件。</p><blockquote><p>审计日志功能增加了 <em>kube-apiserver</em> 的内存消耗，因为会为每个请求存储了审计所需的上下文。内存的消耗取决于审计日志配置 <sup><a href=#1>[1]</a></sup>。</p></blockquote><h2 id=审计事件设计>审计事件设计<a hidden class=anchor aria-hidden=true href=#审计事件设计>#</a></h2><p>审计的schema不同于资源API的设计，没有 <code>metav1.ObjectMeta</code> 属性，Event是一个事件的结构体，Policy是事件配置，属于kubernetes资源，在代码 <a href=https://github.com/kubernetes/kubernetes/blob/e72eea92396503521f1acaab60a2975c13ffc618/staging/src/k8s.io/apiserver/pkg/apis/audit/types.go#L79-L148 target=_blank rel="noopener nofollow noreferrer">k8s.io/apiserver/pkg/apis/audit/types.go</a> 可以看到</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Event</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span> <span class=s>`json:&#34;,inline&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Level</span> <span class=nx>Level</span> <span class=s>`json:&#34;level&#34; protobuf:&#34;bytes,1,opt,name=level,casttype=Level&#34;
</span></span></span><span class=line><span class=cl><span class=s>	AuditID types.UID `</span><span class=nx>json</span><span class=p>:</span><span class=s>&#34;auditID&#34;</span> <span class=nx>protobuf</span><span class=p>:</span><span class=s>&#34;bytes,2,opt,name=auditID,casttype=k8s.io/apimachinery/pkg/types.UID&#34;`
</span></span></span><span class=line><span class=cl><span class=s>	
</span></span></span><span class=line><span class=cl><span class=s>	Stage Stage `</span><span class=nx>json</span><span class=p>:</span><span class=s>&#34;stage&#34;</span> <span class=nx>protobuf</span><span class=p>:</span><span class=s>&#34;bytes,3,opt,name=stage,casttype=Stage&#34;`
</span></span></span><span class=line><span class=cl><span class=s>	RequestURI string `</span><span class=nx>json</span><span class=p>:</span><span class=s>&#34;requestURI&#34;</span> <span class=nx>protobuf</span><span class=p>:</span><span class=s>&#34;bytes,4,opt,name=requestURI&#34;`
</span></span></span><span class=line><span class=cl><span class=s>	Verb string `</span><span class=nx>json</span><span class=p>:</span><span class=s>&#34;verb&#34;</span> <span class=nx>protobuf</span><span class=p>:</span><span class=s>&#34;bytes,5,opt,name=verb&#34;`
</span></span></span><span class=line><span class=cl><span class=s>	User authnv1.UserInfo `</span><span class=nx>json</span><span class=p>:</span><span class=s>&#34;user&#34;</span> <span class=nx>protobuf</span><span class=p>:</span><span class=s>&#34;bytes,6,opt,name=user&#34;`
</span></span></span><span class=line><span class=cl><span class=s>	ImpersonatedUser *authnv1.UserInfo `</span><span class=nx>json</span><span class=p>:</span><span class=s>&#34;impersonatedUser,omitempty&#34;</span> <span class=nx>protobuf</span><span class=p>:</span><span class=s>&#34;bytes,7,opt,name=impersonatedUser&#34;`
</span></span></span><span class=line><span class=cl><span class=s>	SourceIPs []string `</span><span class=nx>json</span><span class=p>:</span><span class=s>&#34;sourceIPs,omitempty&#34;</span> <span class=nx>protobuf</span><span class=p>:</span><span class=s>&#34;bytes,8,rep,name=sourceIPs&#34;`
</span></span></span><span class=line><span class=cl><span class=s>	UserAgent string `</span><span class=nx>json</span><span class=p>:</span><span class=s>&#34;userAgent,omitempty&#34;</span> <span class=nx>protobuf</span><span class=p>:</span><span class=s>&#34;bytes,16,opt,name=userAgent&#34;`
</span></span></span><span class=line><span class=cl><span class=s>	ObjectRef *ObjectReference `</span><span class=nx>json</span><span class=p>:</span><span class=s>&#34;objectRef,omitempty&#34;</span> <span class=nx>protobuf</span><span class=p>:</span><span class=s>&#34;bytes,9,opt,name=objectRef&#34;`
</span></span></span><span class=line><span class=cl><span class=s>	// +optional
</span></span></span><span class=line><span class=cl><span class=s>	ResponseStatus *metav1.Status `</span><span class=nx>json</span><span class=p>:</span><span class=s>&#34;responseStatus,omitempty&#34;</span> <span class=nx>protobuf</span><span class=p>:</span><span class=s>&#34;bytes,10,opt,name=responseStatus&#34;</span><span class=err>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>对于记录的认证事件来说，会根据请求阶段记录审计的阶段，主要分为下属集中情况，每个请求会记录其中一个验证阶段，如代码所示 <sup><a href=#1>[1]</a></sup></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这个阶段是audit handler收到请求后立即生成事件的阶段，然后委托handler chain处理。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>StageRequestReceived</span> <span class=nx>Stage</span> <span class=p>=</span> <span class=s>&#34;RequestReceived&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这个阶段阶段仅对长时间运行的请求如 watch
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 将在发送响应标头后，响应正文之前生成的阶段
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>StageResponseStarted</span> <span class=nx>Stage</span> <span class=p>=</span> <span class=s>&#34;ResponseStarted&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这个阶段是发送相应体后的事件。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>StageResponseComplete</span> <span class=nx>Stage</span> <span class=p>=</span> <span class=s>&#34;ResponseComplete&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果程序出现panic，则触发这个阶段
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>StagePanic</span> <span class=nx>Stage</span> <span class=p>=</span> <span class=s>&#34;Panic&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=审计工作流程>审计工作流程<a hidden class=anchor aria-hidden=true href=#审计工作流程>#</a></h2><p>审计真正工作的地方在 <a href=https://github.com/kubernetes/kubernetes/blob/e72eea92396503521f1acaab60a2975c13ffc618/staging/src/k8s.io/apiserver/pkg/endpoints/filters/audit.go#L42-L119 target=_blank rel="noopener nofollow noreferrer">k8s.io/apiserver/pkg/endpoints/filters/audit.go.WithAudit</a> 函数，下面对与官方文档说明与这个实际代码进行结合</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>WithAudit</span><span class=p>(</span><span class=nx>handler</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>,</span> <span class=nx>sink</span> <span class=nx>audit</span><span class=p>.</span><span class=nx>Sink</span><span class=p>,</span> <span class=nx>policy</span> <span class=nx>audit</span><span class=p>.</span><span class=nx>PolicyRuleEvaluator</span><span class=p>,</span> <span class=nx>longRunningCheck</span> <span class=nx>request</span><span class=p>.</span><span class=nx>LongRunningRequestCheck</span><span class=p>)</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// sink是一个backend（webhook 或 日志），policy则是自定义的事件配置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果两者之一未配置，则不会使用审计功能
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>sink</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>policy</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>handler</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nf>HandlerFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过给定的配置与请求构建出一个事件 context
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 这里可以看到
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>auditContext</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>evaluatePolicyAndCreateAuditEvent</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>policy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to create audit event: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>responsewriters</span><span class=p>.</span><span class=nf>InternalError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;failed to create audit event&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 下面代码可以看出是对事件context进行构建，与拿到来自请求Context
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>ev</span> <span class=o>:=</span> <span class=nx>auditContext</span><span class=p>.</span><span class=nx>Event</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>ev</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>req</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>handler</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>req</span> <span class=p>=</span> <span class=nx>req</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>audit</span><span class=p>.</span><span class=nf>WithAuditContext</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nf>Context</span><span class=p>(),</span> <span class=nx>auditContext</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>req</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>omitStages</span> <span class=o>:=</span> <span class=nx>auditContext</span><span class=p>.</span><span class=nx>RequestAuditConfig</span><span class=p>.</span><span class=nx>OmitStages</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>        <span class=c1>// 这里到StageRequestReceived阶段，如果是收到请求阶段则通过注入的后端进行处理
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>ev</span><span class=p>.</span><span class=nx>Stage</span> <span class=p>=</span> <span class=nx>auditinternal</span><span class=p>.</span><span class=nx>StageRequestReceived</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>processed</span> <span class=o>:=</span> <span class=nf>processAuditEvent</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>sink</span><span class=p>,</span> <span class=nx>ev</span><span class=p>,</span> <span class=nx>omitStages</span><span class=p>);</span> <span class=p>!</span><span class=nx>processed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>audit</span><span class=p>.</span><span class=nx>ApiserverAuditDroppedCounter</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>responsewriters</span><span class=p>.</span><span class=nf>InternalError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>req</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;failed to store audit event&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// 拦截watch类长请求的状态码
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kd>var</span> <span class=nx>longRunningSink</span> <span class=nx>audit</span><span class=p>.</span><span class=nx>Sink</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>longRunningCheck</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ri</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>request</span><span class=p>.</span><span class=nf>RequestInfoFrom</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nf>longRunningCheck</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>ri</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>longRunningSink</span> <span class=p>=</span> <span class=nx>sink</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>respWriter</span> <span class=o>:=</span> <span class=nf>decorateResponseWriter</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>w</span><span class=p>,</span> <span class=nx>ev</span><span class=p>,</span> <span class=nx>longRunningSink</span><span class=p>,</span> <span class=nx>omitStages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// send audit event when we leave this func, either via a panic or cleanly. In the case of long
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// running requests, this will be the second audit event.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 在离开函数前会处理 ResponseStarted、ResponseComplete、Panic这三个阶段
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>r</span> <span class=o>:=</span> <span class=nb>recover</span><span class=p>();</span> <span class=nx>r</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>defer</span> <span class=nb>panic</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 当前发生panic的请求
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>ev</span><span class=p>.</span><span class=nx>Stage</span> <span class=p>=</span> <span class=nx>auditinternal</span><span class=p>.</span><span class=nx>StagePanic</span>
</span></span><span class=line><span class=cl>				<span class=nx>ev</span><span class=p>.</span><span class=nx>ResponseStatus</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Status</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Code</span><span class=p>:</span>    <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Status</span><span class=p>:</span>  <span class=nx>metav1</span><span class=p>.</span><span class=nx>StatusFailure</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Reason</span><span class=p>:</span>  <span class=nx>metav1</span><span class=p>.</span><span class=nx>StatusReasonInternalError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>Message</span><span class=p>:</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;APIServer panic&#39;d: %v&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nf>processAuditEvent</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>sink</span><span class=p>,</span> <span class=nx>ev</span><span class=p>,</span> <span class=nx>omitStages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// if no StageResponseStarted event was sent b/c neither a status code nor a body was sent, fake it here
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// But Audit-Id http header will only be sent when http.ResponseWriter.WriteHeader is called.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>fakedSuccessStatus</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>metav1</span><span class=p>.</span><span class=nx>Status</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Code</span><span class=p>:</span>    <span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Status</span><span class=p>:</span>  <span class=nx>metav1</span><span class=p>.</span><span class=nx>StatusSuccess</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;Connection closed early&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>ev</span><span class=p>.</span><span class=nx>ResponseStatus</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>longRunningSink</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>ev</span><span class=p>.</span><span class=nx>ResponseStatus</span> <span class=p>=</span> <span class=nx>fakedSuccessStatus</span>
</span></span><span class=line><span class=cl>				<span class=nx>ev</span><span class=p>.</span><span class=nx>Stage</span> <span class=p>=</span> <span class=nx>auditinternal</span><span class=p>.</span><span class=nx>StageResponseStarted</span>
</span></span><span class=line><span class=cl>				<span class=nf>processAuditEvent</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>longRunningSink</span><span class=p>,</span> <span class=nx>ev</span><span class=p>,</span> <span class=nx>omitStages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// ResponseStarted 在响应头发送后，响应体发送前的事件。watch会触发他
</span></span></span><span class=line><span class=cl><span class=c1></span>            
</span></span><span class=line><span class=cl>			<span class=nx>ev</span><span class=p>.</span><span class=nx>Stage</span> <span class=p>=</span> <span class=nx>auditinternal</span><span class=p>.</span><span class=nx>StageResponseComplete</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>ev</span><span class=p>.</span><span class=nx>ResponseStatus</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 没有相应状态 正是上面构造的fakedSuccessStatus
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>ev</span><span class=p>.</span><span class=nx>ResponseStatus</span> <span class=p>=</span> <span class=nx>fakedSuccessStatus</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 将事件发送到后端
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nf>processAuditEvent</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>sink</span><span class=p>,</span> <span class=nx>ev</span><span class=p>,</span> <span class=nx>omitStages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}()</span>
</span></span><span class=line><span class=cl>		<span class=nx>handler</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>respWriter</span><span class=p>,</span> <span class=nx>req</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><ul><li><p>在评估请求时，会调用 <code>GetAuthorizerAttributes(ctx)</code> ，这里通过授权记录然后来通过给定的审计配置来</p></li><li><p>当在将事件发送到后端时，使用 <code>processAuditEvent()</code> 函数，最终修改时间后会转交至后端函数，例如webhook，会请求后端配置的webhook url的客户端，最终被执行 <code>return sink.ProcessEvents(ev)</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>backend</span><span class=p>)</span> <span class=nf>processEvents</span><span class=p>(</span><span class=nx>ev</span> <span class=o>...*</span><span class=nx>auditinternal</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>list</span> <span class=nx>auditinternal</span><span class=p>.</span><span class=nx>EventList</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>e</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ev</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>list</span><span class=p>.</span><span class=nx>Items</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>list</span><span class=p>.</span><span class=nx>Items</span><span class=p>,</span> <span class=o>*</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>b</span><span class=p>.</span><span class=nx>w</span><span class=p>.</span><span class=nf>WithExponentialBackoff</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=kd>func</span><span class=p>()</span> <span class=nx>rest</span><span class=p>.</span><span class=nx>Result</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>trace</span> <span class=o>:=</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;Call Audit Events webhook&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=nx>b</span><span class=p>.</span><span class=nx>name</span><span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=s>&#34;event-count&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>list</span><span class=p>.</span><span class=nx>Items</span><span class=p>)})</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Only log audit webhook traces that exceed a 25ms per object limit plus a 50ms request overhead allowance. The high per object limit used here is primarily to allow enough time for the serialization/deserialization of audit events, which contain nested request and response objects plus additional event fields.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>defer</span> <span class=nx>trace</span><span class=p>.</span><span class=nf>LogIfLong</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=mi>50</span><span class=o>+</span><span class=mi>25</span><span class=o>*</span><span class=nb>len</span><span class=p>(</span><span class=nx>list</span><span class=p>.</span><span class=nx>Items</span><span class=p>))</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>b</span><span class=p>.</span><span class=nx>w</span><span class=p>.</span><span class=nx>RestClient</span><span class=p>.</span><span class=nf>Post</span><span class=p>().</span><span class=nf>Body</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>list</span><span class=p>).</span><span class=nf>Do</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}).</span><span class=nf>Error</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div></li></ul><p>在 <a href=https://github.com/kubernetes/kubernetes/blob/e72eea92396503521f1acaab60a2975c13ffc618/staging/src/k8s.io/apiserver/pkg/endpoints/filters/audit.go#L125-L155 target=_blank rel="noopener nofollow noreferrer">k8s.io/apiserver/pkg/endpoints/filters/audit.go.evaluatePolicyAndCreateAuditEvent</a> 会评估请求的级别和规则，而 <a href=https://github.com/kubernetes/kubernetes/blob/e72eea92396503521f1acaab60a2975c13ffc618/staging/src/k8s.io/apiserver/pkg/audit/policy/checker.go#L64-L84 target=_blank rel="noopener nofollow noreferrer">k8s.io/apiserver/pkg/audit/policy/checker.go</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>policyRuleEvaluator</span><span class=p>)</span> <span class=nf>EvaluatePolicyRule</span><span class=p>(</span><span class=nx>attrs</span> <span class=nx>authorizer</span><span class=p>.</span><span class=nx>Attributes</span><span class=p>)</span> <span class=nx>auditinternal</span><span class=p>.</span><span class=nx>RequestAuditConfigWithLevel</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>rule</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Rules</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 评估则是评估用户与用户组，verb，ns,非API资源 /metrics /healthz
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nf>ruleMatches</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>rule</span><span class=p>,</span> <span class=nx>attrs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 通过后，则将这条规则与配置返回
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=nx>auditinternal</span><span class=p>.</span><span class=nx>RequestAuditConfigWithLevel</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Level</span><span class=p>:</span> <span class=nx>rule</span><span class=p>.</span><span class=nx>Level</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>RequestAuditConfig</span><span class=p>:</span> <span class=nx>auditinternal</span><span class=p>.</span><span class=nx>RequestAuditConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>OmitStages</span><span class=p>:</span>        <span class=nx>rule</span><span class=p>.</span><span class=nx>OmitStages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>					<span class=nx>OmitManagedFields</span><span class=p>:</span> <span class=nf>isOmitManagedFields</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>rule</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>OmitManagedFields</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 如果条件都不满足，则构建一个
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>auditinternal</span><span class=p>.</span><span class=nx>RequestAuditConfigWithLevel</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Level</span><span class=p>:</span> <span class=nx>DefaultAuditLevel</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>RequestAuditConfig</span><span class=p>:</span> <span class=nx>auditinternal</span><span class=p>.</span><span class=nx>RequestAuditConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>OmitStages</span><span class=p>:</span>        <span class=nx>p</span><span class=p>.</span><span class=nx>OmitStages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>OmitManagedFields</span><span class=p>:</span> <span class=nx>p</span><span class=p>.</span><span class=nx>OmitManagedFields</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/e72eea92396503521f1acaab60a2975c13ffc618/staging/src/k8s.io/apiserver/pkg/audit/request.go#L48-L93 target=_blank rel="noopener nofollow noreferrer">k8s.io/apiserver/pkg/audit/request.go.NewEventFromRequest</a> 创建出审计事件对象被上面 <a href=https://github.com/kubernetes/kubernetes/blob/e72eea92396503521f1acaab60a2975c13ffc618/staging/src/k8s.io/apiserver/pkg/endpoints/filters/audit.go#L125-L155 target=_blank rel="noopener nofollow noreferrer">evaluatePolicyAndCreateAuditEvent</a> 返回</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// evaluatePolicyAndCreateAuditEvent is responsible for evaluating the audit
</span></span></span><span class=line><span class=cl><span class=c1>// policy configuration applicable to the request and create a new audit
</span></span></span><span class=line><span class=cl><span class=c1>// event that will be written to the API audit log.
</span></span></span><span class=line><span class=cl><span class=c1>// - error if anything bad happened
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>evaluatePolicyAndCreateAuditEvent</span><span class=p>(</span><span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>policy</span> <span class=nx>audit</span><span class=p>.</span><span class=nx>PolicyRuleEvaluator</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>audit</span><span class=p>.</span><span class=nx>AuditContext</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>req</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>attribs</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>GetAuthorizerAttributes</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to GetAuthorizerAttributes: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ls</span> <span class=o>:=</span> <span class=nx>policy</span><span class=p>.</span><span class=nf>EvaluatePolicyRule</span><span class=p>(</span><span class=nx>attribs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>audit</span><span class=p>.</span><span class=nf>ObservePolicyLevel</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>ls</span><span class=p>.</span><span class=nx>Level</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>ls</span><span class=p>.</span><span class=nx>Level</span> <span class=o>==</span> <span class=nx>auditinternal</span><span class=p>.</span><span class=nx>LevelNone</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Don&#39;t audit.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=o>&amp;</span><span class=nx>audit</span><span class=p>.</span><span class=nx>AuditContext</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>RequestAuditConfig</span><span class=p>:</span> <span class=nx>ls</span><span class=p>.</span><span class=nx>RequestAuditConfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>requestReceivedTimestamp</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>request</span><span class=p>.</span><span class=nf>ReceivedTimestampFrom</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>requestReceivedTimestamp</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>ev</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>audit</span><span class=p>.</span><span class=nf>NewEventFromRequest</span><span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>requestReceivedTimestamp</span><span class=p>,</span> <span class=nx>ls</span><span class=p>.</span><span class=nx>Level</span><span class=p>,</span> <span class=nx>attribs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;failed to complete audit event from request: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>audit</span><span class=p>.</span><span class=nx>AuditContext</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>RequestAuditConfig</span><span class=p>:</span> <span class=nx>ls</span><span class=p>.</span><span class=nx>RequestAuditConfig</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Event</span><span class=p>:</span>              <span class=nx>ev</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>到这里，已经清楚的了解到，Kubernetes审计工作与什么位置了，而对于Kubernetes准入给出的登录（<em><strong>Authentication</strong></em>），授权 (<em><strong>Authorization</strong></em>) 与 准入控制 (<em><strong>Admission control</strong></em>) 三个阶段来说，Audition 位于授权之后，正如下图所示，而这个真正的流程在kubernetes中有个属于叫 <em><strong>handler chain</strong></em> 整个链条中，准入与审计只是其中一部分。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221128001225515.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221128001225515.png#center alt=image-20221128001225515 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：Kubernetes 4A 的 handler chain</center><br><p>由图再结合代码可以看出，所有的客户端访问API都需要经过完整经由整个链条，而 Auditing 事件的构建是需要获取经由验证过的用户等资源构建出的事件，首次发生的为 <code>StageRequestReceived</code> ，这将在收到请求后执行，而由代码又可知，因为在最终结束掉整个请求时会执行 <code>WithAudit</code> 函数，这就为 <code>StageResponseComplete</code> 与 <code>StageResponseStarted</code> 这两个阶段被执行，而这个将发生在被注册的 handler 完成后，也就是 <em><strong>Admission control</strong></em> 后因为 AC 是在每个真实REST中被执行。TODO</p><h2 id=审计策略级别-supa-href22asup>审计策略级别 <sup><a href=#2>[2]</a></sup><a hidden class=anchor aria-hidden=true href=#审计策略级别-supa-href22asup>#</a></h2><p>审计策略级别是控制审计记录将记录那些对象的数据内容，当事件被处理时，会按照配置的审计规则进行比较。而使用该功能需要 <em>kube-apiserver</em> 开启参数 <code>--audit-policy-file</code> 指定对应的配置，如果未指定则默认不记录任何事件，可供定义的级别有四个，被定义在 k8s.io/apiserver/pkg/apis/audit/v1/types.go 中</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=c1>// LevelNone disables auditing
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>LevelNone</span> <span class=nx>Level</span> <span class=p>=</span> <span class=s>&#34;None&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// LevelMetadata provides the basic level of auditing.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>LevelMetadata</span> <span class=nx>Level</span> <span class=p>=</span> <span class=s>&#34;Metadata&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// LevelRequest provides Metadata level of auditing, and additionally
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// logs the request object (does not apply for non-resource requests).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>LevelRequest</span> <span class=nx>Level</span> <span class=p>=</span> <span class=s>&#34;Request&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// LevelRequestResponse provides Request level of auditing, and additionally
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// logs the response object (does not apply for non-resource requests).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>LevelRequestResponse</span> <span class=nx>Level</span> <span class=p>=</span> <span class=s>&#34;RequestResponse&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><ul><li><strong>None</strong>： 不记录符合该规则的事件</li><li><strong>Metadata</strong>：只记录请求元数据（如User, timestamp, resources, verb），不记录请求和响应体。</li><li><strong>Request</strong>：记录事件元数据和请求体，不记录响应体。</li><li><strong>RequestResponse</strong>： 记录事件元数据，请求和响应体</li></ul><p>下面是Kubernetes官网给出的 Policy 的配置 <sup><a href=#2>[2]</a></sup></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>audit.k8s.io/v1</span><span class=w> </span><span class=c># This is required.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Policy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># omitStages 代表忽略该阶段所有请求事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># RequestReceived 这里配置的指在RequestReceived阶段忽略所有请求事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>omitStages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;RequestReceived&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 记录将以RequestResponse级别的格式记录pod更改</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>RequestResponse</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 这里资源的配置必须与RBAC配置的一致，pods将不支持pods/log这类子资源</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;pods&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 如果需要配置子资源按照下列方式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>Metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;pods/log&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;pods/status&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 不记录的资源为controller-leader的configmaps资源的请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;configmaps&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resourceNames</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;controller-leader&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 不记录用户为 &#34;system:kube-proxy&#34; 发起的对 endpoints与services资源的watch请求事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>users</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;system:kube-proxy&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;watch&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w> </span><span class=c># core API group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;endpoints&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;services&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 每个登录成功的用户，都会被追加一个用户组为 &#34;system:authenticated&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 下述规则为不记录包含非资源类型的URL的已认证请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>userGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;system:authenticated&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nonResourceURLs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;/api*&#34;</span><span class=w> </span><span class=c># Wildcard matching.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s2>&#34;/version&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 记录kube-system名称空间configmap更改事件的请求体与元数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>Request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w> </span><span class=c># core API group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;configmaps&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># This rule only applies to resources in the &#34;kube-system&#34; namespace.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># The empty string &#34;&#34; can be used to select non-namespaced resources.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespaces</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;kube-system&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 事件将记录所有名称空间内对于configmap与secret资源改变的元数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>Metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w> </span><span class=c># core API group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;secrets&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;configmaps&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 记录对group为core与extensions下的资源类型请求的 请求体与元数据（request级别）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>Request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w> </span><span class=c># core API group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;extensions&#34;</span><span class=w> </span><span class=c># Version of group should NOT be included.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 这种属于泛规则，会记录所有上述其他之外的所有类型请求的元数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 类似于授权，小权限在前，* 最后</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>Metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Long-running requests like watches that fall under this rule will not</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># generate an audit event in RequestReceived.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>omitStages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;RequestReceived&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=backend-supa-href33asup>Backend <sup><a href=#3>[3]</a></sup><a hidden class=anchor aria-hidden=true href=#backend-supa-href33asup>#</a></h2><p>kubernetes目前为Auditing 提供了两个后端，日志方式与webhook方式，kubernetes审计事件会遵循 <code>audit.k8s.io</code> 结构写入到后端。</p><h3 id=日志模式配置>日志模式配置<a hidden class=anchor aria-hidden=true href=#日志模式配置>#</a></h3><p>启用日志模式只需要配置几个参数 <sup><a href=#4>[4]</a></sup></p><ul><li><code>--audit-log-path</code> 写入审计事件的日志路径。这个是必须配置的否则默认输出到STDOUT</li><li><code>--audit-log-maxage</code> 审计日志文件保留的最大天数</li><li><code>--audit-log-maxbackup</code> 审计日志保留的的最大数量</li><li><code>--audit-log-maxsize</code> 审计日志文件最大大小（单位M）大于会切割</li></ul><p>例如配置</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>--audit-policy-file<span class=o>=</span>/etc/kubernetes/audit-policy.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--audit-log-path<span class=o>=</span>/var/log/kubernetes/audit.log <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--audit-log-maxsize<span class=o>=</span>20M</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=webhook-supa-href55asup>webhook <sup><a href=#5>[5]</a></sup><a hidden class=anchor aria-hidden=true href=#webhook-supa-href55asup>#</a></h3><p>webhook是指审计事件将由 <em>kube-apiserver</em> 发送到webhook服务中记录，开启webhook只需要配置 <code>--audit-webhook-config-file</code> 与 <code>--audit-policy-file</code> 两个参数，而其他的则是对该模式的辅助</p><ul><li><p><code>--audit-webhook-config-file</code> ：webhook的配置文件，格式是kubeconfig类型，所有的信息不是kubernetes api配置，而是webhook相关信息</p></li><li><p><code>--audit-webhook-initial-backoff </code>：第一次失败后重试事件，随后仍失败后将以指数方式退避重试</p></li><li><p><code>--audit-webhook-mode</code> ：发送至webhook的模式。 <em>batch</em>, <em>blocking</em>, <em>blocking-strict</em> 。</p></li></ul><p>例如配置</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>--<span class=l>audit-policy-file=/etc/kubernetes/audit-policy.yaml \</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>--<span class=l>audit-webhook-config-file=/etc/kubernetes/auth/audit-webhook.yaml \</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>--<span class=l>audit-webhook-mode=batch \</span></span></span></code></pre></td></tr></table></div></div></div></div><p>对于initialBackoff 的退避重试则如代码所示 <a href=https://github.com/kubernetes/kubernetes/blob/e72eea92396503521f1acaab60a2975c13ffc618/staging/src/k8s.io/apiserver/pkg/server/options/audit.go#L584-L594 target=_blank rel="noopener nofollow noreferrer">k8s.io/apiserver/pkg/server/options/audit.go</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>o</span> <span class=o>*</span><span class=nx>AuditWebhookOptions</span><span class=p>)</span> <span class=nf>newUntruncatedBackend</span><span class=p>(</span><span class=nx>customDial</span> <span class=nx>utilnet</span><span class=p>.</span><span class=nx>DialFunc</span><span class=p>)</span> <span class=p>(</span><span class=nx>audit</span><span class=p>.</span><span class=nx>Backend</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>groupVersion</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>schema</span><span class=p>.</span><span class=nf>ParseGroupVersion</span><span class=p>(</span><span class=nx>o</span><span class=p>.</span><span class=nx>GroupVersionString</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>webhook</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>pluginwebhook</span><span class=p>.</span><span class=nf>NewBackend</span><span class=p>(</span><span class=nx>o</span><span class=p>.</span><span class=nx>ConfigFile</span><span class=p>,</span> <span class=nx>groupVersion</span><span class=p>,</span> <span class=nx>webhook</span><span class=p>.</span><span class=nf>DefaultRetryBackoffWithInitialDelay</span><span class=p>(</span><span class=nx>o</span><span class=p>.</span><span class=nx>InitialBackoff</span><span class=p>),</span> <span class=nx>customDial</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;initializing audit webhook: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>webhook</span> <span class=p>=</span> <span class=nx>o</span><span class=p>.</span><span class=nx>BatchOptions</span><span class=p>.</span><span class=nf>wrapBackend</span><span class=p>(</span><span class=nx>webhook</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>webhook</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在函数 <a href=https://github.com/kubernetes/kubernetes/blob/e72eea92396503521f1acaab60a2975c13ffc618/staging/src/k8s.io/apiserver/pkg/util/webhook/webhook.go#L42-L49 target=_blank rel="noopener nofollow noreferrer">k8s.io/apiserver/pkg/util/webhook/webhook.go.DefaultRetryBackoffWithInitialDelay</a> 中看到 通过 wait.Backoff 进行的</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>return</span> <span class=nx>wait</span><span class=p>.</span><span class=nx>Backoff</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 时间间隔，用于调用 Step 方法时返回的时间间隔
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Duration</span><span class=p>:</span> <span class=nx>initialBackoffDelay</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>   	
</span></span><span class=line><span class=cl>    <span class=c1>// 用于计算下次的时间间隔，不能为负数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Factor 大于 0 时，Backoff 在计算下次的时间间隔时都会根据 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Duration * Factor，Factor * Duration 不能大于 Cap
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Factor</span><span class=p>:</span>   <span class=mf>1.5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 抖动，Jitter &gt; 0 时，每次迭代的时间间隔都会额外加上 0 - Duration * Jitter 的随机时间,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 并且抖动出的时间不会设置为 Duration，而且不受 Caps 的限制
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Jitter</span><span class=p>:</span>   <span class=mf>0.2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 进行指数回退(*Factor) 操作的次数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 当 Factor * Duration &gt; Cap 时 Steps 会被设置为 0, Duration 设置为 Cap
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 也就是说后续的迭代时间间隔都会返回 Duration
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Steps</span><span class=p>:</span>    <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 还有一个cap（Cap time.Duration），是最大的时间间隔
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=批处理>批处理<a hidden class=anchor aria-hidden=true href=#批处理>#</a></h3><p>日志后端与webhook后端都支持批处理模式，默认值为webhook默认开启batch，而log则被禁用</p><ul><li><code>--audit-log-mode/--audit-webhook-mode</code> ：参数通过将webhook替换为log则为对应的 batch 模式的参数，可以通过 <code>kube-apiserver --help|grep "audit"|grep batch</code> 查看<ul><li><code>batch</code> 默认值，缓冲事件进行异步批量处理<ul><li><code>--audit-webhook-batch-buffer-size</code>：批处理之前要缓冲的事件数。如果传入事件的溢出，则被丢弃。</li><li><code>--audit-webhook-batch-max-size</code>：定义每一批中的最大事件数</li><li><code>--audit-webhook-batch-max-wait</code>：批处理队列未满时等待的事件，到时强制写入一次</li><li><code>--audit-webhook-batch-throttle-qps</code>：定义每秒最大平均批次</li><li><code>--audit-webhook-batch-throttle-burst</code>：如果之前还没使用throttle-qps之前，发送的最大批数，通常情况下为第一次启动时生效的参数</li></ul></li><li><code>blocking</code> 阻止 apiserver 处理每个单独事件</li><li><code>blocking-strict</code>：与 <em>blocking</em> 相同，但当 <em>RequestReceived</em> 阶段的审计日志记录失败时，对 kube-apiserver 的整个请求都将失败</li></ul></li></ul><h2 id=参数调整>参数调整<a hidden class=anchor aria-hidden=true href=#参数调整>#</a></h2><p>适当的调整参数与策略可以有效适应 <em>kuber-apiserver</em> 的负载，如在记录日志时应只记录所需的事件，而不是所有的事件，这样可以避免 APIServer不必要开销，例如：</p><ul><li>每个请求存在多个阶段，而审计时其实不关心响应等信息，可以只记录 <code>RequestReceived</code> 的 <code>metadata</code> 级别。</li><li>&ldquo;pods/log&rdquo;, &ldquo;pods/status&rdquo; 在记录时应该区分子资源类型，而不要直接写 <em><code>pods</code></em> 或 <em><code>pods/*</code></em></li><li>kubernetes系统组件内的事件如果没有特殊要求可以不记录</li><li>对于资源类型，如configmap的请求其实没必要记录</li><li>审计记录应严格按照外部用户记录，而不是所有请求</li></ul><p>如何适配APIServer的负载能力，正如官方给的示例一样，如果 <em>kube-apiserver</em> 每秒收到100个请求，而记录事件为 <code>ResponseStarted</code> 和<code>ResponseComplete</code> 阶段，此时会记录的条数约 200/s ，如果batch缓冲区为100，那么需要配置的参数至少2Qps/s。再假设后端处理能力为5秒，那么缓冲区需要配置的大小至少为5秒的事件，即1000条evnet，10个batch。正如下图所示：</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/624219-20220802143739996-2062420228.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/624219-20220802143739996-2062420228.png#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：审计批处理参数调优结构图</center><center><em>Source：</em>https://www.cnblogs.com/zhangmingcheng/p/16539514.html</center><br><p>而kube-apiserver提供了两个Prometheus指标可以用于监控审计子系统的状态</p><ul><li><code>apiserver_audit_event_total</code> 审计事件的总数</li><li><code>apiserver_audit_error_total</code> 由于错误而被丢弃的审计事件总数，例如panic类型事件</li></ul><h2 id=实验audit-webhook>实验：Audit Webhook<a hidden class=anchor aria-hidden=true href=#实验audit-webhook>#</a></h2><p>编写一个webhook，用于处理接收到的日志，这里直接打印</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>serveAudit</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>httpError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>eventList</span> <span class=nx>audit</span><span class=p>.</span><span class=nx>EventList</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>b</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>eventList</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Json convert err: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>httpError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>event</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>eventList</span><span class=p>.</span><span class=nx>Items</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// here is your logic
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;审计ID %s: 用户&lt;%s&gt;, 请求对象&lt;%s&gt;, 操作&lt;%s&gt;, 请求阶段&lt;%s&gt;\n&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>event</span><span class=p>.</span><span class=nx>AuditID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>event</span><span class=p>.</span><span class=nx>User</span><span class=p>.</span><span class=nx>UID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>event</span><span class=p>.</span><span class=nx>RequestURI</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>event</span><span class=p>.</span><span class=nx>Verb</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>event</span><span class=p>.</span><span class=nx>Stage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>当使用命令执行查看Pod的操作时，会看到webhook收到的下述审计日志</p><p>操作命令</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>for</span> n in <span class=sb>`</span>seq <span class=m>1</span> 100<span class=sb>`</span><span class=p>;</span> <span class=k>do</span> kubectl get pod --user<span class=o>=</span>admin<span class=p>;</span> <span class=k>done</span></span></span></code></pre></td></tr></table></div></div></div></div><p>审计日志</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>log</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-log data-lang=log>审计ID c0313416-f950-4361-9823-7c4792b143fd: 用户&lt;admin&gt;, 请求对象&lt;/api/v1/namespaces/default/pods?limit=500&gt;, 操作&lt;list
&gt;, 请求阶段&lt;ResponseComplete&gt;
审计ID db2390c1-83cf-42e7-b589-70cd04003d0e: 用户&lt;admin&gt;, 请求对象&lt;/api/v1/namespaces/default/pods?limit=500&gt;, 操作&lt;list
&gt;, 请求阶段&lt;ResponseComplete&gt;
审计ID a8fc2ff9-d0c5-4263-901c-b5974fd58026: 用户&lt;admin&gt;, 请求对象&lt;/api/v1/namespaces/default/pods?limit=500&gt;, 操作&lt;list
&gt;, 请求阶段&lt;ResponseComplete&gt;</code></pre></div></div><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>kubernetes通过插件的方式提供了提供了一个IT系统 4A模型为集群提供了安全保障，与传统的4A (<em><strong>Authentication</strong></em>, <em><strong>Authorization</strong></em>, <em><strong>Accounting</strong></em>, <em><strong>Auditing</strong></em>) 不同的是，对于 <em>Accounting</em> 与 <em>Authentication</em> 在kubernetes中设计来说 Kubernetes没有用户的实现而是一个抽象，这使得Kubernetes可以更灵活使用任意的用户系统完成登录（OID, X.509, webhook, proxy, SA&mldr;.），而对于授权来说，Kubernetes 通过多种授权模型(RBAC, ABAC, Node, Webhook)，为集群提供了灵活的权限；而不同的是，通过 <em><strong>Admission Control</strong></em> 可以为集群提供更多的安全策略，例如镜像策略，通过三方提供的控制器来自定义更多的安全策略，如OPA。而这种设计为Kubernetes集群提供了一种更灵活的安全。</p><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><blockquote><p><sup id=1>[1]</sup> <a href=https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/ target=_blank rel="noopener nofollow noreferrer"><em><strong>Auditing</strong></em></a></p><p><sup id=2>[2]</sup> <a href=https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/#audit-policy target=_blank rel="noopener nofollow noreferrer"><em><strong>Audit policy</strong></em></a></p><p><sup id=3>[3]</sup> <a href=https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/#audit-backends target=_blank rel="noopener nofollow noreferrer"><em><strong>Audit backends</strong></em></a></p><p><sup id=4>[4]</sup> <a href=https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/#log-backend target=_blank rel="noopener nofollow noreferrer"><em><strong>Log backend</strong></em></a></p><p><sup id=5>[5]</sup> <a href=https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/#webhook-backend target=_blank rel="noopener nofollow noreferrer"><em><strong>Webhook backend</strong></em></a></p><p><sup id=6>[6]</sup> <a href=https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/#batching target=_blank rel="noopener nofollow noreferrer"><em><strong>Event batching</strong></em></a></p><p><sup id=7>[7]</sup> <a href=https://kubernetes.io/docs/tasks/debug/debug-cluster/audit/#parameter-tuning target=_blank rel="noopener nofollow noreferrer"><em><strong>Parameter tuning</strong></em></a></p><p><sup id=8>[8]</sup> <a href=https://ldapwiki.com/wiki/Privilege%20Management%20Infrastructure target=_blank rel="noopener nofollow noreferrer"><em><strong>Privilege Management Infrastructure</strong></em></a></p><p><sup id=9>[9]</sup> <a href=https://www.cnblogs.com/zhangmingcheng/p/16539514.html target=_blank rel="noopener nofollow noreferrer"><em><strong>Kubernetes 审计（Auditing）功能详解</strong></em></a></p><p><sup id=10>[10]</sup> <a href=https://blog.tianfeiyu.com/2019/01/30/k8s-audit-webhook/ target=_blank rel="noopener nofollow noreferrer"><em><strong>kubernetes 审计日志功能</strong></em></a></p></blockquote></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：深入理解Kubernetes 4A - Audit源码解析</p><p>文章链接：<a href=https://www.oomkill.com/2022/11/ch34-auditing/ target=_blank>https://www.oomkill.com/2022/11/ch34-auditing/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2022/11/ch32-authorization/><span>深入理解Kubernetes 4A - Authorization源码解析</span></a></li><li><a href=/2022/11/ch31-authentication/><span>深入理解Kubernetes 4A - Authentication源码解析</span></a></li><li><a href=/2022/07/ch33-admission-webhook/><span>深入理解Kubernetes 4A - Admission Control源码解析</span></a></li><li><a href=/2022/08/ch22-custom-scheduler/><span>基于Prometheus的Kubernetes网络调度器</span></a></li><li><a href=/2022/07/ch21-scheduling-algorithm/><span>如何理解kubernetes调度框架与插件？</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li><li><a href=https://www.oomkill.com/tags/kubernetes-develop/>Kubernetes Develop</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2022/11/kubernetes-eviction/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>kubernetes概念 - 理解Kubernetes的驱逐机制</span>
</a><a class=next href=https://www.oomkill.com/2022/11/ch32-authorization/><span class=title></span>
<span>深入理解Kubernetes 4A - Authorization源码解析&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/blogs","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch34 Auditing","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>