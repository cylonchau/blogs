<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>深入理解Kubernetes 4A - Authentication源码解析 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="ldap,kubernetes,kubernetes Authentication,k8s Authentication webhook,4A"><meta name=description content="本文是关于Kubernetes 4A解析的第1章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A
Overview 本章主要简单阐述kubernetes 认证相关原理，最后以实验来阐述kubernetes用户系统的思路
objective：
了解kubernetes 各种认证机制的原理 了解kubernetes 用户的概念 了解kubernetes authentication webhook 完成实验，如何将其他用户系统接入到kubernetes中的一个思路 如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大。
Kubernetes 认证 在Kubernetes apiserver对于认证部分所描述的，对于所有用户访问Kubernetes API（通过任何客户端，客户端库，kubectl 等）时都会经历 验证 (Authentication) , 授权 (Authorization), 和准入控制 (Admission control) 三个阶段来完成对 “用户” 进行授权，整个流程正如下图所示
图：Kubernetes API 请求的请求处理步骤图 Source：https://www.armosec.io/blog/kubernetes-admission-controller/
其中在大多数教程中，在对这三个阶段所做的工作大致上为：
Authentication 阶段所指用于确认请求访问Kubernetes API 用户是否为合法用户，拒绝为401
Authorization 阶段所指的将是这个用户是否有对操作的资源的权限，拒绝为403
Admission control 阶段所指控制对请求资源进行控制，通俗来说，就是一票否决权，即使前两个步骤完成"><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2022/11/ch31-authentication/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2022/11/ch31-authentication/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-H94HZ5S19Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H94HZ5S19Y")</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="深入理解Kubernetes 4A - Authentication源码解析"><meta property="og:description" content="本文是关于Kubernetes 4A解析的第1章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A
Overview 本章主要简单阐述kubernetes 认证相关原理，最后以实验来阐述kubernetes用户系统的思路
objective：
了解kubernetes 各种认证机制的原理 了解kubernetes 用户的概念 了解kubernetes authentication webhook 完成实验，如何将其他用户系统接入到kubernetes中的一个思路 如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大。
Kubernetes 认证 在Kubernetes apiserver对于认证部分所描述的，对于所有用户访问Kubernetes API（通过任何客户端，客户端库，kubectl 等）时都会经历 验证 (Authentication) , 授权 (Authorization), 和准入控制 (Admission control) 三个阶段来完成对 “用户” 进行授权，整个流程正如下图所示
图：Kubernetes API 请求的请求处理步骤图 Source：https://www.armosec.io/blog/kubernetes-admission-controller/
其中在大多数教程中，在对这三个阶段所做的工作大致上为：
Authentication 阶段所指用于确认请求访问Kubernetes API 用户是否为合法用户，拒绝为401
Authorization 阶段所指的将是这个用户是否有对操作的资源的权限，拒绝为403
Admission control 阶段所指控制对请求资源进行控制，通俗来说，就是一票否决权，即使前两个步骤完成"><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2022/11/ch31-authentication/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-16T00:00:00+00:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入理解Kubernetes 4A - Authentication源码解析"><meta name=twitter:description content="本文是关于Kubernetes 4A解析的第1章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A
Overview 本章主要简单阐述kubernetes 认证相关原理，最后以实验来阐述kubernetes用户系统的思路
objective：
了解kubernetes 各种认证机制的原理 了解kubernetes 用户的概念 了解kubernetes authentication webhook 完成实验，如何将其他用户系统接入到kubernetes中的一个思路 如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大。
Kubernetes 认证 在Kubernetes apiserver对于认证部分所描述的，对于所有用户访问Kubernetes API（通过任何客户端，客户端库，kubectl 等）时都会经历 验证 (Authentication) , 授权 (Authorization), 和准入控制 (Admission control) 三个阶段来完成对 “用户” 进行授权，整个流程正如下图所示
图：Kubernetes API 请求的请求处理步骤图 Source：https://www.armosec.io/blog/kubernetes-admission-controller/
其中在大多数教程中，在对这三个阶段所做的工作大致上为：
Authentication 阶段所指用于确认请求访问Kubernetes API 用户是否为合法用户，拒绝为401
Authorization 阶段所指的将是这个用户是否有对操作的资源的权限，拒绝为403
Admission control 阶段所指控制对请求资源进行控制，通俗来说，就是一票否决权，即使前两个步骤完成"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"深入理解Kubernetes 4A - Authentication源码解析","item":"https://www.oomkill.com/2022/11/ch31-authentication/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"深入理解Kubernetes 4A - Authentication源码解析","name":"深入理解Kubernetes 4A - Authentication源码解析","description":"本文是关于Kubernetes 4A解析的第1章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A\nOverview 本章主要简单阐述kubernetes 认证相关原理，最后以实验来阐述kubernetes用户系统的思路\nobjective：\n了解kubernetes 各种认证机制的原理 了解kubernetes 用户的概念 了解kubernetes authentication webhook 完成实验，如何将其他用户系统接入到kubernetes中的一个思路 如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大。\nKubernetes 认证 在Kubernetes apiserver对于认证部分所描述的，对于所有用户访问Kubernetes API（通过任何客户端，客户端库，kubectl 等）时都会经历 验证 (Authentication) , 授权 (Authorization), 和准入控制 (Admission control) 三个阶段来完成对 “用户” 进行授权，整个流程正如下图所示\n图：Kubernetes API 请求的请求处理步骤图 Source：https://www.armosec.io/blog/kubernetes-admission-controller/\n其中在大多数教程中，在对这三个阶段所做的工作大致上为：\nAuthentication 阶段所指用于确认请求访问Kubernetes API 用户是否为合法用户，拒绝为401\nAuthorization 阶段所指的将是这个用户是否有对操作的资源的权限，拒绝为403\nAdmission control 阶段所指控制对请求资源进行控制，通俗来说，就是一票否决权，即使前两个步骤完成","keywords":["ldap","kubernetes","kubernetes Authentication","k8s Authentication webhook","4A"],"articleBody":" 本文是关于Kubernetes 4A解析的第1章 深入理解Kubernetes 4A - Authentication源码解析 深入理解Kubernetes 4A - Authorization源码解析 深入理解Kubernetes 4A - Admission Control源码解析 深入理解Kubernetes 4A - Audit源码解析 TLS Everywhere - 解密kubernetes集群的安全认证 所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A\nOverview 本章主要简单阐述kubernetes 认证相关原理，最后以实验来阐述kubernetes用户系统的思路\nobjective：\n了解kubernetes 各种认证机制的原理 了解kubernetes 用户的概念 了解kubernetes authentication webhook 完成实验，如何将其他用户系统接入到kubernetes中的一个思路 如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大。\nKubernetes 认证 在Kubernetes apiserver对于认证部分所描述的，对于所有用户访问Kubernetes API（通过任何客户端，客户端库，kubectl 等）时都会经历 验证 (Authentication) , 授权 (Authorization), 和准入控制 (Admission control) 三个阶段来完成对 “用户” 进行授权，整个流程正如下图所示\n图：Kubernetes API 请求的请求处理步骤图 Source：https://www.armosec.io/blog/kubernetes-admission-controller/\n其中在大多数教程中，在对这三个阶段所做的工作大致上为：\nAuthentication 阶段所指用于确认请求访问Kubernetes API 用户是否为合法用户，拒绝为401\nAuthorization 阶段所指的将是这个用户是否有对操作的资源的权限，拒绝为403\nAdmission control 阶段所指控制对请求资源进行控制，通俗来说，就是一票否决权，即使前两个步骤完成\n到这里了解到了Kubernetes API实际上做的工作就是 “人类用户” 与 “kubernetes service account\" [2]；那么就引出了一个重要概念就是 “用户” 在Kubernetes中是什么，以及用户在认证中的也是本章节的中心。\n在Kubernetes官方手册中给出了 ”用户“ 的概念，Kubernetes集群中存在的用户包括 ”普通用户“ 与 “service account” 但是 Kubernetes 没有普通用户的管理方式，只是将使用集群的证书CA签署的有效证书的用户都被视为合法用户 [3]\n那么对于使得Kubernetes集群有一个真正的用户系统，就可以根据上面给出的概念将Kubernetes用户分为 ”外部用户“ 与 ”内部用户“。如何理解外部与内部用户呢？实际上就是有Kubernetes管理的用户，即在kubernetes定义用户的数据模型这种为 “内部用户” ，正如 service account；反之，非Kubernetes托管的用户则为 ”外部用户“ 这中概念也更好的对kubernetes用户的阐述。\n对于外部用户来说，实际上Kubernetes给出了多种用户概念 [3]，例如：\n拥有kubernetes集群证书的用户 拥有Kubernetes集群token的用户（--token-auth-file 指定的静态token） 用户来自外部用户系统，例如 OpenID，LDAP，QQ connect, google identity platform 等 向外部用户授权集群访问的示例 场景1：通过证书请求k8s 该场景中kubernetes将使用证书中的cn作为用户，ou作为组，如果对应 rolebinding/clusterrolebinding 给予该用户权限，那么请求为合法\nbash 1 2 3 4 $ curl https://hostname:6443/api/v1/pods \\ --cert ./client.pem \\ --key ./client-key.pem \\ --cacert ./ca.pem 接下来浅析下在代码中做的事情\n确认用户是 apiserver 在 Authentication 阶段 做的事情，而对应代码在 pkg/kubeapiserver/authenticator 下，整个文件就是构建了一系列的认证器，而x.509证书指是其中一个\ngo 1 2 3 4 5 6 7 8 9 10 11 12 // 创建一个认证器，返回请求或一个k8s认证机制的标准错误 func (config Config) New() (authenticator.Request, *spec.SecurityDefinitions, error) { ... // X509 methods // 可以看到这里就是将x509证书解析为user if config.ClientCAContentProvider != nil { certAuth := x509.NewDynamic(config.ClientCAContentProvider.VerifyOptions, x509.CommonNameUserConversion) authenticators = append(authenticators, certAuth) } ... 接下来看实现原理，NewDynamic函数位于代码 k8s.io/apiserver/pkg/authentication/request/x509/x509.go\n通过代码可以看出，是通过一个验证函数与用户来解析为一个 Authenticator\ngo 1 2 3 4 5 // NewDynamic returns a request.Authenticator that verifies client certificates using the provided // VerifyOptionFunc (which may be dynamic), and converts valid certificate chains into user.Info using the provided UserConversion func NewDynamic(verifyOptionsFn VerifyOptionFunc, user UserConversion) *Authenticator { return \u0026Authenticator{verifyOptionsFn, user} } 验证函数为 CAContentProvider 的方法，而x509部分实现为 k8s.io/apiserver/pkg/server/dynamiccertificates/dynamic_cafile_content.go.VerifyOptions；可以看出返回是一个 x509.VerifyOptions + 与认证的状态\ngo 1 2 3 4 5 6 7 8 9 // VerifyOptions provides verifyoptions compatible with authenticators func (c *DynamicFileCAContent) VerifyOptions() (x509.VerifyOptions, bool) { uncastObj := c.caBundle.Load() if uncastObj == nil { return x509.VerifyOptions{}, false } return uncastObj.(*caBundleAndVerifier).verifyOptions, true } 而用户的获取则位于 k8s.io/apiserver/pkg/authentication/request/x509/x509.go；可以看出，用户正是拿的证书的CN，而组则是为证书的OU\ngo 1 2 3 4 5 6 7 8 9 10 11 12 // CommonNameUserConversion builds user info from a certificate chain using the subject's CommonName var CommonNameUserConversion = UserConversionFunc(func(chain []*x509.Certificate) (*authenticator.Response, bool, error) { if len(chain[0].Subject.CommonName) == 0 { return nil, false, nil } return \u0026authenticator.Response{ User: \u0026user.DefaultInfo{ Name: chain[0].Subject.CommonName, Groups: chain[0].Subject.Organization, }, }, true, nil }) 由于授权不在本章范围内，直接忽略至入库阶段，入库阶段由 RESTStorageProvider 实现 这里，每一个Provider都提供了 Authenticator 这里包含了已经允许的请求，将会被对应的REST客户端写入到库中\ngo 1 2 3 4 5 6 7 8 9 type RESTStorageProvider struct { Authenticator authenticator.Request APIAudiences authenticator.Audiences } // RESTStorageProvider is a factory type for REST storage. type RESTStorageProvider interface { GroupName() string NewRESTStorage(apiResourceConfigSource serverstorage.APIResourceConfigSource, restOptionsGetter generic.RESTOptionsGetter) (genericapiserver.APIGroupInfo, error) } 场景2：通过token 该场景中，当 kube-apiserver 开启了 --enable-bootstrap-token-auth 时，就可以使用 Bootstrap Token 进行认证，通常如下列命令，在请求头中增加 Authorization: Bearer 标识\nbash 1 2 3 $ curl https://hostname:6443/api/v1/pods \\ --cacert ${CACERT} \\ --header \"Authorization: Bearer \" \\ 接下来浅析下在代码中做的事情\n可以看到，在代码 pkg/kubeapiserver/authenticator.New() 中当 kube-apiserver 指定了参数 --token-auth-file=/etc/kubernetes/token.csv\" 这种认证会被激活\ngo 1 2 3 4 5 6 7 if len(config.TokenAuthFile) \u003e 0 { tokenAuth, err := newAuthenticatorFromTokenFile(config.TokenAuthFile) if err != nil { return nil, nil, err } tokenAuthenticators = append(tokenAuthenticators, authenticator.WrapAudienceAgnosticToken(config.APIAudiences, tokenAuth)) } 此时打开 token.csv 查看下token长什么样\nbash 1 2 $ cat /etc/kubernetes/token.csv 12ba4f.d82a57a4433b2359,\"system:bootstrapper\",10001,\"system:bootstrappers\" 这里回到代码 k8s.io/apiserver/pkg/authentication/token/tokenfile/tokenfile.go.NewCSV ，这里可以看出，就是读取 --token-auth-file= 参数指定的tokenfile，然后解析为用户，record[1] 作为用户名，record[2] 作为UID\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 // NewCSV returns a TokenAuthenticator, populated from a CSV file. // The CSV file must contain records in the format \"token,username,useruid\" func NewCSV(path string) (*TokenAuthenticator, error) { file, err := os.Open(path) if err != nil { return nil, err } defer file.Close() recordNum := 0 tokens := make(map[string]*user.DefaultInfo) reader := csv.NewReader(file) reader.FieldsPerRecord = -1 for { record, err := reader.Read() if err == io.EOF { break } if err != nil { return nil, err } if len(record) \u003c 3 { return nil, fmt.Errorf(\"token file '%s' must have at least 3 columns (token, user name, user uid), found %d\", path, len(record)) } recordNum++ if record[0] == \"\" { klog.Warningf(\"empty token has been found in token file '%s', record number '%d'\", path, recordNum) continue } obj := \u0026user.DefaultInfo{ Name: record[1], UID: record[2], } if _, exist := tokens[record[0]]; exist { klog.Warningf(\"duplicate token has been found in token file '%s', record number '%d'\", path, recordNum) } tokens[record[0]] = obj if len(record) \u003e= 4 { obj.Groups = strings.Split(record[3], \",\") } } return \u0026TokenAuthenticator{ tokens: tokens, }, nil } 而token file中配置的格式正是以逗号分隔的一组字符串，\ngo 1 2 3 4 5 6 type DefaultInfo struct { Name string UID string Groups []string Extra map[string][]string } 这种用户最常见的方式就是 kubelet 通常会以此类用户向控制平面进行身份认证，例如下列配置\nbash 1 2 3 4 5 6 7 KUBELET_ARGS=\"--v=0 \\ --logtostderr=true \\ --config=/etc/kubernetes/kubelet-config.yaml \\ --kubeconfig=/etc/kubernetes/auth/kubelet.conf \\ --network-plugin=cni \\ --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \\ --bootstrap-kubeconfig=/etc/kubernetes/auth/bootstrap.conf\" /etc/kubernetes/auth/bootstrap.conf 内容，这里就用到了 kube-apiserver 配置的 --token-auth-file= 用户名，组必须为 system:bootstrappers\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 apiVersion: v1 clusters: - cluster: certificate-authority-data: ...... server: https://10.0.0.4:6443 name: kubernetes contexts: - context: cluster: kubernetes user: system:bootstrapper name: system:bootstrapper@kubernetes current-context: system:bootstrapper@kubernetes kind: Config preferences: {} users: - name: system:bootstrapper 而通常在二进制部署时会出现的问题，例如下列错误\nlog Unable to register node \"hostname\" with API server: nodes is forbidden: User \"system:anonymous\" cannot create resource \"nodes\" in API group \"\" at the cluster scope 而通常解决方法是执行下列命令，这里就是将 kubelet 与 kube-apiserver 通讯时的用户授权，因为kubernetes官方给出的条件是，用户组必须为 system:bootstrappers [4]\nbash 1 $ kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers 生成的clusterrolebinding 如下\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: creationTimestamp: \"2022-08-14T22:26:51Z\" managedFields: - apiVersion: rbac.authorization.k8s.io/v1 fieldsType: FieldsV1 ... time: \"2022-08-14T22:26:51Z\" name: kubelet-bootstrap resourceVersion: \"158\" selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/kubelet-bootstrap uid: b4d70f4f-4ae0-468f-86b7-55e9351e4719 roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: system:node-bootstrapper subjects: - apiGroup: rbac.authorization.k8s.io kind: Group name: system:bootstrappers 上述就是 bootstrap token，翻译后就是引导token，因为其做的工作就是将节点载入Kubernetes系统过程提供认证机制的用户。\nNotes：这种用户不存在与kubernetes内，可以算属于一个外部用户，但认证机制中存在并绑定了最高权限，也可以用来做其他访问时的认证\n场景3：serviceaccount serviceaccount通常为API自动创建的，但在用户中，实际上认证存在两个方向，一个是 --service-account-key-file 这个参数可以指定多个，指定对应的证书文件公钥或私钥，用以办法sa的token\n首先会根据指定的公钥或私钥文件生成token\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 if len(config.ServiceAccountKeyFiles) \u003e 0 { serviceAccountAuth, err := newLegacyServiceAccountAuthenticator(config.ServiceAccountKeyFiles, config.ServiceAccountLookup, config.APIAudiences, config.ServiceAccountTokenGetter) if err != nil { return nil, nil, err } tokenAuthenticators = append(tokenAuthenticators, serviceAccountAuth) } if len(config.ServiceAccountIssuers) \u003e 0 { serviceAccountAuth, err := newServiceAccountAuthenticator(config.ServiceAccountIssuers, config.ServiceAccountKeyFiles, config.APIAudiences, config.ServiceAccountTokenGetter) if err != nil { return nil, nil, err } tokenAuthenticators = append(tokenAuthenticators, serviceAccountAuth) } 对于 --service-account-key-file 他生成的用户都是 “kubernetes/serviceaccount” , 而对于 --service-account-issuer 只是对sa颁发者提供了一个称号标识是谁，而不是统一的 “kubernetes/serviceaccount” ，这里可以从代码中看到，两者是完全相同的，只是称号不同罢了\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // newLegacyServiceAccountAuthenticator returns an authenticator.Token or an error func newLegacyServiceAccountAuthenticator(keyfiles []string, lookup bool, apiAudiences authenticator.Audiences, serviceAccountGetter serviceaccount.ServiceAccountTokenGetter) (authenticator.Token, error) { allPublicKeys := []interface{}{} for _, keyfile := range keyfiles { publicKeys, err := keyutil.PublicKeysFromFile(keyfile) if err != nil { return nil, err } allPublicKeys = append(allPublicKeys, publicKeys...) } // 唯一的区别 这里使用了常量 serviceaccount.LegacyIssuer tokenAuthenticator := serviceaccount.JWTTokenAuthenticator([]string{serviceaccount.LegacyIssuer}, allPublicKeys, apiAudiences, serviceaccount.NewLegacyValidator(lookup, serviceAccountGetter)) return tokenAuthenticator, nil } // newServiceAccountAuthenticator returns an authenticator.Token or an error func newServiceAccountAuthenticator(issuers []string, keyfiles []string, apiAudiences authenticator.Audiences, serviceAccountGetter serviceaccount.ServiceAccountTokenGetter) (authenticator.Token, error) { allPublicKeys := []interface{}{} for _, keyfile := range keyfiles { publicKeys, err := keyutil.PublicKeysFromFile(keyfile) if err != nil { return nil, err } allPublicKeys = append(allPublicKeys, publicKeys...) } // 唯一的区别 这里根据kube-apiserver提供的称号指定名称 tokenAuthenticator := serviceaccount.JWTTokenAuthenticator(issuers, allPublicKeys, apiAudiences, serviceaccount.NewValidator(serviceAccountGetter)) return tokenAuthenticator, nil } 最后根据ServiceAccounts，Secrets等值签发一个token，也就是通过下列命令获取的值\ngo 1 $ kubectl get secret multus-token-v6bfg -n kube-system -o jsonpath={\".data.token\"} 场景4：openid OpenID Connect是 OAuth2 风格，允许用户授权三方网站访问他们存储在另外的服务提供者上的信息，而不需要将用户名和密码提供给第三方网站或分享他们数据的所有内容，下面是一张kubernetes 使用 OID 认证的逻辑图\n图：Kubernetes OID认证 Source：https://developer.okta.com/blog/2021/11/08/k8s-api-server-oidc\n场景5：webhook webhook是kubernetes提供自定义认证的其中一种，主要是用于认证 “不记名 token“ 的钩子，“不记名 token“ 将 由身份验证服务创建。当用户对kubernetes访问时，会触发准入控制，当对kubernetes集群注册了 authenticaion webhook时，将会使用该webhook提供的方式进行身份验证时，此时会为您生成一个 token 。\n如代码 pkg/kubeapiserver/authenticator.New() 中所示 newWebhookTokenAuthenticator 会通过提供的config (--authentication-token-webhook-config-file) 来创建出一个 WebhookTokenAuthenticator\ngo 1 2 3 4 5 6 7 8 if len(config.WebhookTokenAuthnConfigFile) \u003e 0 { webhookTokenAuth, err := newWebhookTokenAuthenticator(config) if err != nil { return nil, nil, err } tokenAuthenticators = append(tokenAuthenticators, webhookTokenAuth) } 下图是kubernetes 中 WebhookToken 验证的工作原理\n图：kubernetes WebhookToken验证原理 Source：https://learnk8s.io/kubernetes-custom-authentication\n最后由token中的authHandler，循环所有的Handlers在运行 AuthenticateToken 去进行获取用户的信息\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func (authHandler *unionAuthTokenHandler) AuthenticateToken(ctx context.Context, token string) (*authenticator.Response, bool, error) { var errlist []error for _, currAuthRequestHandler := range authHandler.Handlers { info, ok, err := currAuthRequestHandler.AuthenticateToken(ctx, token) if err != nil { if authHandler.FailOnError { return info, ok, err } errlist = append(errlist, err) continue } if ok { return info, ok, err } } return nil, false, utilerrors.NewAggregate(errlist) } 而webhook插件也实现了这个方法 AuthenticateToken ,这里会通过POST请求，调用注入的webhook，该请求携带一个JSON 格式的 TokenReview 对象，其中包含要验证的令牌\ngo 1 2 3 4 5 6 7 8 9 func (w *WebhookTokenAuthenticator) AuthenticateToken(ctx context.Context, token string) (*authenticator.Response, bool, error) { .... start := time.Now() result, statusCode, tokenReviewErr = w.tokenReview.Create(ctx, r, metav1.CreateOptions{}) latency := time.Since(start) ... } webhook token认证服务要返回用户的身份信息，就是上面token部分提到的数据结构（webhook来决定接受还是拒绝该用户）\ngo 1 2 3 4 5 6 type DefaultInfo struct { Name string UID string Groups []string Extra map[string][]string } 场景6：代理认证 实验：基于LDAP的身份认证 通过上面阐述，大致了解到kubernetes认证框架中的用户的分类以及认证的策略由哪些，实验的目的也是为了阐述一个结果，就是使用OIDC/webhook 是比其他方式更好的保护，管理kubernetes集群。首先在安全上，假设网络环境是不安全的，那么任意node节点遗漏 bootstrap token文件，就意味着拥有了集群中最高权限；其次在管理上，越大的团队，人数越多，不可能每个用户都提供单独的证书或者token，要知道传统教程中讲到token在kubernetes集群中是永久有效的，除非你删除了这个secret/sa；而Kubernetes提供的插件就很好的解决了这些问题。\n实验环境 一个kubernetes集群 一个openldap服务，建议可以是集群外部的，因为webhook不像SSSD有缓存机制，并且集群不可用，那么认证不可用，当认证不可用时会导致集群不可用，这样事故影响的范围可以得到控制，也叫最小化半径 了解ldap相关技术，并了解go ldap客户端 实验大致分为以下几个步骤：\n建立一个HTTP服务器用于返回给kubernetes Authenticaion服务 查询ldap该用户是否合法 查询用户是否合法 查询用户所属组是否拥有权限 实验开始 初始化用户数据 首先准备openldap初始化数据，创建三个 posixGroup 组，与5个用户 admin, admin1, admin11, searchUser, syncUser 密码均为111，组与用户关联使用的 memberUid\nbash 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 cat \u003c\u003c EOF | ldapdelete -r -H ldap://10.0.0.3 -D \"cn=admin,dc=test,dc=com\" -w 111 dn: dc=test,dc=com objectClass: top objectClass: organizationalUnit objectClass: extensibleObject description: US Organization ou: people dn: ou=tvb,dc=test,dc=com objectClass: organizationalUnit description: Television Broadcasts Limited ou: tvb dn: cn=admin,ou=tvb,dc=test,dc=com objectClass: posixGroup gidNumber: 10000 cn: admin dn: cn=conf,ou=tvb,dc=test,dc=com objectClass: posixGroup gidNumber: 10001 cn: conf dn: cn=dir,ou=tvb,dc=test,dc=com objectClass: posixGroup gidNumber: 10002 cn: dir dn: uid=syncUser,ou=tvb,dc=test,dc=com objectClass: inetOrgPerson objectClass: organizationalPerson objectClass: person objectClass: posixAccount objectClass: shadowAccount objectClass: pwdPolicy pwdAttribute: userPassword uid: syncUser cn: syncUser uidNumber: 10006 gidNumber: 10002 homeDirectory: /home/syncUser loginShell: /bin/bash sn: syncUser givenName: syncUser memberOf: cn=confGroup,ou=tvb,dc=test,dc=com dn: uid=searchUser,ou=tvb,dc=test,dc=com objectClass: inetOrgPerson objectClass: organizationalPerson objectClass: person objectClass: posixAccount objectClass: shadowAccount objectClass: pwdPolicy pwdAttribute: userPassword uid: searchUser cn: searchUser uidNumber: 10005 gidNumber: 10001 homeDirectory: /home/searchUser loginShell: /bin/bash sn: searchUser givenName: searchUser memberOf: cn=dirGroup,ou=tvb,dc=test,dc=com dn: uid=admin1,ou=tvb,dc=test,dc=com objectClass: inetOrgPerson objectClass: organizationalPerson objectClass: person objectClass: posixAccount objectClass: shadowAccount objectClass: pwdPolicy pwdAttribute: userPassword uid: admin1 sn: admin1 cn: admin uidNumber: 10010 gidNumber: 10000 homeDirectory: /home/admin loginShell: /bin/bash givenName: admin memberOf: cn=adminGroup,ou=tvb,dc=test,dc=com dn: uid=admin11,ou=tvb,dc=test,dc=com objectClass: inetOrgPerson objectClass: organizationalPerson objectClass: person objectClass: posixAccount objectClass: shadowAccount objectClass: pwdPolicy sn: admin11 pwdAttribute: userPassword uid: admin11 cn: admin11 uidNumber: 10011 gidNumber: 10000 homeDirectory: /home/admin loginShell: /bin/bash givenName: admin11 memberOf: cn=adminGroup,ou=tvb,dc=test,dc=com dn: uid=admin,ou=tvb,dc=test,dc=com objectClass: inetOrgPerson objectClass: organizationalPerson objectClass: person objectClass: posixAccount objectClass: shadowAccount objectClass: pwdPolicy pwdAttribute: userPassword uid: admin cn: admin uidNumber: 10009 gidNumber: 10000 homeDirectory: /home/admin loginShell: /bin/bash sn: admin givenName: admin memberOf: cn=adminGroup,ou=tvb,dc=test,dc=com EOF 接下来需要确定如何为认证成功的用户，上面讲到对于kubernetes中用户格式为 v1.UserInfo 的格式，即要获得用户，即用户组，假设需要查找的用户为，admin，那么在openldap中查询filter如下：\nbash 1 \"(|(\u0026(objectClass=posixAccount)(uid=admin))(\u0026(objectClass=posixGroup)(memberUid=admin)))\" 上面语句意思是，找到 objectClass=posixAccount 并且 uid=admin 或者 objectClass=posixGroup 并且 memberUid=admin 的条目信息，这里使用 ”|“ 与 ”\u0026“ 是为了要拿到这两个结果。\n编写webhook查询用户部分 这里由于openldap配置密码保存格式不是明文的，如果直接使用 ”=“ 来验证是查询不到内容的，故直接多用了一次登录来验证用户是否合法\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 func ldapSearch(username, password string) (*v1.UserInfo, error) { ldapconn, err := ldap.DialURL(ldapURL) if err != nil { klog.V(3).Info(err) return nil, err } defer ldapconn.Close() // Authenticate as LDAP admin user err = ldapconn.Bind(\"uid=searchUser,ou=tvb,dc=test,dc=com\", \"111\") if err != nil { klog.V(3).Info(err) return nil, err } // Execute LDAP Search request result, err := ldapconn.Search(ldap.NewSearchRequest( \"ou=tvb,dc=test,dc=com\", ldap.ScopeWholeSubtree, ldap.NeverDerefAliases, 0, 0, false, fmt.Sprintf(\"(\u0026(objectClass=posixGroup)(memberUid=%s))\", username), // Filter nil, nil, )) if err != nil { klog.V(3).Info(err) return nil, err } userResult, err := ldapconn.Search(ldap.NewSearchRequest( \"ou=tvb,dc=test,dc=com\", ldap.ScopeWholeSubtree, ldap.NeverDerefAliases, 0, 0, false, fmt.Sprintf(\"(\u0026(objectClass=posixAccount)(uid=%s))\", username), // Filter nil, nil, )) if err != nil { klog.V(3).Info(err) return nil, err } if len(result.Entries) == 0 { klog.V(3).Info(\"User does not exist\") return nil, errors.New(\"User does not exist\") } else { // 验证用户名密码是否正确 if err := ldapconn.Bind(userResult.Entries[0].DN, password); err != nil { e := fmt.Sprintf(\"Failed to auth. %s\\n\", err) klog.V(3).Info(e) return nil, errors.New(e) } else { klog.V(3).Info(fmt.Sprintf(\"User %s Authenticated successfuly!\", username)) } // 拼接为kubernetes authentication 的用户格式 user := new(v1.UserInfo) for _, v := range result.Entries { attrubute := v.GetAttributeValue(\"objectClass\") if strings.Contains(attrubute, \"posixGroup\") { user.Groups = append(user.Groups, v.GetAttributeValue(\"cn\")) } } u := userResult.Entries[0].GetAttributeValue(\"uid\") user.UID = u user.Username = u return user, nil } } 编写HTTP部分 这里有几个需要注意的部分，即用户或者理解为要认证的token的定义，此处使用了 ”username@password“ 格式作为用户的辨别，即登录kubernetes时需要直接输入 ”username@password“ 来作为登录的凭据。\n第二个部分为返回值，返回给Kubernetes的格式必须为 api/authentication/v1.TokenReview 格式，Status.Authenticated 表示用户身份验证结果，如果该用户合法，则设置 tokenReview.Status.Authenticated = true 反之亦然。如果验证成功还需要 Status.User 这就是在ldapSearch\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 func serve(w http.ResponseWriter, r *http.Request) { b, err := ioutil.ReadAll(r.Body) if err != nil { httpError(w, err) return } klog.V(4).Info(\"Receiving: %s\\n\", string(b)) var tokenReview v1.TokenReview err = json.Unmarshal(b, \u0026tokenReview) if err != nil { klog.V(3).Info(\"Json convert err: \", err) httpError(w, err) return } // 提取用户名与密码 s := strings.SplitN(tokenReview.Spec.Token, \"@\", 2) if len(s) != 2 { klog.V(3).Info(fmt.Errorf(\"badly formatted token: %s\", tokenReview.Spec.Token)) httpError(w, fmt.Errorf(\"badly formatted token: %s\", tokenReview.Spec.Token)) return } username, password := s[0], s[1] // 查询ldap，验证用户是否合法 userInfo, err := ldapSearch(username, password) if err != nil { // 这里不打印日志的原因是 ldapSearch 中打印过了 return } // 设置返回的tokenReview if userInfo == nil { tokenReview.Status.Authenticated = false } else { tokenReview.Status.Authenticated = true tokenReview.Status.User = *userInfo } b, err = json.Marshal(tokenReview) if err != nil { klog.V(3).Info(\"Json convert err: \", err) httpError(w, err) return } w.Write(b) klog.V(3).Info(\"Returning: \", string(b)) } func httpError(w http.ResponseWriter, err error) { err = fmt.Errorf(\"Error: %v\", err) w.WriteHeader(http.StatusInternalServerError) // 500 fmt.Fprintln(w, err) klog.V(4).Info(\"httpcode 500: \", err) } 下面是完整的代码\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 package main import ( \"encoding/json\" \"errors\" \"flag\" \"fmt\" \"io/ioutil\" \"net/http\" \"strings\" \"github.com/go-ldap/ldap\" \"k8s.io/api/authentication/v1\" \"k8s.io/klog/v2\" ) var ldapURL string func main() { klog.InitFlags(nil) flag.Parse() http.HandleFunc(\"/authenticate\", serve) klog.V(4).Info(\"Listening on port 443 waiting for requests...\") klog.V(4).Info(http.ListenAndServe(\":443\", nil)) ldapURL = \"ldap://10.0.0.10:389\" ldapSearch(\"admin\", \"1111\") } func serve(w http.ResponseWriter, r *http.Request) { b, err := ioutil.ReadAll(r.Body) if err != nil { httpError(w, err) return } klog.V(4).Info(\"Receiving: %s\\n\", string(b)) var tokenReview v1.TokenReview err = json.Unmarshal(b, \u0026tokenReview) if err != nil { klog.V(3).Info(\"Json convert err: \", err) httpError(w, err) return } // 提取用户名与密码 s := strings.SplitN(tokenReview.Spec.Token, \"@\", 2) if len(s) != 2 { klog.V(3).Info(fmt.Errorf(\"badly formatted token: %s\", tokenReview.Spec.Token)) httpError(w, fmt.Errorf(\"badly formatted token: %s\", tokenReview.Spec.Token)) return } username, password := s[0], s[1] // 查询ldap，验证用户是否合法 userInfo, err := ldapSearch(username, password) if err != nil { // 这里不打印日志的原因是 ldapSearch 中打印过了 return } // 设置返回的tokenReview if userInfo == nil { tokenReview.Status.Authenticated = false } else { tokenReview.Status.Authenticated = true tokenReview.Status.User = *userInfo } b, err = json.Marshal(tokenReview) if err != nil { klog.V(3).Info(\"Json convert err: \", err) httpError(w, err) return } w.Write(b) klog.V(3).Info(\"Returning: \", string(b)) } func httpError(w http.ResponseWriter, err error) { err = fmt.Errorf(\"Error: %v\", err) w.WriteHeader(http.StatusInternalServerError) // 500 fmt.Fprintln(w, err) klog.V(4).Info(\"httpcode 500: \", err) } func ldapSearch(username, password string) (*v1.UserInfo, error) { ldapconn, err := ldap.DialURL(ldapURL) if err != nil { klog.V(3).Info(err) return nil, err } defer ldapconn.Close() // Authenticate as LDAP admin user err = ldapconn.Bind(\"cn=admin,dc=test,dc=com\", \"111\") if err != nil { klog.V(3).Info(err) return nil, err } // Execute LDAP Search request result, err := ldapconn.Search(ldap.NewSearchRequest( \"ou=tvb,dc=test,dc=com\", ldap.ScopeWholeSubtree, ldap.NeverDerefAliases, 0, 0, false, fmt.Sprintf(\"(\u0026(objectClass=posixGroup)(memberUid=%s))\", username), // Filter nil, nil, )) if err != nil { klog.V(3).Info(err) return nil, err } userResult, err := ldapconn.Search(ldap.NewSearchRequest( \"ou=tvb,dc=test,dc=com\", ldap.ScopeWholeSubtree, ldap.NeverDerefAliases, 0, 0, false, fmt.Sprintf(\"(\u0026(objectClass=posixAccount)(uid=%s))\", username), // Filter nil, nil, )) if err != nil { klog.V(3).Info(err) return nil, err } if len(result.Entries) == 0 { klog.V(3).Info(\"User does not exist\") return nil, errors.New(\"User does not exist\") } else { // 验证用户名密码是否正确 if err := ldapconn.Bind(userResult.Entries[0].DN, password); err != nil { e := fmt.Sprintf(\"Failed to auth. %s\\n\", err) klog.V(3).Info(e) return nil, errors.New(e) } else { klog.V(3).Info(fmt.Sprintf(\"User %s Authenticated successfuly!\", username)) } // 拼接为kubernetes authentication 的用户格式 user := new(v1.UserInfo) for _, v := range result.Entries { attrubute := v.GetAttributeValue(\"objectClass\") if strings.Contains(attrubute, \"posixGroup\") { user.Groups = append(user.Groups, v.GetAttributeValue(\"cn\")) } } u := userResult.Entries[0].GetAttributeValue(\"uid\") user.UID = u user.Username = u return user, nil } } 部署webhook kubernetes官方手册中指出，启用webhook认证的标记是在 kube-apiserver 指定参数 --authentication-token-webhook-config-file 。而这个配置文件是一个 kubeconfig 类型的文件格式 [5]\n下列是部署在kubernetes集群外部的配置\n创建一个给 kube-apiserver 使用的配置文件 /etc/kubernetes/auth/authentication-webhook.conf\nyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: v1 kind: Config clusters: - cluster: server: http://10.0.0.1:88/authenticate name: authenticator users: - name: webhook-authenticator current-context: webhook-authenticator@authenticator contexts: - context: cluster: authenticator user: webhook-authenticator name: webhook-authenticator@authenticator 修改 kube-apiserver 参数\nbash 1 2 3 4 5 6 # 指向对应的配置文件 --authentication-token-webhook-config-file=/etc/kubernetes/auth/authentication-webhook.conf # 这个是token缓存时间，指的是用户在访问API时验证通过后在一定时间内无需在请求webhook进行认证了 --authentication-token-webhook-cache-ttl=30m # 版本指定为API使用哪个版本？authentication.k8s.io/v1或v1beta1 --authentication-token-webhook-version=v1 启动服务后，创建一个 kubeconfig 中的用户用于验证结果\nconf apiVersion: v1 clusters: - cluster: certificate-authority-data: server: https://10.0.0.4:6443 name: kubernetes contexts: - context: cluster: kubernetes user: k8s-admin name: k8s-admin@kubernetes current-context: k8s-admin@kubernetes kind: Config preferences: {} users: - name: admin user: token: admin@111 验证结果 当密码不正确时，使用用户admin请求集群\nbash 1 2 $ kubectl get pods --user=admin error: You must be logged in to the server (Unauthorized) 当密码正确时，使用用户admin请求集群\nbash 1 2 $ kubectl get pods --user=admin Error from server (Forbidden): pods is forbidden: User \"admin\" cannot list resource \"pods\" in API group \"\" in the namespace \"default\" 可以看到admin用户是一个不存在与集群中的用户，并且提示没有权限操作对应资源，此时将admin用户与集群中的cluster-admin绑定，测试结果\nbash 1 2 3 $ kubectl create clusterrolebinding admin \\ --clusterrole=cluster-admin \\ --group=admin 此时再尝试使用admin用户访问集群\nbash 1 2 3 4 $ kubectl get pods --user=admin NAME READY STATUS RESTARTS AGE netbox-85865d5556-hfg6v 1/1 Running 0 91d netbox-85865d5556-vlgr4 1/1 Running 0 91d 总结 kubernetes authentication 插件提供的功能可以注入一个认证系统，这样可以完美解决了kubernetes中用户的问题，而这些用户并不存在与kubernetes中，并且也无需为多个用户准备大量serviceaccount或者证书，也可以完成鉴权操作。首先返回值标准如下所示，如果kubernetes集群有对在其他用户系统中获得的 Groups 并建立了 clusterrolebinding 或 rolebinding 那么这个组的所有用户都将有这些权限。管理员只需要维护与公司用户系统中组同样多的 clusterrole 与 clusterrolebinding 即可\ngo 1 2 3 4 5 6 type DefaultInfo struct { Name string UID string Groups []string Extra map[string][]string } 对于如何将 kubernetes 与其他平台进行融合可以参考 文章\nNotes：Kubernetes原生就支持OID，完全不用自己开发webhook从而实现接入其他系统，这里展示的只是一个思路\nReference [1] Implementing a custom Kubernetes authentication method\n[2] Controlling Access to the Kubernetes API\n[3] Users in Kubernetes\n[4] bootstrap tokens\n[5] Webhook Token Authentication\n","wordCount":"3097","inLanguage":"zh","datePublished":"2022-11-16T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2022/11/ch31-authentication/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">深入理解Kubernetes 4A - Authentication源码解析</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-11-16</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>3097 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>15 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/ldap/>#Ldap</a>
<a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a>
<a href=https://www.oomkill.com/tags/kubernetes-develop/>#Kubernetes Develop</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a><li><a href=#kubernetes-%e8%ae%a4%e8%af%81 aria-label="Kubernetes 认证">Kubernetes 认证</a><li><a href=#%e5%90%91%e5%a4%96%e9%83%a8%e7%94%a8%e6%88%b7%e6%8e%88%e6%9d%83%e9%9b%86%e7%be%a4%e8%ae%bf%e9%97%ae%e7%9a%84%e7%a4%ba%e4%be%8b aria-label=向外部用户授权集群访问的示例>向外部用户授权集群访问的示例</a><ul><li><a href=#%e5%9c%ba%e6%99%af1%e9%80%9a%e8%bf%87%e8%af%81%e4%b9%a6%e8%af%b7%e6%b1%82k8s aria-label=场景1：通过证书请求k8s>场景1：通过证书请求k8s</a><li><a href=#%e5%9c%ba%e6%99%af2%e9%80%9a%e8%bf%87token aria-label=场景2：通过token>场景2：通过token</a><li><a href=#%e5%9c%ba%e6%99%af3serviceaccount aria-label=场景3：serviceaccount>场景3：serviceaccount</a><li><a href=#%e5%9c%ba%e6%99%af4openid aria-label=场景4：openid>场景4：openid</a><li><a href=#%e5%9c%ba%e6%99%af5webhook aria-label=场景5：webhook>场景5：webhook</a><li><a href=#%e5%9c%ba%e6%99%af6%e4%bb%a3%e7%90%86%e8%ae%a4%e8%af%81 aria-label=场景6：代理认证>场景6：代理认证</a></ul><li><a href=#%e5%ae%9e%e9%aa%8c%e5%9f%ba%e4%ba%8eldap%e7%9a%84%e8%ba%ab%e4%bb%bd%e8%ae%a4%e8%af%81 aria-label=实验：基于LDAP的身份认证>实验：基于LDAP的身份认证</a><ul><li><a href=#%e5%ae%9e%e9%aa%8c%e7%8e%af%e5%a2%83 aria-label=实验环境>实验环境</a><li><a href=#%e5%ae%9e%e9%aa%8c%e5%bc%80%e5%a7%8b aria-label=实验开始>实验开始</a><ul><li><a href=#%e5%88%9d%e5%a7%8b%e5%8c%96%e7%94%a8%e6%88%b7%e6%95%b0%e6%8d%ae aria-label=初始化用户数据>初始化用户数据</a><li><a href=#%e7%bc%96%e5%86%99webhook%e6%9f%a5%e8%af%a2%e7%94%a8%e6%88%b7%e9%83%a8%e5%88%86 aria-label=编写webhook查询用户部分>编写webhook查询用户部分</a><li><a href=#%e7%bc%96%e5%86%99http%e9%83%a8%e5%88%86 aria-label=编写HTTP部分>编写HTTP部分</a></ul><li><a href=#%e9%83%a8%e7%bd%b2webhook aria-label=部署webhook>部署webhook</a><li><a href=#%e9%aa%8c%e8%af%81%e7%bb%93%e6%9e%9c aria-label=验证结果>验证结果</a></ul><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><div class="pe-details admonition abstract"><div class="pe-details-summary admonition-title"><i class="icon fas fa-list-ul fa-fw" aria-hidden=true></i>本文是关于Kubernetes 4A解析的第1章<i class="pe-details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=pe-details-content><div class=admonition-content><ul><li>深入理解Kubernetes 4A - Authentication源码解析</li><li><a href=https://www.oomkill.com/2022/11/ch32-authorization/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Authorization源码解析</a></li><li><a href=https://www.oomkill.com/2022/07/ch33-admission-webhook/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Admission Control源码解析</a></li><li><a href=https://www.oomkill.com/2022/11/ch34-auditing/ target=_blank rel="noopener nofollow noreferrer">深入理解Kubernetes 4A - Audit源码解析</a></li><li><a href=https://www.oomkill.com/2024/11/k8s-auth-and-regenerate-cert/ target=_blank rel="noopener nofollow noreferrer">TLS Everywhere - 解密kubernetes集群的安全认证</a></li></ul><p>所有关于Kubernetes 4A部分代码上传至仓库 github.com/cylonchau/hello-k8s-4A</p></div></div></div><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>本章主要简单阐述kubernetes 认证相关原理，最后以实验来阐述kubernetes用户系统的思路</p><p><strong>objective</strong>：</p><ul><li>了解kubernetes 各种认证机制的原理</li><li>了解kubernetes 用户的概念</li><li>了解kubernetes authentication webhook</li><li>完成实验，如何将其他用户系统接入到kubernetes中的一个思路</li></ul><p>如有错别字或理解错误地方请多多担待，代码是以1.24进行整理，实验是以1.19环境进行，差别不大。</p><h2 id=kubernetes-认证>Kubernetes 认证<a hidden class=anchor aria-hidden=true href=#kubernetes-认证>#</a></h2><p>在Kubernetes apiserver对于认证部分所描述的，对于所有用户访问Kubernetes API（通过任何客户端，客户端库，<code>kubectl</code> 等）时都会经历 验证 (<em><strong>Authentication</strong></em>) , 授权 (<em><strong>Authorization</strong></em>), 和准入控制 (<em><strong>Admission control</strong></em>) 三个阶段来完成对 “用户” 进行授权，整个流程正如下图所示</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/vhesGDFN3dLdzXwS7vzPdXkI3aglQYZgGhjc-Cx_boaV6URKFFoe8mFRZZUuJyGHywa_bOkeUlIkm-nJkCVMHPk9dr2dXFwNzAQJKzft2phsTcEDjdObjmugBcYtpdPLpLIYuIGzeFYvtsR2Lw.jpeg><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/vhesGDFN3dLdzXwS7vzPdXkI3aglQYZgGhjc-Cx_boaV6URKFFoe8mFRZZUuJyGHywa_bOkeUlIkm-nJkCVMHPk9dr2dXFwNzAQJKzft2phsTcEDjdObjmugBcYtpdPLpLIYuIGzeFYvtsR2Lw.jpeg#center alt=image-20221025003822017 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：Kubernetes API 请求的请求处理步骤图</center><center><em>Source：</em>https://www.armosec.io/blog/kubernetes-admission-controller/</center><br><p>其中在大多数教程中，在对这三个阶段所做的工作大致上为：</p><ul><li><p><em><strong>Authentication</strong></em> 阶段所指用于确认请求访问Kubernetes API 用户是否为合法用户，拒绝为401</p></li><li><p><em><strong>Authorization</strong></em> 阶段所指的将是这个用户是否有对操作的资源的权限，拒绝为403</p></li><li><p><em><strong>Admission control</strong></em> 阶段所指控制对请求资源进行控制，通俗来说，就是一票否决权，即使前两个步骤完成</p></li></ul><p>到这里了解到了Kubernetes API实际上做的工作就是 “人类用户” 与 “kubernetes service account" <sup><a href=#2>[2]</a></sup>；那么就引出了一个重要概念就是 “用户” 在Kubernetes中是什么，以及用户在认证中的也是本章节的中心。</p><p>在Kubernetes官方手册中给出了 ”用户“ 的概念，Kubernetes集群中存在的用户包括 ”普通用户“ 与 “service account” 但是 Kubernetes 没有普通用户的管理方式，只是将使用集群的证书CA签署的有效证书的用户都被视为合法用户 <sup><a href=#3>[3]</a></sup></p><p>那么对于使得Kubernetes集群有一个真正的用户系统，就可以根据上面给出的概念将Kubernetes用户分为 ”外部用户“ 与 ”内部用户“。如何理解外部与内部用户呢？实际上就是有Kubernetes管理的用户，即在kubernetes定义用户的数据模型这种为 “内部用户” ，正如 service account；反之，非Kubernetes托管的用户则为 ”外部用户“ 这中概念也更好的对kubernetes用户的阐述。</p><p>对于外部用户来说，实际上Kubernetes给出了多种用户概念 <sup><a href=#3>[3]</a></sup>，例如：</p><ul><li>拥有kubernetes集群证书的用户</li><li>拥有Kubernetes集群token的用户（<code>--token-auth-file</code> 指定的静态token）</li><li>用户来自外部用户系统，例如 <em>OpenID</em>，<em>LDAP</em>，<em>QQ connect</em>, <em>google identity platform</em> 等</li></ul><h2 id=向外部用户授权集群访问的示例>向外部用户授权集群访问的示例<a hidden class=anchor aria-hidden=true href=#向外部用户授权集群访问的示例>#</a></h2><h3 id=场景1通过证书请求k8s>场景1：通过证书请求k8s<a hidden class=anchor aria-hidden=true href=#场景1通过证书请求k8s>#</a></h3><p>该场景中kubernetes将使用证书中的cn作为用户，ou作为组，如果对应 <code>rolebinding/clusterrolebinding</code> 给予该用户权限，那么请求为合法</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl https://hostname:6443/api/v1/pods <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--cert ./client.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--key ./client-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--cacert ./ca.pem </span></span></code></pre></td></tr></table></div></div></div></div><p>接下来浅析下在代码中做的事情</p><p>确认用户是 <em><strong>apiserver</strong></em> 在 <em><strong>Authentication</strong></em> 阶段 做的事情，而对应代码在 <a href=pkg/kubeapiserver/authenticator>pkg/kubeapiserver/authenticator</a> 下，整个文件就是构建了一系列的认证器，而x.509证书指是其中一个</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 创建一个认证器，返回请求或一个k8s认证机制的标准错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>config</span> <span class=nx>Config</span><span class=p>)</span> <span class=nf>New</span><span class=p>()</span> <span class=p>(</span><span class=nx>authenticator</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=o>*</span><span class=nx>spec</span><span class=p>.</span><span class=nx>SecurityDefinitions</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// X509 methods
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 可以看到这里就是将x509证书解析为user
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>config</span><span class=p>.</span><span class=nx>ClientCAContentProvider</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>certAuth</span> <span class=o>:=</span> <span class=nx>x509</span><span class=p>.</span><span class=nf>NewDynamic</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>ClientCAContentProvider</span><span class=p>.</span><span class=nx>VerifyOptions</span><span class=p>,</span> <span class=nx>x509</span><span class=p>.</span><span class=nx>CommonNameUserConversion</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>authenticators</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>authenticators</span><span class=p>,</span> <span class=nx>certAuth</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></td></tr></table></div></div></div></div><p>接下来看实现原理，NewDynamic函数位于代码 <a href=https://github.com/kubernetes/kubernetes/blob/fdc77503e954d1ee641c0e350481f7528e8d068b/staging/src/k8s.io/apiserver/pkg/authentication/request/x509/x509.go#L126-L130 target=_blank rel="noopener nofollow noreferrer">k8s.io/apiserver/pkg/authentication/request/x509/x509.go</a></p><p>通过代码可以看出，是通过一个验证函数与用户来解析为一个 <em>Authenticator</em></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// NewDynamic returns a request.Authenticator that verifies client certificates using the provided
</span></span></span><span class=line><span class=cl><span class=c1>// VerifyOptionFunc (which may be dynamic), and converts valid certificate chains into user.Info using the provided UserConversion
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewDynamic</span><span class=p>(</span><span class=nx>verifyOptionsFn</span> <span class=nx>VerifyOptionFunc</span><span class=p>,</span> <span class=nx>user</span> <span class=nx>UserConversion</span><span class=p>)</span> <span class=o>*</span><span class=nx>Authenticator</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>Authenticator</span><span class=p>{</span><span class=nx>verifyOptionsFn</span><span class=p>,</span> <span class=nx>user</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>验证函数为 CAContentProvider 的方法，而x509部分实现为 <a href=https://github.com/kubernetes/kubernetes/blob/fdc77503e954d1ee641c0e350481f7528e8d068b/staging/src/k8s.io/apiserver/pkg/server/dynamiccertificates/dynamic_cafile_content.go#L253-L261 target=_blank rel="noopener nofollow noreferrer">k8s.io/apiserver/pkg/server/dynamiccertificates/dynamic_cafile_content.go.VerifyOptions</a>；可以看出返回是一个 <code>x509.VerifyOptions</code> + 与认证的状态</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// VerifyOptions provides verifyoptions compatible with authenticators
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>DynamicFileCAContent</span><span class=p>)</span> <span class=nf>VerifyOptions</span><span class=p>()</span> <span class=p>(</span><span class=nx>x509</span><span class=p>.</span><span class=nx>VerifyOptions</span><span class=p>,</span> <span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>uncastObj</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>caBundle</span><span class=p>.</span><span class=nf>Load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>uncastObj</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>x509</span><span class=p>.</span><span class=nx>VerifyOptions</span><span class=p>{},</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>uncastObj</span><span class=p>.(</span><span class=o>*</span><span class=nx>caBundleAndVerifier</span><span class=p>).</span><span class=nx>verifyOptions</span><span class=p>,</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而用户的获取则位于 <a href=https://github.com/kubernetes/kubernetes/blob/fdc77503e954d1ee641c0e350481f7528e8d068b/staging/src/k8s.io/apiserver/pkg/authentication/request/x509/x509.go#L248-L258 target=_blank rel="noopener nofollow noreferrer">k8s.io/apiserver/pkg/authentication/request/x509/x509.go</a>；可以看出，用户正是拿的证书的CN，而组则是为证书的OU</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// CommonNameUserConversion builds user info from a certificate chain using the subject&#39;s CommonName
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>CommonNameUserConversion</span> <span class=p>=</span> <span class=nf>UserConversionFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>chain</span> <span class=p>[]</span><span class=o>*</span><span class=nx>x509</span><span class=p>.</span><span class=nx>Certificate</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>authenticator</span><span class=p>.</span><span class=nx>Response</span><span class=p>,</span> <span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>chain</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Subject</span><span class=p>.</span><span class=nx>CommonName</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>authenticator</span><span class=p>.</span><span class=nx>Response</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>User</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>DefaultInfo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>   <span class=nx>chain</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Subject</span><span class=p>.</span><span class=nx>CommonName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Groups</span><span class=p>:</span> <span class=nx>chain</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Subject</span><span class=p>.</span><span class=nx>Organization</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=kc>true</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></td></tr></table></div></div></div></div><p>由于授权不在本章范围内，直接忽略至入库阶段，入库阶段由 <a href=https://github.com/kubernetes/kubernetes/blob/fdc77503e954d1ee641c0e350481f7528e8d068b/pkg/controlplane/instance.go#L561 target=_blank rel="noopener nofollow noreferrer">RESTStorageProvider</a> 实现 这里，每一个Provider都提供了 <code>Authenticator</code> 这里包含了已经允许的请求，将会被对应的REST客户端写入到库中</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>RESTStorageProvider</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Authenticator</span> <span class=nx>authenticator</span><span class=p>.</span><span class=nx>Request</span>
</span></span><span class=line><span class=cl>	<span class=nx>APIAudiences</span>  <span class=nx>authenticator</span><span class=p>.</span><span class=nx>Audiences</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// RESTStorageProvider is a factory type for REST storage.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>RESTStorageProvider</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>GroupName</span><span class=p>()</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nf>NewRESTStorage</span><span class=p>(</span><span class=nx>apiResourceConfigSource</span> <span class=nx>serverstorage</span><span class=p>.</span><span class=nx>APIResourceConfigSource</span><span class=p>,</span> <span class=nx>restOptionsGetter</span> <span class=nx>generic</span><span class=p>.</span><span class=nx>RESTOptionsGetter</span><span class=p>)</span> <span class=p>(</span><span class=nx>genericapiserver</span><span class=p>.</span><span class=nx>APIGroupInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=场景2通过token>场景2：通过token<a hidden class=anchor aria-hidden=true href=#场景2通过token>#</a></h3><p>该场景中，当 <em><strong>kube-apiserver</strong></em> 开启了 <code>--enable-bootstrap-token-auth</code> 时，就可以使用 Bootstrap Token 进行认证，通常如下列命令，在请求头中增加 <code>Authorization: Bearer &lt;token></code> 标识</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl https://hostname:6443/api/v1/pods <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cacert <span class=si>${</span><span class=nv>CACERT</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --header <span class=s2>&#34;Authorization: Bearer &lt;token&gt;&#34;</span> <span class=err>\</span></span></span></code></pre></td></tr></table></div></div></div></div><p>接下来浅析下在代码中做的事情</p><p>可以看到，在代码 <a href=pkg/kubeapiserver/authenticator>pkg/kubeapiserver/authenticator.New()</a> 中当 <em><strong>kube-apiserver</strong></em> 指定了参数 <code>--token-auth-file=/etc/kubernetes/token.csv"</code> 这种认证会被激活</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>TokenAuthFile</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>tokenAuth</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>newAuthenticatorFromTokenFile</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>TokenAuthFile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>tokenAuthenticators</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>tokenAuthenticators</span><span class=p>,</span> <span class=nx>authenticator</span><span class=p>.</span><span class=nf>WrapAudienceAgnosticToken</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>APIAudiences</span><span class=p>,</span> <span class=nx>tokenAuth</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>此时打开 token.csv 查看下token长什么样</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat /etc/kubernetes/token.csv
</span></span><span class=line><span class=cl>12ba4f.d82a57a4433b2359,<span class=s2>&#34;system:bootstrapper&#34;</span>,10001,<span class=s2>&#34;system:bootstrappers&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>这里回到代码 <a href=https://github.com/kubernetes/kubernetes/blob/fdc77503e954d1ee641c0e350481f7528e8d068b/staging/src/k8s.io/apiserver/pkg/authentication/token/tokenfile/tokenfile.go#L45-L91 target=_blank rel="noopener nofollow noreferrer">k8s.io/apiserver/pkg/authentication/token/tokenfile/tokenfile.go.NewCSV</a> ，这里可以看出，就是读取 <code>--token-auth-file=</code> 参数指定的tokenfile，然后解析为用户，<code>record[1]</code> 作为用户名，<code>record[2]</code> 作为UID</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// NewCSV returns a TokenAuthenticator, populated from a CSV file.
</span></span></span><span class=line><span class=cl><span class=c1>// The CSV file must contain records in the format &#34;token,username,useruid&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewCSV</span><span class=p>(</span><span class=nx>path</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>TokenAuthenticator</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>file</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>file</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>recordNum</span> <span class=o>:=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=nx>tokens</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>user</span><span class=p>.</span><span class=nx>DefaultInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>reader</span> <span class=o>:=</span> <span class=nx>csv</span><span class=p>.</span><span class=nf>NewReader</span><span class=p>(</span><span class=nx>file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>reader</span><span class=p>.</span><span class=nx>FieldsPerRecord</span> <span class=p>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>record</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>reader</span><span class=p>.</span><span class=nf>Read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>record</span><span class=p>)</span> <span class=p>&lt;</span> <span class=mi>3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;token file &#39;%s&#39; must have at least 3 columns (token, user name, user uid), found %d&#34;</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>record</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>recordNum</span><span class=o>++</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>record</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Warningf</span><span class=p>(</span><span class=s>&#34;empty token has been found in token file &#39;%s&#39;, record number &#39;%d&#39;&#34;</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>recordNum</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>obj</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>DefaultInfo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span> <span class=nx>record</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span>
</span></span><span class=line><span class=cl>			<span class=nx>UID</span><span class=p>:</span>  <span class=nx>record</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>exist</span> <span class=o>:=</span> <span class=nx>tokens</span><span class=p>[</span><span class=nx>record</span><span class=p>[</span><span class=mi>0</span><span class=p>]];</span> <span class=nx>exist</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Warningf</span><span class=p>(</span><span class=s>&#34;duplicate token has been found in token file &#39;%s&#39;, record number &#39;%d&#39;&#34;</span><span class=p>,</span> <span class=nx>path</span><span class=p>,</span> <span class=nx>recordNum</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>tokens</span><span class=p>[</span><span class=nx>record</span><span class=p>[</span><span class=mi>0</span><span class=p>]]</span> <span class=p>=</span> <span class=nx>obj</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>record</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>4</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>obj</span><span class=p>.</span><span class=nx>Groups</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>record</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=s>&#34;,&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>TokenAuthenticator</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>tokens</span><span class=p>:</span> <span class=nx>tokens</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而token file中配置的格式正是以逗号分隔的一组字符串，</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DefaultInfo</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>UID</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Groups</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Extra</span>  <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>这种用户最常见的方式就是 <em><strong>kubelet</strong></em> 通常会以此类用户向控制平面进行身份认证，例如下列配置</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBELET_ARGS</span><span class=o>=</span><span class=s2>&#34;--v=0 \
</span></span></span><span class=line><span class=cl><span class=s2>    --logtostderr=true \
</span></span></span><span class=line><span class=cl><span class=s2>    --config=/etc/kubernetes/kubelet-config.yaml \
</span></span></span><span class=line><span class=cl><span class=s2>    --kubeconfig=/etc/kubernetes/auth/kubelet.conf \
</span></span></span><span class=line><span class=cl><span class=s2>    --network-plugin=cni \
</span></span></span><span class=line><span class=cl><span class=s2>    --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 \
</span></span></span><span class=line><span class=cl><span class=s2>    --bootstrap-kubeconfig=/etc/kubernetes/auth/bootstrap.conf&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>/etc/kubernetes/auth/bootstrap.conf</code> 内容，这里就用到了 <em><strong>kube-apiserver</strong></em> 配置的 <code>--token-auth-file=</code> 用户名，组必须为 <code>system:bootstrappers</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class=l>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://10.0.0.4:6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrapper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrapper@kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrapper@kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>preferences</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrapper</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而通常在二进制部署时会出现的问题，例如下列错误</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>log</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-log data-lang=log>Unable to register node &#34;hostname&#34; with API server: nodes is forbidden: User &#34;system:anonymous&#34; cannot create resource &#34;nodes&#34; in API group &#34;&#34; at the cluster scope</code></pre></div></div><p>而通常解决方法是执行下列命令，这里就是将 <em><strong>kubelet</strong></em> 与 <em><strong>kube-apiserver</strong></em> 通讯时的用户授权，因为kubernetes官方给出的条件是，用户组必须为 <code>system:bootstrappers</code> <sup><a href=#4>[4]</a></sup></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl create clusterrolebinding kubelet-bootstrap --clusterrole<span class=o>=</span>system:node-bootstrapper --group<span class=o>=</span>system:bootstrappers</span></span></code></pre></td></tr></table></div></div></div></div><p>生成的clusterrolebinding 如下</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-08-14T22:26:51Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>managedFields</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fieldsType</span><span class=p>:</span><span class=w> </span><span class=l>FieldsV1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>time</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2022-08-14T22:26:51Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubelet-bootstrap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;158&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selfLink</span><span class=p>:</span><span class=w> </span><span class=l>/apis/rbac.authorization.k8s.io/v1/clusterrolebindings/kubelet-bootstrap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>b4d70f4f-4ae0-468f-86b7-55e9351e4719</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:node-bootstrapper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers</span></span></span></code></pre></td></tr></table></div></div></div></div><p>上述就是 bootstrap token，翻译后就是引导token，因为其做的工作就是将节点载入Kubernetes系统过程提供认证机制的用户。</p><blockquote><p>Notes：这种用户不存在与kubernetes内，可以算属于一个外部用户，但认证机制中存在并绑定了最高权限，也可以用来做其他访问时的认证</p></blockquote><h3 id=场景3serviceaccount>场景3：serviceaccount<a hidden class=anchor aria-hidden=true href=#场景3serviceaccount>#</a></h3><p>serviceaccount通常为API自动创建的，但在用户中，实际上认证存在两个方向，一个是 <code>--service-account-key-file</code> 这个参数可以指定多个，指定对应的证书文件公钥或私钥，用以办法sa的token</p><p>首先会根据指定的公钥或私钥文件生成token</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>ServiceAccountKeyFiles</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>serviceAccountAuth</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>newLegacyServiceAccountAuthenticator</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>ServiceAccountKeyFiles</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>ServiceAccountLookup</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>APIAudiences</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>ServiceAccountTokenGetter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>tokenAuthenticators</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>tokenAuthenticators</span><span class=p>,</span> <span class=nx>serviceAccountAuth</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>ServiceAccountIssuers</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>serviceAccountAuth</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>newServiceAccountAuthenticator</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>ServiceAccountIssuers</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>ServiceAccountKeyFiles</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>APIAudiences</span><span class=p>,</span> <span class=nx>config</span><span class=p>.</span><span class=nx>ServiceAccountTokenGetter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>tokenAuthenticators</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>tokenAuthenticators</span><span class=p>,</span> <span class=nx>serviceAccountAuth</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>对于 <code>--service-account-key-file</code> 他生成的用户都是 “kubernetes/serviceaccount” , 而对于 <code>--service-account-issuer</code> 只是对sa颁发者提供了一个称号标识是谁，而不是统一的 “kubernetes/serviceaccount” ，这里可以从代码中看到，两者是完全相同的，只是称号不同罢了</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// newLegacyServiceAccountAuthenticator returns an authenticator.Token or an error
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>newLegacyServiceAccountAuthenticator</span><span class=p>(</span><span class=nx>keyfiles</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>lookup</span> <span class=kt>bool</span><span class=p>,</span> <span class=nx>apiAudiences</span> <span class=nx>authenticator</span><span class=p>.</span><span class=nx>Audiences</span><span class=p>,</span> <span class=nx>serviceAccountGetter</span> <span class=nx>serviceaccount</span><span class=p>.</span><span class=nx>ServiceAccountTokenGetter</span><span class=p>)</span> <span class=p>(</span><span class=nx>authenticator</span><span class=p>.</span><span class=nx>Token</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>allPublicKeys</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}{}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>keyfile</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>keyfiles</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>publicKeys</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>keyutil</span><span class=p>.</span><span class=nf>PublicKeysFromFile</span><span class=p>(</span><span class=nx>keyfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>allPublicKeys</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>allPublicKeys</span><span class=p>,</span> <span class=nx>publicKeys</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 唯一的区别 这里使用了常量 serviceaccount.LegacyIssuer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>tokenAuthenticator</span> <span class=o>:=</span> <span class=nx>serviceaccount</span><span class=p>.</span><span class=nf>JWTTokenAuthenticator</span><span class=p>([]</span><span class=kt>string</span><span class=p>{</span><span class=nx>serviceaccount</span><span class=p>.</span><span class=nx>LegacyIssuer</span><span class=p>},</span> <span class=nx>allPublicKeys</span><span class=p>,</span> <span class=nx>apiAudiences</span><span class=p>,</span> <span class=nx>serviceaccount</span><span class=p>.</span><span class=nf>NewLegacyValidator</span><span class=p>(</span><span class=nx>lookup</span><span class=p>,</span> <span class=nx>serviceAccountGetter</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>tokenAuthenticator</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// newServiceAccountAuthenticator returns an authenticator.Token or an error
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>newServiceAccountAuthenticator</span><span class=p>(</span><span class=nx>issuers</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>keyfiles</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>apiAudiences</span> <span class=nx>authenticator</span><span class=p>.</span><span class=nx>Audiences</span><span class=p>,</span> <span class=nx>serviceAccountGetter</span> <span class=nx>serviceaccount</span><span class=p>.</span><span class=nx>ServiceAccountTokenGetter</span><span class=p>)</span> <span class=p>(</span><span class=nx>authenticator</span><span class=p>.</span><span class=nx>Token</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>allPublicKeys</span> <span class=o>:=</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}{}</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>keyfile</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>keyfiles</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>publicKeys</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>keyutil</span><span class=p>.</span><span class=nf>PublicKeysFromFile</span><span class=p>(</span><span class=nx>keyfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>allPublicKeys</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>allPublicKeys</span><span class=p>,</span> <span class=nx>publicKeys</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 唯一的区别 这里根据kube-apiserver提供的称号指定名称
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>tokenAuthenticator</span> <span class=o>:=</span> <span class=nx>serviceaccount</span><span class=p>.</span><span class=nf>JWTTokenAuthenticator</span><span class=p>(</span><span class=nx>issuers</span><span class=p>,</span> <span class=nx>allPublicKeys</span><span class=p>,</span> <span class=nx>apiAudiences</span><span class=p>,</span> <span class=nx>serviceaccount</span><span class=p>.</span><span class=nf>NewValidator</span><span class=p>(</span><span class=nx>serviceAccountGetter</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>tokenAuthenticator</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>最后根据ServiceAccounts，Secrets等值签发一个token，也就是通过下列命令获取的值</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>$</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>secret</span> <span class=nx>multus</span><span class=o>-</span><span class=nx>token</span><span class=o>-</span><span class=nx>v6bfg</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>jsonpath</span><span class=p>={</span><span class=s>&#34;.data.token&#34;</span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=场景4openid>场景4：openid<a hidden class=anchor aria-hidden=true href=#场景4openid>#</a></h3><p>OpenID Connect是 OAuth2 风格，允许用户授权三方网站访问他们存储在另外的服务提供者上的信息，而不需要将用户名和密码提供给第三方网站或分享他们数据的所有内容，下面是一张kubernetes 使用 OID 认证的逻辑图</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/kube-login-oidc-ad4caf57f124e622897e0781fe1e3d6e1ecb5c6099776e6677ca800c4458f1de.jpg><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/kube-login-oidc-ad4caf57f124e622897e0781fe1e3d6e1ecb5c6099776e6677ca800c4458f1de.jpg#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：Kubernetes OID认证</center><center><em>Source：</em>https://developer.okta.com/blog/2021/11/08/k8s-api-server-oidc</center><br><h3 id=场景5webhook>场景5：webhook<a hidden class=anchor aria-hidden=true href=#场景5webhook>#</a></h3><p>webhook是kubernetes提供自定义认证的其中一种，主要是用于认证 “<em><strong>不记名 token</strong></em>“ 的钩子，“<em><strong>不记名 token</strong></em>“ 将 由身份验证服务创建。当用户对kubernetes访问时，会触发准入控制，当对kubernetes集群注册了 authenticaion webhook时，将会使用该webhook提供的方式进行身份验证时，此时会为您生成一个 token 。</p><p>如代码 <a href=pkg/kubeapiserver/authenticator>pkg/kubeapiserver/authenticator.New()</a> 中所示 newWebhookTokenAuthenticator 会通过提供的config (<code>--authentication-token-webhook-config-file</code>) 来创建出一个 WebhookTokenAuthenticator</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>WebhookTokenAuthnConfigFile</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>webhookTokenAuth</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>newWebhookTokenAuthenticator</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>tokenAuthenticators</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>tokenAuthenticators</span><span class=p>,</span> <span class=nx>webhookTokenAuth</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>下图是kubernetes 中 WebhookToken 验证的工作原理</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/25d075712ff343ce492a5db30733cd93.svg><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/25d075712ff343ce492a5db30733cd93.svg#center alt="Webhook 令牌认证插件" onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：kubernetes WebhookToken验证原理</center><center><em>Source：</em>https://learnk8s.io/kubernetes-custom-authentication</center><br><p>最后由token中的authHandler，循环所有的Handlers在运行 <code>AuthenticateToken</code> 去进行获取用户的信息</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>authHandler</span> <span class=o>*</span><span class=nx>unionAuthTokenHandler</span><span class=p>)</span> <span class=nf>AuthenticateToken</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>token</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>authenticator</span><span class=p>.</span><span class=nx>Response</span><span class=p>,</span> <span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=kd>var</span> <span class=nx>errlist</span> <span class=p>[]</span><span class=kt>error</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>currAuthRequestHandler</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>authHandler</span><span class=p>.</span><span class=nx>Handlers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>info</span><span class=p>,</span> <span class=nx>ok</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>currAuthRequestHandler</span><span class=p>.</span><span class=nf>AuthenticateToken</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>if</span> <span class=nx>authHandler</span><span class=p>.</span><span class=nx>FailOnError</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>info</span><span class=p>,</span> <span class=nx>ok</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>         <span class=nx>errlist</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>errlist</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=k>continue</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=nx>info</span><span class=p>,</span> <span class=nx>ok</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>utilerrors</span><span class=p>.</span><span class=nf>NewAggregate</span><span class=p>(</span><span class=nx>errlist</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而webhook插件也实现了这个方法 <code>AuthenticateToken</code> ,这里会通过POST请求，调用注入的webhook，该请求携带一个JSON 格式的 <code>TokenReview</code> 对象，其中包含要验证的令牌</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>w</span> <span class=o>*</span><span class=nx>WebhookTokenAuthenticator</span><span class=p>)</span> <span class=nf>AuthenticateToken</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>token</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>authenticator</span><span class=p>.</span><span class=nx>Response</span><span class=p>,</span> <span class=kt>bool</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>...</span><span class=p>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>start</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>result</span><span class=p>,</span> <span class=nx>statusCode</span><span class=p>,</span> <span class=nx>tokenReviewErr</span> <span class=p>=</span> <span class=nx>w</span><span class=p>.</span><span class=nx>tokenReview</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>CreateOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>		<span class=nx>latency</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Since</span><span class=p>(</span><span class=nx>start</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>webhook token认证服务要返回<a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#userinfo-v1beta1-authentication-k8s-io target=_blank rel="noopener nofollow noreferrer">用户的身份信息</a>，就是上面token部分提到的数据结构（webhook来决定接受还是拒绝该用户）</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DefaultInfo</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>UID</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Groups</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Extra</span>  <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=场景6代理认证>场景6：代理认证<a hidden class=anchor aria-hidden=true href=#场景6代理认证>#</a></h3><h2 id=实验基于ldap的身份认证>实验：基于LDAP的身份认证<a hidden class=anchor aria-hidden=true href=#实验基于ldap的身份认证>#</a></h2><p>通过上面阐述，大致了解到kubernetes认证框架中的用户的分类以及认证的策略由哪些，实验的目的也是为了阐述一个结果，就是使用OIDC/webhook 是比其他方式更好的保护，管理kubernetes集群。首先在安全上，假设网络环境是不安全的，那么任意node节点遗漏 bootstrap token文件，就意味着拥有了集群中最高权限；其次在管理上，越大的团队，人数越多，不可能每个用户都提供单独的证书或者token，要知道传统教程中讲到token在kubernetes集群中是永久有效的，除非你删除了这个secret/sa；而Kubernetes提供的插件就很好的解决了这些问题。</p><h3 id=实验环境>实验环境<a hidden class=anchor aria-hidden=true href=#实验环境>#</a></h3><ul><li>一个kubernetes集群</li><li>一个openldap服务，建议可以是集群外部的，因为webhook不像SSSD有缓存机制，并且集群不可用，那么认证不可用，当认证不可用时会导致集群不可用，这样事故影响的范围可以得到控制，也叫最小化半径</li><li>了解ldap相关技术，并了解go ldap客户端</li></ul><p><strong>实验大致分为以下几个步骤</strong>：</p><ul><li>建立一个HTTP服务器用于返回给kubernetes Authenticaion服务</li><li>查询ldap该用户是否合法<ul><li>查询用户是否合法</li><li>查询用户所属组是否拥有权限</li></ul></li></ul><h3 id=实验开始>实验开始<a hidden class=anchor aria-hidden=true href=#实验开始>#</a></h3><h4 id=初始化用户数据>初始化用户数据<a hidden class=anchor aria-hidden=true href=#初始化用户数据>#</a></h4><p>首先准备openldap初始化数据，创建三个 posixGroup 组，与5个用户 admin, admin1, admin11, searchUser, syncUser 密码均为111，组与用户关联使用的 <code>memberUid</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat <span class=s>&lt;&lt; EOF | ldapdelete -r  -H ldap://10.0.0.3 -D &#34;cn=admin,dc=test,dc=com&#34; -w 111
</span></span></span><span class=line><span class=cl><span class=s>dn: dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>objectClass: top
</span></span></span><span class=line><span class=cl><span class=s>objectClass: organizationalUnit
</span></span></span><span class=line><span class=cl><span class=s>objectClass: extensibleObject
</span></span></span><span class=line><span class=cl><span class=s>description: US Organization
</span></span></span><span class=line><span class=cl><span class=s>ou: people
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>dn: ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>objectClass: organizationalUnit
</span></span></span><span class=line><span class=cl><span class=s>description: Television Broadcasts Limited
</span></span></span><span class=line><span class=cl><span class=s>ou: tvb
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>dn: cn=admin,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>objectClass: posixGroup
</span></span></span><span class=line><span class=cl><span class=s>gidNumber: 10000
</span></span></span><span class=line><span class=cl><span class=s>cn: admin
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>dn: cn=conf,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>objectClass: posixGroup
</span></span></span><span class=line><span class=cl><span class=s>gidNumber: 10001
</span></span></span><span class=line><span class=cl><span class=s>cn: conf
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>dn: cn=dir,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>objectClass: posixGroup
</span></span></span><span class=line><span class=cl><span class=s>gidNumber: 10002
</span></span></span><span class=line><span class=cl><span class=s>cn: dir
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>dn: uid=syncUser,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>objectClass: inetOrgPerson
</span></span></span><span class=line><span class=cl><span class=s>objectClass: organizationalPerson
</span></span></span><span class=line><span class=cl><span class=s>objectClass: person
</span></span></span><span class=line><span class=cl><span class=s>objectClass: posixAccount
</span></span></span><span class=line><span class=cl><span class=s>objectClass: shadowAccount
</span></span></span><span class=line><span class=cl><span class=s>objectClass: pwdPolicy
</span></span></span><span class=line><span class=cl><span class=s>pwdAttribute: userPassword
</span></span></span><span class=line><span class=cl><span class=s>uid: syncUser
</span></span></span><span class=line><span class=cl><span class=s>cn: syncUser
</span></span></span><span class=line><span class=cl><span class=s>uidNumber: 10006
</span></span></span><span class=line><span class=cl><span class=s>gidNumber: 10002
</span></span></span><span class=line><span class=cl><span class=s>homeDirectory: /home/syncUser
</span></span></span><span class=line><span class=cl><span class=s>loginShell: /bin/bash
</span></span></span><span class=line><span class=cl><span class=s>sn: syncUser
</span></span></span><span class=line><span class=cl><span class=s>givenName: syncUser
</span></span></span><span class=line><span class=cl><span class=s>memberOf: cn=confGroup,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>dn: uid=searchUser,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>objectClass: inetOrgPerson
</span></span></span><span class=line><span class=cl><span class=s>objectClass: organizationalPerson
</span></span></span><span class=line><span class=cl><span class=s>objectClass: person
</span></span></span><span class=line><span class=cl><span class=s>objectClass: posixAccount
</span></span></span><span class=line><span class=cl><span class=s>objectClass: shadowAccount
</span></span></span><span class=line><span class=cl><span class=s>objectClass: pwdPolicy
</span></span></span><span class=line><span class=cl><span class=s>pwdAttribute: userPassword
</span></span></span><span class=line><span class=cl><span class=s>uid: searchUser
</span></span></span><span class=line><span class=cl><span class=s>cn: searchUser
</span></span></span><span class=line><span class=cl><span class=s>uidNumber: 10005
</span></span></span><span class=line><span class=cl><span class=s>gidNumber: 10001
</span></span></span><span class=line><span class=cl><span class=s>homeDirectory: /home/searchUser
</span></span></span><span class=line><span class=cl><span class=s>loginShell: /bin/bash
</span></span></span><span class=line><span class=cl><span class=s>sn: searchUser
</span></span></span><span class=line><span class=cl><span class=s>givenName: searchUser
</span></span></span><span class=line><span class=cl><span class=s>memberOf: cn=dirGroup,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>dn: uid=admin1,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>objectClass: inetOrgPerson
</span></span></span><span class=line><span class=cl><span class=s>objectClass: organizationalPerson
</span></span></span><span class=line><span class=cl><span class=s>objectClass: person
</span></span></span><span class=line><span class=cl><span class=s>objectClass: posixAccount
</span></span></span><span class=line><span class=cl><span class=s>objectClass: shadowAccount
</span></span></span><span class=line><span class=cl><span class=s>objectClass: pwdPolicy
</span></span></span><span class=line><span class=cl><span class=s>pwdAttribute: userPassword
</span></span></span><span class=line><span class=cl><span class=s>uid: admin1
</span></span></span><span class=line><span class=cl><span class=s>sn: admin1
</span></span></span><span class=line><span class=cl><span class=s>cn: admin
</span></span></span><span class=line><span class=cl><span class=s>uidNumber: 10010
</span></span></span><span class=line><span class=cl><span class=s>gidNumber: 10000
</span></span></span><span class=line><span class=cl><span class=s>homeDirectory: /home/admin
</span></span></span><span class=line><span class=cl><span class=s>loginShell: /bin/bash
</span></span></span><span class=line><span class=cl><span class=s>givenName: admin
</span></span></span><span class=line><span class=cl><span class=s>memberOf: cn=adminGroup,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>dn: uid=admin11,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>objectClass: inetOrgPerson
</span></span></span><span class=line><span class=cl><span class=s>objectClass: organizationalPerson
</span></span></span><span class=line><span class=cl><span class=s>objectClass: person
</span></span></span><span class=line><span class=cl><span class=s>objectClass: posixAccount
</span></span></span><span class=line><span class=cl><span class=s>objectClass: shadowAccount
</span></span></span><span class=line><span class=cl><span class=s>objectClass: pwdPolicy
</span></span></span><span class=line><span class=cl><span class=s>sn: admin11
</span></span></span><span class=line><span class=cl><span class=s>pwdAttribute: userPassword
</span></span></span><span class=line><span class=cl><span class=s>uid: admin11
</span></span></span><span class=line><span class=cl><span class=s>cn: admin11
</span></span></span><span class=line><span class=cl><span class=s>uidNumber: 10011
</span></span></span><span class=line><span class=cl><span class=s>gidNumber: 10000
</span></span></span><span class=line><span class=cl><span class=s>homeDirectory: /home/admin
</span></span></span><span class=line><span class=cl><span class=s>loginShell: /bin/bash
</span></span></span><span class=line><span class=cl><span class=s>givenName: admin11
</span></span></span><span class=line><span class=cl><span class=s>memberOf: cn=adminGroup,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>dn: uid=admin,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>objectClass: inetOrgPerson
</span></span></span><span class=line><span class=cl><span class=s>objectClass: organizationalPerson
</span></span></span><span class=line><span class=cl><span class=s>objectClass: person
</span></span></span><span class=line><span class=cl><span class=s>objectClass: posixAccount
</span></span></span><span class=line><span class=cl><span class=s>objectClass: shadowAccount
</span></span></span><span class=line><span class=cl><span class=s>objectClass: pwdPolicy
</span></span></span><span class=line><span class=cl><span class=s>pwdAttribute: userPassword
</span></span></span><span class=line><span class=cl><span class=s>uid: admin
</span></span></span><span class=line><span class=cl><span class=s>cn: admin
</span></span></span><span class=line><span class=cl><span class=s>uidNumber: 10009
</span></span></span><span class=line><span class=cl><span class=s>gidNumber: 10000
</span></span></span><span class=line><span class=cl><span class=s>homeDirectory: /home/admin
</span></span></span><span class=line><span class=cl><span class=s>loginShell: /bin/bash
</span></span></span><span class=line><span class=cl><span class=s>sn: admin
</span></span></span><span class=line><span class=cl><span class=s>givenName: admin
</span></span></span><span class=line><span class=cl><span class=s>memberOf: cn=adminGroup,ou=tvb,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></td></tr></table></div></div></div></div><p>接下来需要确定如何为认证成功的用户，上面讲到对于kubernetes中用户格式为 <code>v1.UserInfo</code> 的格式，即要获得用户，即用户组，假设需要查找的用户为，admin，那么在openldap中查询filter如下：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=s2>&#34;(|(&amp;(objectClass=posixAccount)(uid=admin))(&amp;(objectClass=posixGroup)(memberUid=admin)))&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>上面语句意思是，找到 <code>objectClass=posixAccount</code> 并且 <code>uid=admin</code> 或者 <code>objectClass=posixGroup</code> 并且 <code>memberUid=admin</code> 的条目信息，这里使用 ”|“ 与 ”&“ 是为了要拿到这两个结果。</p><h4 id=编写webhook查询用户部分>编写webhook查询用户部分<a hidden class=anchor aria-hidden=true href=#编写webhook查询用户部分>#</a></h4><p>这里由于openldap配置密码保存格式不是明文的，如果直接使用 ”=“ 来验证是查询不到内容的，故直接多用了一次登录来验证用户是否合法</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ldapSearch</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>password</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>UserInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ldapconn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ldap</span><span class=p>.</span><span class=nf>DialURL</span><span class=p>(</span><span class=nx>ldapURL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>ldapconn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Authenticate as LDAP admin user
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>ldapconn</span><span class=p>.</span><span class=nf>Bind</span><span class=p>(</span><span class=s>&#34;uid=searchUser,ou=tvb,dc=test,dc=com&#34;</span><span class=p>,</span> <span class=s>&#34;111&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Execute LDAP Search request
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ldapconn</span><span class=p>.</span><span class=nf>Search</span><span class=p>(</span><span class=nx>ldap</span><span class=p>.</span><span class=nf>NewSearchRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;ou=tvb,dc=test,dc=com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ldap</span><span class=p>.</span><span class=nx>ScopeWholeSubtree</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ldap</span><span class=p>.</span><span class=nx>NeverDerefAliases</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;(&amp;(objectClass=posixGroup)(memberUid=%s))&#34;</span><span class=p>,</span> <span class=nx>username</span><span class=p>),</span> <span class=c1>// Filter
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>userResult</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ldapconn</span><span class=p>.</span><span class=nf>Search</span><span class=p>(</span><span class=nx>ldap</span><span class=p>.</span><span class=nf>NewSearchRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;ou=tvb,dc=test,dc=com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ldap</span><span class=p>.</span><span class=nx>ScopeWholeSubtree</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ldap</span><span class=p>.</span><span class=nx>NeverDerefAliases</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;(&amp;(objectClass=posixAccount)(uid=%s))&#34;</span><span class=p>,</span> <span class=nx>username</span><span class=p>),</span> <span class=c1>// Filter
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>Entries</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;User does not exist&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;User does not exist&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 验证用户名密码是否正确
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ldapconn</span><span class=p>.</span><span class=nf>Bind</span><span class=p>(</span><span class=nx>userResult</span><span class=p>.</span><span class=nx>Entries</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>DN</span><span class=p>,</span> <span class=nx>password</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>e</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;Failed to auth. %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;User %s Authenticated successfuly!&#34;</span><span class=p>,</span> <span class=nx>username</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 拼接为kubernetes authentication 的用户格式
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>user</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>v1</span><span class=p>.</span><span class=nx>UserInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>result</span><span class=p>.</span><span class=nx>Entries</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>attrubute</span> <span class=o>:=</span> <span class=nx>v</span><span class=p>.</span><span class=nf>GetAttributeValue</span><span class=p>(</span><span class=s>&#34;objectClass&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>attrubute</span><span class=p>,</span> <span class=s>&#34;posixGroup&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>user</span><span class=p>.</span><span class=nx>Groups</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>Groups</span><span class=p>,</span> <span class=nx>v</span><span class=p>.</span><span class=nf>GetAttributeValue</span><span class=p>(</span><span class=s>&#34;cn&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>u</span> <span class=o>:=</span> <span class=nx>userResult</span><span class=p>.</span><span class=nx>Entries</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nf>GetAttributeValue</span><span class=p>(</span><span class=s>&#34;uid&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>user</span><span class=p>.</span><span class=nx>UID</span> <span class=p>=</span> <span class=nx>u</span>
</span></span><span class=line><span class=cl>		<span class=nx>user</span><span class=p>.</span><span class=nx>Username</span> <span class=p>=</span> <span class=nx>u</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>user</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=编写http部分>编写HTTP部分<a hidden class=anchor aria-hidden=true href=#编写http部分>#</a></h4><p>这里有几个需要注意的部分，即用户或者理解为要认证的token的定义，此处使用了 ”username@password“ 格式作为用户的辨别，即登录kubernetes时需要直接输入 ”username@password“ 来作为登录的凭据。</p><p>第二个部分为返回值，返回给Kubernetes的格式必须为 <code>api/authentication/v1.TokenReview</code> 格式，<code>Status.Authenticated</code> 表示用户身份验证结果，如果该用户合法，则设置 <code>tokenReview.Status.Authenticated = true</code> 反之亦然。如果验证成功还需要 <code>Status.User</code> 这就是在<code>ldapSearch</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>serve</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>httpError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Receiving: %s\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>tokenReview</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>TokenReview</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>b</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>tokenReview</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Json convert err: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>httpError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 提取用户名与密码
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>SplitN</span><span class=p>(</span><span class=nx>tokenReview</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Token</span><span class=p>,</span> <span class=s>&#34;@&#34;</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;badly formatted token: %s&#34;</span><span class=p>,</span> <span class=nx>tokenReview</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Token</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nf>httpError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;badly formatted token: %s&#34;</span><span class=p>,</span> <span class=nx>tokenReview</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Token</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>username</span><span class=p>,</span> <span class=nx>password</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>s</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 查询ldap，验证用户是否合法
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>userInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>ldapSearch</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 这里不打印日志的原因是 ldapSearch 中打印过了
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 设置返回的tokenReview
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>userInfo</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>tokenReview</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Authenticated</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>tokenReview</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Authenticated</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=nx>tokenReview</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>User</span> <span class=p>=</span> <span class=o>*</span><span class=nx>userInfo</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>tokenReview</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Json convert err: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>httpError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Returning: &#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>httpError</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span> <span class=c1>// 500
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintln</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;httpcode 500: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>下面是完整的代码</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;io/ioutil&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/go-ldap/ldap&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/api/authentication/v1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/klog/v2&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>ldapURL</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>InitFlags</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/authenticate&#34;</span><span class=p>,</span> <span class=nx>serve</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Listening on port 443 waiting for requests...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:443&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>ldapURL</span> <span class=p>=</span> <span class=s>&#34;ldap://10.0.0.10:389&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nf>ldapSearch</span><span class=p>(</span><span class=s>&#34;admin&#34;</span><span class=p>,</span> <span class=s>&#34;1111&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>serve</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ioutil</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>httpError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Receiving: %s\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>tokenReview</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>TokenReview</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>b</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>tokenReview</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Json convert err: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>httpError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 提取用户名与密码
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>SplitN</span><span class=p>(</span><span class=nx>tokenReview</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Token</span><span class=p>,</span> <span class=s>&#34;@&#34;</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;badly formatted token: %s&#34;</span><span class=p>,</span> <span class=nx>tokenReview</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Token</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nf>httpError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;badly formatted token: %s&#34;</span><span class=p>,</span> <span class=nx>tokenReview</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Token</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>username</span><span class=p>,</span> <span class=nx>password</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>s</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 查询ldap，验证用户是否合法
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>userInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>ldapSearch</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 这里不打印日志的原因是 ldapSearch 中打印过了
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 设置返回的tokenReview
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>userInfo</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>tokenReview</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Authenticated</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>tokenReview</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Authenticated</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=nx>tokenReview</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>User</span> <span class=p>=</span> <span class=o>*</span><span class=nx>userInfo</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>tokenReview</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Json convert err: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nf>httpError</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Returning: &#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>httpError</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span> <span class=c1>// 500
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintln</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;httpcode 500: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ldapSearch</span><span class=p>(</span><span class=nx>username</span><span class=p>,</span> <span class=nx>password</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>UserInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ldapconn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ldap</span><span class=p>.</span><span class=nf>DialURL</span><span class=p>(</span><span class=nx>ldapURL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>ldapconn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Authenticate as LDAP admin user
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>ldapconn</span><span class=p>.</span><span class=nf>Bind</span><span class=p>(</span><span class=s>&#34;cn=admin,dc=test,dc=com&#34;</span><span class=p>,</span> <span class=s>&#34;111&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Execute LDAP Search request
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>result</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ldapconn</span><span class=p>.</span><span class=nf>Search</span><span class=p>(</span><span class=nx>ldap</span><span class=p>.</span><span class=nf>NewSearchRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;ou=tvb,dc=test,dc=com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ldap</span><span class=p>.</span><span class=nx>ScopeWholeSubtree</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ldap</span><span class=p>.</span><span class=nx>NeverDerefAliases</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;(&amp;(objectClass=posixGroup)(memberUid=%s))&#34;</span><span class=p>,</span> <span class=nx>username</span><span class=p>),</span> <span class=c1>// Filter
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>userResult</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ldapconn</span><span class=p>.</span><span class=nf>Search</span><span class=p>(</span><span class=nx>ldap</span><span class=p>.</span><span class=nf>NewSearchRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;ou=tvb,dc=test,dc=com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ldap</span><span class=p>.</span><span class=nx>ScopeWholeSubtree</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ldap</span><span class=p>.</span><span class=nx>NeverDerefAliases</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;(&amp;(objectClass=posixAccount)(uid=%s))&#34;</span><span class=p>,</span> <span class=nx>username</span><span class=p>),</span> <span class=c1>// Filter
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>Entries</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;User does not exist&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;User does not exist&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 验证用户名密码是否正确
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ldapconn</span><span class=p>.</span><span class=nf>Bind</span><span class=p>(</span><span class=nx>userResult</span><span class=p>.</span><span class=nx>Entries</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>DN</span><span class=p>,</span> <span class=nx>password</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>e</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;Failed to auth. %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Info</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;User %s Authenticated successfuly!&#34;</span><span class=p>,</span> <span class=nx>username</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 拼接为kubernetes authentication 的用户格式
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>user</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>v1</span><span class=p>.</span><span class=nx>UserInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>result</span><span class=p>.</span><span class=nx>Entries</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>attrubute</span> <span class=o>:=</span> <span class=nx>v</span><span class=p>.</span><span class=nf>GetAttributeValue</span><span class=p>(</span><span class=s>&#34;objectClass&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>attrubute</span><span class=p>,</span> <span class=s>&#34;posixGroup&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>user</span><span class=p>.</span><span class=nx>Groups</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>Groups</span><span class=p>,</span> <span class=nx>v</span><span class=p>.</span><span class=nf>GetAttributeValue</span><span class=p>(</span><span class=s>&#34;cn&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>u</span> <span class=o>:=</span> <span class=nx>userResult</span><span class=p>.</span><span class=nx>Entries</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nf>GetAttributeValue</span><span class=p>(</span><span class=s>&#34;uid&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>user</span><span class=p>.</span><span class=nx>UID</span> <span class=p>=</span> <span class=nx>u</span>
</span></span><span class=line><span class=cl>		<span class=nx>user</span><span class=p>.</span><span class=nx>Username</span> <span class=p>=</span> <span class=nx>u</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>user</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=部署webhook>部署webhook<a hidden class=anchor aria-hidden=true href=#部署webhook>#</a></h3><p>kubernetes官方手册中指出，启用webhook认证的标记是在 <em><strong>kube-apiserver</strong></em> 指定参数 <code>--authentication-token-webhook-config-file</code> 。而这个配置文件是一个 <em>kubeconfig</em> 类型的文件格式 <sup><a href=#5>[5]</a></sup></p><p>下列是部署在kubernetes集群外部的配置</p><p>创建一个给 <em>kube-apiserver</em> 使用的配置文件 <code>/etc/kubernetes/auth/authentication-webhook.conf</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>yaml</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>http://10.0.0.1:88/authenticate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>authenticator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>webhook-authenticator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>webhook-authenticator@authenticator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>authenticator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>webhook-authenticator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>webhook-authenticator@authenticator</span></span></span></code></pre></td></tr></table></div></div></div></div><p>修改 <em>kube-apiserver</em> 参数</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 指向对应的配置文件</span>
</span></span><span class=line><span class=cl>--authentication-token-webhook-config-file<span class=o>=</span>/etc/kubernetes/auth/authentication-webhook.conf
</span></span><span class=line><span class=cl><span class=c1># 这个是token缓存时间，指的是用户在访问API时验证通过后在一定时间内无需在请求webhook进行认证了</span>
</span></span><span class=line><span class=cl>--authentication-token-webhook-cache-ttl<span class=o>=</span>30m
</span></span><span class=line><span class=cl><span class=c1># 版本指定为API使用哪个版本？authentication.k8s.io/v1或v1beta1</span>
</span></span><span class=line><span class=cl>--authentication-token-webhook-version<span class=o>=</span>v1</span></span></code></pre></td></tr></table></div></div></div></div><p>启动服务后，创建一个 kubeconfig 中的用户用于验证结果</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: 
    server: https://10.0.0.4:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: k8s-admin
  name: k8s-admin@kubernetes
current-context: k8s-admin@kubernetes
kind: Config
preferences: {}
users:
- name: admin
  user: 
    token: admin@111</code></pre></div></div><h3 id=验证结果>验证结果<a hidden class=anchor aria-hidden=true href=#验证结果>#</a></h3><p><strong>当密码不正确时，使用用户admin请求集群</strong></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get pods --user<span class=o>=</span>admin
</span></span><span class=line><span class=cl>error: You must be logged in to the server <span class=o>(</span>Unauthorized<span class=o>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p><strong>当密码正确时，使用用户admin请求集群</strong></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get pods --user<span class=o>=</span>admin
</span></span><span class=line><span class=cl>Error from server <span class=o>(</span>Forbidden<span class=o>)</span>: pods is forbidden: User <span class=s2>&#34;admin&#34;</span> cannot list resource <span class=s2>&#34;pods&#34;</span> in API group <span class=s2>&#34;&#34;</span> in the namespace <span class=s2>&#34;default&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以看到admin用户是一个不存在与集群中的用户，并且提示没有权限操作对应资源，此时将admin用户与集群中的cluster-admin绑定，测试结果</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl create clusterrolebinding admin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--clusterrole<span class=o>=</span>cluster-admin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>	--group<span class=o>=</span>admin</span></span></code></pre></td></tr></table></div></div></div></div><p>此时再尝试使用admin用户访问集群</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get pods --user<span class=o>=</span>admin
</span></span><span class=line><span class=cl>NAME                      READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>netbox-85865d5556-hfg6v   1/1     Running   <span class=m>0</span>          91d
</span></span><span class=line><span class=cl>netbox-85865d5556-vlgr4   1/1     Running   <span class=m>0</span>          91d</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><p>kubernetes authentication 插件提供的功能可以注入一个认证系统，这样可以完美解决了kubernetes中用户的问题，而这些用户并不存在与kubernetes中，并且也无需为多个用户准备大量serviceaccount或者证书，也可以完成鉴权操作。首先返回值标准如下所示，如果kubernetes集群有对在其他用户系统中获得的 <code>Groups</code> 并建立了 <code>clusterrolebinding</code> 或 <code>rolebinding</code> 那么这个组的所有用户都将有这些权限。管理员只需要维护与公司用户系统中组同样多的 clusterrole 与 clusterrolebinding 即可</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DefaultInfo</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>UID</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Groups</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Extra</span>  <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>对于如何将 kubernetes 与其他平台进行融合可以参考 <a href=https://cylonchau.github.io/kubernetes-dashborad-based.html target=_blank rel="noopener nofollow noreferrer">文章</a></p><blockquote><p>Notes：Kubernetes原生就支持OID，完全不用自己开发webhook从而实现接入其他系统，这里展示的只是一个思路</p></blockquote><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><blockquote><p><sup id=1>[1]</sup> <a href=https://learnk8s.io/kubernetes-custom-authentication target=_blank rel="noopener nofollow noreferrer"><em><strong>Implementing a custom Kubernetes authentication method</strong></em></a></p><p><sup id=2>[2]</sup> <a href=https://kubernetes.io/docs/concepts/security/controlling-access/ target=_blank rel="noopener nofollow noreferrer"><em><strong>Controlling Access to the Kubernetes API</strong></em></a></p><p><sup id=3>[3]</sup> <a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/#users-in-kubernetes target=_blank rel="noopener nofollow noreferrer"><em><strong>Users in Kubernetes</strong></em></a></p><p><sup id=4>[4]</sup> <a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/#bootstrap-tokens target=_blank rel="noopener nofollow noreferrer"><em><strong>bootstrap tokens</strong></em></a></p><p><sup id=5>[5]</sup> <a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/#webhook-token-authentication target=_blank rel="noopener nofollow noreferrer"><em><strong>Webhook Token Authentication</strong></em></a></p></blockquote></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：深入理解Kubernetes 4A - Authentication源码解析</p><p>文章链接：<a href=https://www.oomkill.com/2022/11/ch31-authentication/ target=_blank>https://www.oomkill.com/2022/11/ch31-authentication/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2022/07/ch33-admission-webhook/><span>深入理解Kubernetes 4A - Admission Control源码解析</span></a></li><li><a href=/2022/08/ch22-custom-scheduler/><span>基于Prometheus的Kubernetes网络调度器</span></a></li><li><a href=/2022/07/ch21-scheduling-algorithm/><span>如何理解kubernetes调度框架与插件？</span></a></li><li><a href=/2022/07/ch20-schedule-workflow/><span>kube-scheduler的调度上下文</span></a></li><li><a href=/2022/07/ch16-scheduler/><span>kubernetes的决策组件 - kube-scheduler原理分析</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/ldap/>Ldap</a></li><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li><li><a href=https://www.oomkill.com/tags/kubernetes-develop/>Kubernetes Develop</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2022/11/ch32-authorization/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>深入理解Kubernetes 4A - Authorization源码解析</span>
</a><a class=next href=https://www.oomkill.com/2022/11/ch11-sssd/><span class=title></span>
<span>理解ldap - 使用SSSD接入OpenLDAP实现身份验证&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/blogs","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch31 Authentication","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>