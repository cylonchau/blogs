<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>理解ldap应用 - Linux系统接入OpenLDAP做认证后端 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="ldap,linux,Linux通过openldap认证"><meta name=description content="Overview 如果要使Linux账号通过LDAP进行身份认证，就需要配置Linux的 身份验证模块 (Pluggable Authentication Modules) 与 名称服务交换系统 (Name Service Switch) 与LDAP交互。
PAM 和 NSS [3] NSS (name service switch) 通俗理解为是一个数据库系统，他作用是用于如何将操作系统与各种名称的解析机制关联起来，例如主机名，用户名，组名等内容的查找；例如UID查找使用 passwd 库，GID的查找使用 group 库，并且还可以告知查找的来源，如文件，LDAP等
PAM (Pluggable Authentication Modules) 全称是可插拔的认证模块，PAM在Linux中是位于用户数据库与应用之间的认证模块，它本身并不工作，并且本身也不提供或扩展现有数据库系统，当登陆shell时，依赖于由NSS提供的密码库与组库等信息，完成对应的查询
例如下列两张图完整的阐述了PAM与NSS之间，在用户登陆时做了些什么
图：pam和nss工作示意图1Source：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e
由图可以看出，当在进行 ping , id 等操作时，会通过nss找到 passwd 库找到用户id，以及通过nss确定是 hosts解析还是dns服务解析对应的域名
如果这张图不明白可以看下一张图
图：pam和nss工作示意图2-1Source：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e
图2-1 中使用了tom用户去登录pecan主机，此时在节点 yam 上，将寻找 pecan主机的IP，这是通过 /etc/nsswitch.conf 来确定是通过 hosts 还是 dns服务进行查找。
接下来找到pecan的IP，这里会输入用户名与密码，这里将会被sshd服务接管，此时 pecan 主机的sshd接收到用户端请求连接后，将用户名通过nss进行识别，确定是否为合法用户，如果用户有效，则通过PAM进行认证。认证的源也将由 /etc/nsswitch.conf 中配置的对应 passwd 库来找到，例如ldap,file等。正如下图2-2所示
图：pam和nss工作示意图2-2Source：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e
Linux with LDAP [1] 在大致了解了Linux登录认证的原理后，知道了要使Linux使用LDAP需要配置两个部分，NSS与PAM，通常有下述几种方案：
NSS + PAM SSSD (System Security Services Daemon)，SSSD是提供严重的一种工具，可以包含多种源例如LDAP，AD，Kerberos 等，并且提供了缓存功能（当ldap不可用时提供服务） 配置NSS 安装 nss-pam-ldapd"><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2019/09/ch10-linux-with-ldap/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2019/09/ch10-linux-with-ldap/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-H94HZ5S19Y"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-H94HZ5S19Y")</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="理解ldap应用 - Linux系统接入OpenLDAP做认证后端"><meta property="og:description" content="Overview 如果要使Linux账号通过LDAP进行身份认证，就需要配置Linux的 身份验证模块 (Pluggable Authentication Modules) 与 名称服务交换系统 (Name Service Switch) 与LDAP交互。
PAM 和 NSS [3] NSS (name service switch) 通俗理解为是一个数据库系统，他作用是用于如何将操作系统与各种名称的解析机制关联起来，例如主机名，用户名，组名等内容的查找；例如UID查找使用 passwd 库，GID的查找使用 group 库，并且还可以告知查找的来源，如文件，LDAP等
PAM (Pluggable Authentication Modules) 全称是可插拔的认证模块，PAM在Linux中是位于用户数据库与应用之间的认证模块，它本身并不工作，并且本身也不提供或扩展现有数据库系统，当登陆shell时，依赖于由NSS提供的密码库与组库等信息，完成对应的查询
例如下列两张图完整的阐述了PAM与NSS之间，在用户登陆时做了些什么
图：pam和nss工作示意图1Source：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e
由图可以看出，当在进行 ping , id 等操作时，会通过nss找到 passwd 库找到用户id，以及通过nss确定是 hosts解析还是dns服务解析对应的域名
如果这张图不明白可以看下一张图
图：pam和nss工作示意图2-1Source：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e
图2-1 中使用了tom用户去登录pecan主机，此时在节点 yam 上，将寻找 pecan主机的IP，这是通过 /etc/nsswitch.conf 来确定是通过 hosts 还是 dns服务进行查找。
接下来找到pecan的IP，这里会输入用户名与密码，这里将会被sshd服务接管，此时 pecan 主机的sshd接收到用户端请求连接后，将用户名通过nss进行识别，确定是否为合法用户，如果用户有效，则通过PAM进行认证。认证的源也将由 /etc/nsswitch.conf 中配置的对应 passwd 库来找到，例如ldap,file等。正如下图2-2所示
图：pam和nss工作示意图2-2Source：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e
Linux with LDAP [1] 在大致了解了Linux登录认证的原理后，知道了要使Linux使用LDAP需要配置两个部分，NSS与PAM，通常有下述几种方案：
NSS + PAM SSSD (System Security Services Daemon)，SSSD是提供严重的一种工具，可以包含多种源例如LDAP，AD，Kerberos 等，并且提供了缓存功能（当ldap不可用时提供服务） 配置NSS 安装 nss-pam-ldapd"><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2019/09/ch10-linux-with-ldap/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-09-30T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-28T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="理解ldap应用 - Linux系统接入OpenLDAP做认证后端"><meta name=twitter:description content="Overview 如果要使Linux账号通过LDAP进行身份认证，就需要配置Linux的 身份验证模块 (Pluggable Authentication Modules) 与 名称服务交换系统 (Name Service Switch) 与LDAP交互。
PAM 和 NSS [3] NSS (name service switch) 通俗理解为是一个数据库系统，他作用是用于如何将操作系统与各种名称的解析机制关联起来，例如主机名，用户名，组名等内容的查找；例如UID查找使用 passwd 库，GID的查找使用 group 库，并且还可以告知查找的来源，如文件，LDAP等
PAM (Pluggable Authentication Modules) 全称是可插拔的认证模块，PAM在Linux中是位于用户数据库与应用之间的认证模块，它本身并不工作，并且本身也不提供或扩展现有数据库系统，当登陆shell时，依赖于由NSS提供的密码库与组库等信息，完成对应的查询
例如下列两张图完整的阐述了PAM与NSS之间，在用户登陆时做了些什么
图：pam和nss工作示意图1Source：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e
由图可以看出，当在进行 ping , id 等操作时，会通过nss找到 passwd 库找到用户id，以及通过nss确定是 hosts解析还是dns服务解析对应的域名
如果这张图不明白可以看下一张图
图：pam和nss工作示意图2-1Source：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e
图2-1 中使用了tom用户去登录pecan主机，此时在节点 yam 上，将寻找 pecan主机的IP，这是通过 /etc/nsswitch.conf 来确定是通过 hosts 还是 dns服务进行查找。
接下来找到pecan的IP，这里会输入用户名与密码，这里将会被sshd服务接管，此时 pecan 主机的sshd接收到用户端请求连接后，将用户名通过nss进行识别，确定是否为合法用户，如果用户有效，则通过PAM进行认证。认证的源也将由 /etc/nsswitch.conf 中配置的对应 passwd 库来找到，例如ldap,file等。正如下图2-2所示
图：pam和nss工作示意图2-2Source：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e
Linux with LDAP [1] 在大致了解了Linux登录认证的原理后，知道了要使Linux使用LDAP需要配置两个部分，NSS与PAM，通常有下述几种方案：
NSS + PAM SSSD (System Security Services Daemon)，SSSD是提供严重的一种工具，可以包含多种源例如LDAP，AD，Kerberos 等，并且提供了缓存功能（当ldap不可用时提供服务） 配置NSS 安装 nss-pam-ldapd"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"理解ldap应用 - Linux系统接入OpenLDAP做认证后端","item":"https://www.oomkill.com/2019/09/ch10-linux-with-ldap/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"理解ldap应用 - Linux系统接入OpenLDAP做认证后端","name":"理解ldap应用 - Linux系统接入OpenLDAP做认证后端","description":"Overview 如果要使Linux账号通过LDAP进行身份认证，就需要配置Linux的 身份验证模块 (Pluggable Authentication Modules) 与 名称服务交换系统 (Name Service Switch) 与LDAP交互。\nPAM 和 NSS [3] NSS (name service switch) 通俗理解为是一个数据库系统，他作用是用于如何将操作系统与各种名称的解析机制关联起来，例如主机名，用户名，组名等内容的查找；例如UID查找使用 passwd 库，GID的查找使用 group 库，并且还可以告知查找的来源，如文件，LDAP等\nPAM (Pluggable Authentication Modules) 全称是可插拔的认证模块，PAM在Linux中是位于用户数据库与应用之间的认证模块，它本身并不工作，并且本身也不提供或扩展现有数据库系统，当登陆shell时，依赖于由NSS提供的密码库与组库等信息，完成对应的查询\n例如下列两张图完整的阐述了PAM与NSS之间，在用户登陆时做了些什么\n图：pam和nss工作示意图1\rSource：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e\n由图可以看出，当在进行 ping , id 等操作时，会通过nss找到 passwd 库找到用户id，以及通过nss确定是 hosts解析还是dns服务解析对应的域名\n如果这张图不明白可以看下一张图\n图：pam和nss工作示意图2-1\rSource：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e\n图2-1 中使用了tom用户去登录pecan主机，此时在节点 yam 上，将寻找 pecan主机的IP，这是通过 /etc/nsswitch.conf 来确定是通过 hosts 还是 dns服务进行查找。\n接下来找到pecan的IP，这里会输入用户名与密码，这里将会被sshd服务接管，此时 pecan 主机的sshd接收到用户端请求连接后，将用户名通过nss进行识别，确定是否为合法用户，如果用户有效，则通过PAM进行认证。认证的源也将由 /etc/nsswitch.conf 中配置的对应 passwd 库来找到，例如ldap,file等。正如下图2-2所示\n图：pam和nss工作示意图2-2\rSource：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e\nLinux with LDAP [1] 在大致了解了Linux登录认证的原理后，知道了要使Linux使用LDAP需要配置两个部分，NSS与PAM，通常有下述几种方案：\nNSS + PAM SSSD (System Security Services Daemon)，SSSD是提供严重的一种工具，可以包含多种源例如LDAP，AD，Kerberos 等，并且提供了缓存功能（当ldap不可用时提供服务） 配置NSS 安装 nss-pam-ldapd","keywords":["ldap","linux","Linux通过openldap认证"],"articleBody":"Overview 如果要使Linux账号通过LDAP进行身份认证，就需要配置Linux的 身份验证模块 (Pluggable Authentication Modules) 与 名称服务交换系统 (Name Service Switch) 与LDAP交互。\nPAM 和 NSS [3] NSS (name service switch) 通俗理解为是一个数据库系统，他作用是用于如何将操作系统与各种名称的解析机制关联起来，例如主机名，用户名，组名等内容的查找；例如UID查找使用 passwd 库，GID的查找使用 group 库，并且还可以告知查找的来源，如文件，LDAP等\nPAM (Pluggable Authentication Modules) 全称是可插拔的认证模块，PAM在Linux中是位于用户数据库与应用之间的认证模块，它本身并不工作，并且本身也不提供或扩展现有数据库系统，当登陆shell时，依赖于由NSS提供的密码库与组库等信息，完成对应的查询\n例如下列两张图完整的阐述了PAM与NSS之间，在用户登陆时做了些什么\n图：pam和nss工作示意图1\rSource：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e\n由图可以看出，当在进行 ping , id 等操作时，会通过nss找到 passwd 库找到用户id，以及通过nss确定是 hosts解析还是dns服务解析对应的域名\n如果这张图不明白可以看下一张图\n图：pam和nss工作示意图2-1\rSource：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e\n图2-1 中使用了tom用户去登录pecan主机，此时在节点 yam 上，将寻找 pecan主机的IP，这是通过 /etc/nsswitch.conf 来确定是通过 hosts 还是 dns服务进行查找。\n接下来找到pecan的IP，这里会输入用户名与密码，这里将会被sshd服务接管，此时 pecan 主机的sshd接收到用户端请求连接后，将用户名通过nss进行识别，确定是否为合法用户，如果用户有效，则通过PAM进行认证。认证的源也将由 /etc/nsswitch.conf 中配置的对应 passwd 库来找到，例如ldap,file等。正如下图2-2所示\n图：pam和nss工作示意图2-2\rSource：https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e\nLinux with LDAP [1] 在大致了解了Linux登录认证的原理后，知道了要使Linux使用LDAP需要配置两个部分，NSS与PAM，通常有下述几种方案：\nNSS + PAM SSSD (System Security Services Daemon)，SSSD是提供严重的一种工具，可以包含多种源例如LDAP，AD，Kerberos 等，并且提供了缓存功能（当ldap不可用时提供服务） 配置NSS 安装 nss-pam-ldapd\nCentOS/Redhat：\tyum install -y nss-pam-ldapd Debian/Ubuntu：apt-get install libnss-ldapd 配置 /etc/nsswitch.conf ，该文件保存了各数据库，需要对 group , passwd , shadow 库开启 ldap\nconf passwd: files sss ldap\rshadow: files sss ldap\rgroup: files sss ldap 配置PAM CentOS/Redhat：\tyum install -y pam_ldap Debian/Ubuntu：apt-get install libpam-ldapd 要想通过本地 Sudo 实现 OpenLDAP 用户提权，可按以下步骤操作。\nsh 1 2 3 4 5 6 7 8 9 authconfig \\ --enableldap \\ --enableldapauth \\ --ldapserver=ldap://10.0.0.10:389 \\ --ldapbasedn=\"dc=test,dc=org\" \\ --enablemkhomedir \\ --ldapbasedn=\"ou=tvb,dc=test,dc=org\" \\ --enableshadow \\ --update \\ Notes：\nCentOS/RedHat 也可以使用 SSSD替代，yum install -y sssd ，上面提供的方案是NSS+PAM\n通常情况下Ubuntu会使用 SSSD 服务替代，SSSD包含了 PAM模块 和 NSS模块\nUbuntu中，没有被 authconfig 没有被打包在 SSSD 中，通常需要安装 sudo apt install ldap-auth-config\nLinux用户权限控制 部署此功能的原因是能够在所有基础结构服务器上仅使用一个用户，并且无需每次在每台服务器上手动更新 /etc/sudoers 文件，即可为此用户提供sudo权限。现在，这些天您可以使用像ansible这样的工具来执行此操作，但是并不是说OpenLDAP用法必须仅用于posixGroup用户访问，因此OpenLDAP只擅长它。OpenLDAP集成应扩展到您部署的每个集中式系统，并且您唯一的“管理员”用户可以访问基础架构范围内的所有系统。\nsudoers在slapd部分配置 要使 OpenLDAP 服务端实现用户权限控制，具体的实施步骤可以大致分为如下几步：\n创建 ldap 中 sudoers容器，并创建默认的搜索域\n为 slapd 导入sudo schema\n定义sudo规则条目及sudo组\n通过手动定义用户加入sudo组，集成sudo权限\n命令添加及修改 通过转换 本地 sudoers 配置文件 为LDAP ldif格式文件\nOpenLDAP 提供的 perl脚本 sudoers2ldif ，通常会看到，如果没有可以从 Github 中下载 sudo 提供的转换命令 cvtsudoers 图形化管理界面配置\n客户端配置加入OpenLDAP服务端\n客户端识别sudo策略及验证用户权限\nOpenLDAP服务端导入sudo schema sh 1 2 3 4 5 6 7 8 9 10 11 12 13 # 找到sudo的openldap schema rpm -ql sudo | grep schema # 将其复制到openldap schema目录 cp /usr/share/doc/sudo-1.8.23/schema.OpenLDAP /etc/openldap/schema/sudo.schema # 生成include sudo.ldif echo \"include /etc/openldap/schema/sudo.schema\" \u003e /tmp/sudo.conf slapcat -f /tmp/sudo.conf -F /tmp/ -n 0 -s \"cn={0}sudo,cn=schema,cn=config\" \u003e /tmp/sudo.ldif # 最后需要删除后面几行 sed -i \"s@{0}sudo@sudo@g\" /tmp/sudo.ldif head -n -8 /tmp/sudo.ldif \u003e /etc/openldap/schema/sudo.ldif 生成的对应schema在：/etc/openldap/slapd.d/cn=config/cn=schema/\n为 OpenLDAP 创建 suers 容器 创建ldap的sudoers容器，官网有给出提示，sudoers如果在ldap中使用必须放在 ou=SUDOers 中，其中 cn=default 为最先被查找的条目\nThe sudoers configuration is contained in the ‘ou=SUDOers’ LDAP container. [2]\n默认情况下，sudo检索的域为 cn=default,ou=SUDOers,dc=xx,dc=xx 如果找到，那么该条目中所有 sudoOption 属性都会被解析为全局默认值，这类似于服务端中查询一个 sudo 用户权限时一般有两到三次查询。\n第一次查询解析全局配置 第二次查询匹配用户名或者用户所在的组（特殊标签 ALL 也在此次查询中匹配），如果没有找到相关匹配项，则发出第三次查询，此次查询返回所有包含用户组的条目并检查该用户是否存在于这些组中 下面命令是创建一个 sudoers 在 ldap中的根容器 ou=SUDOers ，这个步骤总是需要手动执行，因为默认通过 /etc/sudoers 转换过来的 ldif 是不带这个域的\nbash 1 2 3 4 5 $ cat \u003c\u003c EOF | ldapadd -D \"cn=admin,dc=test,dc=com\" -w 111 -H ldap://10.0.0.10:389 dn: ou=SUDOers,dc=test,dc=com objectclass: organizationalunit ou: SUDOers EOF 下面步骤是将 /etc/sudoers 转换为 ldap ldif\n创建一个环境变量 SUDOERS_BASE ，这个在perl脚本执行的必须条件。\nbash 1 export SUDOERS_BASE=\"ou=SUDOers,dc=test,dc=com\" 接下来，使用sudo包中提供了一个命令 cvtsudoers 可以将 sudoers的配置文件 /etc/sudoers 转换为LDAP ldif格式文件\nbash 1 cvtsudoers /etc/sudoers -f ldif -o sudoers_defaults.ldif 另外，通过脚本将 sudoers的配置文件 /etc/sudoers 转换为LDAP ldif格式的文件，将用这个来创建默认的cn=default 的sudoers\nbash 1 perl sudoers2ldif /etc/sudoers \u003e sudoers_defaults.ldif Notes：openldap还有一种操作为 ldif to schema，通过下述命令可以完成 [4]\nbash 1 sed '/^dn: /d;/^objectClass: /d;/^cn: /d;s/olcAttributeTypes:/attributetype/g;s/olcObjectClasses:/objectclass/g' file.ldif \u003e file.schema 接下来将这些配置导入到ldap中\nbash 1 ldapadd -D \"cn=admin,dc=test,dc=com\" -w 111 -H ldap://10.0.0.10:389 -f sudoers_defaults.ldif 配置客户端主机支持sudo over ldap 在客户端，需要两个额外步骤。\n需要添加： /etc/nsswitch.conf\nsh 1 2 3 4 ## 增加 sudoers: ldap files echo 'sudoers: ldap files' \u003e\u003e /etc/nsswitch.conf 需要提供：/etc/sudo-ldap.conf\nsh 1 2 3 4 binddn cn=clientsearch,ou=admin,dc=cylon,dc=org bindpw 111 uri ldap://10.0.0.20 sudoers_base ou=sudoers,dc=cylon,dc=org Troubleshooting 错误：invalid structural object class chain\nbash 1 2 ldap_add: Object class violation (65) additional info: invalid structural object class chain (groupOfUniqueNames/posixGroup) 原因：在ldap中 groupOfUniqueNames / posixGroup / inetOrgPerson 实际上是同一种类型 [6] ，级别的对象组，其 objectClass 只能选择包含一个，要 gidNumber 就不能有 memberOf 了。\n问题出于：对于筛选来说，posixGroup 组并不支持 memberOf 属性，这种情况下可能无法做到权限的筛选与用户的筛选等，但是对于Linux 使用ldap管理用户权限时，普通的 groupOfUniqueNames 并不带有 gidNumber 属性，使得用户没有组，这时配置的组的权限，sudo实际不生效。\n解决：\n为 posixGroup 生成一个 memberOf 属性 [5]，这里在尝试导入 ldif 文件时 slapd 生成配置失败无报错 直接使用 posixGroup 替换组 groupOfUniqueNames posixGroup 使用的是 memberUid 进行关联，在检索时，可以使用 uid=memberUid 进行过滤 本质上 posixGroup 与 groupOfUniqueNames 只是对组，没有对用户 需要配置 refint 解决引用关系一致性问题，正如下列给出配置一样 ldif dn: olcOverlay=refint,olcDatabase={1}mdb,cn=config\robjectClass: olcConfig\robjectClass: olcOverlayConfig\robjectClass: olcRefintConfig\robjectClass: top\rolcOverlay: refint\rolcRefintAttribute: memberUid uid\rolcRefintNothing: cn=default,dc=test,dc=com Reference [1] Configure OpenLDAP login for CentOS 7\n[2] sudoers.ldap.man\n[3] Understanding nss and pam using a ssh example\n[4] Convert AD-Schema from *.ldif to *.schema\n[5] GENERATING A MEMBEROF ATTRIBUTE FOR POSIXGROUPS\n[6] how to fix (65) invalid structural object class chain (posixGroup/groupOfNames)?\n[7] Configure OpenLDAP login for CentOS 7\n[8] Linux LDAP Authentication\n[9] Linux user management with LDAP\n[10] 2. LDAP authentication using pam_ldap and nss_ldap\n[11] How to Configure SUDO via OpenLDAP Server\n[12] SUDOers from OpenLDAP\n[13] OpenLDAPSudo权限讲解-OpenLDAPSudo权限讲解\n[14] authconfig\n[15] Configuring PAM Authentication and User Mapping with LDAP Authentication\n","wordCount":"635","inLanguage":"zh","datePublished":"2019-09-30T00:00:00Z","dateModified":"2022-11-28T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2019/09/ch10-linux-with-ldap/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">理解ldap应用 - Linux系统接入OpenLDAP做认证后端</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2019-09-30</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>635 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>3 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/ldap/>#Ldap</a>
<a href=https://www.oomkill.com/tags/databases/>#Databases</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a><li><a href=#pam-%e5%92%8c-nss-supa-href33asup aria-label="PAM 和 NSS [3]">PAM 和 NSS <sup><a href=#3>[3]</a></sup></a><li><a href=#linux-with-ldap-supa-href11asup aria-label="Linux with LDAP [1]">Linux with LDAP <sup><a href=#1>[1]</a></sup></a><ul><li><a href=#%e9%85%8d%e7%bd%aenss aria-label=配置NSS>配置NSS</a><li><a href=#%e9%85%8d%e7%bd%aepam aria-label=配置PAM>配置PAM</a></ul><li><a href=#linux%e7%94%a8%e6%88%b7%e6%9d%83%e9%99%90%e6%8e%a7%e5%88%b6 aria-label=Linux用户权限控制>Linux用户权限控制</a><ul><li><a href=#sudoers%e5%9c%a8slapd%e9%83%a8%e5%88%86%e9%85%8d%e7%bd%ae aria-label=sudoers在slapd部分配置>sudoers在slapd部分配置</a><li><a href=#openldap%e6%9c%8d%e5%8a%a1%e7%ab%af%e5%af%bc%e5%85%a5sudo-schema aria-label="OpenLDAP服务端导入sudo schema">OpenLDAP服务端导入sudo schema</a><li><a href=#%e4%b8%ba-openldap-%e5%88%9b%e5%bb%ba-suers-%e5%ae%b9%e5%99%a8 aria-label="为 OpenLDAP 创建 suers 容器">为 OpenLDAP 创建 suers 容器</a><li><a href=#%e9%85%8d%e7%bd%ae%e5%ae%a2%e6%88%b7%e7%ab%af%e4%b8%bb%e6%9c%ba%e6%94%af%e6%8c%81sudo-over-ldap aria-label="配置客户端主机支持sudo over ldap">配置客户端主机支持sudo over ldap</a></ul><li><a href=#troubleshooting aria-label=Troubleshooting>Troubleshooting</a><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>如果要使Linux账号通过LDAP进行身份认证，就需要配置Linux的 身份验证模块 (<em><strong>Pluggable Authentication Modules</strong></em>) 与 名称服务交换系统 (<em><strong>Name Service Switch</strong></em>) 与LDAP交互。</p><h2 id=pam-和-nss-supa-href33asup>PAM 和 NSS <sup><a href=#3>[3]</a></sup><a hidden class=anchor aria-hidden=true href=#pam-和-nss-supa-href33asup>#</a></h2><p>NSS (<em><strong>name service switch</strong></em>) 通俗理解为是一个数据库系统，他作用是用于如何将操作系统与各种名称的解析机制关联起来，例如主机名，用户名，组名等内容的查找；例如UID查找使用 <code>passwd</code> 库，GID的查找使用 <code>group</code> 库，并且还可以告知查找的来源，如文件，LDAP等</p><p>PAM (<em><strong>Pluggable Authentication Modules</strong></em>) 全称是可插拔的认证模块，PAM在Linux中是位于用户数据库与应用之间的认证模块，它本身并不工作，并且本身也不提供或扩展现有数据库系统，当登陆shell时，依赖于由NSS提供的密码库与组库等信息，完成对应的查询</p><p>例如下列两张图完整的阐述了PAM与NSS之间，在用户登陆时做了些什么</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221112160527824.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221112160527824.png#center alt=image-20221112160527824 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：pam和nss工作示意图1</center><center><em>Source：</em>https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e</center><br><p>由图可以看出，当在进行 <code>ping</code> , <code>id</code> 等操作时，会通过nss找到 <code>passwd</code> 库找到用户id，以及通过nss确定是 hosts解析还是dns服务解析对应的域名</p><p>如果这张图不明白可以看下一张图</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221112160836827.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221112160836827.png#center alt=image-20221112160836827 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：pam和nss工作示意图2-1</center><center><em>Source：</em>https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e</center><br><p>图2-1 中使用了tom用户去登录pecan主机，此时在节点 <code>yam</code> 上，将寻找 pecan主机的IP，这是通过 <code>/etc/nsswitch.conf</code> 来确定是通过 <code>hosts</code> 还是 dns服务进行查找。</p><p>接下来找到pecan的IP，这里会输入用户名与密码，这里将会被sshd服务接管，此时 pecan 主机的sshd接收到用户端请求连接后，将用户名通过nss进行识别，确定是否为合法用户，如果用户有效，则通过PAM进行认证。认证的源也将由 <code>/etc/nsswitch.conf</code> 中配置的对应 <code>passwd</code> 库来找到，例如ldap,file等。正如下图2-2所示</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221112161605611.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221112161605611.png#center alt=image-20221112161605611 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：pam和nss工作示意图2-2</center><center><em>Source：</em>https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e</center><br><h2 id=linux-with-ldap-supa-href11asup>Linux with LDAP <sup><a href=#1>[1]</a></sup><a hidden class=anchor aria-hidden=true href=#linux-with-ldap-supa-href11asup>#</a></h2><p>在大致了解了Linux登录认证的原理后，知道了要使Linux使用LDAP需要配置两个部分，NSS与PAM，通常有下述几种方案：</p><ul><li>NSS + PAM</li><li>SSSD (<em><strong>System Security Services Daemon</strong></em>)，SSSD是提供严重的一种工具，可以包含多种源例如LDAP，AD，Kerberos 等，并且提供了缓存功能（当ldap不可用时提供服务）</li></ul><h3 id=配置nss>配置NSS<a hidden class=anchor aria-hidden=true href=#配置nss>#</a></h3><p>安装 <code>nss-pam-ldapd</code></p><ul><li>CentOS/Redhat：<code> yum install -y nss-pam-ldapd</code></li><li>Debian/Ubuntu：<code>apt-get install libnss-ldapd</code></li></ul><p>配置 <em><strong>/etc/nsswitch.conf</strong></em> ，该文件保存了各数据库，需要对 <code>group</code> , <code>passwd </code>, <code>shadow </code>库开启 ldap</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>conf</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-conf data-lang=conf>passwd:     files sss ldap
shadow:     files sss ldap
group:      files sss ldap</code></pre></div></div><h3 id=配置pam>配置PAM<a hidden class=anchor aria-hidden=true href=#配置pam>#</a></h3><ul><li>CentOS/Redhat：<code> yum install -y pam_ldap</code></li><li>Debian/Ubuntu：<code>apt-get install libpam-ldapd</code></li></ul><p>要想通过本地 Sudo 实现 OpenLDAP 用户提权，可按以下步骤操作。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>authconfig <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enableldap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enableldapauth <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--ldapserver<span class=o>=</span>ldap://10.0.0.10:389 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--ldapbasedn<span class=o>=</span><span class=s2>&#34;dc=test,dc=org&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enablemkhomedir <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--ldapbasedn<span class=o>=</span><span class=s2>&#34;ou=tvb,dc=test,dc=org&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--enableshadow <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--update <span class=err>\</span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>Notes：</p><ul><li><p>CentOS/RedHat 也可以使用 SSSD替代，<code>yum install -y sssd</code> ，上面提供的方案是NSS+PAM</p></li><li><p>通常情况下Ubuntu会使用 SSSD 服务替代，SSSD包含了 PAM模块 和 NSS模块</p></li><li><p>Ubuntu中，没有被 <code>authconfig</code> 没有被打包在 SSSD 中，通常需要安装 <code>sudo apt install ldap-auth-config</code></p></li></ul></blockquote><h2 id=linux用户权限控制>Linux用户权限控制<a hidden class=anchor aria-hidden=true href=#linux用户权限控制>#</a></h2><p>部署此功能的原因是能够在所有基础结构服务器上仅使用一个用户，并且无需每次在每台服务器上手动更新 <font color=#f8070d size=3><code>/etc/sudoers</code></font> 文件，即可为此用户提供sudo权限。现在，这些天您可以使用像ansible这样的工具来执行此操作，但是并不是说OpenLDAP用法必须仅用于posixGroup用户访问，因此OpenLDAP只擅长它。OpenLDAP集成应扩展到您部署的每个集中式系统，并且您唯一的“管理员”用户可以访问基础架构范围内的所有系统。</p><h3 id=sudoers在slapd部分配置>sudoers在slapd部分配置<a hidden class=anchor aria-hidden=true href=#sudoers在slapd部分配置>#</a></h3><p>要使 <code>OpenLDAP</code> 服务端实现用户权限控制，具体的实施步骤可以大致分为如下几步：</p><ul><li><p>创建 ldap 中 sudoers容器，并创建默认的搜索域</p></li><li><p>为 <code>slapd</code> 导入sudo schema</p></li><li><p>定义sudo规则条目及sudo组</p><ul><li><p>通过手动定义用户加入sudo组，集成sudo权限</p><ul><li>命令添加及修改</li></ul></li><li><p>通过转换 本地 sudoers 配置文件 为LDAP ldif格式文件</p><ul><li>OpenLDAP 提供的 perl脚本 <code>sudoers2ldif</code> ，通常会看到，如果没有可以从 <a href=https://github.com/lbt/sudo/blob/master/plugins/sudoers/sudoers2ldif target=_blank rel="noopener nofollow noreferrer">Github</a> 中下载</li><li>sudo 提供的转换命令 <code>cvtsudoers</code></li></ul></li></ul></li><li><p>图形化管理界面配置</p></li><li><p>客户端配置加入OpenLDAP服务端</p></li><li><p>客户端识别sudo策略及验证用户权限</p></li></ul><h3 id=openldap服务端导入sudo-schema>OpenLDAP服务端导入sudo schema<a hidden class=anchor aria-hidden=true href=#openldap服务端导入sudo-schema>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 找到sudo的openldap schema</span>
</span></span><span class=line><span class=cl>rpm -ql sudo <span class=p>|</span> grep schema
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将其复制到openldap schema目录</span>
</span></span><span class=line><span class=cl>cp /usr/share/doc/sudo-1.8.23/schema.OpenLDAP /etc/openldap/schema/sudo.schema  
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成include sudo.ldif</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;include   /etc/openldap/schema/sudo.schema&#34;</span> &gt;  /tmp/sudo.conf
</span></span><span class=line><span class=cl>slapcat -f /tmp/sudo.conf -F /tmp/ -n <span class=m>0</span> -s <span class=s2>&#34;cn={0}sudo,cn=schema,cn=config&#34;</span> &gt; /tmp/sudo.ldif
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 最后需要删除后面几行</span>
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s@{0}sudo@sudo@g&#34;</span> /tmp/sudo.ldif
</span></span><span class=line><span class=cl>head -n -8 /tmp/sudo.ldif &gt; /etc/openldap/schema/sudo.ldif</span></span></code></pre></td></tr></table></div></div></div></div><p>生成的对应schema在：<font color=#f8070d size=3><code>/etc/openldap/slapd.d/cn=config/cn=schema/</code></font></p><h3 id=为-openldap-创建-suers-容器>为 OpenLDAP 创建 suers 容器<a hidden class=anchor aria-hidden=true href=#为-openldap-创建-suers-容器>#</a></h3><p>创建ldap的sudoers容器，官网有给出提示，sudoers如果在ldap中使用必须放在 <code>ou=SUDOers</code> 中，其中 <code>cn=default</code> 为最先被查找的条目</p><blockquote><p>The <em>sudoers</em> configuration is contained in the ‘<code>ou=SUDOers</code>’ LDAP container. <sup><a href=#2>[2]</a></sup></p></blockquote><p>默认情况下，sudo检索的域为 <code>cn=default,ou=SUDOers,dc=xx,dc=xx</code> 如果找到，那么该条目中所有 <code>sudoOption</code> 属性都会被解析为全局默认值，这类似于服务端中查询一个 sudo 用户权限时一般有两到三次查询。</p><ul><li>第一次查询解析全局配置</li><li>第二次查询匹配用户名或者用户所在的组（特殊标签 ALL 也在此次查询中匹配），如果没有找到相关匹配项，则发出第三次查询，此次查询返回所有包含用户组的条目并检查该用户是否存在于这些组中</li></ul><p>下面命令是创建一个 sudoers 在 ldap中的根容器 <code>ou=SUDOers</code> ，这个步骤总是需要手动执行，因为默认通过 <code>/etc/sudoers</code> 转换过来的 ldif 是不带这个域的</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat <span class=s>&lt;&lt; EOF | ldapadd -D &#34;cn=admin,dc=test,dc=com&#34; -w 111 -H ldap://10.0.0.10:389
</span></span></span><span class=line><span class=cl><span class=s>dn: ou=SUDOers,dc=test,dc=com
</span></span></span><span class=line><span class=cl><span class=s>objectclass: organizationalunit
</span></span></span><span class=line><span class=cl><span class=s>ou: SUDOers
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></td></tr></table></div></div></div></div><p>下面步骤是将 <code>/etc/sudoers</code> 转换为 ldap <code>ldif</code></p><p>创建一个环境变量 <code>SUDOERS_BASE</code> ，这个在perl脚本执行的必须条件。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>SUDOERS_BASE</span><span class=o>=</span><span class=s2>&#34;ou=SUDOers,dc=test,dc=com&#34;</span></span></span></code></pre></td></tr></table></div></div></div></div><p>接下来，使用sudo包中提供了一个命令 <code>cvtsudoers </code>可以将 sudoers的配置文件 <code>/etc/sudoers</code> 转换为LDAP ldif格式文件</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cvtsudoers /etc/sudoers -f ldif -o sudoers_defaults.ldif</span></span></code></pre></td></tr></table></div></div></div></div><p>另外，通过脚本将 sudoers的配置文件 <code>/etc/sudoers</code> 转换为LDAP ldif格式的文件，将用这个来创建默认的<code>cn=default</code> 的sudoers</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>perl sudoers2ldif /etc/sudoers &gt; sudoers_defaults.ldif</span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>Notes：openldap还有一种操作为 <em>ldif to schema</em>，通过下述命令可以完成 <sup><a href=#4>[4]</a></sup></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sed <span class=s1>&#39;/^dn: /d;/^objectClass: /d;/^cn: /d;s/olcAttributeTypes:/attributetype/g;s/olcObjectClasses:/objectclass/g&#39;</span> file.ldif &gt; file.schema</span></span></code></pre></td></tr></table></div></div></div></div></blockquote><p>接下来将这些配置导入到ldap中</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ldapadd -D <span class=s2>&#34;cn=admin,dc=test,dc=com&#34;</span> -w <span class=m>111</span> -H ldap://10.0.0.10:389 -f sudoers_defaults.ldif</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=配置客户端主机支持sudo-over-ldap>配置客户端主机支持sudo over ldap<a hidden class=anchor aria-hidden=true href=#配置客户端主机支持sudo-over-ldap>#</a></h3><p>在客户端，需要两个额外步骤。</p><p><strong>需要添加</strong>：<font color=#f8070d size=3><code> /etc/nsswitch.conf</code></font></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl> <span class=c1>## 增加</span>
</span></span><span class=line><span class=cl> sudoers:    ldap files
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> <span class=nb>echo</span> <span class=s1>&#39;sudoers:    ldap files&#39;</span> &gt;&gt; /etc/nsswitch.conf</span></span></code></pre></td></tr></table></div></div></div></div><p><strong>需要提供</strong>：<font color=#f8070d size=3><code>/etc/sudo-ldap.conf</code></font></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>sh</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>binddn <span class=nv>cn</span><span class=o>=</span>clientsearch,ou<span class=o>=</span>admin,dc<span class=o>=</span>cylon,dc<span class=o>=</span>org
</span></span><span class=line><span class=cl>bindpw <span class=m>111</span>
</span></span><span class=line><span class=cl>uri ldap://10.0.0.20
</span></span><span class=line><span class=cl>sudoers_base <span class=nv>ou</span><span class=o>=</span>sudoers,dc<span class=o>=</span>cylon,dc<span class=o>=</span>org</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=troubleshooting>Troubleshooting<a hidden class=anchor aria-hidden=true href=#troubleshooting>#</a></h2><p>错误：<code>invalid structural object class chain</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ldap_add: Object class violation <span class=o>(</span>65<span class=o>)</span>
</span></span><span class=line><span class=cl>	additional info: invalid structural object class chain <span class=o>(</span>groupOfUniqueNames/posixGroup<span class=o>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>原因：在ldap中 <code>groupOfUniqueNames</code> / <code>posixGroup</code> / <code>inetOrgPerson</code> 实际上是同一种类型 <sup><a href=#6>[6]</a></sup> ，级别的对象组，其 <code>objectClass</code> 只能选择包含一个，要 <code>gidNumber</code> 就不能有 <code>memberOf</code> 了。</p><p><strong>问题出于</strong>：对于筛选来说，<code>posixGroup</code> 组并不支持 <code>memberOf</code> 属性，这种情况下可能无法做到权限的筛选与用户的筛选等，但是对于Linux 使用ldap管理用户权限时，普通的 <code>groupOfUniqueNames</code> 并不带有 <code>gidNumber</code> 属性，使得用户没有组，这时配置的组的权限，sudo实际不生效。</p><p><strong>解决</strong>：</p><ul><li>为 <code>posixGroup</code> 生成一个 <code>memberOf</code> 属性 <sup><a href=#5>[5]</a></sup>，这里在尝试导入 ldif 文件时 slapd 生成配置失败无报错</li><li>直接使用 <code>posixGroup</code> 替换组 <code>groupOfUniqueNames</code><ul><li><code>posixGroup</code> 使用的是 <code>memberUid</code> 进行关联，在检索时，可以使用 <code>uid=memberUid</code> 进行过滤</li><li>本质上 <code>posixGroup</code> 与 <code>groupOfUniqueNames</code> 只是对组，没有对用户</li><li>需要配置 refint 解决引用关系一致性问题，正如下列给出配置一样<div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>ldif</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><pre tabindex=0><code class=language-ldif data-lang=ldif>dn: olcOverlay=refint,olcDatabase={1}mdb,cn=config
objectClass: olcConfig
objectClass: olcOverlayConfig
objectClass: olcRefintConfig
objectClass: top
olcOverlay: refint
olcRefintAttribute: memberUid uid
olcRefintNothing: cn=default,dc=test,dc=com</code></pre></div></div></li></ul></li></ul><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><blockquote><p><sup id=1>[1]</sup> <a href=https://joeho.xyz/blog-posts/configure-openldap-login-for-centos7/ target=_blank rel="noopener nofollow noreferrer"><em><strong>Configure OpenLDAP login for CentOS 7</strong></em></a></p><p><sup id=2>[2]</sup> <a href=https://www.sudo.ws/docs/man/sudoers.ldap.man/#SUDOers_LDAP_container target=_blank rel="noopener nofollow noreferrer"><em><strong>sudoers.ldap.man</strong></em></a></p><p><sup id=3>[3]</sup> <a href=https://medium.com/@fengliplatform/understanding-nss-and-pam-using-a-ssh-example-80512eb0f39e target=_blank rel="noopener nofollow noreferrer"><em><strong>Understanding nss and pam using a ssh example</strong></em></a></p><p><sup id=4>[4]</sup> <a href=https://serverfault.com/questions/818393/openldap-convert-ad-schema-from-ldif-to-schema target=_blank rel="noopener nofollow noreferrer"><em><strong>Convert AD-Schema from *.ldif to *.schema</strong></em></a></p><p><sup id=5>[5]</sup> <a href=http://blog.oddbit.com/post/2013-07-22-generating-a-membero/ target=_blank rel="noopener nofollow noreferrer"><em><strong>GENERATING A MEMBEROF ATTRIBUTE FOR POSIXGROUPS</strong></em></a></p><p><sup id=6>[6]</sup> <a href=https://ldap.umich.narkive.com/4c1rn2Qz/how-to-fix-65-invalid-structural-object-class-chain-posixgroup-groupofnames target=_blank rel="noopener nofollow noreferrer"><em><strong>how to fix (65) invalid structural object class chain (posixGroup/groupOfNames)?</strong></em></a></p><p><sup id=7>[7]</sup> <a href=https://joeho.xyz/blog-posts/configure-openldap-login-for-centos7/ target=_blank rel="noopener nofollow noreferrer"><em><strong>Configure OpenLDAP login for CentOS 7</strong></em></a></p><p><sup id=8>[8]</sup> <a href=https://linuxhint.com/linux-ldap-authentication-2/ target=_blank rel="noopener nofollow noreferrer"><em><strong>Linux LDAP Authentication</strong></em></a></p><p><sup id=9>[9]</sup> <a href=https://www.vennedey.net/resources/1-Linux-user-management-with-LDAP target=_blank rel="noopener nofollow noreferrer"><em><strong>Linux user management with LDAP</strong></em></a></p><p><sup id=10>[10]</sup> <a href=https://tldp.org/HOWTO/archived/LDAP-Implementation-HOWTO/pamnss.html target=_blank rel="noopener nofollow noreferrer"><em><strong>2. LDAP authentication using pam_ldap and nss_ldap</strong></em></a></p><p><sup id=11>[11]</sup> <a href=https://kifarunix.com/how-to-configure-sudo-via-openldap-server/ target=_blank rel="noopener nofollow noreferrer"><em><strong>How to Configure SUDO via OpenLDAP Server</strong></em></a></p><p><sup id=12>[12]</sup> <a href=http://pig.made-it.com/ldap-sudoers.html target=_blank rel="noopener nofollow noreferrer"><em><strong>SUDOers from OpenLDAP</strong></em></a></p><p><sup id=13>[13]</sup> <a href="https://wiki.shileizcc.com/confluence/pages/viewpage.action?pageId=40566794#OpenLDAPSudo%e6%9d%83%e9%99%90%e8%ae%b2%e8%a7%a3-OpenLDAPSudo%e6%9d%83%e9%99%90%e8%ae%b2%e8%a7%a3" target=_blank rel="noopener nofollow noreferrer"><em><strong>OpenLDAPSudo权限讲解-OpenLDAPSudo权限讲解</strong></em></a></p><p><sup id=14>[14]</sup> <a href=https://linux.die.net/man/8/authconfig target=_blank rel="noopener nofollow noreferrer"><em><strong>authconfig</strong></em></a></p><p><sup id=15>[15]</sup> <a href=https://mariadb.com/kb/en/configuring-pam-authentication-and-user-mapping-with-ldap-authentication/ target=_blank rel="noopener nofollow noreferrer"><em><strong>Configuring PAM Authentication and User Mapping with LDAP Authentication</strong></em></a></p></blockquote></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：理解ldap应用 - Linux系统接入OpenLDAP做认证后端</p><p>文章链接：<a href=https://www.oomkill.com/2019/09/ch10-linux-with-ldap/ target=_blank>https://www.oomkill.com/2019/09/ch10-linux-with-ldap/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2019/09/ch9-openldap-configuration/><span>理解ldap配置 - openldap中的一些高级配置</span></a></li><li><a href=/2019/09/ch8-backup-and-restore/><span>理解ldap配置 - OpenLDAP备份与恢复策略</span></a></li><li><a href=/2019/09/ch7-acl/><span>理解ldap配置 - OpenLDAP访问控制（ACL）</span></a></li><li><a href=/2019/09/ch6-replication/><span>理解ldap配置 - OpenLDAP中的4种复制机制</span></a></li><li><a href=/2019/09/ch05-openldap-ssl/><span>理解ldap配置 - OpenLDAP使用SSL/TLS通信安全</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/ldap/>Ldap</a></li><li><a href=https://www.oomkill.com/tags/databases/>Databases</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2019/09/03-1-acquaintance-rdb/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>Ceph RBD - 初识块存储RBD</span>
</a><a class=next href=https://www.oomkill.com/2019/09/ch9-openldap-configuration/><span class=title></span>
<span>理解ldap配置 - openldap中的一些高级配置&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/blogs","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch10 linux with ldap","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>